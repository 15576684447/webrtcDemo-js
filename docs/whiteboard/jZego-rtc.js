!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r=t();for(var i in r)("object"==typeof exports?exports:e)[i]=r[i]}}("undefined"!=typeof self?self:this,function(){return i={},n.m=r=[,,function(e,t,r){"use strict";var i,n,o,s,a,c,d;Object.defineProperty(t,"__esModule",{value:!0}),t.Platform=t.Action=t.ActionType=t.ViewTool=t.Direction=t.RenderMode=t.ScrollMode=void 0,(i=t.ScrollMode||(t.ScrollMode={}))[i.Page=0]="Page",i[i.Scroll=1]="Scroll",(n=t.RenderMode||(t.RenderMode={}))[n.Horizontal=1]="Horizontal",n[n.Vertical=2]="Vertical",n[n.Center=3]="Center",(o=t.Direction||(t.Direction={}))[o.Horizontal=1]="Horizontal",o[o.Vertical=2]="Vertical",(s=t.ViewTool||(t.ViewTool={}))[s.Pen=1]="Pen",s[s.Text=2]="Text",s[s.Line=4]="Line",s[s.Rect=8]="Rect",s[s.Ellipse=16]="Ellipse",s[s.Selector=32]="Selector",s[s.Eraser=64]="Eraser",(a=t.ActionType||(t.ActionType={}))[a.Single=1]="Single",a[a.Multi=2]="Multi",a[a.Other=4]="Other",(c=t.Action||(t.Action={}))[c.Update=2]="Update",c[c.Delete=4]="Delete",c[c.Move=8]="Move",c[c.Create=32]="Create",(d=t.Platform||(t.Platform={}))[d.Pc=1]="Pc",d[d.Mobile=2]="Mobile"},,,,,,,,,,,,,,,,,,,function(e,t,r){"use strict";var i,n,o;Object.defineProperty(t,"__esModule",{value:!0}),t.ModAction=t.PushType=t.Direction=void 0,(i=t.Direction||(t.Direction={}))[i.Center=0]="Center",i[i.Horizontal=1]="Horizontal",i[i.Vertical=2]="Vertical",(n=t.PushType||(t.PushType={}))[n.SetMod=1]="SetMod",n[n.ClearPageGraphics=2]="ClearPageGraphics",n[n.DrawPageGraphics=3]="DrawPageGraphics",(o=t.ModAction||(t.ModAction={}))[o.Add=1]="Add",o[o.Removed=2]="Removed",o[o.Modify=3]="Modify"},function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.hasOwnProperty.call(e,r)&&i(t,e,r);return n(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.checkTextSize=t.checkBrushSize=t.checkColor=t.addTextBeginPlace=t.splitTextHandle=t.calSizeHandle=t.calHandle=t.transData=t.transColor=t.bindStopsEvents=t.transGraphicsData=t.mapGraphicsData=t.simplifyPathData=t.transRgbTo16=t.transPathByPointList=t.createSvgElementHandle=t.setAttributeHandle=t.createGraphicId=void 0;var s=o(r(76)),y=r(2),a=r(69),c=r(70);t.createGraphicId=function(){return""+c(s.v4())};t.setAttributeHandle=function(t,e){e.forEach(function(e){t.setAttribute(e.attr,e.value)})};t.createSvgElementHandle=function(e,t){var r=document.querySelector(e);if(r)return[r];var i=document.createElementNS("http://www.w3.org/2000/svg","g");return(r=document.createElementNS("http://www.w3.org/2000/svg",t)).id=e.split("#")[1],i.appendChild(r),[r,i]};function d(e){for(var t=e.length,r=t-4,i="M"+e[0]+", "+e[1],n=0;n<t-2;n+=2){var o=n?e[n-2]:e[0],s=n?e[n-1]:e[1],a=e[n+0],c=e[n+1],d=e[n+2],l=e[n+3],h=n!==r?e[n+4]:d,u=n!==r?e[n+5]:l;i+=" C"+(Number(a)+(d-o)/6*.1)+","+(Number(c)+(l-s)/6*.1)+","+(Number(d)-(h-a)/6*.1)+","+(Number(l)-(u-c)/6*.1)+","+d+","+l}return i}t.transPathByPointList=d;function l(e){if(0===e.indexOf("#"))return e;var t=e.replace(/rgba?/,"").replace(/\(/,"").replace(/\)/,"").replace(/[\s+]/g,"").split(","),r=parseFloat(t[3]||"1"),i=Math.floor(r*parseInt(t[0])+255*(1-r)),n=Math.floor(r*parseInt(t[1])+255*(1-r)),o=Math.floor(r*parseInt(t[2])+255*(1-r));return"#"+("0"+i.toString(16)).slice(-2)+("0"+n.toString(16)).slice(-2)+("0"+o.toString(16)).slice(-2)}t.transRgbTo16=l;t.checkColor=function(e){return/^#[0-9a-fA-F]{6}|rgba?\(*.+\d\)$/.test(e)};t.checkBrushSize=function(e){return/^([1-9]|[1-9]\d|100)$/.test(""+e)};t.checkTextSize=function(e){return/^([1-9]|[1-9]\d|100)$/.test(""+e)&&12<=e};t.simplifyPathData=function(e){var t=[],i=[];return e.forEach(function(e,t,r){t%2==0&&i.push({x:e,y:r[t+1]})}),a(i,1).forEach(function(e){t=t.concat([e.x,e.y])}),t};function h(e){var t=e[0],r=e[1],i=e[2],n=e[3];return[Math.min(t,i),Math.min(r,n)]}t.mapGraphicsData=function(e,t){switch(e){case"path":o={d:d(t)};break;case"line":o={x1:t[0],y1:t[1],x2:t[2],y2:t[3]};break;case"rect":var r=Math.abs(t[2]-t[0]),i=Math.abs(t[3]-t[1]),n=h(t),o={x:n[0],y:n[1],width:r,height:i};break;case"ellipse":var s=Math.abs(t[2]-t[0])/2,a=Math.abs(t[3]-t[1])/2,c=h(t);o={cx:c[0]+s,cy:c[1]+a,rx:s,ry:a};break;default:o=!1}return o};t.transGraphicsData=function(e,t,r){var i=JSON.parse(JSON.stringify(e));return i.forEach(function(e){e.action_type=r,e.action=t,delete e.initX,delete e.initY,delete e.selected,delete e.fontSize,delete e.bgColor}),i};t.transColor=function(e,t){var r=e.color;t?(r=r.toString(16),e.color="#"+r.slice(2).padStart(6,"0")):(r=l(r),e.color=parseInt("0xFF"+r.split("#")[1]))};function u(e,t,r){var i=e[t];e[t]=e[r],e[r]=i}function p(e,t,r,i){var n=i.charCodeAt(t);e[t]=i.charCodeAt(r),e[r]=n}function g(e){for(var t=e.split(","),r=new Uint8Array(Int32Array.from([+t[0],+t[1]]).buffer),i=unescape(encodeURIComponent(t[2])).split("").map(function(e){return e.charCodeAt()}),n=0;n<r.length;n+=4)u(r,n,n+3),u(r,n+1,n+2);var o=new Uint8Array(r.length+i.length);return o.set(r),o.set(i,r.length),btoa(String.fromCharCode.apply(null,o))}function f(e){for(var t=atob(e),r=new Uint8Array(t.length),i=0;i<8;i+=4)p(r,i,i+3,t),p(r,i+1,i+2,t);for(;i<t.length;i++)r[i]=t.charCodeAt(i);return Array.from(new Int32Array(r.buffer,0,2)).join(",")+","+decodeURIComponent(escape(String.fromCharCode.apply(String,Array.from(r.subarray(8)))))}t.transData=function(e,t){var r=e.type,i=e.data,n=e.oldData;if(r===y.ViewTool.Text)t?(e.data=f(i),e.oldData&&(e.oldData=f(n))):(e.data=g(i),e.oldData&&(e.oldData=g(n)));else if(t){for(var o=atob(i),s=new Uint8Array(o.length),a=0;a<o.length;a+=4)p(s,a,a+3,o),p(s,a+1,a+2,o);e.data=Array.from(new Int32Array(s.buffer)).slice(1)}else{var c=i.slice();c.unshift(c.length/2);for(var s=new Uint8Array(Int32Array.from(c).buffer),a=0;a<s.length;a+=4)u(s,a,a+3),u(s,a+1,a+2);e.data=btoa(String.fromCharCode.apply(null,s))}};function b(e,t,r,i){var n=r.sizeWidth,o=e.size,s=e.type;i?(e.size=Math.round(o*t/n),y.ViewTool.Text===s?e.size<r.minFontSize&&(e.size=r.minFontSize):e.size<r.minLineWidth&&(e.size=r.minLineWidth)):e.size=Math.round(o*n/t)}t.calSizeHandle=b;t.calHandle=function(e,t,r,i,n){var o,s,a,c,d,l,h,u,p,g,f,m,v;b(e,r,i,n),s=t,a=i,c=n,h=(o=e).type,u=o.px,p=o.py,g=o.x,f=o.y,m=o.data,v=a.placeWidth,h===y.ViewTool.Text?(d=m.split(","),c?(d[0]=Math.round(d[0]*s/v)+"",d[1]=Math.round(d[1]*s/v)+""):(d[0]=Math.round(d[0]*v/s)+"",d[1]=Math.round(d[1]*v/s)+""),o.data=d.join(",")):(l=[],m.forEach(function(e){c?l.push(Math.round(e*s/v)):l.push(Math.round(e*v/s))}),o.data=l),c?(o.px&&(o.px=Math.round(u*s/v)),o.py&&(o.py=Math.round(p*s/v)),o.x=Math.round(g*s/v),o.y=Math.round(f*s/v)):(o.px&&(o.px=Math.round(u*v/s)),o.py&&(o.py=Math.round(p*v/s)),o.x=Math.round(g*v/s),o.y=Math.round(f*v/s))};t.bindStopsEvents=function(t,e){e.forEach(function(e){t.addEventListener(e,function(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0})})};t.splitTextHandle=function(e){var t=e.split(",");return{beginX:t[0],beginY:t[1],text:t[2]}};t.addTextBeginPlace=function(e,t,r){return parseInt(t)+","+parseInt(r)+","+e}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,r){"use strict";var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.ZegoClient=t.PROTO_VERSION=void 0,r(60);var o=r(64),s=r(72),a=r(73),c=r(75);t.PROTO_VERSION="1.0.0";var d,l=(d=c.ZegoClient,n(h,d),h.prototype.login=function(e,t,r,i,n){var o=this;d.prototype.login.call(this,e,t,r,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];o.loginTimes=0,o.getRoom(),o.onRemotePush(),i.apply(void 0,e)},function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];n.apply(void 0,e)})},h.prototype.on=function(e,t){return this.baseManager.on(e,t)},h.prototype.off=function(e,t){return this.baseManager.off(e,t)},h.prototype.getVersion=function(){return t.PROTO_VERSION},h);function h(){var r=d.call(this)||this;r.loginTimes=0;var e=new s.WhiteboardError,i=new a.WhiteboardService({stateCenter:r.stateCenter,logger:r.logger,socketCenter:r.socketCenter,whiteboardError:e});r.baseManager=new o.BaseManager(i,e),r.getRoom=i.getRoom.bind(i),r.onRemotePush=i.onRemotePush.bind(i);var n=r.roomHandler.loginSuccessCallBack;r.roomHandler.loginSuccessCallBack=function(e,t){n(e,t),r.loginTimes++,1<r.loginTimes&&i.reload()};return["getViewList","createView","attachView","destroyView"].forEach(function(e){r[e]=r.baseManager[e].bind(r.baseManager)}),r}t.ZegoClient=l},function(e,t,r){var i=r(61),n=r(62);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[e.i,n,""]]);var o={insert:"head",singleton:!1};i(n,o);e.exports=n.locals||{}},function(e,t,o){"use strict";var r,i,n=function(){return void 0===r&&(r=Boolean(window&&document&&document.all&&!window.atob)),r},s=(i={},function(e){if(void 0===i[e]){var t=document.querySelector(e);if(window.HTMLIFrameElement&&t instanceof window.HTMLIFrameElement)try{t=t.contentDocument.head}catch(e){t=null}i[e]=t}return i[e]}),h=[];function u(e){for(var t=-1,r=0;r<h.length;r++)if(h[r].identifier===e){t=r;break}return t}function c(e,t){for(var r={},i=[],n=0;n<e.length;n++){var o=e[n],s=t.base?o[0]+t.base:o[0],a=r[s]||0,c="".concat(s," ").concat(a);r[s]=a+1;var d=u(c),l={css:o[1],media:o[2],sourceMap:o[3]};-1!==d?(h[d].references++,h[d].updater(l)):h.push({identifier:c,updater:function(t,e){var r,i,n;{var o;n=e.singleton?(o=m++,r=f=f||p(e),i=g.bind(null,r,o,!1),g.bind(null,r,o,!0)):(r=p(e),i=function(e,t,r){var i=r.css,n=r.media,o=r.sourceMap;n?e.setAttribute("media",n):e.removeAttribute("media");o&&btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */"));if(e.styleSheet)e.styleSheet.cssText=i;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(i))}}.bind(null,r,e),function(){!function(e){if(null===e.parentNode)return;e.parentNode.removeChild(e)}(r)})}return i(t),function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap)return;i(t=e)}else n()}}(l,t),references:1}),i.push(c)}return i}function p(e){var t,r=document.createElement("style"),i=e.attributes||{};if(void 0!==i.nonce||(t=o.nc)&&(i.nonce=t),Object.keys(i).forEach(function(e){r.setAttribute(e,i[e])}),"function"==typeof e.insert)e.insert(r);else{var n=s(e.insert||"head");if(!n)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");n.appendChild(r)}return r}var a,d=(a=[],function(e,t){return a[e]=t,a.filter(Boolean).join("\n")});function g(e,t,r,i){var n,o,s=r?"":i.media?"@media ".concat(i.media," {").concat(i.css,"}"):i.css;e.styleSheet?e.styleSheet.cssText=d(t,s):(n=document.createTextNode(s),(o=e.childNodes)[t]&&e.removeChild(o[t]),o.length?e.insertBefore(n,o[t]):e.appendChild(n))}var f=null,m=0;e.exports=function(e,s){(s=s||{}).singleton||"boolean"==typeof s.singleton||(s.singleton=n());var a=c(e=e||[],s);return function(e){if(e=e||[],"[object Array]"===Object.prototype.toString.call(e)){for(var t=0;t<a.length;t++){var r=u(a[t]);h[r].references--}for(var i=c(e,s),n=0;n<a.length;n++){var o=u(a[n]);0===h[o].references&&(h[o].updater(),h.splice(o,1))}a=i}}}},function(e,t,r){(t=r(63)(!1)).push([e.i,"[id^='zego-whiteboard-con'],\ndiv[id^='zego-docsview'] {\n    background-color: #f1f3f4;\n}\n\n[id^='zego-whiteboard'] {\n    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);\n    position: absolute;\n}\n[id^='zego-whiteboard'] *,\n[id^='zego-whiteboard'] ::after,\n[id^='zego-whiteboard'] ::before {\n    box-sizing: border-box !important;\n}\n[id^='zego-whiteboard'] [id^='zego-graphics-bg-container'] {\n    width: 100%;\n    height: 100%;\n    position: absolute;\n    z-index: 0;\n    left: 0;\n    top: 0;\n}\n[id^='zego-whiteboard'] [id^='zego-graphics-container'] {\n    width: 100%;\n    height: 100%;\n    position: absolute;\n    z-index: 1;\n    left: 0;\n    top: 0;\n}\n[id^='zego-whiteboard'] [id^='zego-box-container'] {\n    width: 100%;\n    height: 100%;\n    position: absolute;\n    z-index: 1;\n    left: 0;\n    top: 0;\n}\n[id^='zego-whiteboard'] svg {\n    transform-origin: 0px 0px 0px;\n    position: absolute;\n    width: 100%;\n    height: 100%;\n    z-index: 0;\n    margin: 0px;\n    padding: 0px;\n    left: 0;\n    right: 0;\n}\n[id^='zego-whiteboard'] textarea {\n    width: 100%;\n    height: 100%;\n    overflow: hidden;\n    border: none;\n    outline: none;\n    background: transparent;\n    resize: none;\n    position: absolute;\n    top: 0;\n    right: 0;\n    left: 0;\n    bottom: 0;\n    padding: 3px;\n    line-height: 1;\n    font-family: inherit;\n    font-size: inherit;\n    box-sizing: border-box;\n    color: inherit;\n}\n[id^='zego-whiteboard'] pre {\n    display: block;\n    visibility: hidden;\n    margin: 0px 0px;\n    font-family: inherit;\n    font-size: inherit;\n    color: inherit;\n    line-height: 1;\n    padding: 3px;\n}\n[id^='zego-whiteboard'] [id^='zego-textarea'] {\n    border: 1px dashed transparent;\n}\n[id^='zego-graphics-box'],\n[id^='zego-whiteboard'] [id^='zego-textarea'] {\n    position: absolute;\n}\n\n[id^='zego-docsview-'] {\n    position: absolute;\n    pointer-events: none;\n    left: 0;\n    top: 0;\n}\n",""]),e.exports=t},function(e,t,r){"use strict";e.exports=function(r){var c=[];return c.toString=function(){return this.map(function(e){var t=function(e,t){var r=e[1]||"",i=e[3];if(!i)return r;if(t&&"function"==typeof btoa){var n=function(e){var t=btoa(unescape(encodeURIComponent(JSON.stringify(e)))),r="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(t);return"/*# ".concat(r," */")}(i),o=i.sources.map(function(e){return"/*# sourceURL=".concat(i.sourceRoot||"").concat(e," */")});return[r].concat(o).concat([n]).join("\n")}return[r].join("\n")}(e,r);return e[2]?"@media ".concat(e[2]," {").concat(t,"}"):t}).join("")},c.i=function(e,t,r){"string"==typeof e&&(e=[[null,e,""]]);var i={};if(r)for(var n=0;n<this.length;n++){var o=this[n][0];null!=o&&(i[o]=!0)}for(var s=0;s<e.length;s++){var a=[].concat(e[s]);r&&i[a[0]]||(t&&(a[2]?a[2]="".concat(t," and ").concat(a[2]):a[2]=t),c.push(a))}},c}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BaseManager=void 0,r(65);var o=r(66),i=r(71),n=(s.prototype.registerLoadfileListener=function(){var t=this;document.body.addEventListener("loadfile",function(e){t.fileInfoMap[e.detail.fileID]=e.detail})},s.prototype.registerPushCallbackHandle=function(){var i=this;this.serviceHandle.bindListener("pushClearPageGraphics",function(e){i.clearGraphicsPushCallback(e)}),this.serviceHandle.bindListener("pushDrawPageGraphics",function(e,t){i.drawGraphicsPushCallback(e,t)}),this.serviceHandle.bindListener("pushAddMod",function(e){i.addModPushCallback(e)}),this.serviceHandle.bindListener("pushRemovedMod",function(e){i.removedModPushCallback(e)}),this.serviceHandle.bindListener("pushScroll",function(e,t,r){i.scrollPushCallback(e,t,r)})},s.prototype.registerPullCallbackHandle=function(){var n=this;this.serviceHandle.bindListener("getPageGraphicsList",function(e,t,r){var i=n.getMapInstance(e);i&&i.updateRemoteToLocal(t,r)})},s.prototype.addModPushCallback=function(e){var t=new o.WhiteboardViewMod(e,this.whiteboardStore,this.serviceHandle);this.serviceHandle.actionCustomListener("viewAdd",t)},s.prototype.removedModPushCallback=function(e){var t=this.getMapInstance(e);t&&(t.destroy(),t=null),this.serviceHandle.actionCustomListener("viewRemoved",e),this.deleteMapInstance(e)},s.prototype.scrollPushCallback=function(e,t,r){var i=this.getMapInstance(e);i&&i.scrollToHandle(t,r,!1)},s.prototype.setFileInfo=function(e){var t;!e.fileInfo||(t=(t=this.fileInfoMap[e.fileInfo.fileID])&&t[e.fileInfo.fileName])&&(e.aspectWidth=t.width,e.aspectHeight=t.height,e.pageCount=t.pageCount)},s.prototype.clearGraphicsPushCallback=function(e){var t=this.getMapInstance(e);t&&t.clearLocalHandle()},s.prototype.drawGraphicsPushCallback=function(e,t){var i,n,r=this.getMapInstance(e);r&&(i=[],n=[],t.forEach(function(e){var t=e.del_graphic_id_list,r=e.graphic_list;i=i.concat(t),n=n.concat(r)}),r.updateRemoteToLocal(n,i))},s.prototype.deleteMapInstance=function(e){delete this.modIdMapInstance[e]},s.prototype.getMapInstance=function(e){return this.modIdMapInstance[e]},s.prototype.setMapInstance=function(e){this.modIdMapInstance[e.getID()]=e},s.prototype.activitedView=function(t){var r=this;Object.keys(this.modIdMapInstance).forEach(function(e){r.getMapInstance(e).setActivited(e===t)})},s.prototype.checkAttachingParent=function(e){return!!document.getElementById(e)},s.prototype.checkCreatingView=function(e){return!(!e||!e.roomID||!e.name||isNaN(+e.aspectWidth)||!+e.aspectWidth||isNaN(+e.aspectHeight)||!+e.aspectHeight)},s.prototype.getActivitedView=function(){return Object.values(this.modIdMapInstance).find(function(e){return e.isActivited()})},s.prototype.getViewList=function(){var n=this;return new Promise(function(r,i){n.serviceHandle.getModList(1,function(e){try{var t=[];e.forEach(function(e){t.push(new o.WhiteboardViewMod(e,n.whiteboardStore,n.serviceHandle))}),r(t)}catch(e){i(n.whiteboardError.transError(n.whiteboardError.CODES.ZegoWhiteboardViewErrorGetListFail))}},function(e){i(e)})})},s.prototype.createView=function(t){var n=this;return new Promise(function(r,i){var e;n.checkCreatingView(t)?(n.setFileInfo(t),n.serviceHandle.createMod(t,function(e){try{var t=new o.WhiteboardViewMod(e,n.whiteboardStore,n.serviceHandle);r(t)}catch(e){i(n.whiteboardError.transError(n.whiteboardError.CODES.ZegoWhiteboardViewErrorViewCreateFail))}},function(e){i(e)})):(e=n.whiteboardError.transError(n.whiteboardError.CODES.ZegoWhiteboardViewErrorParamInvalid,"参数错误：roomID必填、name必填、aspectWidth为正整数、aspectHeight为正整数"),i(e))})},s.prototype.destroyView=function(r){var i=this;return new Promise(function(e,t){r?i.serviceHandle.destroyMod(r.getID(),function(){try{r.destroy(),r=null,e()}catch(e){t(i.whiteboardError.transError(i.whiteboardError.CODES.ZegoWhiteboardViewErrorDestroyFail))}},function(e){t(e)}):t(i.whiteboardError.transError(i.whiteboardError.CODES.ZegoWhiteboardViewErrorViewNotExist))})},s.prototype.attachView=function(i,n){var o=this;return new Promise(function(e,t){if(o.checkAttachingParent(n))if(i)try{var r=i;r.init(n),o.setMapInstance(r),o.activitedView(r.getID()),e()}catch(e){t(o.whiteboardError.transError(o.whiteboardError.CODES.ZegoWhiteboardViewErrorAttachFail))}else t(o.whiteboardError.transError(o.whiteboardError.CODES.ZegoWhiteboardViewErrorViewNotExist));else t(o.whiteboardError.transError(o.whiteboardError.CODES.ZegoWhiteboardViewErrorViewParentNotExist))})},s.prototype.on=function(e,t){return this.serviceHandle.bindCustomListener(e,t)},s.prototype.off=function(e,t){return this.serviceHandle.deleteCustomListener(e,t)},s);function s(e,t){this.modIdMapInstance={},this.fileInfoMap={},this.whiteboardStore=new i.WhiteboardStore,this.whiteboardError=t,this.serviceHandle=e,this.registerLoadfileListener(),this.registerPushCallbackHandle(),this.registerPullCallbackHandle()}t.BaseManager=n},function(e,t){function r(e,t){t=t||{bubbles:!1,cancelable:!1,detail:void 0};var r=document.createEvent("CustomEvent");return r.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),r}-1!==window.navigator.userAgent.indexOf("Trident")&&(r.prototype=window.Event.prototype,window.CustomEvent=r,document.body.scrollTo||(Element.prototype.scrollTo=function(e,t){this.scrollLeft=e,this.scrollTop=t}),document.body.scrollBy||(Element.prototype.scrollBy=function(e,t){this.scrollLeft+=e,this.scrollTop+=t}),FileReader.prototype.readAsBinaryString||(FileReader.prototype.readAsBinaryString=function(e){var o=this,s=new FileReader;s.onload=function(e){for(var t="",r=new Uint8Array(s.result),i=r.byteLength,n=0;n<i;n++)t+=String.fromCharCode(r[n]);o.content=t,o.result=t,o.onload()},s.readAsArrayBuffer(e)}))},function(e,t,r){"use strict";var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),c=this&&this.__assign||function(){return(c=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)},s=this&&this.__spreadArrays||function(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;for(var i=Array(e),n=0,t=0;t<r;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,n++)i[n]=o[s];return i};Object.defineProperty(t,"__esModule",{value:!0}),t.WhiteboardViewMod=void 0;var o,a=r(67),d=r(68),f=r(21),m=r(2),b=r(22),l=(o=a.WhiteboardView,n(h,o),h.prototype.checkMultipoint=function(e){return 1<e.touches.length},h.prototype.destroy=function(){this.parentDom&&(this.parentDom.parentNode&&this.parentDom.parentNode.removeChild(this.parentDom),this.parentDom=null)},h.prototype.updateBindEvents=function(){var t=this;switch(this.bindEvents.mousemoveHandle&&this.whiteboardNode.removeEventListener(this.viewEvent.moveEventName,this.bindEvents.mousemoveHandle),this.bindEvents.mouseupHandle&&this.whiteboardNode.removeEventListener(this.viewEvent.upEventName,this.bindEvents.mouseupHandle),this.bindEvents.eraserMousemoveHandle&&this.whiteboardNode.removeEventListener(this.viewEvent.moveEventName,this.bindEvents.eraserMousemoveHandle),this.whiteboardStore.basicState.type){case m.ViewTool.Pen:case m.ViewTool.Line:case m.ViewTool.Ellipse:case m.ViewTool.Rect:this.bindEvents.mouseupHandle=function(){return t.drawSvgMouseupHandle()},this.whiteboardNode.addEventListener(this.viewEvent.upEventName,this.bindEvents.mouseupHandle);break;case m.ViewTool.Text:this.bindEvents.mouseupHandle=function(e){return t.textMouseupHandle(e)},this.whiteboardNode.addEventListener(this.viewEvent.upEventName,this.bindEvents.mouseupHandle);break;case m.ViewTool.Selector:this.bindEvents.mouseupHandle=function(){return t.selectMouseupHandle()},this.whiteboardNode.addEventListener(this.viewEvent.upEventName,this.bindEvents.mouseupHandle);break;case m.ViewTool.Eraser:1===this.viewEvent.platform?(this.whiteboardNode.addEventListener(this.viewEvent.moveEventName,this.bindEvents.eraserMousemoveHandle),this.bindEvents.mouseupHandle=function(){return t.eraserMouseupPcHandle()}):this.bindEvents.mouseupHandle=function(e){return t.eraserMouseupMbHandle(e)},this.whiteboardNode.addEventListener(this.viewEvent.upEventName,this.bindEvents.mouseupHandle)}},h.prototype.init=function(e){this.parentDom||(this.viewEvent=new d.WhiteboardViewEvent,this.createModule(e)),this.updateBindEvents(),this.whiteboardNode.addEventListener(this.viewEvent.downEventName,this.bindEvents.mousedownHandle),this.whiteboardNode.addEventListener(this.viewEvent.upEventName,this.bindEvents.mouseupHandle),this.whiteboardNode.addEventListener("mouseleave",this.bindEvents.mouseleaveHandle),this.initDraw(),this.activited();var t=this.serviceHandle.getScrollPercent(this.whiteboardID),r=t.horizontalPercent,i=t.verticalPercent;this.scrollToHandle(r,i,!1),this.parentDom.dispatchEvent(new CustomEvent("pagechange_wb",{detail:{y:Math.ceil(i*this.viewInfo.viewHeight)}}))},h.prototype.calculateHandle=function(e,t){var r={viewWidth:0,viewHeight:0};if(this.hasFileInfo()){this.viewInfo.direction=f.Direction.Vertical;var i,n,o,s,a=this.parentDom.firstChild;return a&&(n=(i=a.getAttribute("data-page"))?Number(i):1,o=a.clientWidth,s=a.clientHeight,r.viewWidth=o,r.viewHeight=s*n),r}var c,d=this.serviceHandle.getAspectRatio(this.whiteboardID),l=Number(d.split(":")[0]),h=Number(d.split(":")[1]),u=Math.round(h/(l*t/e));return 2<=u?(r.viewWidth=e,r.viewHeight=u*t,this.isScrollMode()||this.updateViewInfo({page:1,pageCount:u}),this.viewInfo.direction=f.Direction.Vertical):2<=(c=Math.round(l/(h*e/t)))?(r.viewWidth=c*e,r.viewHeight=t,this.isScrollMode()||this.updateViewInfo({page:1,pageCount:c}),this.viewInfo.direction=f.Direction.Horizontal):(r.viewWidth=e,r.viewHeight=t,this.viewInfo.direction=f.Direction.Center),r},h.prototype.isScrollMode=function(){return this.whiteboardStore.basicState.scroll===m.ScrollMode.Scroll},h.prototype.hasFileInfo=function(){return this.viewInfo.hasOwnProperty("isFile")||(this.viewInfo.isFile=!!this.serviceHandle.getFileInfo(this.whiteboardID)),this.viewInfo.isFile},h.prototype.createModule=function(e){var r=this,t=document.getElementById(e),i=this.hasFileInfo();i&&(this.parentDom=t,this.handlePageChangeListener(this.parentDom));var n=t.clientWidth,o=t.clientHeight;this.serviceHandle.setViewportSize(this.whiteboardID,n,o),this.whiteboardNode=document.createElement("div"),this.whiteboardNode.id=""+this.whiteboardStore.reservedKey.whiteboardPrefix+this.whiteboardID,this.whiteboardNode.className=m.ViewTool[this.whiteboardStore.basicState.type];var s=this.calculateHandle(n,o),a=s.viewWidth,c=s.viewHeight;this.whiteboardNode.style.cssText="width: "+a+"px; height: "+c+"px;",this.serviceHandle.setSize(this.whiteboardID,a,c);var d=document.createDocumentFragment();[this.whiteboardStore.reservedKey.graphicsBgContainerIdPrefix,this.whiteboardStore.reservedKey.graphicsContainerIdPrefix,this.whiteboardStore.reservedKey.boxContainerIdPrefix].forEach(function(e){var t=document.createElement("div");t.id=""+e+r.whiteboardID,d.appendChild(t)});var l=this.getElementChild(d);this.graphicsConNode=l[1],this.graphicsBoxConNode=l[2],this.graphicsBgContainerNode=l[0],this.whiteboardNode.appendChild(d);var h,u,p,g=document.createElementNS("http://www.w3.org/2000/svg","svg");g.id=""+this.whiteboardStore.reservedKey.graphicsSvgIdPrefix+this.whiteboardID,g.setAttribute("xmlns","http://www.w3.org/2000/svg"),g.setAttribute("version","1.1"),this.graphicsConNode.appendChild(g),this.svgNode=g,i?(o<c-20?this.parentDom.style.overflowX="hidden":n<a-20&&(this.parentDom.style.overflowY="hidden"),(p=this.parentDom.querySelector("#"+this.whiteboardNode.id))&&this.removeElement(p),this.parentDom.appendChild(this.whiteboardNode),this.parentDom.addEventListener("scroll",this.scrollHandle)):((h=document.createElement("div")).id=""+this.whiteboardStore.reservedKey.whiteboardContainerPrefix+this.whiteboardID,h.appendChild(this.whiteboardNode),u=this.isScrollMode()?this.viewInfo.direction===f.Direction.Horizontal?"overflow: auto hidden;":"overflow: hidden auto;":"overflow: hidden",h.style.cssText="width: 100%; height: 100%;"+u,(p=t.querySelector("#"+h.id))&&this.removeElement(p),t.appendChild(h),this.parentDom=h,this.isScrollMode()&&this.parentDom.addEventListener("scroll",this.scrollHandle)),this.getOffsetData(),this.updateViewInfo({viewportWidth:n,viewportHeight:o,viewWidth:a,viewHeight:c})},h.prototype.setActivited=function(e){this._activited=e},h.prototype.isActivited=function(){return this._activited},h.prototype.activited=function(){var t,r=this;this.setActivited(!0),this.parentDom&&this.parentDom.parentNode&&(t=this.parentDom.id,Array.from(this.getElementChild(this.parentDom.parentNode)).forEach(function(e){e.style.display=e.id===t?"block":"none",e.lastElementChild&&"DIV"!==e.lastElementChild.tagName&&r.removeElement(e)}),this.graphicsBgContainerNode.style.backgroundColor=this.hasFileInfo()?"rgba(255,255,255,0)":this.whiteboardStore.basicState.bgColor)},h.prototype.initDraw=function(){this.updateProtoGraphic(),this.updateMousePointList()},h.prototype.updateMousePointList=function(e){this.mousePointList=e?this.mousePointList.concat(e):[]},h.prototype.updateFlowData=function(e){e?Object.assign(this.flowData,e):this.flowData={isWillMove:!1,isBlur:!1,noMoveUp:!0,isAlreadyMove:!1,moving:!1}},h.prototype.updateProtoGraphic=function(e){e?Object.assign(this.protoGraphic,e):this.protoGraphic=c({graphic_id:"",data:[],oldData:"",selected:!1,x:0,y:0,px:0,py:0},this.whiteboardStore.basicState)},h.prototype.updateViewInfo=function(e){Object.assign(this.viewInfo,e)},h.prototype.getMouseChangedPoint=function(e){var t,r,i;return i=1===this.viewEvent.platform?(r=e.clientX,e.clientY):(r=(t=e.changedTouches[0]).clientX,t.clientY),this.transLocation({clientX:r,clientY:i})},h.prototype.getMouseStartPoint=function(e){var t,r,i;return i=1===this.viewEvent.platform?(r=e.clientX,e.clientY):(r=(t=e.touches[0]).clientX,t.clientY),this.transLocation({clientX:r,clientY:i})},h.prototype.updateGraphicsData=function(e){var t=this.protoGraphic.data;this.protoGraphic.type===m.ViewTool.Pen?t.push.apply(t,e):t.splice.apply(t,s([2,2],e))},h.prototype.moveGraphics=function(){var n=this;this.graphicList.forEach(function(e){var t=e.graphic_id,r=e.x,i=e.y;e.selected&&(n.moveByOffset(t,r,i),n.updateGraphicsBox(e))})},h.prototype.updateBoxBorderOnSelector=function(){var n,o=this,s=this.whiteboardStore.reservedKey.graphicsIdPrefix,e="#"+s+this.protoGraphic.graphic_id,t=this.whiteboardNode.querySelector(e);t&&(n=t.getBoundingClientRect(),this.graphicList.forEach(function(e){var t,r=o.whiteboardNode.querySelector("#"+s+e.graphic_id),i=o.getBoxByGraphicId(e.graphic_id);r&&(t=r.getBoundingClientRect(),Math.max(n.left,t.left)<Math.min(n.right,t.right)&&Math.max(n.top,t.top)<Math.min(n.bottom,t.bottom)?(e.selected=!0,i&&(i.style.border=o.whiteboardStore.selectedBorderCss)):(e.selected=!1,i&&(i.style.border=o.whiteboardStore.unSelectedBorderCss)))}))},h.prototype.getMouseCoverGraphics=function(e){var c=this,t=1===this.viewEvent.platform?e:e.changedTouches[0],d=t.clientX,l=t.clientY,h=!1,u=0;return this.graphicList.forEach(function(e){var t,r,i,n,o,s,a=c.getBoxByGraphicId(e.graphic_id);a&&(r=(t=a.getBoundingClientRect()).left,i=t.top,n=t.right,o=t.bottom,r<=d&&d<=n&&i<=l&&l<=o&&(s=Math.pow(o-i,2)+Math.pow(n-r,2),(!u||s<u)&&(u=s,h=e)))}),h},h.prototype.addTextareaDom=function(e){var t=e.graphic_id,r=e.data,i=document.createElement("textarea"),n=""+this.whiteboardStore.reservedKey.graphicsIdPrefix+t;i.setAttribute("id",n),i.setAttribute("spellcheck","false"),i.setAttribute("maxlength",""+this.whiteboardStore.maxlength);var o=b.splitTextHandle(r).text;return i.value=o,i},h.prototype.addPreDom=function(e){var t=e.size,r=e.data,i=b.splitTextHandle(r).text,n=document.createElement("pre");return n.innerHTML=i,n.style.cssText="min-height:"+(t+6)+"px;min-width:"+(t+6)+"px;",n},h.prototype.addTextareaConDom=function(e){var t=e.size,r=e.color,i=e.data,n=e.graphic_id,o=b.splitTextHandle(i),s=o.beginX,a=o.beginY,c=document.createElement("div"),d=""+this.whiteboardStore.reservedKey.textareaConIdPrefix+n;return c.setAttribute("id",d),c.style.cssText="font-size:"+t+"px;left:"+s+"px;top:"+a+"px;color:"+r+";caret-color:"+r+";",c},h.prototype.bindTextareaInputEvent=function(e){var c=this;e.addEventListener("input",function(e){var t=e.target,r=t.value,i=t.previousSibling,n=t.parentNode;r.length>c.whiteboardStore.maxlength&&(t.value=r.slice(0,c.whiteboardStore.maxlength));var o=(i.innerHTML=r).split("\n").length,s=n.style.fontSize,a=Number(s.split("px")[0]);i.style.height=o*a+"px"})},h.prototype.bindTextareaFocusEvent=function(e,t){var i=this,r=t.data,n=b.splitTextHandle(r),o=n.beginX,s=n.beginY;e.addEventListener("focus",function(e){var t=e.target;t.parentNode.style.borderColor="red";var r=t.id.split(i.whiteboardStore.reservedKey.graphicsIdPrefix)[1];i.setDataToGraphicList(r,{oldData:b.addTextBeginPlace(t.value,o,s)})})},h.prototype.bindTextareaBlurEvents=function(e){var u=this;e.addEventListener("blur",function(e){var t=e.target,r=t.parentNode,i=t.value,n=t.id.split(u.whiteboardStore.reservedKey.graphicsIdPrefix)[1];u.updatePointerEvents(2,u.graphicsBoxConNode.querySelector(u.getBoxSelectorByGraphicId(n)));var o,s,a=u.getDataFromGraphicList(n,"oldData").oldData,c=b.splitTextHandle(a),d=c.text,l=c.beginX,h=c.beginY;i?(o=d?m.Action.Update:m.Action.Create,u.updateFlowData({isBlur:!0}),r.style.borderColor="transparent",i!==d&&u.graphicList.forEach(function(e){e.graphic_id===n&&(e.oldData=e.data,e.data=b.addTextBeginPlace(i,l,h),u.updateGraphicsBox(e),u.updateToRemote([e],o,m.ActionType.Single))}),u.initDraw()):(u.removeElement(r),d&&(o=m.Action.Delete,u.graphicList.forEach(function(e,t,r){e.graphic_id===n&&(r.splice(t,1),e.oldData=e.data,u.updateToRemote([e],o,m.ActionType.Single))}),(s=u.getBoxByGraphicId(n))&&u.removeElement(s)))})},h.prototype.addTextareaGraphic=function(e,t){var r=this.addTextareaDom(e),i=this.addPreDom(e),n=this.addTextareaConDom(e);n.appendChild(i),n.appendChild(r),this.graphicsConNode.appendChild(n),this.bindTextareaInputEvent(r),this.bindTextareaFocusEvent(r,e),b.bindStopsEvents(r,[this.viewEvent.downEventName,this.viewEvent.moveEventName,this.viewEvent.upEventName]),t||(r.focus(),this.updatePointerEvents(1,null)),this.bindTextareaBlurEvents(r),this.moveByOffset(e.graphic_id,e.x,e.y)},h.prototype.updateTextareaGraphic=function(e){var t,r,i=e.graphic_id,n=e.data,o=e.size,s=e.color,a=e.x,c=e.y,d=b.splitTextHandle(n),l=d.beginX,h=d.beginY,u=d.text,p=this.graphicsConNode.querySelector(this.getInstanceSelectorByGraphicId(i));p&&(p.value=u,p.parentNode.style.cssText="font-size: "+o+"px;left: "+l+"px;top: "+h+"px;color: "+s+";transform: translate("+a+"px, "+c+"px);caret-color:"+s+";",t=p.previousSibling,r=u.split("\n").length,t.innerHTML=u,t.style.cssText="min-height:"+(o+6)+"px;min-width:"+(o+6)+"px;height:"+(r*o+6)+"px;",this.updateGraphicsBox(e))},h.prototype.foucsTextarea=function(e){this.setDataToGraphicList(e,{selected:!1});var t=this.getBoxByGraphicId(e);t&&(t.style.borderColor="transparent"),this.updatePointerEvents(1,t);var r=this.getInstanceByGraphicId(e);r&&(r.style.borderColor="red",Array.from(this.getElementChild(r)).forEach(function(e){"TEXTAREA"===e.tagName&&e.focus()}))},h.prototype.moveByOffset=function(e,t,r){var i=this.getInstanceByGraphicId(e);i&&("g"===i.tagName?this.getElementChild(i)[0].setAttribute("transform","translate("+(t||0)+", "+(r||0)+")"):i.style.transform="translate("+(t||0)+"px, "+(r||0)+"px)")},h.prototype.drawGraphicsLine=function(e,t,r,i,n){void 0===t&&(t="none"),void 0===r&&(r=1),void 0===i&&(i="round"),void 0===n&&(n="round");var o=e.data,s=e.graphic_id,a=e.color,c=e.size,d=e.x,l=e.y,h=b.mapGraphicsData("line",o),u=h.x1,p=h.y1,g=h.x2,f=h.y2,m=this.getInstanceSelectorByGraphicId(s),v=b.createSvgElementHandle(m,"line"),y=v[0];v[1]&&this.svgNode.appendChild(v[1]),b.setAttributeHandle(y,[{attr:"fill",value:t},{attr:"opacity",value:r},{attr:"stroke",value:a},{attr:"stroke-width",value:c},{attr:"stroke-linejoin",value:i},{attr:"stroke-linecap",value:n},{attr:"x1",value:u},{attr:"y1",value:p},{attr:"x2",value:g},{attr:"y2",value:f}]),this.moveByOffset(s,d,l)},h.prototype.drawGraphicsRect=function(e,t,r,i,n){void 0===t&&(t="none"),void 0===r&&(r=1),void 0===i&&(i="round"),void 0===n&&(n="round");var o,s,a,c=e.data,d=e.graphic_id,l=e.color,h=e.size,u=e.x,p=e.y,g=b.mapGraphicsData("rect",c),f=g.width,m=g.height,v=g.x,y=g.y;f&&m&&(o="#"+this.whiteboardStore.reservedKey.graphicsIdPrefix+d,a=(s=b.createSvgElementHandle(o,"rect"))[0],s[1]&&this.svgNode.appendChild(s[1]),b.setAttributeHandle(a,[{attr:"fill",value:t},{attr:"opacity",value:r},{attr:"stroke",value:l},{attr:"stroke-width",value:h},{attr:"stroke-linejoin",value:i},{attr:"stroke-linecap",value:n},{attr:"width",value:f},{attr:"height",value:m},{attr:"x",value:v},{attr:"y",value:y}]),this.moveByOffset(d,u,p))},h.prototype.drawGraphicsPath=function(e,t,r,i){void 0===t&&(t="none"),void 0===r&&(r="round"),void 0===i&&(i="round");var n,o,s,a,c=e.color,d=e.size,l=e.graphic_id,h=e.data,u=e.x,p=e.y;h.length<4||(n=b.mapGraphicsData("path",h).d,o="#"+this.whiteboardStore.reservedKey.graphicsIdPrefix+l,a=(s=b.createSvgElementHandle(o,"path"))[0],s[1]&&this.svgNode.appendChild(s[1]),b.setAttributeHandle(a,[{attr:"fill",value:t},{attr:"d",value:n},{attr:"stroke",value:c},{attr:"stroke-width",value:d},{attr:"stroke-linejoin",value:r},{attr:"stroke-linecap",value:i}]),this.moveByOffset(l,u,p))},h.prototype.drawGraphicsEllipse=function(e,t,r,i,n){void 0===t&&(t="none"),void 0===r&&(r=1),void 0===i&&(i="round"),void 0===n&&(n="round");var o,s,a,c=e.color,d=e.size,l=e.data,h=e.graphic_id,u=e.x,p=e.y,g=b.mapGraphicsData("ellipse",l),f=g.cx,m=g.cy,v=g.rx,y=g.ry;0!==v&&0!==y&&(o="#"+this.whiteboardStore.reservedKey.graphicsIdPrefix+h,a=(s=b.createSvgElementHandle(o,"ellipse"))[0],s[1]&&this.svgNode.appendChild(s[1]),b.setAttributeHandle(a,[{attr:"fill",value:t},{attr:"opacity",value:r},{attr:"stroke",value:c},{attr:"stroke-width",value:d},{attr:"stroke-linejoin",value:i},{attr:"stroke-linecap",value:n},{attr:"cx",value:f},{attr:"cy",value:m},{attr:"rx",value:v},{attr:"ry",value:y}]),this.moveByOffset(h,u,p))},h.prototype.drawGraphicsHandle=function(e){switch(e.type){case m.ViewTool.Pen:this.drawGraphicsPath(e);break;case m.ViewTool.Line:this.drawGraphicsLine(e);break;case m.ViewTool.Ellipse:this.drawGraphicsEllipse(e);break;case m.ViewTool.Rect:this.drawGraphicsRect(e);break;case m.ViewTool.Selector:this.drawGraphicsRect(e,e.color,.3),this.updateBoxBorderOnSelector()}},h.prototype.updateGraphicsBox=function(e){var t=e.type,r=e.graphic_id,i=e.size,n=e.selected,o=t===m.ViewTool.Text?0:i,s=this.graphicsConNode.querySelector(this.getInstanceSelectorByGraphicId(r));if(!s)return!1;var a=this.getBoxInfoByGraphicInfo(s,o),c=a.left,d=a.top,l="width: "+a.width+"px;height: "+a.height+"px;left: "+c+"px;top: "+d+"px;border: "+this.whiteboardStore[n?"selectedBorderCss":"unSelectedBorderCss"]+";",h=this.graphicsBoxConNode.querySelector(this.getBoxSelectorByGraphicId(r));return h||((h=document.createElement("div")).setAttribute("id",""+this.whiteboardStore.reservedKey.graphicsBoxIdPrefix+r),this.graphicsBoxConNode.appendChild(h),t===m.ViewTool.Text&&(l+="pointer-events: initial;")),h.style.cssText=l,h},h.prototype.getBoxByGraphicId=function(e){var t=this.getBoxSelectorByGraphicId(e);return this.graphicsBoxConNode.querySelector(t)},h.prototype.getInstanceByGraphicId=function(e){var t=this.getInstanceSelectorByGraphicId(e),r=this.graphicsConNode.querySelector(t);return r=r&&r.parentNode},h.prototype.getInstanceSelectorByGraphicId=function(e){return"#"+this.whiteboardStore.reservedKey.graphicsIdPrefix+e},h.prototype.getBoxSelectorByGraphicId=function(e){return"#"+this.whiteboardStore.reservedKey.graphicsBoxIdPrefix+e},h.prototype.updateGraphicListOnMoving=function(){var e=this.mousePointList.length,i=this.mousePointList[e-2]-this.mousePointList[e-4],n=this.mousePointList[e-1]-this.mousePointList[e-3];this.graphicList.forEach(function(e){var t,r;e.selected&&(t=e.x,r=e.y,void 0===e.initX&&void 0===e.initY&&(e.initX=t,e.initY=r),e.px=t,e.py=r,e.x=t+i,e.y=r+n)})},h.prototype.transLocation=function(e){var t=this.viewInfo,r=t.offsetLeft,i=t.offsetTop,n=t.scrollTop,o=t.scrollLeft;return{clientX:Math.round(e.clientX-r+o),clientY:Math.round(e.clientY-i+n)}},h.prototype.getScrollData=function(){var e=this.parentDom,t=0,r=0;if(e)for(t+=e.scrollTop,r+=e.scrollLeft;e.parentNode;)t+=e.parentNode.scrollTop||0,r+=e.parentNode.scrollLeft||0,e=e.parentNode;this.viewInfo.offsetPageY?t+=this.viewInfo.offsetPageY:this.viewInfo.offsetPageX&&(r+=this.viewInfo.offsetPageX),this.updateViewInfo({scrollTop:t,scrollLeft:r})},h.prototype.getOffsetData=function(){var e=this.parentDom,t=0,r=0;if(e)for(t+=e.offsetTop,r+=e.offsetLeft;e.offsetParent;)t+=e.offsetParent.offsetTop,r+=e.offsetParent.offsetLeft,e=e.offsetParent;this.updateViewInfo({offsetLeft:r,offsetTop:t})},h.prototype.getDataFromGraphicList=function(r){for(var i=[],e=1;e<arguments.length;e++)i[e-1]=arguments[e];for(var n={},o=this,t=0,s=this.graphicList.length;t<s&&"break"!==function(e){var t=o.graphicList[e];if(r===t.graphic_id)return i.forEach(function(e){n[e]=t[e]}),"break"}(t);t++);return n},h.prototype.setDataToGraphicList=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];for(var i=0,n=this.graphicList.length;i<n;i++){var o=this.graphicList[i];if(e===o.graphic_id){Object.assign.apply(Object,s([o],t));break}}},h.prototype.removeGraphic=function(i){var e=this.getBoxByGraphicId(i),t=this.getInstanceByGraphicId(i);e&&this.removeElement(e),t&&this.removeElement(t),this.graphicList.forEach(function(e,t,r){e.graphic_id===i&&r.splice(t,1)})},h.prototype.updatePointerEvents=function(e,t){var r=this;1===e?(Array.from(this.getElementChild(this.graphicsBoxConNode)).forEach(function(e){var t=r.getInstanceByGraphicId(e.id.split(r.whiteboardStore.reservedKey.graphicsBoxIdPrefix)[1]);t&&"DIV"===t.nodeName&&(e.style.pointerEvents="initial")}),this.graphicsBoxConNode.style.pointerEvents="none",t&&(t.style.pointerEvents="none")):(this.graphicsBoxConNode.style.pointerEvents="initial",t&&(t.style.pointerEvents="initial"))},h.prototype.getBoxInfoByGraphicInfo=function(e,t){var r=e.getBoundingClientRect(),i=r.left,n=r.top,o=r.width,s=r.height,a=this.transLocation({clientX:i,clientY:n}),i=a.clientX-Math.ceil(t/2)-this.whiteboardStore.boxBorderWidth-this.whiteboardStore.boxPadding,n=a.clientY-Math.ceil(t/2)-this.whiteboardStore.boxBorderWidth-this.whiteboardStore.boxPadding,c="electron"===this.serviceHandle.platform?-1:this.whiteboardStore.boxBorderWidth;return{left:i,top:n,width:o=o+t+2*this.whiteboardStore.boxPadding+c,height:s=s+t+2*this.whiteboardStore.boxPadding+c}},h.prototype.drawSvgMouseupHandle=function(){if(this._enable){this.whiteboardNode.removeEventListener(this.viewEvent.moveEventName,this.bindEvents.mousemoveHandle),this.updateFlowData({moving:!1});var e=this.protoGraphic,t=e.graphic_id,r=e.type,i=e.data;if(t&&this.updateGraphicsBox(this.protoGraphic)){if(r===m.ViewTool.Pen){var n=this.getInstanceByGraphicId(t);if(!n)return;var o=b.simplifyPathData(i);this.getElementChild(n)[0].setAttribute("d",b.mapGraphicsData("path",o).d),this.updateProtoGraphic({data:o})}var s=JSON.parse(JSON.stringify(this.protoGraphic));this.graphicList.push(s),this.updateToRemote([s],m.Action.Create,m.ActionType.Single)}this.initDraw()}},h.prototype.selectMouseupHandle=function(){var e,t,r,i,n;this._enable&&(this.updateFlowData({moving:!1}),t=(e=this.flowData).noMoveUp,r=e.isAlreadyMove,t&&!0!==t&&this.foucsTextarea(t),this.whiteboardNode.removeEventListener(this.viewEvent.moveEventName,this.bindEvents.mousemoveHandle),(i=this.graphicsConNode.querySelector("#"+this.whiteboardStore.reservedKey.graphicsIdPrefix+this.protoGraphic.graphic_id))&&this.removeElement(i.parentNode),r&&((n=this.graphicList.filter(function(e){return e.selected})).forEach(function(e){e.px=e.initX,e.py=e.initY,delete e.initX,delete e.initY}),this.updateToRemote(n,m.Action.Move,1<n.length?m.ActionType.Multi:m.ActionType.Single)),this.initDraw())},h.prototype.textMouseupHandle=function(e){var t,r,i,n;this._enable&&(this.flowData.isBlur?this.updateFlowData({isBlur:!1}):(r=(t=this.getMouseChangedPoint(e)).clientX,i=t.clientY,this.updateProtoGraphic(c({graphic_id:b.createGraphicId(),x:0,y:0,px:0,py:0,data:b.addTextBeginPlace("",r+"",i+"")},this.whiteboardStore.basicState)),n=c(c({},this.protoGraphic),{size:this.whiteboardStore.basicState.fontSize}),this.graphicList.push(n),this.addTextareaGraphic(n)))},h.prototype.eraserMouseupPcHandle=function(){var e;!this._enable||(e=this.graphicList.filter(function(e){return!0===e.selected})).length&&this.removeGraphicList(e)},h.prototype.eraserMouseupMbHandle=function(e){var t,r,i=this;this._enable&&((t=this.getMouseCoverGraphics(e))?(r=t.graphic_id,this.graphicList.forEach(function(e){var t=i.getBoxByGraphicId(e.graphic_id);e.graphic_id===r?(e.selected=!0,t&&(t.style.border=i.whiteboardStore.selectedBorderCss)):(e.selected=!1,t&&(t.style.border=i.whiteboardStore.unSelectedBorderCss))})):this.graphicList.forEach(function(e){e.selected=!1;var t=i.getBoxByGraphicId(e.graphic_id);t&&(t.style.border=i.whiteboardStore.unSelectedBorderCss)}),this.eraserMouseupPcHandle())},h.prototype.removeElement=function(e){var t=e.parentNode;t?t.removeChild(e):e.remove?e.remove():e.removeNode()},h.prototype.getElementChild=function(e){return e.children||e.childNodes},h.prototype.removeElementChild=function(t){Array.from(this.getElementChild(t)).forEach(function(e){t.removeChild(e)})},h.prototype.removeGraphicList=function(e){var i=this;e.forEach(function(e){var t=i.getBoxByGraphicId(e.graphic_id);t&&i.removeElement(t);var r=i.getInstanceByGraphicId(e.graphic_id);r&&i.removeElement(r)}),this.graphicList.forEach(function(t,r,i){e.forEach(function(e){e.graphic_id===t.graphic_id&&i.splice(r,1)})}),this.updateToRemote(e,m.Action.Delete,1<e.length?m.ActionType.Multi:m.ActionType.Single)},h.prototype.clearSelected=function(){var t=this;Array.from(this.getElementChild(this.graphicsBoxConNode)).forEach(function(e){e.style.border=t.whiteboardStore.unSelectedBorderCss})},h.prototype.scrollToHandle=function(e,t,r){var i=this,n=Math.ceil(e*this.viewInfo.viewWidth),o=Math.ceil(t*this.viewInfo.viewHeight);this.emitScroll(e,t,r),(this.isScrollMode()||this.viewInfo.isScroll)&&(this.viewInfo.scrollTicking=!0,this.parentDom.scrollTo(n,o),setTimeout(function(){i.viewInfo.scrollTicking=!1},30)),r||(this.jumpPage(n,o,t),this.serviceHandle.actionCustomListener("viewScroll",this.getID(),e,t,this.viewInfo.page))},h.prototype.emitScroll=function(e,t,r){this.serviceHandle.loadCurrentGraphics(this.whiteboardID,e,t),r&&this.serviceHandle.scroll(this.whiteboardID,e,t)},h.prototype.jumpPage=function(e,t,r){var i;1<this.viewInfo.pageCount&&this.viewInfo.page<=this.viewInfo.pageCount&&(this.viewInfo.direction===f.Direction.Horizontal?(i=Math.min(Math.floor(e/this.viewInfo.viewportWidth)+1,this.viewInfo.pageCount),this.whiteboardNode.style.transform="translateX("+-e+"px)",this.updateViewInfo({offsetPageX:e,page:i})):this.hasFileInfo()?this.parentDom.dispatchEvent(new CustomEvent("pagechange_wb",{detail:{y:t,push:!0}})):(i=Math.min(Math.floor(t/this.viewInfo.viewportHeight)+1,this.viewInfo.pageCount),this.whiteboardNode.style.transform="translateY("+-t+"px)",this.updateViewInfo({offsetPageY:t,page:i})))},h.prototype.handlePageChangeListener=function(n){var o=this;n.addEventListener("pagechange_docs",function(e){var t,r,i;e&&e.detail&&e.detail.page&&(t=e.detail.y,r=e.detail.scroll,i=Number((t/o.viewInfo.viewHeight).toFixed(4)),o.viewInfo.page=e.detail.page,o.viewInfo.pageCount=o.viewInfo.pageCount||e.detail.pageCount,(o.viewInfo.isScroll=r)||(n.removeEventListener("scroll",o.scrollHandle),o.viewInfo.offsetPageY=t,o.whiteboardNode.style.transform="translateY("+-t+"px)",e.detail.notify&&o.scrollToHandle(0,i,!0)),o.serviceHandle.actionCustomListener("viewScroll",o.getID(),0,i,o.viewInfo.page))})},h.prototype.backAddHandle=function(e){e.type===m.ViewTool.Text?this.addTextareaGraphic(e,!0):this.drawGraphicsHandle(e),this.updateGraphicsBox(e),this.graphicList.push(e)},h.prototype.backRemoveHandle=function(e){this.removeGraphic(e.graphic_id)},h.prototype.backMoveHandle=function(e){var t=e.graphic_id,r=e.x,i=e.y;this.setDataToGraphicList(t,{x:r,y:i}),this.moveByOffset(t,r,i),this.updateGraphicsBox(e)},h.prototype.backUpdateHandle=function(e){var t,r,i,n,o,s,a,c=e.graphic_id,d=e.data,l=b.splitTextHandle(d).text,h=this.getInstanceByGraphicId(c);h&&(r=(t=this.getElementChild(h))[0],i=t[1],n=e.data,i.value=l,r.innerHTML=l,s=(o=h.getBoundingClientRect()).width,a=o.height,this.getBoxByGraphicId(c).style.cssText+="width:"+s+"px;height:"+a+"px;",this.setDataToGraphicList(c,{data:n}))},h.prototype.undoAndRedoHandle=function(e){var t=this;e.forEach(function(e){switch(e.action){case m.Action.Delete:t.backRemoveHandle(e);break;case m.Action.Create:t.backAddHandle(e);break;case m.Action.Move:t.backMoveHandle(e);break;case m.Action.Update:t.backUpdateHandle(e)}})},h.prototype.clearLocalHandle=function(){var t=this;this.graphicList.length=0,this.graphicsBoxConNode.innerHTML="",Array.from(this.getElementChild(this.graphicsConNode)).forEach(function(e){"svg"!==e.tagName?t.graphicsConNode.removeChild(e):t.removeElementChild(e)})},h.prototype.updateRemoteToLocal=function(e,t){var i=this;this.getOffsetData(),this.getScrollData(),e.forEach(function(t){var r=t.graphic_id,e=i.graphicList.some(function(e){return r===e.graphic_id&&(Object.assign(e,t),!0)});e||i.graphicList.push(t),t.type===m.ViewTool.Text?e&&document.getElementById(""+i.whiteboardStore.reservedKey.graphicsIdPrefix+r)?i.updateTextareaGraphic(t):i.addTextareaGraphic(t,!0):i.drawGraphicsHandle(t),i.updateGraphicsBox(t)}),t&&t.forEach(function(e){i.removeGraphic(e)})},h.prototype.updateToRemote=function(e,t,r){var i=this,n=b.transGraphicsData(e,t,r);this.serviceHandle.updateToRemote(this.whiteboardID,n,function(e){i.undoAndRedoHandle(e)})},h.prototype.enable=function(e){return this._enable=!!e,!0},h.prototype.isEnable=function(){return!!this._enable},h.prototype.clear=function(){var t=this;this.serviceHandle.clearView(this.whiteboardID,function(){try{t.clearLocalHandle()}catch(e){t.serviceHandle.actionCustomListener("error",t.serviceHandle.whiteboardError.transError(t.serviceHandle.whiteboardError.CODES.ZegoWhiteboardViewErrorClearFail))}},function(){t.serviceHandle.actionCustomListener("error",t.serviceHandle.whiteboardError.transError(t.serviceHandle.whiteboardError.CODES.ZegoWhiteboardViewErrorClearFail))})},h.prototype.scroll=function(e,t){if(isNaN(+e)||isNaN(+t)){var r=this.serviceHandle.whiteboardError.transError(this.serviceHandle.whiteboardError.CODES.ZegoWhiteboardViewErrorParamInvalid,"参数错误：horizontalPercent、verticalPercent取值为0~1");return this.serviceHandle.actionCustomListener("error",r),!1}var i,n,o;return 1<this.viewInfo.pageCount&&0<this.viewInfo.page&&!this.hasFileInfo()&&(this.viewInfo.direction===f.Direction.Horizontal?(e<0&&(e=0),1<e&&(e=1),i=e*this.viewInfo.viewWidth|0,(o=Math.round(i/this.viewInfo.viewportWidth)+1)<=this.viewInfo.pageCount&&(this.whiteboardNode.style.transform="translateX("+-i+"px)",this.updateViewInfo({offsetPageX:i,page:o}),this.scrollToHandle(Number(e.toFixed(4)),0,!0))):(t<0&&(t=0),1<t&&(t=1),n=t*this.viewInfo.viewHeight|0,(o=Math.round(n/this.viewInfo.viewportHeight)+1)<=this.viewInfo.pageCount&&(this.whiteboardNode.style.transform="translateY("+-n+"px)",this.updateViewInfo({offsetPageY:n,page:o}),this.scrollToHandle(0,Number(t.toFixed(4)),!0)))),!0},h.prototype.getCurrentScrollPercent=function(){return this.serviceHandle.getScrollPercent(this.whiteboardID)},h.prototype.undo=function(){var t=this;this.serviceHandle.undo(this.whiteboardID,function(e){t.undoAndRedoHandle(e)},function(e){t.undoAndRedoHandle(e)})},h.prototype.redo=function(){var t=this;this.serviceHandle.redo(this.whiteboardID,function(e){t.undoAndRedoHandle(e)},function(e){t.undoAndRedoHandle(e)})},h.prototype.getAspectRatio=function(){return this.serviceHandle.getAspectRatio(this.whiteboardID)},h.prototype.getFileInfo=function(){var e=this.serviceHandle.getFileInfo(this.whiteboardID);return e?JSON.parse(JSON.stringify(e)):e},h.prototype.getID=function(){return this.whiteboardID},h.prototype.getName=function(){return this.serviceHandle.getModName(this.whiteboardID)},h.prototype.getRoomID=function(){return this.serviceHandle.getRoomID(this.whiteboardID)},h.prototype.getPageCount=function(){return this.viewInfo.pageCount||1},h.prototype.setBackgroundColor=function(e){if(b.checkColor(e))return this.whiteboardStore.basicState.bgColor=e,this.graphicsBgContainerNode.style.backgroundColor=e,!0;var t=this.serviceHandle.whiteboardError.transError(this.serviceHandle.whiteboardError.CODES.ZegoWhiteboardViewErrorParamInvalid,"参数错误：color仅支持16进制、rgba");return this.serviceHandle.actionCustomListener("error",t),!1},h.prototype.getBackgroundColor=function(){return this.whiteboardStore.basicState.bgColor},h.prototype.setToolType=function(e){if(-1!==Object.keys(m.ViewTool).indexOf(""+e))return this.whiteboardStore.basicState.type===e||(this.whiteboardStore.basicState.type=e,this.updateBindEvents(),this.clearSelected()),!0;var t=this.serviceHandle.whiteboardError.transError(this.serviceHandle.whiteboardError.CODES.ZegoWhiteboardViewErrorParamInvalid,"参数错误：工具类型为1:path 涂鸦，2:text 文本框，4:line 线段，8:rect 矩形，16:ellipse 椭圆，32: selector 选择");return this.serviceHandle.actionCustomListener("error",t),!1},h.prototype.getToolType=function(){return this.whiteboardStore.basicState.type},h.prototype.setBrushColor=function(e){if(b.checkColor(e))return this.whiteboardStore.basicState.color=e,!0;var t=this.serviceHandle.whiteboardError.transError(this.serviceHandle.whiteboardError.CODES.ZegoWhiteboardViewErrorParamInvalid,"参数错误：color仅支持16进制、rgba");return this.serviceHandle.actionCustomListener("error",t),!1},h.prototype.getBrushColor=function(){return this.whiteboardStore.basicState.color},h.prototype.setBrushSize=function(e){if(b.checkBrushSize(e))return this.whiteboardStore.basicState.size=e,!0;var t=this.serviceHandle.whiteboardError.transError(this.serviceHandle.whiteboardError.CODES.ZegoWhiteboardViewErrorParamInvalid,"参数错误：画笔粗细为1~100内的整数");return this.serviceHandle.actionCustomListener("error",t),!1},h.prototype.getBrushSize=function(){return this.whiteboardStore.basicState.size},h.prototype.setTextSize=function(e){if(b.checkTextSize(e))return this.whiteboardStore.basicState.fontSize=e,!0;var t=this.serviceHandle.whiteboardError.transError(this.serviceHandle.whiteboardError.CODES.ZegoWhiteboardViewErrorParamInvalid,"参数错误：文本大小为12~100内的整数");return this.serviceHandle.actionCustomListener("error",t),!1},h.prototype.getTextSize=function(){return this.whiteboardStore.basicState.fontSize},h.prototype.getPage=function(){return this.viewInfo.page||1},h.prototype.setScrollMode=function(e){this.whiteboardStore.basicState.scroll=e},h.prototype.previousPage=function(){var e,t;1<this.viewInfo.pageCount&&1<this.viewInfo.page&&!this.hasFileInfo()&&(this.viewInfo.direction===f.Direction.Horizontal?(e=(this.viewInfo.page-2)*this.viewInfo.viewportWidth,this.whiteboardNode.style.transform="translateX("+-e+"px)",this.updateViewInfo({offsetPageX:e,page:this.viewInfo.page-1}),this.scrollToHandle(Number((e/this.viewInfo.viewWidth).toFixed(4)),0,!0)):(t=(this.viewInfo.page-2)*this.viewInfo.viewportHeight,this.whiteboardNode.style.transform="translateY("+-t+"px)",this.updateViewInfo({offsetPageY:t,page:this.viewInfo.page-1}),this.scrollToHandle(0,Number((t/this.viewInfo.viewHeight).toFixed(4)),!0)))},h.prototype.nextPage=function(){var e,t;1<this.viewInfo.pageCount&&this.viewInfo.page<this.viewInfo.pageCount&&!this.hasFileInfo()&&(this.viewInfo.direction===f.Direction.Horizontal?(e=this.viewInfo.page*this.viewInfo.viewportWidth,this.whiteboardNode.style.transform="translateX("+-e+"px)",this.updateViewInfo({offsetPageX:e,page:this.viewInfo.page+1}),this.scrollToHandle(Number((e/this.viewInfo.viewWidth).toFixed(4)),0,!0)):(t=this.viewInfo.page*this.viewInfo.viewportHeight,this.whiteboardNode.style.transform="translateY("+-t+"px)",this.updateViewInfo({offsetPageY:t,page:this.viewInfo.page+1}),this.scrollToHandle(0,Number((t/this.viewInfo.viewHeight).toFixed(4)),!0)))},h);function h(e,t,r){var a=o.call(this)||this;return a._enable=!0,a._activited=!1,a.viewInfo={},a.graphicList=[],a.mousePointList=[],a.flowData={isWillMove:!1,isBlur:!1,noMoveUp:!0,isAlreadyMove:!1,moving:!1},a.scrollHandle=function(o){a.viewInfo.scrollTicking||(requestAnimationFrame(function(){var e,t=o.target,r=t.scrollTop,i=t.scrollLeft,n=a.viewInfo.direction===f.Direction.Horizontal?(e=Number((i/a.viewInfo.viewWidth).toFixed(4)),0):(e=0,Number((r/a.viewInfo.viewHeight).toFixed(4)));a.emitScroll(e,n,!0),a.viewInfo.scrollTicking=!1}),a.viewInfo.scrollTicking=!0)},a.mouseleaveHandle=function(){a._enable&&(a.whiteboardNode.removeEventListener(a.viewEvent.moveEventName,a.bindEvents.mousemoveHandle),a.flowData.moving&&(-1<[m.ViewTool.Pen,m.ViewTool.Line,m.ViewTool.Rect,m.ViewTool.Ellipse].indexOf(a.whiteboardStore.basicState.type)?a.drawSvgMouseupHandle():a.whiteboardStore.basicState.type===m.ViewTool.Selector&&a.selectMouseupHandle()))},a.mousemoveHandle=function(e){if(a._enable){if(a.viewEvent.platform===m.Platform.Mobile){if(a.checkMultipoint(e))return;e.preventDefault()}a.updateFlowData({noMoveUp:!1});var t=a.getMouseChangedPoint(e),r=t.clientX,i=t.clientY;a.flowData.isWillMove?(a.updateMousePointList([r,i]),a.updateGraphicListOnMoving(),a.updateFlowData({isAlreadyMove:!0}),a.moveGraphics()):(a.updateGraphicsData([r,i]),a.drawGraphicsHandle(a.protoGraphic)),a.updateFlowData({moving:!0})}},a.mousedownHandle=function(e){if(a._enable){if(a.viewEvent.platform===m.Platform.Mobile){if(a.checkMultipoint(e))return;e.preventDefault()}a.updateFlowData();var t,r,i,n,o,s=a.whiteboardStore.basicState.type;a.getOffsetData(),a.getScrollData(),s!==m.ViewTool.Text&&s!==m.ViewTool.Eraser&&(s===m.ViewTool.Selector&&((t=a.getMouseCoverGraphics(e))?(r=t.graphic_id,a.graphicList.filter(function(e){return!0===e.selected}).length<=1&&a.graphicList.forEach(function(e){var t=a.getBoxByGraphicId(e.graphic_id);e.graphic_id===r?(e.selected&&e.type===m.ViewTool.Text&&a.updateFlowData({noMoveUp:e.graphic_id}),e.selected=!0,t&&(t.style.border=a.whiteboardStore.selectedBorderCss)):(e.selected=!1,t&&(t.style.border=a.whiteboardStore.unSelectedBorderCss))}),a.updateFlowData({isWillMove:!0})):a.graphicList.forEach(function(e){e.selected=!1;var t=a.getBoxByGraphicId(e.graphic_id);t&&(t.style.border=a.whiteboardStore.unSelectedBorderCss)})),n=(i=a.getMouseStartPoint(e)).clientX,o=i.clientY,a.updateMousePointList([n,o]),a.updateProtoGraphic(c(c({graphic_id:b.createGraphicId()},a.whiteboardStore.basicState),{x:0,y:0,px:0,py:0,data:[n,o]})),a.whiteboardNode.addEventListener(a.viewEvent.moveEventName,a.bindEvents.mousemoveHandle))}},a.eraserMousemoveHandle=function(e){var t,r;a._enable&&a.whiteboardStore.basicState.type===m.ViewTool.Eraser&&((t=a.getMouseCoverGraphics(e))?(r=t.graphic_id,a.graphicList.forEach(function(e){var t=a.getBoxByGraphicId(e.graphic_id);e.graphic_id===r?(e.selected=!0,t&&(t.style.border=a.whiteboardStore.selectedBorderCss)):(e.selected=!1,t&&(t.style.border=a.whiteboardStore.unSelectedBorderCss))})):a.graphicList.forEach(function(e){e.selected=!1;var t=a.getBoxByGraphicId(e.graphic_id);t&&(t.style.border=a.whiteboardStore.unSelectedBorderCss)}))},a.bindEvents={mousemoveHandle:a.mousemoveHandle,mouseleaveHandle:a.mouseleaveHandle,mouseupHandle:console.log,mousedownHandle:a.mousedownHandle,eraserMousemoveHandle:a.eraserMousemoveHandle},a.whiteboardID=e,a.whiteboardStore=t,a.serviceHandle=r,a}t.WhiteboardViewMod=l},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WhiteboardView=void 0;function i(){}t.WhiteboardView=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WhiteboardViewEvent=void 0;var i=(n.prototype.bindEvent=function(e,t){},n.prototype.removeEvent=function(e,t){},n);function n(){this.eventList={},navigator.userAgent.match(/Android|BlackBerry|iPhone|iPad|iPod|Opera Mini|IEMobile/i)?(this.platform=2,this.downEventName="touchstart",this.upEventName="touchend",this.moveEventName="touchmove"):(this.platform=1,this.downEventName="mousedown",this.upEventName="mouseup",this.moveEventName="mousemove")}t.WhiteboardViewEvent=i},function(t,r,i){var o;!function(){"use strict";function n(e,t){var r=e.length-1,i=[e[0]];return function e(t,r,i,n,o){for(var s,a,c,d,l,h,u,p,g,f=n,m=r+1;m<i;m++){var v=(a=t[m],c=t[r],d=t[i],g=p=u=h=l=void 0,h=c.x,u=c.y,p=d.x-h,g=d.y-u,0===p&&0===g||(1<(l=((a.x-h)*p+(a.y-u)*g)/(p*p+g*g))?(h=d.x,u=d.y):0<l&&(h+=p*l,u+=g*l)),(p=a.x-h)*p+(g=a.y-u)*g);f<v&&(s=m,f=v)}n<f&&(1<s-r&&e(t,r,s,n,o),o.push(t[s]),1<i-s&&e(t,s,i,n,o))}(e,0,r,t,i),i.push(e[r]),i}function e(e,t,r){if(e.length<=2)return e;var i=void 0!==t?t*t:1;return e=n(e=r?e:function(e,t){for(var r,i,n,o,s,a=e[0],c=[a],d=1,l=e.length;d<l;d++)r=e[d],n=a,s=o=void 0,o=(i=r).x-n.x,s=i.y-n.y,t<o*o+s*s&&(c.push(r),a=r);return a!==r&&c.push(r),c}(e,i),i)}void 0===(o=function(){return e}.call(r,i,r,t))||(t.exports=o)}()},function(e,t,r){e.exports=function(e,t){for(var r,i,n=3&e.length,o=e.length-n,s=t,a=3432918353,c=461845907,d=0;d<o;)i=255&e.charCodeAt(d)|(255&e.charCodeAt(++d))<<8|(255&e.charCodeAt(++d))<<16|(255&e.charCodeAt(++d))<<24,++d,s=27492+(65535&(r=5*(65535&(s=(s^=i=(65535&(i=(i=(65535&i)*a+(((i>>>16)*a&65535)<<16)&4294967295)<<15|i>>>17))*c+(((i>>>16)*c&65535)<<16)&4294967295)<<13|s>>>19))+((5*(s>>>16)&65535)<<16)&4294967295))+((58964+(r>>>16)&65535)<<16);switch(i=0,n){case 3:i^=(255&e.charCodeAt(d+2))<<16;case 2:i^=(255&e.charCodeAt(d+1))<<8;case 1:s^=i=(65535&(i=(i=(65535&(i^=255&e.charCodeAt(d)))*a+(((i>>>16)*a&65535)<<16)&4294967295)<<15|i>>>17))*c+(((i>>>16)*c&65535)<<16)&4294967295}return s^=e.length,s=2246822507*(65535&(s^=s>>>16))+((2246822507*(s>>>16)&65535)<<16)&4294967295,s=3266489909*(65535&(s^=s>>>13))+((3266489909*(s>>>16)&65535)<<16)&4294967295,(s^=s>>>16)>>>0}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WhiteboardStore=void 0;function i(){this.reservedKey={graphicsBgContainerIdPrefix:"zego-graphics-bg-container",graphicsContainerIdPrefix:"zego-graphics-container",graphicsSvgIdPrefix:"zego-svg",boxContainerIdPrefix:"zego-box-container",graphicsIdPrefix:"zego-graphics",textareaConIdPrefix:"zego-textarea",graphicsBoxIdPrefix:"zego-graphics-box",whiteboardPrefix:"zego-whiteboard",whiteboardContainerPrefix:"zego-whiteboard-con"},this.basicState={type:n.ViewTool.Pen,size:6,fontSize:24,color:"#0044FF",bgColor:"rgb(241, 243, 244)",scroll:n.ScrollMode.Page},this.boxPadding=0,this.boxBorderWidth=2,this.selectedBorderCss="2px solid rgba(183,186,194,1)",this.unSelectedBorderCss="2px solid transparent",this.maxlength=50}var n=r(2);t.WhiteboardStore=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WhiteboardError=void 0;var i=(n.prototype.transError=function(e,t){var r=this.viewCodeMap[e],i=this.sdkCodeMap[e];return i&&(r=this.viewCodeMap[i]),r?{code:r,msg:t=t||this.interfaceCodeData[r]}:{code:e,msg:t=t||this.interfaceCodeData[e]||""}},n);function n(){this.CODES={ZegoWhiteboardViewErrorInternal:3000001,ZegoWhiteboardViewErrorParamInvalid:3000002,ZegoWhiteboardViewErrorNetworkTimeout:3000003,ZegoWhiteboardViewErrorNetworkDisconnect:3000004,ZegoWhiteboardViewErrorInvalidRsp:3000005,ZegoWhiteboardViewErrorRequestTooMany:3000006,ZegoWhiteboardViewErrorNoLoginRoom:3010001,ZegoWhiteboardViewErrorUserNotExist:3010002,ZegoWhiteboardViewErrorViewNotExist:3020001,ZegoWhiteboardViewErrorViewCreateFail:3020002,ZegoWhiteboardViewErrorViewModifyFail:3020003,ZegoWhiteboardViewErrorViewNameLimit:3020004,ZegoWhiteboardViewErrorViewParentNotExist:3020005,ZegoWhiteboardViewErrorViewNumLimit:3020006,ZegoWhiteboardViewErrorGraphicNotExist:3030001,ZegoWhiteboardViewErrorGraphicCreateFail:3030002,ZegoWhiteboardViewErrorGraphicModifyFail:3030003,ZegoWhiteboardViewErrorGraphicUnableDraw:3030004,ZegoWhiteboardViewErrorGraphicDataLimit:3030005,ZegoWhiteboardViewErrorGraphicNumLimit:3030006,ZegoWhiteboardViewErrorGraphicTextLimit:3030007,ZegoWhiteboardViewErrorInitFail:3040001,ZegoWhiteboardViewErrorGetListFail:3040002,ZegoWhiteboardViewErrorCreateFail:3040003,ZegoWhiteboardViewErrorDestroyFail:3040004,ZegoWhiteboardViewErrorAttachFail:3040005,ZegoWhiteboardViewErrorClearFail:3040006,ZegoWhiteboardViewErrorScrollFail:3040007,ZegoWhiteboardViewErrorUndoFail:3040008,ZegoWhiteboardViewErrorRedoFail:3040009},this.interfaceCodeData={3000001:"内部错误",3000002:"参数错误",3000003:"网络超时",3000004:"网络断开",3000005:"网络回包错误",3000006:"请求过于频繁",3010001:"未登录房间",3010002:"用户不存在",3020001:"白板view不存在",3020002:"创建白板view失败",3020003:"修改白板view失败",3020004:"白板view名称过长",3020005:"白板view的parent不存在",3020006:"超过白板最大数量限制",3030001:"图元不存在",3030002:"创建图元错误",3030003:"修改图元错误",3030004:"未开启绘制",3030005:"单个图元数据大小超过限制",3030006:"超过图元最大数量限制",3030007:"文本字数超过上限",3040001:"初始化失败",3040002:"拉取白板view列表失败",3040003:"创建白板view失败",3040004:"销毁白板view失败",3040005:"attach白板view失败",3040006:"清空白板view失败",3040007:"滚动白板view失败",3040008:"撤销操作失败",3040009:"重做操作失败"},this.sdkCodeMap={1003:112001003,1014:112001014,1101:112001101,1102:112001102,1104:112001104,1114:112001114,1212:112001212,1201:112001201,1202:112001202,1219:112001219,1217:112001217,1222:112001222,1223:112001223},this.viewCodeMap={10001e3:3000001,10001001:3000002,111001002:3000003,111001001:3000004,60003001:3000005,111101001:3000006,112001003:3010001,112001014:3010002,112001101:3020001,112001102:3020002,112001104:3020003,112001114:3020006,112001212:3030002,112001201:3030003,112001202:3030003,112001219:3030003,112001217:3030005,112001222:3030005,112001223:3030006}}t.WhiteboardError=i},function(e,t,r){"use strict";var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)},s=this&&this.__awaiter||function(e,s,a,c){return new(a=a||Promise)(function(r,t){function i(e){try{o(c.next(e))}catch(e){t(e)}}function n(e){try{o(c.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?r(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(i,n)}o((c=c.apply(e,s||[])).next())})},u=this&&this.__generator||function(r,i){var n,o,s,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=i.call(r,a)}catch(e){t=[6,e],o=0}finally{n=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.WhiteboardService=void 0;var c,a,h,d,p,l,g=r(74),T=r(2),E=r(22),f=r(21);(a=c=c||{})[a.Initiative=1]="Initiative",a[a.Inner=2]="Inner",(d=h=h||{})[d.InProgress=1]="InProgress",d[d.Pending=2]="Pending",(l=p=p||{})[l.success=1]="success",l[l.error=2]="error";var m,v=(m=g.WhiteboardServiceBase,n(y,m),y.prototype.reverseGraphicList=function(e){var t=JSON.parse(JSON.stringify(e)),r=t[0].action;return t.forEach(function(e){switch(r){case T.Action.Create:e.action=T.Action.Delete;break;case T.Action.Delete:e.action=T.Action.Create;break;case T.Action.Move:e.x=e.px,e.y=e.py;break;case T.Action.Update:e.data=e.oldData}}),t},y.prototype.transModInfo=function(e,t){var r,i,n={room_id:""},o={ar_w:1,ar_h:1,x:0,y:0,w:0,h:0,z:0};return e&&((i=(r=JSON.parse(e)).file_info)&&(r.file_info={fileID:i.file_id,fileName:i.file_name,fileType:+i.file_type,authKey:i.auth_key}),n=r),t&&(o=JSON.parse(t)),{modContent:n,modPos:o}},y.prototype.createModInfo=function(e){var t,r,i,n,o,s={room_id:e.roomID};return e.fileInfo&&(r=(t=e.fileInfo).fileID,i=t.fileName,n=t.fileType,o=t.authKey,s.file_info={file_id:r,file_name:i,file_type:n,auth_key:o}),e.pageCount&&(s.whiteboard_page_count=e.pageCount),{modContent:s,modPos:{x:0,y:0,w:0,h:0,z:0,ar_w:e.aspectWidth,ar_h:e.aspectHeight}}},y.prototype.getModHeader=function(){return{sdk_version:1,id_name:this.stateCenter.idName}},y.prototype.getModInfo=function(e){var i=this;return new Promise(function(t,r){i.queueWSCmdHandler("/eduv1/get_mod","/eduv1/get_mod",{header:i.getModHeader(),body:JSON.stringify({mod_id_list:e})},function(e){i.handleGetModInfoRsp(e,t,r)})})},y.prototype.posToPageNum=function(e,t,r,i,n,o,s){var a=r.cx,c=r.cy,d=0;return a&&c&&(i+=o,n+=s,d=99<(d=t-1<(d=e===f.Direction.Horizontal?i<=0?0:Math.floor(i/a):n<=0?0:Math.floor(n/c))?t-1:d)?99:d),d},y.prototype.mapPageNumList=function(e){for(var t=[],r=Math.min.apply(Math,e),i=Math.max.apply(Math,e),n=r;n<=i;n++)t.push(n);return t},y.prototype.judgeGraphicPage=function(e,t){var i=this,r=this.getMap(e),n=r.innerDirection,o=r.innerPageSize,s=r.innerPageCount,a=[],c=t.type,d=t.data,l=t.x,h=t.y;switch(c){case T.ViewTool.Text:var u=E.splitTextHandle(d),p=u.beginX,g=u.beginY,f=this.posToPageNum(n,s,o,Number(p),Number(g),l,h),a=this.mapPageNumList([f]);break;case T.ViewTool.Pen:var m=[];d.forEach(function(e,t,r){t%2||m.push(i.posToPageNum(n,s,o,r[t],r[t+1],l,h))}),a=this.mapPageNumList(m);break;case T.ViewTool.Line:case T.ViewTool.Rect:case T.ViewTool.Ellipse:var v=d[0],y=d[1],b=d[2],S=d[3],C=this.posToPageNum(n,s,o,v,y,l,h),_=this.posToPageNum(n,s,o,b,S,l,h);a=this.mapPageNumList([C,_])}return a},y.prototype.checkProtoGraphic=function(e){var t=e.action,r=e.action_type,i=e.graphic_id,n=e.type,o=e.data,s=e.color,a=e.size,c=e.x,d=e.y,l={action:t,action_type:r,graphic_id:i,type:n};switch(t){case T.Action.Create:case T.Action.Update:l.data=o,l.color=s,l.size=a,l.x=c,l.y=d;break;case T.Action.Delete:break;case T.Action.Move:l.x=c,l.y=d}return l},y.prototype.mapDrawPages=function(t,e){var i=this,r=JSON.parse(JSON.stringify(e)),n=this.getMap(t),o=n.graphicListSeqs,s=[],a=[];r.forEach(function(r){var e=i.judgeGraphicPage(t,r);delete r.oldData,E.transColor(r,!1),E.calHandle(r,n.viewWidth,n.viewportWidth,i.calStandard,!1),E.transData(r,!1),r=i.checkProtoGraphic(r),e.forEach(function(e){a.includes(e)||a.push(e);var t=o[e];s.push({page:e,graphic_list_seq:t,draw_list:[r]})})});var c=[];return a.forEach(function(t){var r={page:t,draw_list:[]};s.forEach(function(e){e.page===t&&(r.draw_list=r.draw_list.concat(e.draw_list),r.graphic_list_seq=e.graphic_list_seq)}),c.push(r)}),c},y.prototype.splitPage=function(e,t,r){var i=this.getMap(e);if(i&&t&&r){var n=1,o=0,s=0;r<=t?(o=s=r,100<(n=Math.ceil(t/r))&&(o=Math.ceil(t/99),n=100),i.innerDirection=f.Direction.Horizontal):(s=o=t,100<(n=Math.ceil(r/t))&&(s=Math.ceil(r/99),n=100),i.innerDirection=f.Direction.Vertical),i.innerPageCount=n;for(var a=0;a<n;a++)i.graphicListSeqs[a]=0,i.pullMarks[a]=!1;i.innerPageSize.cx=o,i.innerPageSize.cy=s}},y.prototype.getRoom=function(){this.queueWSCmdHandler("/eduv1/get_room","/eduv1/get_room",{header:this.getModHeader(),body:""},void 0)},y.prototype.actionListener=function(e){for(var t,r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];this.listenerList[e]&&(t=this.listenerList)[e].apply(t,r)},y.prototype.bindListener=function(e,t){this.listenerList[e]=t},y.prototype.updateMap=function(e){var t,r=this.getMap(e.whiteboardID);r?((t=e.modPropSeq)&&Object.assign(r.modPropSeq,t),delete e.modPropSeq,Object.assign(r,e)):this.modIdMapData[e.whiteboardID]=o({graphicListSeqs:{0:0},pullMarks:{0:!1},modSeq:0,undoList:[],redoList:[],viewWidth:0,viewHeight:0,viewportWidth:0,viewportHeight:0,innerPageCount:1,innerDirection:f.Direction.Horizontal,innerPageSize:{cx:0,cy:0},modType:1,modSubtype:1,operateTimes:0,inProgress:!1,sendSwitch:!0,modifyModTaskList:[]},e)},y.prototype.getMap=function(e){return this.modIdMapData[e]},y.prototype.deleteMap=function(e){delete this.modIdMapData[e]},y.prototype.getModPropSeq=function(e){return this.modIdMapData[e].modPropSeq},y.prototype.updateMapByMod=function(e){var t=e.mod_content,r=e.mod_pos,i=this.transModInfo(t,r),n=i.modContent,o=i.modPos;this.updateMap({whiteboardID:e.mod_id,name:e.mod_title,aspectWidth:o.ar_w,aspectHeight:o.ar_h,roomID:n.room_id,fileInfo:n.file_info,horizontalPercent:e.mod_horizontal_percent,verticalPercent:e.mod_vertical_percent,modType:e.mod_type,modSubtype:e.mod_subtype,modSeq:e.mod_seq,outPageCount:n.whiteboard_page_count,modPropSeq:{mod_title:e.mod_seq,mod_type:e.mod_seq,mod_subtype:e.mod_seq,mod_pos:e.mod_seq,mod_status:e.mod_seq,mod_content:e.mod_seq,mod_extra:e.mod_seq,mod_reserve:e.mod_seq,mod_delete_flag:e.mod_seq,mod_horizontal_percent:e.mod_seq,mod_vertical_percent:e.mod_seq}})},y.prototype.updateMapByModifyModOption=function(e,t,r){var i=e.mod_id,n=e.mod_title,o=e.mod_horizontal_percent,s=e.mod_vertical_percent,a=e.is_modify_mod_horizontal_percent,c=e.is_modify_mod_vertical_percent,d=e.is_modify_mod_title,l=this.getModPropSeq(i),h=l.mod_horizontal_percent,u=l.mod_vertical_percent,p=l.mod_title,g=this.getMap(i),f=g.horizontalPercent,m=g.verticalPercent;a&&h<t&&(this.updateMap({whiteboardID:i,horizontalPercent:o,modPropSeq:{mod_horizontal_percent:t}}),r&&f!==o&&this.pushScrollHandle(i,o,0)),c&&u<t&&(this.updateMap({whiteboardID:i,verticalPercent:s,modPropSeq:{mod_vertical_percent:t}}),r&&m!==s&&this.pushScrollHandle(i,0,s)),d&&p<t&&this.updateMap({whiteboardID:i,name:n,modPropSeq:{mod_title:t}})},y.prototype.updateMapByGraphicListSeqs=function(e,t){var r=this.getMap(e).graphicListSeqs,i=t.graphicListSeqs;t.pages.forEach(function(e,t){r[e]=i[t]})},y.prototype.getPopTaskIndex=function(e){var r=e.length-1,i=0;return e.forEach(function(e,t){i<e.cmdSeq&&(r=t,i=e.cmdSeq)}),r},y.prototype.getUndoHandle=function(e){var t=this.modIdMapData[e];return t.undoList[this.getPopTaskIndex(t.undoList)]},y.prototype.addUndoHandle=function(e,t){this.modIdMapData[e].undoList.push({cmdSeq:this.socketCenter.cmdSeq+1,task:t})},y.prototype.deleteUndoHandle=function(e){var t=this.modIdMapData[e];t.undoList.splice(this.getPopTaskIndex(t.undoList),1)},y.prototype.getRedoHandle=function(e){var t=this.modIdMapData[e];return t.redoList[this.getPopTaskIndex(t.redoList)]},y.prototype.addRedoHandle=function(e,t){this.modIdMapData[e].redoList.push({cmdSeq:this.socketCenter.cmdSeq+1,task:t})},y.prototype.deleteRedoHandle=function(e){var t=this.modIdMapData[e];t.redoList.splice(this.getPopTaskIndex(t.redoList),1)},y.prototype.setInProgress=function(e,t){this.modIdMapData[e].inProgress=t},y.prototype.getInProgress=function(e){return this.modIdMapData[e].inProgress},y.prototype.setSendSwitch=function(e,t){this.modIdMapData[e].sendSwitch=t},y.prototype.getSendSwitch=function(e){var t=this.modIdMapData[e];return!t||t.sendSwitch},y.prototype.clearPullMarks=function(e){var r=this,t=e?[e]:Object.keys(this.modIdMapData);Object.values(t).forEach(function(e){var t=r.modIdMapData[e];Object.keys(t.pullMarks).forEach(function(e){t.pullMarks[+e]=!1})})},y.prototype.updateModifyModTaskList=function(e){var t,r=e.data.mod_id,i=this.getMap(r),n=e.status,o=e.push;n===h.InProgress?i.modifyModTaskList.splice(0,i.modifyModTaskList.length,e):o||-1===(t=i.modifyModTaskList.findIndex(function(e){return e.push===o&&e.status===h.Pending}))?i.modifyModTaskList.push(e):Object.assign(i.modifyModTaskList[t].data,e.data)},y.prototype.modifyModSendBefore=function(e){var t=e.mod_id,r=this.getSendSwitch(t);this.setSendSwitch(t,!1);var i={data:e,push:!1,status:r?h.InProgress:h.Pending};return this.updateModifyModTaskList(i),r},y.prototype.cachePushModifyModTaskHandle=function(e){var n=this;e.forEach(function(e){var t=e.pushModSeq,r=e.data,i=r.mod_id;n.getMap(i).modSeq<t&&n.updateMap({modSeq:t,whiteboardID:i}),n.updateMapByModifyModOption(r,t,!0)})},y.prototype.modifyModRspAfter=function(e,t){var r=t.modifyModOption,i=t.success,n=t.error,o=t.errorData,s=r.mod_id,a=this.getMap(s).modifyModTaskList,c=a.filter(function(e){return!e.push&&e.status===h.Pending})[0];this.cachePushModifyModTaskHandle(a.filter(function(e){return e.push})),c?(this.setSendSwitch(s,!0),this.setMod(c.data,i,n)):(1===e?i(s):n(o,this.getOldModInfoByModifyModOption(r)),this.setSendSwitch(s,!0))},y.prototype.getOldModInfoByModifyModOption=function(t){var r={};return Object.keys(t).forEach(function(e){e.includes("mod_id")||e.includes("is_modify_mod")||(r[e]=t[e])}),r},y.prototype.checkScroll=function(e,t,r){var i=this.getMap(e);if(i){var n=i.horizontalPercent,o=i.verticalPercent,s=Object.assign({mod_id:e},t!==n?{mod_horizontal_percent:t,is_modify_mod_horizontal_percent:!0}:null,r!==o?{mod_vertical_percent:r,is_modify_mod_vertical_percent:!0}:null);return!(!s.is_modify_mod_horizontal_percent&&!s.is_modify_mod_vertical_percent)&&s}return!1},y.prototype.getModName=function(e){var t=this.getMap(e);return t?t.name:""},y.prototype.getRoomID=function(e){var t=this.getMap(e);return t?t.roomID:""},y.prototype.getPageCount=function(e){var t=this.getMap(e);return t?t.outPageCount:void 0},y.prototype.setSize=function(e,t,r){var i=this.getMap(e);return!!(i&&t&&r)&&(i.viewHeight=r,i.viewWidth=t,this.splitPage(e,t,r),!0)},y.prototype.setViewportSize=function(e,t,r){var i=this.getMap(e);i&&t&&r&&(i.viewportHeight=r,i.viewportWidth=t)},y.prototype.undo=function(e,t,r){var i,n,o=this;this.getInProgress(e)||(i=this.getUndoHandle(e))&&(t(n=this.reverseGraphicList(i.task)),this.updateToRemoteHandle(e,n,function(){o.deleteUndoHandle(e),o.addRedoHandle(e,i.task)},function(){r(JSON.parse(JSON.stringify(i.task)))}))},y.prototype.redo=function(e,t,r){var i,n=this;this.getInProgress(e)||(i=this.getRedoHandle(e))&&(t(JSON.parse(JSON.stringify(i.task))),this.updateToRemoteHandle(e,i.task,function(){n.deleteRedoHandle(e),n.addUndoHandle(e,i.task)},function(){r(n.reverseGraphicList(i.task))}))},y.prototype.createMod=function(e,t,r){var i=this,n=this.createModInfo(e),o=n.modContent,s=n.modPos,a={mod_id:E.createGraphicId(),mod_title:e.name,mod_subtype:1,mod_type:1,mod_delete_flag:0,mod_content:JSON.stringify(o),mod_horizontal_percent:0,mod_vertical_percent:0,mod_pos:JSON.stringify(s)};this.queueWSCmdHandler("/eduv1/create_mod","/eduv1/create_mod",{header:this.getModHeader(),body:JSON.stringify(a)},function(e){return i.handleCreateModRsp(e,t,r)})},y.prototype.setMod=function(t,r,i){var n=this,e=t.mod_id;this.modifyModSendBefore(t)&&this.queueWSCmdHandler("/eduv1/modify_mod","/eduv1/modify_mod",{header:this.getModHeader(),body:JSON.stringify(o({mod_seq:this.getMap(e).modSeq},t))},function(e){n.handleSetModRsp(t,e,r,i)})},y.prototype.destroyMod=function(e,t,r){var i=this;this.queueWSCmdHandler("/eduv1/destroy_mod","/eduv1/destroy_mod",{header:this.getModHeader(),body:JSON.stringify({mod_id:e})},function(e){i.handleDestroyModRsp(e,t,r)})},y.prototype.clearView=function(t,r,i){var n=this;this.queueWSCmdHandler("/eduv1/clear_page_graphics","/eduv1/clear_page_graphics",{header:this.getModHeader(),body:JSON.stringify({mod_id:t})},function(e){n.handleClearRsp(e,t,r,i)})},y.prototype.updateToRemote=function(e,t,r){var i=this;this.updateToRemoteHandle(e,t,function(){i.addUndoHandle(e,t)},function(){var e=i.reverseGraphicList(t);r(e)})},y.prototype.updateToRemoteHandle=function(t,e,r,i){var n=this;this.setInProgress(t,!0),this.queueWSCmdHandler("/eduv1/draw_page_graphics","/eduv1/draw_page_graphics",{header:this.getModHeader(),body:JSON.stringify({mod_id:t,draw_pages:this.mapDrawPages(t,e)})},function(e){n.handleUpdateToRemoteRsp(t,e,r,i)})},y.prototype.getModList=function(t,r,i){var n=this;this.queueWSCmdHandler("/eduv1/get_mod_list","/eduv1/get_mod_list",{header:this.getModHeader(),body:JSON.stringify({mod_list_seq:0,limit:this.modLimit,marker:"",mod_type:1})},function(e){n.handleGetModListRsp(t,e,r,i)})},y.prototype.scroll=function(n,e,t,r,o){var i=this.checkScroll(n,e,t);i&&this.setMod(i,function(e){r&&r(e)},function(e,t){var r=t.mod_horizontal_percent,i=t.mod_vertical_percent;void 0===r&&void 0===i||o&&o(n,r,i)})},y.prototype.reload=function(){this.clearPullMarks(),this.getModList(c.Inner)},y.prototype.loadCurrentGraphics=function(e,t,r){for(var i=this.getCurrentPages(e,t,r),n=i.minPage,o=i.maxPage,s=this.getMap(e),a=[],c=n;c<=o;c++)s.pullMarks[c]||a.push(c);a.length&&this.getPageGraphicsList(e,a)},y.prototype.getScrollPercent=function(e){var t=this.getMap(e);return{horizontalPercent:t.horizontalPercent,verticalPercent:t.verticalPercent}},y.prototype.getAspectRatio=function(e){var t=this.getMap(e);return t.aspectWidth+":"+t.aspectHeight},y.prototype.getFileInfo=function(e){var t=this.getMap(e);return t&&t.fileInfo},y.prototype.getCurrentPages=function(e,t,r){var i,n=this.getMap(e),o=n.viewWidth,s=n.viewHeight,a=n.innerPageSize,c=n.viewportWidth,d=n.viewportHeight,l=n.innerDirection===f.Direction.Horizontal?(i=Math.floor(o*t/a.cx))+Math.floor(c/a.cx):(i=Math.floor(s*r/a.cy))+Math.floor(d/a.cy);return{minPage:i,maxPage:l=99<l?99:l}},y.prototype.getPageGraphicsList=function(t,e,r){var i,n=this;r||(i=this.getMap(t).graphicListSeqs,r=e.map(function(e){return i[e]})),this.queueWSCmdHandler("/eduv1/get_page_graphics","/eduv1/get_page_graphics",{header:this.getModHeader(),body:JSON.stringify({mod_id:t,pages:e,graphic_list_seqs:r,limit:this.graphicLimit})},function(e){n.handleGetPageGraphicsListRsp(t,e)})},y.prototype.onRemotePush=function(){var r=this;this.queueWSCmdHandler(null,"biz_channel",null,function(e,t){switch(t){case f.PushType.DrawPageGraphics:r.pushDrawPageGraphicsHandle(e);break;case f.PushType.SetMod:r.pushSetModHandle(e);break;case f.PushType.ClearPageGraphics:r.pushClearPageGraphicsHandle(e)}})},y.prototype.sendWbMessage=function(e,t,r,o){t&&"string"==typeof t?(e||this.socketCenter.registerRouter("push_biz_channel",function(e){var t=e.body.req_body;try{var r=JSON.parse(t).msg_body,i=JSON.parse(r),n=i.page_graphics?f.PushType.DrawPageGraphics:i.action_list?f.PushType.SetMod:f.PushType.ClearPageGraphics;o(i,n)}catch(e){o({},0)}}),e&&r&&"string"==typeof e&&this.socketCenter.sendMessage("biz_channel",r,function(e,t,r){try{(r=JSON.parse(r)).body=r.body?JSON.parse(r.body):{},o(r)}catch(e){}},function(e,t){try{o({header:{code:e.code,message:e.msg}})}catch(e){o({header:{code:3000001,message:"内部错误"}})}})):this.logger.error("zc.qh.0 rspCmd error")},y.prototype.queueWSCmdHandler=function(i,n,o,s){var a=this;return new Promise(function(r,t){try{var e={channel:"edu",cmd:i,req_body:JSON.stringify(o)};a.sendWbMessage(i,n,e,function(e,t){r(e,t),s&&s(e,t)})}catch(e){t(e)}})},y.prototype.handleCreateModRsp=function(d,l,h){return s(this,void 0,void 0,function(){var t,r,i,n,o,s,a,c;return u(this,function(e){switch(e.label){case 0:return t=d.header,r=d.body,i=t.code,n=t.message,0!==i?[3,2]:(o=r.mod_list_seq,s=r.mod_id,this.modListSeq=o,[4,this.getModInfo([s])]);case 1:return a=e.sent(),c=a[0],this.updateMapByMod(c),l(c.mod_id),[3,3];case 2:h(this.whiteboardError.transError(i,n)),e.label=3;case 3:return[2]}})})},y.prototype.handleGetModInfoRsp=function(e,t,r){var i=e.header,n=e.body,o=i.code,s=i.message;0===o?t(n.mod_list):r(this.whiteboardError.transError(o,s))},y.prototype.handleSetModRsp=function(e,t,r,i){var n,o,s,a=t.header,c=t.body,d=a.code,l=a.message;0===d?(n=c.mod_list_seq,o=c.mod_seq,s=c.mod_id,this.modListSeq=n,this.updateMap({whiteboardID:s,modSeq:o}),this.updateMapByModifyModOption(e,o,!1),this.modifyModRspAfter(p.success,{modifyModOption:e,success:r,error:i})):this.modifyModRspAfter(p.error,{modifyModOption:e,success:r,error:i,errorData:this.whiteboardError.transError(d,l)})},y.prototype.handleDestroyModRsp=function(e,t,r){var i,n,o=e.header,s=e.body,a=o.code,c=o.message;0===a?(i=s.mod_list_seq,n=s.mod_id,this.modListSeq=i,t(n),this.deleteMap(n)):r(this.whiteboardError.transError(a,c))},y.prototype.handleClearRsp=function(e,t,r,i){var n,o,s,a,c=e.header,d=e.body,l=c.code,h=c.message;0===l?(r(),n=d.graphic_list_seqs,o=d.pages,s=d.mod_id,this.updateMapByGraphicListSeqs(s,{pages:o,graphicListSeqs:n}),this.updateMap({whiteboardID:s,undoList:[],redoList:[],operateTimes:0})):(a=this.getMap(t))&&++a.operateTimes<5?this.clearView(t,r,i):i(this.whiteboardError.transError(l,h))},y.prototype.compareHandle=function(n,e,t){var o=this,s=Object.keys(this.modIdMapData),a=[];e.sort(function(e,t){return t.mod_create_time-e.mod_create_time}),e.forEach(function(e){var t=e.mod_id,r=e.mod_horizontal_percent,i=e.mod_vertical_percent;a.push(t),-1===s.indexOf(t)?n===c.Inner?o.pushAddMod(e):o.updateMapByMod(e):(o.updateMapByMod(e),o.pushScrollHandle(t,r,i))}),s.forEach(function(t){-1===e.findIndex(function(e){return e.mod_id===t})&&(n===c.Inner?o.pushRemovedMod(t):o.deleteMap(t))}),n===c.Initiative&&t&&t(a)},y.prototype.handleGetModListRsp=function(e,t,r,i){var n,o,s=t.header,a=t.body,c=s.code,d=s.message;0===c?(n=a.mod_list_seq,o=a.mod_list,this.modListSeq=n,this.compareHandle(e,o||[],r)):i&&i(this.whiteboardError.transError(c,d))},y.prototype.handleGetPageGraphicsListRsp=function(d,e){var t,l,h,u=this,r=e.header,i=e.body;0===r.code&&(t=i.pages,l=[],h=[],t.forEach(function(e){var t=e.graphic_list,r=e.del_graphic_id_list,i=e.page,n=e.ret_graphic_list_seq,o=e.svr_graphic_list_seq,t=t||[],r=r||[];u.updateMapByGraphicListSeqs(d,{pages:[i],graphicListSeqs:[o]});var s=u.getMap(d),a=s.viewWidth,c=s.viewportWidth;t.forEach(function(e){E.transData(e,!0),E.calHandle(e,a,c,u.calStandard,!0),E.transColor(e,!0)}),u.actionListener("getPageGraphicsList",d,t,r),o!==n&&0!==n?(l.push(i),h.push(n)):u.getMap(d).pullMarks[i]=!0}),l.length&&this.getPageGraphicsList(d,l,h))},y.prototype.handleUpdateToRemoteRsp=function(e,t,r,i){var n,o,s,a=t.header,c=t.body,d=a.code,l=a.message;this.setInProgress(e,!1),0===d?(n=c.graphic_list_seqs,o=c.mod_id,s=c.pages,this.updateMapByGraphicListSeqs(o,{pages:s,graphicListSeqs:n}),r()):i(this.whiteboardError.transError(d,l))},y.prototype.pushDrawPageGraphicsHandle=function(e){var t,o,s,a=this,r=e.page_graphics,c=e.mod_id,i=this.getMap(c);i&&i.viewWidth&&i.viewHeight&&(t=this.getMap(c),o=t.viewWidth,s=t.viewportWidth,r.forEach(function(e){var t=e.del_graphic_id_list,r=e.graphic_list,i=e.action_seq,n=e.page;r?r.forEach(function(e){E.transData(e,!0),E.calHandle(e,o,s,a.calStandard,!0),E.transColor(e,!0),a.updateMapByGraphicListSeqs(c,{pages:[n],graphicListSeqs:[i]})}):e.graphic_list=[],e.del_graphic_id_list=t||[]}),this.actionListener("pushDrawPageGraphics",c,r))},y.prototype.pushClearPageGraphicsHandle=function(e){var t=e.action_seqs,r=e.pages,i=e.mod_id,n=this.getMap(i);n&&n.viewWidth&&n.viewHeight&&(this.updateMapByGraphicListSeqs(i,{pages:r,graphicListSeqs:t}),this.actionListener("pushClearPageGraphics",i))},y.prototype.pushAddMod=function(e){var t=e.mod_id;this.updateMapByMod(e),this.actionListener("pushAddMod",t)},y.prototype.pushRemovedMod=function(e){this.deleteMap(e),this.actionListener("pushRemovedMod",e)},y.prototype.pushModifyMod=function(e){var t,r=e.mod_id,i=e.mod_seq,n=e.mod_title,o=e.mod_horizontal_percent,s=e.mod_vertical_percent,a=e.is_modify_mod_vertical_percent,c=e.is_modify_mod_horizontal_percent,d=e.is_modify_mod_title,l=this.getMap(r);l&&l.viewWidth&&l.viewHeight&&(this.getSendSwitch(r)?(i>l.modSeq&&this.updateMap({whiteboardID:r,modSeq:i}),this.updateMapByModifyModOption(e,i,!0)):(t=Object.assign({mod_id:r},a?{mod_horizontal_percent:o,is_modify_mod_vertical_percent:a}:null,c?{mod_vertical_percent:s,is_modify_mod_horizontal_percent:c}:null,d?{mod_title:n,is_modify_mod_title:d}:null),this.updateModifyModTaskList({status:h.Pending,data:t,push:!0,pushModSeq:i})))},y.prototype.pushScrollHandle=function(e,t,r){this.actionListener("pushScroll",e,Number((+t).toFixed(4)),Number((+r).toFixed(4)))},y.prototype.pushSetModHandle=function(e){var t,r,i=e.mod_list_seq,n=e.action_list;i>=this.modListSeq&&(this.modListSeq=i,(r=(t=n[0]).action)===f.ModAction.Removed?this.pushRemovedMod(t.mod_id):r===f.ModAction.Add?this.pushAddMod(t):r===f.ModAction.Modify&&this.pushModifyMod(t))},y);function y(e){var t=m.call(this,"web",e.whiteboardError)||this;t.modIdMapData={},t.listenerList={},t.graphicLimit=100,t.modLimit=20,t.calStandard={sizeWidth:1280,placeWidth:128e4,minFontSize:12,maxFontSize:100,minLineWidth:1,maxLineWidth:100};var r=e.stateCenter,i=e.logger,n=e.socketCenter;return t.stateCenter=r,t.logger=i,t.socketCenter=n,t.modListSeq=0,t}t.WhiteboardService=v},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WhiteboardServiceBase=void 0;var i=(n.prototype.bindCustomListener=function(e,t){return!!this.customListenerList[e]&&"function"==typeof t&&(-1==this.customListenerList[e].indexOf(t)&&this.customListenerList[e].push(t),!0)},n.prototype.deleteCustomListener=function(e,t){if(!this.customListenerList[e])return!1;var r=this.customListenerList[e];return t?r.splice(r.indexOf(t),1):this.customListenerList[e]=[],!0},n.prototype.actionCustomListener=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];this.customListenerList[e]&&this.customListenerList[e].forEach(function(e){e.apply(void 0,t)})},n);function n(e,t){this.customListenerList={error:[],viewAdd:[],viewRemoved:[],viewScroll:[]},this.platform=e,this.whiteboardError=t}t.WhiteboardServiceBase=i},function(e,t,r){e.exports=function(r){var i={};function n(e){if(i[e])return i[e].exports;var t=i[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,n),t.l=!0,t.exports}return n.m=r,n.c=i,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(r,i,function(e){return t[e]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=5)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PROTO_VERSION="1.7.0",t.ROOMVERSION="V1",function(e){e[e.debug=0]="debug",e[e.info=1]="info",e[e.warn=2]="warn",e[e.error=3]="error",e[e.report=99]="report",e[e.disable=100]="disable"}(t.ENUM_LOG_LEVEL||(t.ENUM_LOG_LEVEL={})),function(e){e[e.disable=0]="disable",e[e.websocket=1]="websocket",e[e.https=2]="https"}(t.ENUM_REMOTE_TYPE||(t.ENUM_REMOTE_TYPE={}));var i=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this._id=null,this.next=null,this.prev=null,this._id=e,this._data=t}return Object.defineProperty(e.prototype,"id",{get:function(){return this._id},set:function(e){this._id=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"data",{get:function(){return this._data},set:function(e){this._data=e},enumerable:!0,configurable:!0}),e.prototype.hasNext=function(){return this.next&&this.next.id},e.prototype.hasPrev=function(){return this.prev&&this.prev.id},e}();t.ListNode=i;var n=function(){function e(){this.start=new i,this.end=new i,this._idCounter=0,this._numNodes=0,this.start.next=this.end,this.start.prev=null,this.end.prev=this.start,this.end.next=null}return e.prototype.insertBefore=function(e,t){var r=new i(this._idCounter,t);return r.next=e,r.prev=e.prev,e.prev.next=r,e.prev=r,++this._idCounter,++this._numNodes,r},e.prototype.addLast=function(e){return this.insertBefore(this.end,e)},e.prototype.add=function(e){return this.addLast(e)},e.prototype.getFirst=function(){return 0===this._numNodes?null:this.start.next},e.prototype.getLast=function(){return 0===this._numNodes?null:this.end.prev},e.prototype.size=function(){return this._numNodes},e.prototype.getFromFirst=function(e){var t=0,r=this.start.next;if(0<=e)for(;t<e&&null!==r;)r=r.next,++t;else r=null;if(null===r)throw"Index out of bounds.";return r},e.prototype.get=function(e){return 0===e?this.getFirst():e===this._numNodes-1?this.getLast():this.getFromFirst(e)},e.prototype.remove=function(e){return e.prev.next=e.next,e.next.prev=e.prev,--this._numNodes,e},e.prototype.removeFirst=function(){var e=null;return 0<this._numNodes&&(e=this.remove(this.start.next)),e},e.prototype.removeLast=function(){var e=null;return 0<this._numNodes&&(e=this.remove(this.end.prev)),e},e.prototype.removeAll=function(){this.start.next=this.end,this.end.prev=this.start,this._numNodes=0,this._idCounter=0},e.prototype.each=function(e){for(var t=this.start;t.hasNext();)e(t=t.next)},e.prototype.find=function(e){for(var t=this.start,r=!1,i=null;t.hasNext()&&!r;)e(t=t.next)&&(i=t,r=!0);return i},e.prototype.map=function(e){for(var t=this.start,r=[];t.hasNext();)e(t=t.next)&&r.push(t);return r},e.prototype.push=function(e){return this.addLast(e)},e.prototype.unshift=function(e){0<this._numNodes?this.insertBefore(this.start.next,e):this.insertBefore(this.end,e)},e.prototype.pop=function(){return this.removeLast()},e.prototype.shift=function(){return this.removeFirst()},e}();t.LinkedList=n,t.sdkErrorList={SUCCESS:{code:"ZegoClient.Success",msg:"success."},PARAM:{code:"ZegoClient.Error.Param",msg:"input error."},HEARTBEAT_TIMEOUT:{code:"ZegoClient.Error.Timeout",msg:"heartbeat timeout."},LOGIN_TIMEOUT:{code:"ZegoClient.Error.Timeout",msg:"login timeout."},SEND_MSG_TIMEOUT:{code:"ZegoClient.Error.Timeout",msg:"send customsg timeout."},RESET_QUEUE:{code:"ZegoClient.Error.Timeout",msg:"msg waiting ack is clear when reset."},LOGIN_DISCONNECT:{code:"ZegoClient.Error.Network",msg:"network is broken and login fail."},KICK_OUT:{code:"ZegoClient.Error.Kickout",msg:"kickout reason="},UNKNOWN:{code:"ZegoClient.Error.Unknown",msg:"unknown error."},FREQ_LIMITED:{code:"ZegoClient.Error.requencyLimited",msg:"Frequency Limited."}},function(e){e[e.disconnected=0]="disconnected",e[e.connecting=1]="connecting",e[e.connected=2]="connected"}(t.ENUM_SIGNAL_STATE||(t.ENUM_SIGNAL_STATE={})),t.ENUM_RESOLUTION_TYPE={LOW:{width:240,height:320,frameRate:15,bitRate:300},MEDIUM:{width:480,height:640,frameRate:15,bitRate:800},HIGH:{width:720,height:1280,frameRate:20,bitRate:1500}},t.ENUM_RETRY_STATE={didNotStart:0,retrying:1,finished:2},t.ENUM_PUBLISH_STATE={start:0,waitingSessionRsp:1,waitingOffserRsp:2,waitingServerAnswer:3,waitingServerICE:4,connecting:5,publishing:6,stop:7,didNotStart:8},t.ENUM_PUBLISH_STATE_NEGO={stop:0,start:1,waiterAnswer:2,waitingCandidate:3,sendCandidate:4,iceConnected:5},t.ENUM_PLAY_STATE={start:0,waitingSessionRsp:1,waitingOffserRsp:2,waitingServerAnswer:3,waitingServerICE:4,connecting:5,playing:6,stop:7,didNotStart:8},t.ENUM_PLAY_STATE_NEGO={stop:0,start:1,waiterAnswer:2,waitingCandidate:3,sendCandidate:4,iceConnected:5},t.ENUM_CONNECT_STATE={disconnect:0,connecting:1,connected:2},t.MAX_TRY_CONNECT_COUNT=1,t.SEND_MSG_RESET=2,t.SEND_MSG_TIMEOUT=1,t.MAX_TRY_HEARTBEAT_COUNT=5,t.ENUM_PUBLISH_STREAM_STATE={waiting_url:1,tryPublish:2,update_info:3,publishing:4,stop:5},t.ENUM_STREAM_SUB_CMD={liveNone:0,liveBegin:2001,liveEnd:2002,liveUpdate:2003},t.ENUM_STREAM_UPDATE_TYPE={added:0,deleted:1},function(e){e[e.logout=0]="logout",e[e.trylogin=1]="trylogin",e[e.login=2]="login"}(t.ENUM_RUN_STATE||(t.ENUM_RUN_STATE={})),t.ENUM_PUBLISH_STATE_UPDATE={start:0,error:1,retry:2},t.ENUM_PLAY_STATE_UPDATE={start:0,error:1,retry:2},t.MAX_TRY_LOGIN_COUNT=5,t.TRY_LOGIN_INTERVAL=[2e3,4e3,6e3,8e3,1e4],t.MINIUM_HEARTBEAT_INTERVAL=3e3,t.ENUM_STREAM_UPDATE_CMD={added:12001,deleted:12002,updated:12003},t.SERVER_ERROR_CODE=1e4,t.MIXSTREAM_ERROR_CODE=1e4,function(e){e[e.low=1]="low",e[e.stantard=2]="stantard",e[e.hight=3]="hight",e[e.custome=4]="custome"}(t.QUALITYLEVEL||(t.QUALITYLEVEL={})),t.ENUM_SIGNAL_SUB_CMD={none:0,joinLiveRequest:1001,joinLiveResult:1002,joinLiveInvite:1003,joinLiveStop:1004},t.ENUM_PUSH_SIGNAL_SUB_CMD={none:0,pushJoinLiveRequest:11001,pushJoinLiveResult:11002,pushJoinLiveInvite:11003,pushJoinLiveStop:11004},function(e){e[e.auto=0]="auto",e[e.ultra=1]="ultra"}(t.ENUM_PLAY_SOURCE_TYPE||(t.ENUM_PLAY_SOURCE_TYPE={})),function(e){e[e.stop=0]="stop",e[e.start=1]="start"}(t.ENUM_BROADCASTER_STATUS||(t.ENUM_BROADCASTER_STATUS={})),function(e){e[e.cdn=0]="cdn",e[e.ultra=1]="ultra",e[e.customUrl=2]="customUrl"}(t.ENUM_DISPATCH_TYPE||(t.ENUM_DISPATCH_TYPE={})),function(e){e[e.ClientType_None=0]="ClientType_None",e[e.ClientType_H5=1]="ClientType_H5",e[e.ClientType_SmallPragram=2]="ClientType_SmallPragram",e[e.ClientType_Webrtc=3]="ClientType_Webrtc"}(t.E_CLIENT_TYPE||(t.E_CLIENT_TYPE={}))},function(e,t,r){"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.playErrorList={DISPATCH_ERROR:{code:"ZegoPlayWeb.Error.Dispatch",msg:"dispatch request error"},DISPATCH_TIMEOUT:{code:"ZegoPlayWeb.Timeout.Dispatch",msg:"dispatch request timeout"},TOKEN_ERROR:{code:"ZegoPlayWeb.Error.Token",msg:"login token error"},SEND_SESSION_TIMEOUT:{code:"ZegoPlayWeb.Timeout.Session",msg:"send session request timeout"},CREATE_SESSION_ERROR:{code:"ZegoPlayWeb.Error.Session",msg:"create session error"},CREATE_OFFER_ERROR:{code:"ZegoPublish.Error.CreateOffer",msg:"create offer error"},SERVER_MEDIA_DESC_TIMEOUT:{code:"ZegoPlayWeb.Timeout.RemoteOffer",msg:"wating server mediaDesc timeout"},SET_REMOTE_DESC_ERROR:{code:"ZegoPlayWeb.Error.RemoteOffer",msg:"other side offer error"},CREATE_ANSWER_ERROR:{code:"ZegoPlayWeb.Error.CreateAnswer",msg:"create offer error"},SET_LOCAL_DESC_ERROR:{code:"ZegoPlayWeb.Error.LocalDesc",msg:"setLocalDescription error"},SEND_MEDIA_DESC_TIMEOUT:{code:"ZegoPlayWeb.Timeout.Desc",msg:"send mediaDesc timeout"},SEND_CANDIDATE_ERROR:{code:"ZegoPlayWeb.Error.Candidate",msg:"send candidate error"},SEND_CANDIDATE_TIMEOUT:{code:"ZegoPlayWeb.Timeout.Candidate",msg:"send candidate timeout"},SERVER_NEGO_TIMEOUT:{code:"ZegoPlayWeb.Timeout.negotiation",msg:"negotiation timeout"},SERVER_CANDIDATE_TIMEOUT:{code:"ZegoPlayWeb.Timeout.ServerCandidate",msg:"waiting candidate timeout"},SERVER_CANDIDATE_ERROR:{code:"ZegoPlayWeb.Error.ServerCandidate",msg:"recv candidate error"},MEDIA_CONNECTION_FAILED:{code:"ZegoPlayWeb.Error.ConnectionFailed",msg:"ice Connection state failed"},MEDIA_CONNECTION_CLOSED:{code:"ZegoPlayWeb.Error.ConnectionClosed",msg:"ice connection state closed"},SESSION_CLOSED:{code:"ZegoPlayWeb.Error.SessionClosed",msg:"server session closed"},WEBSOCKET_ERROR:{code:"ZegoPlayWeb.Error.SocketError",msg:"network error"}},t.publishErrorList={DISPATCH_ERROR:{code:"ZegoPublish.Error.Dispatch",msg:"dispatch request error"},DISPATCH_TIMEOUT:{code:"ZegoPublish.Timeout.Dispatch",msg:"dispatch request timeout"},TOKEN_ERROR:{code:"ZegoPublish.Error.Token",msg:"login token error"},SEND_SESSION_TIMEOUT:{code:"ZegoPublish.Timeout.Session",msg:"send session request timeout"},CREATE_SESSION_ERROR:{code:"ZegoPublish.Error.Session",msg:"create session error"},CREATE_OFFER_ERROR:{code:"ZegoPublish.Error.CreateOffer",msg:"create offer error"},SET_LOCAL_DESC_ERROR:{code:"ZegoPublish.Error.LocalDesc",msg:"setLocalDescription error"},SEND_MEDIA_DESC_TIMEOUT:{code:"ZegoPublish.Timeout.Desc",msg:"send mediaDesc timeout"},SERVER_MEDIA_DESC_TIMEOUT:{code:"ZegoPublish.Timeout.ServerAnswer",msg:"waiting server mediaDesc timeout"},SERVER_MEDIA_DESC_ERROR:{code:"ZegoPublish.Error.ServerAnswer",msg:"server mediaDesc type error"},SET_REMOTE_DESC_ERROR:{code:"ZegoPublish.Error.RemoteDesc",msg:"other side offer error"},SEND_CANDIDATE_TIMEOUT:{code:"ZegoPublish.Timeout.Candidate",msg:"sendIceCandidate error"},SERVER_CANDIDATE_TIMEOUT:{code:"ZegoPublish.Timeout.ServerCandidate",msg:"waiting candidate timeout"},SERVER_NEGO_TIMEOUT:{code:"ZegoPublish.Timeout.negotiation",msg:"negotiation timeout"},SERVER_CANDIDATE_ERROR:{code:"ZegoPublish.Error.ServerCandidate",msg:"recv candidate error"},SESSION_CLOSED:{code:"ZegoPublish.Error.SessionClosed",msg:"server session closed"},MEDIA_CONNECTION_FAILED:{code:"ZegoPublish.Error.IConnectionFailed",msg:"Iice Connection state failed"},MEDIA_CONNECTION_CLOSED:{code:"ZegoPublish.Error.ConnectionClosed",msg:"ice connection state closed"},MEDIA_CONNECTION_DISCONNECTED:{code:"ZegoPublish.Error.IConnectionDisconnected",msg:"ice connection state disconnected"},WEBSOCKET_ERROR:{code:"ZegoPublish.Error.SocketError",msg:"network error"}},t.ENUM_PUBLISH_STATE_UPDATE={start:0,error:1,retry:2},t.ENUM_PLAY_STATE_UPDATE={start:0,error:1,retry:2,stop:3},t.ENUM_RETRY_STATE={didNotStart:0,retrying:1,finished:2},t.getSeq=(i=1,function(){return i++})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){}return e.checkConfigParam=function(e,t){return e.appid&&"number"==typeof e.appid?!e.server||e.server.length<1||"string"!=typeof e.server&&!Array.isArray(e.server)?(t.error("ccp.0 server must be string or string[] and not empty"),!1):!(!e.idName||"string"!=typeof e.idName)||(t.error("ccp.0 idName must be string and not empty"),!1):(t.error("ccp.0 appid must be number"),!1)},e.checkLoginParam=function(e,t){return!0},e.checkPreviewParam=function(e,t){var r=e.bitRate;if(4===e.videoQuality||e.externalMediaStream){if("number"!=typeof e.width)return t.error("zc.p.sp.0 width must be number"),!1;if("number"!=typeof e.height)return t.error("zc.p.sp.0 height must be number"),!1;if("number"!=typeof e.frameRate)return t.error("zc.p.sp.0 frameRate must be number"),!1;if("number"==typeof r)r<48&&(r=48),1e4<r&&(r=1e4),e.minBitRate=e.maxBitRate=e.bitRate;else if(r.minBitRate&&r.maxBitRate&&"number"==typeof r.minBitRate&&"number"==typeof r.maxBitRate&&r.minBitRate<=r.maxBitRate)e.minBitRate=r.minBitRate<48?48:r.minBitRate,e.maxBitRate=1e4<r.maxBitRate?1e4:r.maxBitRate;else if(r)return t.error("zc.p.sp.0 bitRate must be number or object which has minBitRate and maxBitRate"),!1}return!0},e.registerCallback=function(e,t,r){var i,n;t.success&&(i=t.success),t.error&&(n=t.error),r[e+"SuccessCallback"]=i,r[e+"ErrorCallback"]=n},e.actionErrorCallback=function(e,t){return t[e+"ErrorCallback"]},e.actionSuccessCallback=function(e,t){return t[e+"SuccessCallback"]},e.getServerError=function(e){var t={1:"parse json error.",1001:"login is processing.",1002:"liveroom request error.",1003:"zpush connect fail.",1004:"zpush handshake fail.",1005:"zpush login fail.",1006:"user login state is wrong.",1007:"got no zpush addr",1008:"token error",1009:"dispatch error",1010:"token expired",2002:"biz channel error",1e9:"liveroom cmd error, result="};if(0===e)return{code:"ZegoClient.Success",msg:"success"};var r={code:"ZegoClient.Error.Server",msg:""};return r.msg=1e9<e?t[1e9]+e:t[e]?t[e]:"unknown error code:"+e,r},e.isKeepTryLogin=function(e){switch(e){case 1002:case 1003:return!0;default:return!1}},e.mergeStreamList=function(e,t,r,i,n){e.debug("msl.0 call");var o,s=[],a=[],c=[];i=i||[];for(var d=0;d<i.length;d++)if(i[d].anchor_id_name!=t){o=!1;for(var l=0;l<r.length;l++)if(i[d].stream_id===r[l].stream_id){i[d].extra_info!==r[l].extra_info&&c.push(i[d]),o=!0;break}o||s.push(i[d])}else e.debug("msl.0 have self stream added");for(var h=0;h<r.length;h++){o=!1;for(var u=0;u<i.length;u++)if(r[h].stream_id===i[u].stream_id){o=!0;break}o||a.push(r[h])}for(r.splice(0),d=0;d<i.length;d++)r.push(i[d]);n(s,a,c),e.debug("msl.0 call success")},e.checkCustomCommandParam=function(e){return!0},e.generateRandumNumber=function(e){return parseInt(Math.random()*(e+1)+"",10)},e.uuid=function(e,t){var r,i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),n=[];if(t=t||i.length,e)for(r=0;r<e;r++)n[r]=i[0|Math.random()*t];else{var o=void 0;for(n[8]=n[13]=n[18]=n[23]="-",n[14]="4",r=0;r<36;r++)n[r]||(o=0|16*Math.random(),n[r]=i[19==r?3&o|8:o])}return n.join("")},e.supportDetection=function(e,t,r){var i={webRtc:!1,capture:!1,videoDecodeType:{H264:!1,VP8:!1},screenSharing:e};(window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection)&&(i.webRtc=!0),navigator&&(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.msGetUserMedia||navigator.mozGetUserMedia||navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)&&(i.capture=!0),this.supportVideoCodeType(function(e){i.videoDecodeType.H264=e.H264,i.videoDecodeType.VP8=e.VP8,t&&t(i)},function(e){r&&r(e)})},e.compareVersion=function(e,t){e=e.split("."),t=t.split(".");for(var r=Math.max(e.length,t.length);e.length<r;)e.push("0");for(;t.length<r;)t.push("0");for(var i=0;i<r;i++){var n=parseInt(e[i]),o=parseInt(t[i]);if(o<n)return 1;if(n<o)return-1}return 0},e.isSupportLive=function(r,t){var e=wx.getSystemInfoSync().SDKVersion,i={code:-1,msg:""};this.compareVersion(e,"1.7.0")<0&&(i={code:10001,msg:"当前微信版本过低，无法使用相关组件"},r&&r(i)),wx.getSetting({success:function(e){var t=e.authSetting;t["scope.camera"]&&t["scope.record"]||(i={code:10002,msg:"需要摄像头和录音功能的授权"}),r&&r(i)},fail:function(e){t&&t(e)}})},e.isSupportQQLive=function(r,t){var e=qq.getSystemInfoSync().SDKVersion,i={code:-1,msg:""};this.compareVersion(e,"1.7.0")<0&&(i={code:10001,msg:"当前微信版本过低，无法使用相关组件"},r&&r(i)),qq.getSetting({success:function(e){var t=e.authSetting;t["scope.camera"]&&t["scope.record"]||(i={code:10002,msg:"需要摄像头和录音功能的授权"}),r&&r(i)},fail:function(e){t&&t(e)}})},e.supportVideoCodeType=function(s,t){var a=!1;new RTCPeerConnection(null).createOffer({offerToReceiveAudio:1,offerToReceiveVideo:1}).then(function(e){var t,r,i,n,o;e&&e.sdp&&(a=!0,t=e.sdp.split("\r\n"),r=t.some(function(e){return e.startsWith("a=rtpmap:")&&-1<e.indexOf("H264/")}),i=t.some(function(e){return e.startsWith("a=rtpmap:")&&-1<e.indexOf("VP8/")}),n=t.some(function(e){return e.startsWith("a=rtpmap:")&&-1<e.indexOf("VP9/")}),o=t.some(function(e){return e.startsWith("a=rtpmap:")&&-1<e.indexOf("H264/")}),s&&s({H264:r,VP8:i,VP9:n,H265:o}))},function(e){a=!0,clearTimeout(r),t&&t(e)});var r=setTimeout(function(){0==a&&t(!1)},200)},e.inlineWorker=function(e){if(Worker){var t=e.toString().trim().match(/^function\s*\w*\s*\([\w\s,]*\)\s*{([\w\W]*?)}$/)[1],r=URL.createObjectURL(new window.Blob([t],{type:"text/javascript"}));return new Worker(r)}return null},e}();t.ClientUtil=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e){this.loop=!1,this.replace=!1,this.effectEndedCallBack=null,this.effectEndedListener=null,this.startTimes=0,this.startOffset=0,this.pauseTimes=0,this.resumeOffset=0,this.isMixAudio=!1,this.logger=e}return e.prototype.preloadEffect=function(e,r){var i=this;this.logger.info("amu.pe.0 start preload effect");var n=new("undefined"!=typeof webkitAudioContext?webkitAudioContext:AudioContext),o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="arraybuffer",o.onload=function(){var e,t;200==o.status||304==o.status?(e=o.response,n.decodeAudioData(e,function(e){i.logger.info("amu.pe.0 effect preload success"),r("",e)},function(e){r(e)})):(t=o.statusText,r(t))},o.send()},e.prototype.playEffect=function(e,t,r,i,n){var o=this;!0!==this.isMixAudio?this.audioBuffer?(this.startOffset=e||0,this.loop=t||!1,this.replace=r||!1,this.effectEndedCallBack=n,this.mixEffect(this.audioBuffer,function(){o.buffSource.loop=!!t,e?o.buffSource.start(0,e/1e3):o.buffSource.start(0),o.startTimes=Date.now(),o.effectEndedListener=o.effectEndedHandler.bind(o),o.buffSource.addEventListener("ended",o.effectEndedListener),i&&i()})):this.logger.error("amu.pe.1 no audio buffer found"):this.logger.error("amu.pe.1 audio is mixing")},e.prototype.pauseEffect=function(){this.stopMixingAudio(),this.resumeOffset=(this.pauseTimes-this.startTimes+this.startOffset)%(1e3*this.audioBuffer.duration)},e.prototype.resumeEffect=function(){this.playEffect(this.resumeOffset,this.loop,this.replace,null,this.effectEndedCallBack),this.startOffset=this.resumeOffset},e.prototype.mixEffect=function(e,t){this.localStream?(this.ac=new("undefined"!=typeof webkitAudioContext?webkitAudioContext:AudioContext),this.gainNode=this.ac.createGain(),this.buffSource=this.ac.createBufferSource(),this.buffSource.buffer=e,this.buffSource.connect(this.gainNode),this.gainNode.connect(this.ac.destination),this.replaceTrack()&&t()):this.logger.error("amu.me.0 localStream can not be found")},e.prototype.startMixingAudio=function(e,t){return this.replace=t||!1,this.isMixAudio?(this.logger.error("amu.sma.0 audio is mixing"),!1):this.localStream?(e.captureStream=e.captureStream||e.mozCaptureStream||e.webkitCaptureStream,this.ac=new("undefined"!=typeof webkitAudioContext?webkitAudioContext:AudioContext),this.gainNode=this.ac.createGain(),this.mixAudio=this.ac.createMediaStreamSource(e.captureStream()),this.mixAudio.connect(this.gainNode),this.replaceTrack()):(this.logger.error("amu.sma.0 localStream can not be found"),!1)},e.prototype.replaceTrack=function(){this.streamSource=this.ac.createMediaStreamSource(this.localStream),this.destination=this.ac.createMediaStreamDestination(),this.replace||this.streamSource.connect(this.destination),this.gainNode.connect(this.destination);var t=this.destination.stream.getAudioTracks()[0],e=this.peerConnection.getSenders().find(function(e){return e.track.kind===t.kind});return e?(this.micTrack=this.localStream.getAudioTracks()[0],this.originTrack||(this.originTrack=this.micTrack),e.replaceTrack(t),this.localStream.removeTrack(this.micTrack),this.localStream.addTrack(t),!(this.isMixAudio=!1)):(this.logger.error("amu.rt.0 no sender"),!1)},e.prototype.stopMixingAudio=function(){var t=this;return this.localStream?(this.peerConnection.getSenders().find(function(e){return e.track.kind===t.micTrack.kind}).replaceTrack(this.originTrack),this.localStream.removeTrack(this.localStream.getAudioTracks()[0]),this.localStream.addTrack(this.originTrack),this.mixAudio?(this.mixAudio.disconnect(this.gainNode),this.mixAudio=null):this.buffSource&&(this.buffSource.removeEventListener("ended",this.effectEndedListener),this.buffSource.stop(),this.pauseTimes=Date.now(),this.buffSource.disconnect(this.gainNode),this.buffSource=null),this.gainNode.disconnect(this.destination),this.micTrack=null,this.ac=null,!(this.isMixAudio=!1)):(this.logger.error("amu.sma.1 localStream can not be found"),!1)},e.prototype.setMixingAudioVolume=function(e){if(!this.gainNode)return this.logger.error("amu.sma.2 no mixing audio found"),!1;this.gainNode.gain.value=e},e.prototype.effectEndedHandler=function(){this.stopMixingAudio(),this.effectEndedCallBack&&this.effectEndedCallBack()},e}();t.audioMixUtil=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){}return e.zegoSdp=function(e){var t=e.split("\r\n"),n=[],o=[];t.forEach(function(e){var t=e.match(/a=rtpmap:(\d+)\s+((H264\/90000)|(opus\/48000\/2))/);t&&t[1]&&t[2]&&("H264/90000"===t[2]&&n.push(t[1]),"opus/48000/2"===t[2]&&o.push(t[1]))});var s=[];return t.map(function(e){var t,r=!0,i=e.match(/((a=rtcp-fb:)|(a=rtpmap:)|(a=fmtp:))(\d+)/);i&&i[5]&&(n.concat(o).some(function(e){return e==i[5]})||(r=!1)),-1<e.indexOf("m=video")?e=[(t=e.split(" "))[0],t[1],t[2]].concat(n).join(" "):-1<e.indexOf("m=audio")&&(e=[(t=e.split(" "))[0],t[1],t[2]].concat(o).join(" ")),r&&s.push(e)}),s.join("\r\n")},e.getSDPByVideDecodeType=function(o,e){var s={str:"",arr:[],obj:{H264:[],H265:[],VP8:[],VP9:[],OHTER:[]}};if(!o.includes("m=video"))return o;var t=/m=video.+/.exec(o)[0];t=t.match(/[\s|\d]+/g)[1].replace(" ",""),s.str=t,s.arr=s.str.split(" "),s.arr.forEach(function(e){var t=new RegExp("a=rtpmap:"+e+".+").exec(o)[0];t.includes("H264")?s.obj.H264.push(e):t.includes("H265")?s.obj.H265.push(e):t.includes("VP8")?s.obj.VP8.push(e):t.includes("VP9")?s.obj.VP9.push(e):s.obj.OHTER.push(e)}),s.obj.OHTER.forEach(function(e){var t=new RegExp("a=fmtp:"+e+".+apt=(\\d+)").exec(o),r=t&&t[1];r&&(s.obj.H264.includes(r)?s.obj.H264.push(e):s.obj.H265.includes(r)?s.obj.H265.push(e):s.obj.VP8.includes(r)?s.obj.VP8.push(e):s.obj.VP9.includes(r)&&s.obj.VP9.push(e))});var r=[];return"VP9"===e?r=s.obj.H265.concat(s.obj.H264,s.obj.VP8):"VP8"===e?r=s.obj.H265.concat(s.obj.H264,s.obj.VP9):"H264"===e?r=s.obj.H265.concat(s.obj.VP8,s.obj.VP9):"H265"===e&&(r=s.obj.VP8.concat(s.obj.H264,s.obj.VP9)),r.forEach(function(e){var t=s.arr.indexOf(e);s.arr.splice(t,1);var r=new RegExp("a=rtpmap:"+e+".+\\s\\n","g"),i=new RegExp("a=rtcp-fb:"+e+".+\\s\\n","g"),n=new RegExp("a=fmtp:"+e+".+\\s\\n","g");o=(o=(o=o.replace(r,"")).replace(i,"")).replace(n,"")}),o=o.replace(t,s.arr.join(" "))},e}();t.sdpUtil=i},function(e,t,r){"use strict";var i,o=this&&this.__extends||(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),a=this&&this.__assign||Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},c=this&&this.__awaiter||function(o,s,a,c){return new(a=a||Promise)(function(e,t){function r(e){try{n(c.next(e))}catch(e){t(e)}}function i(e){try{n(c.throw(e))}catch(e){t(e)}}function n(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,i)}n((c=c.apply(o,s||[])).next())})},d=this&&this.__generator||function(r,i){var n,o,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!((s=0<(s=a.trys).length&&s[s.length-1])||6!==t[0]&&2!==t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=i.call(r,a)}catch(e){t=[6,e],o=0}finally{n=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(t,"__esModule",{value:!0});var l=r(0),h=r(1),u=r(6),p=r(8),g=r(2),f=r(3),n=r(17),m=r(26),v=r(27),s=function(n){function s(){var e=this,t=new u.LoggerWeb,r=new m.StateCenter,i=new p.ZegoStreamCenterWeb(t,r);return(e=n.call(this)||this).streamCenter=i,e.logger=t,e.stateCenter=r,e.audioMixing=new f.audioMixUtil(t),e.init(),e.bindWindowListener(),e}return o(s,n),s.prototype.getSocket=function(e){return new WebSocket(e)},s.prototype.enableCamera=function(e,t){return this.logger.debug("zc.p.ec.0 call"),"boolean"!=typeof t?(this.logger.error("zc.p.ec.0 argument is not bool"),!1):this.streamCenter.enableCamera(e,t)},s.prototype.enableMicrophone=function(e,t){return this.logger.debug("zc.p.em.0 call"),"boolean"!=typeof t?(this.logger.error("zc.p.em.0 argument is not bool"),!1):this.streamCenter.enableMicrophone(e,t)},s.prototype.setLocalAudioOutput=function(e,t){return this.logger.debug("zc.p.slao call"),"string"==typeof t&&this.streamCenter.setStreamAudioOutput(e,t)},s.prototype.setPlayAudioOutput=function(e,t){return this.logger.debug("zc.p.spao call"),"string"==typeof t&&this.streamCenter.setPlayStreamAudioOutput(e,t)},s.prototype.setCustomSignalUrl=function(e){if(this.logger.debug("zc.p.scs.0 call: "+e),!e||0==e.length)return this.logger.error("zc.p.scs.0 param error"),!1;var t=!0;if(e.forEach(function(e){return 0!=e.indexOf("wss://")&&(t=!1)}),!t)return this.logger.error("zc.p.scs.0 url is not correct"),!1;this.stateCenter.customUrl=e},s.prototype.setQualityMonitorCycle=function(e){"number"==typeof e&&1e3<=e&&this.streamCenter.setQualityMonitorCycle(e)},s.prototype.startPlayingStream=function(r,e,t,i){var n=this;if(this.logger.info("zc.p.sps.0 call"),!r||""===r)return this.logger.error("zc.p.sps.0 param error"),!1;if(!e)return this.logger.error("zc.p.sps.0 don't have remoteVideo"),!1;if(this.stateCenter.customUrl)return this.streamCenter.setPlayStateStart(r,e,t,i)?this.streamCenter.startPlayingStream(r,this.stateCenter.customUrl):(this.logger.error("zc.p.sps.0 cannot start play"),!1);if(!this.stateCenter.isLogin())return this.logger.error("zc.p.sps.0 not login"),!1;for(var o=!1,s=0;s<this.stateCenter.streamList.length;s++)if(this.stateCenter.streamList[s].stream_id===r){o=!0;break}if(0==o&&this.logger.info("zc.p.sps.0 cannot find stream"),this.stateCenter.pullLimited||(r=NaN+r),!this.streamCenter.setPlayStateStart(r,e,t,i))return this.logger.info("zc.p.sps.0 cannot start play"),!1;var a={stream_id:r,ptype:"pull",signals:this.streamCenter.getAllInUseUrl()};return this.socketCenter.registerRouter("webrtc_url",function(e){n.handleFetchWebRtcUrlRsp(e)}),this.socketCenter.sendMessage("webrtc_url",a,void 0,function(e,t){e==l.sdkErrorList.SEND_MSG_TIMEOUT?n.onPlayStateUpdate(l.ENUM_PLAY_STATE_UPDATE.error,r,h.playErrorList.DISPATCH_TIMEOUT):n.onPlayStateUpdate(l.ENUM_PLAY_STATE_UPDATE.error,r,h.playErrorList.DISPATCH_ERROR),n.streamCenter.stopPlayingStream(r)}),!0},s.prototype.stopPlayingStream=function(e){if(this.logger.info("zc.p.sps.1.0 call"),!e||""===e)return this.logger.info("zc.p.sps.1.0 param error"),!1;var t=this.streamCenter.getTotalStreamId(e),r=this.streamCenter.playerList[t];if(!r||0==r.serverUrls.length)return r&&this.logger.error("zc.p.sps.1.0 stream can not be destroyed"),!1;for(var i in this.streamCenter.stopPlayingStream(e),this.stateCenter.streamUrlMap)if(this.stateCenter.streamUrlMap[i]===e){delete this.stateCenter.streamUrlMap[i];break}return this.logger.debug("zc.p.sps.1.0 call success"),!0},s.prototype.startPreview=function(e,t,r,i){if(this.logger.debug("zc.p.sp.0 call"),!e)return this.logger.error("zc.p.sp.0 no localVideo"),!1;if(t.audioBitRate){if("number"!=typeof t.audioBitRate)return void this.logger.error("zc.p.sp.0 audioBitRate must be number");if(t.audioBitRate<48e3)return void this.logger.error("zc.p.sp.0 audioBitRate cannot less 48000");this.stateCenter.audioBitRate=t.audioBitRate}return!!g.ClientUtil.checkPreviewParam(t,this.logger)&&this.streamCenter.startPreview(e,t,r,i)},s.prototype.stopPreview=function(e){return this.logger.debug("zc.p.sp.1 call"),e?this.streamCenter.stopPreview(e):(this.logger.info("zc.p.sp.1 param error"),!1)},s.prototype.startPublishingStream=function(r,e,t,i){var n=this;if(this.logger.info("zc.p.sps.1 call streamid: "+r),!r)return this.logger.error("zc.p.sps.1 param error"),!1;if((i=i||{}).audioBitRate=this.stateCenter.audioBitRate,this.stateCenter.customUrl&&0!=this.stateCenter.customUrl.length)return this.stateCenter.publishStreamList[r]={state:l.ENUM_PUBLISH_STREAM_STATE.tryPublish,extra_info:t},this.streamCenter.setPublishStateStart(r,e,i)?this.streamCenter.startPublishingStream(r,this.stateCenter.customUrl):(this.logger.info("zc.p.sps.1 cannot start publish"),!1);if(!this.stateCenter.isLogin())return this.logger.error("zc.p.sps.1 not login"),!1;if(this.stateCenter.publishStreamList[r]={state:l.ENUM_PUBLISH_STREAM_STATE.tryPublish,extra_info:t},!this.streamCenter.setPublishStateStart(r,e,i))return this.logger.error("zc.p.sps.1 cannot start publish"),!1;this.logger.info("zc.p.sps.1 start publish");var o={stream_id:r,ptype:"push",signals:this.streamCenter.getAllInUseUrl(),header_kvs:[{key:"grpc-metadata-push",value:i&&i.cdnUrl||""}]};return this.socketCenter.registerRouter("webrtc_url",function(e){n.handleFetchWebRtcUrlRsp(e)}),this.socketCenter.sendMessage("webrtc_url",o,void 0,function(e,t){e==l.sdkErrorList.SEND_MSG_TIMEOUT?n.onPublishStateUpdate(l.ENUM_PUBLISH_STATE_UPDATE.error,r,h.publishErrorList.DISPATCH_TIMEOUT):n.onPublishStateUpdate(l.ENUM_PUBLISH_STATE_UPDATE.error,r,h.publishErrorList.DISPATCH_ERROR),n.streamCenter.stopPublishingStream(r)}),!0},s.prototype.stopPublishingStream=function(e){if(this.logger.info("zc.p.sps.1.1 call streamid: "+e),!e)return this.logger.info("zc.p.sps.1.1 param error"),!1;var t=this.streamCenter.getTotalStreamId(e),r=this.streamCenter.publisherList[t];return r&&0!=r.serverUrls.length?(this.streamCenter.stopPublishingStream(e),this.stateCenter.publishStreamList[e]&&(this.stateCenter.publishStreamList[e].state>=l.ENUM_PUBLISH_STREAM_STATE.update_info&&this.streamHandler.updateStreamInfo(e,l.ENUM_STREAM_SUB_CMD.liveEnd),delete this.stateCenter.publishStreamList[e]),!0):(r&&this.logger.error("zc.p.sps.1.1 stream can not be destroyed when dispatching"),!1)},s.prototype.preloadEffect=function(r,e,i){var n=this;r&&"number"==typeof r&&e&&"string"==typeof e?this.stateCenter.audioEffectBuffer[r]?this.logger.error("zc.pe.0 audio buffer already exists"):this.audioMixing.preloadEffect(e,function(e,t){return e?(n.logger.error("zc.pe.0 effect preload fail "+e),void(i&&i(e))):void(t&&(n.stateCenter.audioEffectBuffer[r]=t,i&&i()))}):this.logger.error("zc.pe.0 params error")},s.prototype.playEffect=function(e,t,r){var i,n;e.streamId&&"string"==typeof e.streamId&&e.effectId&&"number"==typeof e.effectId?this.stateCenter.audioEffectBuffer[e.effectId]?(i=this.stateCenter.audioEffectBuffer[e.effectId],(n=this.getPublisher(e.streamId))?i?n.playEffect(e,i,t,r):this.logger.error("zc.pe.1 no audio buffer found"):this.logger.error("zc.pe.1 publisher doesn't exist")):this.logger.error("zc,pe.1 audio buffer dosesn't exists"):this.logger.error("zc.pe.1 params error")},s.prototype.pauseEffect=function(e){var t;e&&"string"==typeof e?(t=this.getPublisher(e))?t.pauseEffect():this.logger.error("zc.pe.2 publisher doesn't exist"):this.logger.error("zc.pe.2 streamid format error")},s.prototype.resumeEffect=function(e){var t;e&&"string"==typeof e?(t=this.getPublisher(e))?t.resumeEffect():this.logger.error("zc.re.0 publisher doesn't exist"):this.logger.error("zc.re.0 streamid format error")},s.prototype.unloadEffect=function(e){return e&&"number"==typeof e?(delete this.stateCenter.audioEffectBuffer[e],!0):(this.logger.error("zc.ue.0 params error"),!1)},s.prototype.startMixingAudio=function(e,t,r){if(this.logger.debug("zc.sma.0 call"),!e||"string"!=typeof e)return this.logger.error("zc.sma.0 stream id error"),!1;if(!t)return this.logger.error("zc.sma.0 no audio"),!1;var i=this.getPublisher(e);return i?i.startMixingAudio(t,r):(this.logger.error("zc.sma.0 publisher doesn't exist"),!1)},s.prototype.stopMixingAudio=function(e){if(!e||"string"!=typeof e)return this.logger.error("zc.sma.1 param streamid format error"),!1;var t=this.getPublisher(e);return t?t.stopMixingAudio():(this.logger.error("zc.sma.1 publisher doesn't exist"),!1)},s.prototype.setMixingAudioVolume=function(e,t){if(this.logger.debug("zc.sma.2 call"),!e||"string"!=typeof e||"number"!=typeof t||t<0||100<t)return this.logger.error("zc.sma.2 param error"),!1;var r=this.getPublisher(e);return r?r.audioMixing.setMixingAudioVolume(t/100):(this.logger.error("zc.sma.2 publisher doesn't exist"),!1)},s.prototype.getPublisher=function(e){var t=null,r=this.streamCenter.getTotalStreamId(e);return this.streamCenter.publisherList[r]&&this.streamCenter.publisherList[r].publisher&&(t=this.streamCenter.publisherList[r].publisher),t},s.prototype.startScreenShotChrome=function(e){if(!s.screenShotReady)return this.logger.error('zc.b.ss Please install the extension:1. Go to chrome://extensions  2. Check: "Enable Developer mode   3. Click: "Load the unpacked extension... 4. Choose "extension" folder from the repository 5. Reload this page'),!1;window.postMessage({type:"SS_UI_REQUEST",text:"start"},"*"),g.ClientUtil.registerCallback("screenShare",{success:e},this.stateCenter.callbackList)},s.prototype.startScreenSharing=function(e,t,r){var i=this;"getDisplayMedia"in navigator.mediaDevices?navigator.mediaDevices.getDisplayMedia({audio:t,video:{width:e.width||window.screen.width,height:e.height||window.screen.height,frameRate:e.frameRate||15,displaySurface:e.displaySurface||"minitor"}}).then(function(e){(i.stateCenter.screenShotStream=e).getVideoTracks()[0].onended=function(){return i.onScreenSharingEnded()},r(!0,e)}).catch(function(e){i.logger.error("zc.b.sss "+e),r(!1,null,e)}):this.logger.error("zc.b.sss getDisplayMedia is not supported ")},s.prototype.startScreenShotFirFox=function(e,t,r,i){var n=this,o={video:{width:e.width||window.screen.width,height:e.height||window.screen.height,frameRate:e.frameRate||15},audio:r};o.video.mediaSource=t,navigator.mediaDevices.getUserMedia(o).then(function(e){(n.stateCenter.screenShotStream=e).getVideoTracks()[0].onended=function(){return n.onScreenSharingEnded()},i(!0,e)}).catch(function(e){n.logger.error("zc.b.ssf "+e),i(!1,null)})},s.prototype.stopScreenShot=function(){this.stateCenter.screenShotStream.getTracks().forEach(function(e){e.stop()}),window.postMessage({type:"SS_UI_CANCEL",text:"start"},"*")},s.prototype.switchDevice=function(i,n,o,s,a){var c=this;"audio"!==i&&"video"!==i||"string"!=typeof o?this.logger.error("zg.sd.0 param error"):this.enumDevices(function(e){var t=e.cameras,r=e.microphones;t.find(function(e){return e.deviceId==o})||r.find(function(e){return e.deviceId==o})?c.streamCenter.switchDevice(i,n,o,s,a):c.logger.error("zg.sd.0 can not switch device")},function(e){return a&&a(e)})},s.prototype.WebrtcOnPublishStateUpdateHandle=function(e,t,r){this.stateCenter.publishStreamList[t].state==l.ENUM_PUBLISH_STREAM_STATE.publishing&&this.onPublishStateUpdate(e,t,r)},s.prototype.setCDNInfo=function(e,t){e.urls_flv=t.urls_flv,e.urls_hls=t.urls_m3u8,e.urls_https_flv=t.urls_https_flv,e.urls_https_hls=t.urls_https_m3u8,e.urls_rtmp=t.urls_rtmp},s.prototype.onScreenSharingEnded=function(){},s.prototype.loginBodyData=function(){return{id_name:this.stateCenter.idName,nick_name:this.stateCenter.nickName,role:this.stateCenter.role,token:this.stateCenter.token,version:l.PROTO_VERSION,room_name:this.stateCenter.roomid,user_state_flag:this.stateCenter.userStateUpdate?1:0,room_create_flag:this.stateCenter.roomCreateFlag,client_type:l.E_CLIENT_TYPE.ClientType_Webrtc,third_token:this.stateCenter.third_token}},s.prototype.screenStreamFrom=function(e,t,r){var i=this,n={};n.audio={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e}},n.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxWidth:window.screen.width,maxHeight:window.screen.height}},t||(n.audio=!1),navigator.mediaDevices.getUserMedia(n).then(function(e){(i.stateCenter.screenShotStream=e).getVideoTracks()[0].onended=function(){return i.onScreenSharingEnded()},r(!0,e)}).catch(function(e){i.logger.error("zc.b.ssf "+e),r(!1,null,e)})},s.prototype.filterStreamList=function(r){var e={},t={},i={},n=[],o=0;for(var s in this.stateCenter.streamList.forEach(function(e,t){e.stream_id==r&&(o=t)}),this.stateCenter.streamList[o])"urls_flv"!=s&&"urls_https_flv"!=s||(e[s]=this.stateCenter.streamList[o][s]),"urls_m3u8"!=s&&"urls_https_m3u8"!=s||(t[s]=this.stateCenter.streamList[o][s]),"urls_rtmp"==s&&(i[s]=this.stateCenter.streamList[o][s]);var a=window.location.protocol,c=window.navigator.userAgent;if(/Safari/.test(c)&&!/Chrome/.test(c))for(var s in t)t[s]&&t[s].forEach(function(e){-1!==e.indexOf(a)&&n.push(e)});else if("http:"==a)for(var s in e)e[s]&&e[s].forEach(function(e){-1===e.indexOf("http")&&-1===e.indexOf("https")||n.push(e)});else if("https:"==a)for(var s in e)e[s]&&e[s].forEach(function(e){-1!==e.indexOf(a)&&n.push(e)});else if("rtmp:"==a)for(var s in i)i[s]&&i[s].forEach(function(e){-1!==e.indexOf(a)&&n.push(e)});return n.filter(function(e,t,r){return r.indexOf(e)==t})},s.prototype.voiceChange=function(e,t){return e&&"number"==typeof e?t&&"string"==typeof t?this.getPublisher(t).voiceChange(e):(this.logger.error("zc.vc.0 stream id error"),!1):(this.logger.error("zc.vc.0 mult error"),!1)},s.prototype.voiceBack=function(e){return this.getPublisher(e).voiceBack()},s.prototype.setPublishStreamConstraints=function(e,t,r,i){this.logger.info("zc.spsc.0 call"),"string"==typeof e&&""!=e?this.streamCenter.setPublishStreamConstraints(e,t,r,i):this.logger.error("zc.spsc.0 stream ID must be string and not empty")},s.supportDetection=function(e,t){navigator&&navigator.mediaDevices&&(this.screenShotReady||"getDisplayMedia"in navigator.mediaDevices)?g.ClientUtil.supportDetection(!0,e,t):g.ClientUtil.supportDetection(!1,e,t)},s.prototype.enumDevices=function(e,t){s.enumDevices(e,t)},s.enumDevices=function(s,t){void 0!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(function(e){for(var t=[],r=[],i=[],n=0;n<e.length;n++){var o=e[n];"audioinput"===o.kind&&t.push({label:o.label,deviceId:o.deviceId}),"audiooutput"===o.kind&&r.push({label:o.label,deviceId:o.deviceId}),"videoinput"===o.kind&&i.push({label:o.label,deviceId:o.deviceId})}s&&s({microphones:t,speakers:r,cameras:i})}).catch(function(e){t&&t(e)}):t&&t("browser don't support enumerate devices")},s.getAudioInfo=function(e,t,r){if(!e.srcObject)return!1;var i=a({},r);return new v.MediaUtil(i).connectToSource(e.srcObject,function(e){t(e)})},s.handleDataAvailable=function(e){e.data&&0<e.data.size&&s.recordedBlobs.push(e.data)},s.startRecord=function(i,n,o){return c(this,void 0,void 0,function(){var t,r;return d(this,function(e){switch(e.label){case 0:return s.recordedBlobs=[],r={mimeType:"video/webm;codecs=vp9"},MediaRecorder.isTypeSupported(r.mimeType)||(r={mimeType:"video/webm;codecs=vp8"},MediaRecorder.isTypeSupported(r.mimeType)||(r={mimeType:"video/webm"},MediaRecorder.isTypeSupported(r.mimeType)||(r={mimeType:""}))),n&&n.audio?(r={mimeType:"audio/webm"},MediaRecorder.isTypeSupported(r.mimeType)||(r={mimeType:""}),[4,navigator.mediaDevices.getUserMedia({audio:{deviceId:n.audioInput?n.audioInput:""}})]):[3,2];case 1:return t=e.sent(),s.recordType="audio",[3,3];case 2:t=i.captureStream(),e.label=3;case 3:try{s.mediaRecorder=new MediaRecorder(t,r)}catch(e){return o&&o(e),[2]}return s.mediaRecorder.onstop=function(e){n&&n.audio&&t.getTracks().forEach(function(e){return e.stop()})},s.mediaRecorder.ondataavailable=s.handleDataAvailable,s.mediaRecorder.start(10),o&&o(),[2]}})})},s.stopRecord=function(){s.mediaRecorder&&s.mediaRecorder.stop()},s.resumeRecord=function(){s.mediaRecorder&&s.mediaRecorder.resume()},s.pauseRecord=function(){s.mediaRecorder&&s.mediaRecorder.pause()},s.saveRecord=function(e){if(s.mediaRecorder&&s.recordedBlobs){var t,r=new Blob(s.recordedBlobs,{type:"video"===s.recordType?"video/webm":"audio/webm"}),i=window.URL.createObjectURL(r);return"string"==typeof e&&""!==e&&((t=document.createElement("a")).style.display="none",t.href=i,t.download=e+".webm",document.body.appendChild(t),t.click(),setTimeout(function(){document.body.removeChild(t),window.URL.revokeObjectURL(i)},100)),i}},s.resumeRecordAudio=function(){s.mediaRecorder&&s.mediaRecorder.resume()},s.pauseRecordAudio=function(){s.mediaRecorder&&s.mediaRecorder.pause()},s.getRecordAudio=function(){if(s.mediaRecorder&&s.recordedBlobs){var e=new Blob(s.recordedBlobs);return window.URL.createObjectURL(e)}},s.takeSnapShot=function(e,t){var r;e&&0!==e.videoHeight&&((r=document.createElement("canvas")).width=e.videoWidth,r.height=e.videoHeight,r.getContext("2d").drawImage(e,0,0,r.width,r.height),t.src=r.toDataURL("image/jpeg"))},s.saveSnapShot=function(e,i){var t;e&&0!==e.videoHeight&&((t=document.createElement("canvas")).width=e.videoWidth,t.height=e.videoHeight,t.getContext("2d").drawImage(e,0,0,t.width,t.height),t.toBlob(function(e){var t=window.URL.createObjectURL(e),r=document.createElement("a");r.style.display="none",r.href=t,r.download=i+".jpeg",document.body.appendChild(r),r.click(),setTimeout(function(){document.body.removeChild(r),window.URL.revokeObjectURL(t)},100)}))},s.prototype.bindWindowListener=function(){var o=this,e=navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPhone/i)?"pagehide":"beforeunload";window.addEventListener(e,function(e){for(var t in window.event.cancelBubble=!0,o.streamCenter.publisherList)o.stopPublishingStream(t);for(var t in o.streamCenter.playerList)o.stopPublishingStream(t);o.logout()}),window.addEventListener("message",function(e){var t=e.data,r=t.type,i=t.streamId,n=t.canRequestAudioTrack;e.origin,"SS_DIALOG_SUCCESS"===r&&o.screenStreamFrom(i,n,g.ClientUtil.actionSuccessCallback("screenShare",o.stateCenter.callbackList)),"SS_DIALOG_CANCEL"===r&&(o.logger.error("zc.b.ss "+r),g.ClientUtil.actionSuccessCallback("screenShare",o.stateCenter.callbackList)(!1,null,r))})},s.screenShotReady=!1,s.recordType="video",s}(n.BaseCenter);t.ZegoClient=s,window.addEventListener("message",function(e){var t=e.data,r=t.type;t.streamId,e.origin;window.location.origin,"SS_PING"===r&&(s.screenShotReady=!0)})},function(e,t,r){"use strict";var i,n=this&&this.__extends||(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0});var o=r(7),s=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t.prototype.openWebSocketLogServer=function(e){if(this.url!=e){if(!(this.url=e))return;if(null!=this.websocket&&2!=this.websocket.readyState&&3!=this.websocket.readyState)return;this.stopWebSocketServer(),this.websocket=new WebSocket(e),this.websocket.onopen=function(e){},this.websocket.onclose=function(e){},this.websocket.onmessage=function(e){},this.websocket.onerror=function(e){}}},t.prototype.SendHttpsLog=function(){var e,t,r=this;0!=this.logCacheSend.length&&(e=this.logCacheSend.join("\n"),(t=new XMLHttpRequest).onreadystatechange=function(){if(4==t.readyState&&200==t.status){if(0==t.responseText.length)return;try{var e=JSON.parse(t.responseText).interval;"number"==typeof e&&r.logUploadInterval!==e&&(r.timeInterval=e,r.openHttpsLogServer(r.url))}catch(e){}}},t.open("POST",this.url,!0),t.send(e),this.logCacheSend=[])},t.prototype.logReportParamList=function(e,t){var r=new Date,i=r.getFullYear()+"/";return i+=(o.D[r.getMonth()+1]||r.getMonth()+1)+"/",i+=(o.D[r.getDate()]||r.getDate())+" ",i+=(o.D[r.getHours()]||r.getHours())+":",i+=(o.D[r.getMinutes()]||r.getMinutes())+":",i+=o.D[r.getSeconds()]||r.getSeconds(),i+="."+r.getTime()%1e3,t.time=i,t.level=e,t.console="rtc",t.appid=this.appid,t.roomid=this.roomid,t.userid=this.userid,t.id_name=this.userid,t.userName=this.userName,t.sessionid=this.sessionid,t.version=this.version,[JSON.stringify(t)]},t}(o.Logger);t.LoggerWeb=s},function(e,a,t){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var i=t(0);a.D=["00","01","02","03","04","05","06","07","08","09"];var r=function(){function e(){this.logLevel=i.ENUM_LOG_LEVEL.info,this.logUploadTimer=null,this.logUploadInterval=1e4,this.logCache=[],this.logCacheSend=[],this.logCacheMax=100}return e.prototype.setLogLevel=function(e){this.logLevel<i.ENUM_LOG_LEVEL.debug||this.logLevel>i.ENUM_LOG_LEVEL.report?this.logLevel=i.ENUM_LOG_LEVEL.disable:this.logLevel=e},e.prototype.setRemoteLogLevel=function(e){this.logRemoteLevel<i.ENUM_LOG_LEVEL.debug||this.logRemoteLevel>i.ENUM_LOG_LEVEL.report?this.logRemoteLevel=i.ENUM_LOG_LEVEL.disable:this.logRemoteLevel=e},e.prototype.setSessionInfo=function(e,t,r,i,n,o){this.appid=e,this.roomid=t,this.sessionid=r,this.userid=i,this.userName=n,this.version=o},e.prototype.openLogServer=function(e){try{e.startsWith("wss:")?(this.logType=i.ENUM_REMOTE_TYPE.websocket,this.openWebSocketLogServer(e)):e.startsWith("https:")?(this.logType=i.ENUM_REMOTE_TYPE.https,this.openHttpsLogServer(e)):this.logType=i.ENUM_REMOTE_TYPE.disable}catch(e){this.error(JSON.stringify(e))}},e.prototype.stopLogServer=function(){this.logType==i.ENUM_REMOTE_TYPE.websocket?this.stopWebSocketServer():this.logType==i.ENUM_REMOTE_TYPE.https&&(this.SendHttpsLog(),this.stopHttpsServer()),this.logType=i.ENUM_REMOTE_TYPE.disable},e.prototype.stopWebSocketServer=function(){this.websocket&&(this.websocket.onclose=null,this.websocket.onerror=null,this.websocket.close(),this.websocket=null)},e.prototype.openHttpsLogServer=function(e){var t=this;(this.url=e)&&(this.stopHttpsServer(),this.logUploadTimer||(this.logUploadTimer=setInterval(function(){t.SendHttpsLog()},this.logUploadInterval)))},e.prototype.stopHttpsServer=function(){this.logUploadTimer&&(clearInterval(this.logUploadTimer),this.logUploadTimer=null)},e.prototype.report=function(e){var t=this.logReportParamList(i.ENUM_LOG_LEVEL.report,e);this.logLevel!==i.ENUM_LOG_LEVEL.disable&&(this.logLevel,i.ENUM_LOG_LEVEL.report),this.RemoteLog(i.ENUM_LOG_LEVEL.report,t,!0)},e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this.logParamList(i.ENUM_LOG_LEVEL.debug,e.join(""));this.logLevel!==i.ENUM_LOG_LEVEL.disable&&(this.logLevel,i.ENUM_LOG_LEVEL.debug),this.log(i.ENUM_LOG_LEVEL.debug,r)},e.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this.logParamList(i.ENUM_LOG_LEVEL.info,e.join(""));this.logLevel!==i.ENUM_LOG_LEVEL.disable&&(this.logLevel,i.ENUM_LOG_LEVEL.info),this.log(i.ENUM_LOG_LEVEL.info,r)},e.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this.logParamList(i.ENUM_LOG_LEVEL.warn,e.join(""));this.logLevel!==i.ENUM_LOG_LEVEL.disable&&(this.logLevel,i.ENUM_LOG_LEVEL.warn),this.log(i.ENUM_LOG_LEVEL.warn,r)},e.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=this.logParamList(i.ENUM_LOG_LEVEL.error,e.join(""));this.logLevel!==i.ENUM_LOG_LEVEL.disable&&(this.logLevel,i.ENUM_LOG_LEVEL.error),this.log(i.ENUM_LOG_LEVEL.error,r)},e.prototype.log=function(e,t){this.logRemoteLevel!==i.ENUM_LOG_LEVEL.disable&&this.logRemoteLevel<=e&&this.RemoteLog(e,t)},e.prototype.RemoteLog=function(e,t,r){if(void 0===r&&(r=!1),""!=this.url)if(this.logType==i.ENUM_REMOTE_TYPE.websocket)this.RemoteWebSocketLog(e,t);else if(this.logType==i.ENUM_REMOTE_TYPE.https)this.RemoteHttpsLog(e,t,r);else if(this.logLevel!==i.ENUM_LOG_LEVEL.disable&&this.logLevel<=e)for(this.logCacheSend.push(t);this.logCacheSend.length>this.logCacheMax;)this.logCacheSend.shift()},e.prototype.RemoteWebSocketLog=function(e,t){if(null==this.websocket||2==this.websocket.readyState||3==this.websocket.readyState){var r=this.url;this.url="",this.openLogServer(r),this.logCacheSend.length<this.logCacheMax&&this.logCacheSend.push(t)}else if(0==this.websocket.readyState)this.logCacheSend.length<this.logCacheMax&&this.logCacheSend.push(t);else if(1==this.websocket.readyState)if(0<this.logCacheSend.length){for(var i="",n=0;n<this.logCacheSend.length;n++)4e3<(i+this.logCacheSend[n]).length&&(this.websocket.send(i),i=""),i=i+this.logCacheSend[n]+"\n";t=i+t,this.logCacheSend=[],this.websocket.send(t)}else this.websocket.send(t);else this.logCacheSend.length<this.logCacheMax&&this.logCacheSend.push(t)},e.prototype.RemoteHttpsLog=function(e,t,r){this.logCacheSend.push(t),(this.logCacheSend.length>=this.logCacheMax||!0===r)&&this.SendHttpsLog()},e.prototype.logParamList=function(e,t){var r=new Date,i=r.getFullYear()+"/";i+=(a.D[r.getMonth()+1]||r.getMonth()+1)+"/",i+=(a.D[r.getDate()]||r.getDate())+" ",i+=(a.D[r.getHours()]||r.getHours())+":",i+=(a.D[r.getMinutes()]||r.getMinutes())+":",i+=a.D[r.getSeconds()]||r.getSeconds(),i+="."+r.getTime()%1e3;var n=t.substr(0,t.indexOf(" "));0==n.length&&(n=t);var o=t.substr(t.indexOf(" ")+1,4500);0==o.length&&(o="");var s={time:i,level:e,action:n,content:o,appid:this.appid,roomid:this.roomid,userid:this.userid,userName:this.userName,sessionid:this.sessionid};return[JSON.stringify(s)]},e}();a.Logger=r},function(e,t,r){"use strict";var i,n=this&&this.__extends||(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0});var s=r(9),a=r(10),c=r(11),f=r(1),l=r(0),o=r(14),d=r(15),h=function(r){function e(e,t){var o=r.call(this,e,t)||this;return o.testEnvironment=!1,o.heartbeatTimer=null,o.heartbeatInterval=1e4,o.chargeInfos={itemtype:"ChargeInfos",timestamp_begin:0,timestamp_end:0,timestamp_diff_flag:0,timestamp_diff:0,infos:[]},o.chargeInfosTimer=null,o.chargeInfosInterval=6e4,o.qualityTimerInterval=3e3,o.maxRetryCount=5,o.previewVideoList=[],o.signalList={},o.tryCountConnectInterval=3e3,o.checkMessageTimeout=function(){for(var e in o.signalList)o.signalList[e].signal&&o.signalList[e].signal.checkMessageTimeout()},o.getAllInUseUrl=function(){var e=[];for(var t in o.signalList)e.push(t);return e},o.onDisconnectHandle=function(e){if(o.logger.info("zsc.od.0 call"),o.signalList[e]){var t=o.signalList[e];delete o.signalList[e];for(var r=0;r<t.publishConnectedList.length;r++){var i=o.publisherList[t.publishConnectedList[r]];i&&i.publisher&&i.publisher.onDisconnect()}for(r=0;r<t.playConnectedList.length;r++){var n=o.playerList[t.playConnectedList[r]];n&&n.player&&n.player.onDisconnect()}o.stopSignalHeartbeat(),o.stopChargeInfosUpload()}},o.logger=e,o.stateCenter=t,o.dataReport=new s.ZegoDataReport(o.logger),o}return n(e,r),e.prototype.onSignalDisconnected=function(e){},e.prototype.setQualityMonitorCycle=function(e){this.logger.debug("zsc.qmc.0 timeInterval "+e),this.qualityTimerInterval=e},e.prototype.setSessionInfo=function(e,t,r,i){this.logger.debug("zsc.ssi.0 called"),this.appid=e,this.userid=t,this.token=r,this.testEnvironment=i},e.prototype.onPlayStateUpdate=function(e,t,r){},e.prototype.onPlayQualityUpdate=function(e,t){},e.prototype.onPublishStateUpdate=function(e,t,r){},e.prototype.onPublishQualityUpdate=function(e,t){},e.prototype.onUpdateHeartBeartIntervalHandle=function(e){e!=this.heartbeatInterval&&(this.logger.debug("zsc.uhb.0 update "+e),this.heartbeatTimer&&(clearTimeout(this.heartbeatTimer),this.heartbeatTimer=null),this.heartbeatInterval=e,this.startSignalHeartbeat())},e.prototype.switchDevice=function(r,i,e,n,t){var o,s,a,c,d,l,h,u=this,p=null,g=/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent);(o=this.checkPreview(i))?(delete(s=o.mediaStreamConfig).facingMode,c="video"===r?(s.videoInput=e,i.srcObject.getVideoTracks()[0]):(s.audioInput=e,i.srcObject.getAudioTracks()[0]),g||c.stop(),h=o.getMediaStreamConstraints(s),navigator.mediaDevices.getUserMedia(h).then(function(e){for(var t in"video"===r?(d=e.getVideoTracks()[0],o.localStream.removeTrack(o.localStream.getVideoTracks()[0])):(d=e.getAudioTracks()[0],o.localStream.removeTrack(o.localStream.getAudioTracks()[0])),u.publisherList)u.publisherList[t].localVideo===i&&(l=t);l&&(p=u.publisherList[l].publisher,(a=p.peerConnection.getSenders().find(function(e){return e.track.kind===d.kind}))?a.replaceTrack(d):u.logger.warn("zg.sd.0 no sender found, only swithcing device on localMediaElement")),o.localStream.addTrack(d),p.signal.sendStreamStatus(f.getSeq(),p.sessionId,o.localStream.getVideoTracks()[0].enabled?0:2,o.localStream.getAudioTracks()[0].enabled?0:2),n&&n()},function(e){return t&&t(e)})):this.logger.error("zg.sd.0 no preview found")},e.prototype.enableMicrophone=function(e,t){var r=this.checkPreview(e);return r?r.enableMicrophone(t,this):(this.logger.info("zsc.em.0 no preview"),!1)},e.prototype.enableCamera=function(e,t){var r=this.checkPreview(e);return r?r.enableCamera(t,this):(this.logger.error("zsc.ec.0 no preview"),!1)},e.prototype.startPreview=function(e,t,r,i){var n=this;if(!e)return this.logger.error("zsc.sp.0 localVideo null"),!1;var o=this.checkPreview(e);return o?this.logger.warn("zsc.sp.0 localvideo already exist"):(o=new a.ZegoPreview(this.logger),this.previewVideoList.push(o),o.startPreview(e,t,function(){n.logger.debug("zsc.sp.0 call success"),r&&r()},function(e){n.previewVideoList=n.previewVideoList.filter(function(e){return e!==o}),i&&i(e)})),!0},e.prototype.stopPreview=function(e){if(!e)return this.logger.warn("zsc.sp.0 localVideo null"),!1;for(var t in this.publisherList)this.publisherList[t].localVideo===e&&(this.publisherList[t].localVideo=null);var r=this.checkPreview(e);return r?(r.previewSuc&&(r.stopPreview(),this.removePreview(r)),!0):(this.logger.warn("zsc.sp.0 no preview"),!1)},e.prototype.setPublishStateStart=function(n,e,t){var o=this,r=this.getTotalStreamId(n);if(this.publisherList[r])return this.logger.error("zsc.pss.0 publisher already exist"),!1;var i=new c.ZegoPublish(this.logger,null,this.dataReport,this.qualityTimerInterval,this);return i.onPublishStateUpdate=function(e,t,r){var i=o.publisherList[t];i?o.onPublishStateUpdate(e,i.streamId,r):o.logger.error("zsc.psuh.0 cannot find publish "+n)},i.onPublishQualityUpdate=function(e,t){var r=o.publisherList[e];r?o.onPublishQualityUpdate(r.streamId,t):o.logger.error("zsc.psuh.0 cannot find publish "+n)},this.publisherList[r]={localVideo:e,publisher:i,serverUrls:[],retryCount:0,streamId:n,playOption:t,tryCountConnect:1,countConnectTimer:void 0},this.dataReport.eventStart(i.reportSeq,"GetSignalUrl"),!0},e.prototype.getTotalStreamId=function(e){if(this.testEnvironment){var t="zegotest-"+this.appid+"-"+e;return this.logger.info("zsc.gts.0 test streamid "+t),t}return e},e.prototype.startPublishingStream=function(e,t,r){this.logger.info("zsc.sps.0 call");var i=this.getTotalStreamId(e),n=this.publisherList[i];if(!n)return this.logger.error("zsc.sps.0 publisher don't exist"),!1;var o=n.publisher;if(this.dataReport.eventEndWithMsg(o.reportSeq,"GetSignalUrl",{urls:t}),!t||0===t.length)return this.onPublishStateUpdate(f.ENUM_PUBLISH_STATE_UPDATE.error,e,f.publishErrorList.DISPATCH_ERROR),this.logger.info("zsc.sps.0 server don't have signal url"),!1;n.serverUrls=n.serverUrls.concat(t);var s=t.indexOf(this.server);return-1!==s&&(n.serverUrls.splice(s,1),n.serverUrls.unshift(this.server)),this.connectPublishServer(i)},e.prototype.updateWaitingList=function(e,t,r,i,n){t?e.publishWaitingList.push({streamId:r,success:i,error:n}):e.playWaitingList.push({streamId:r,success:i,error:n})},e.prototype.publishStream=function(e){var t,r,i,n,o=this.publisherList[e].publisher;o?(r=t=null,i=this.publisherList[e].playOption,(n=this.checkPreview(this.publisherList[e].localVideo))&&(t=n.localStream,r=n.videoInfo),t||this.logger.info("zsc.ps.0 no localStream"),this.logger.debug("zsc.ps.0 call success"),o.startPublish(e,t,r,n.mediaStreamConfig,i)):this.logger.info("zsc.ps.0 publisher don't exist")},e.prototype.connectPublishServer=function(e){var s=this,t=this.publisherList[e];return t?(this.dataReport.eventStart(t.publisher.reportSeq,"ConnectServer"),this.connetWithReuseSignalServerTimer(e,!0,function(e,t,r){var i,n,o=s.publisherList[e];o?(i=o.publisher)?(s.dataReport.eventEndWithMsg(i.reportSeq,"ConnectServer",{result:0,server:r}),n=t.tokenInfo,s.logger.info("zsc.cps.0 update token success"),n&&n.report&&(i.qualityUpload=n.report,i.qualityUploadInterval=n.report_interval),i.signal=t.signal,o.retryCount=0,s.server=r,s.publishStream(e),s.getTokenSuccess()):s.logger.info("zsc.cps.1 check publisher don't exist"):s.logger.info("zsc.cps.0 after connect publisher don't exist")},function(e,t){s.logger.error("zsc.cps.0 "+e+" connect fail "+t);var r=s.publisherList[e];r?s.shouldRetry(r,t)?(s.logger.info("zsc.cps.1 retry connect"),r.serverUrls.splice(0,1),r.retryCount+=1,s.connectPublishServer(e)):s.onPublishStateUpdate(f.ENUM_PUBLISH_STATE_UPDATE.error,e,f.publishErrorList.DISPATCH_TIMEOUT):s.logger.info("zsc.cps.0 after connect publisher don't exist")}),!0):(this.logger.error("zsc.cps.0 publisher don't exist"),!1)},e.prototype.shouldRetry=function(e,t){return 0!=e.serverUrls.length&&!(e.retryCount>=this.maxRetryCount)&&3==t},e.prototype.getTokenSuccess=function(){this.logger.debug("zsc.gts.0 call")},e.prototype.stopPublishingStream=function(e){var t=this.getTotalStreamId(e),r=this.publisherList[t];r?(this.publisherList[t].countConnectTimer&&clearTimeout(this.publisherList[t].countConnectTimer),delete this.publisherList[t],r.publisher&&(r.publisher.stopPublish(),delete r.publisher),this.removeStreamFromSignal(!0,t),this.stopSignalHeartbeat(),this.stopChargeInfosUpload(),this.logger.debug("zsc.sps.0.1 call success")):this.logger.warn("zsc.sps.0.1 publisher don't exist")},e.prototype.setPlayStreamAudioOutput=function(e,t){var r=this.getTotalStreamId(e);if(null==t||0==t.length)return!1;this.logger.debug("zsc.psao.1 device "+t);var i=this.playerList[r];return i?i.player?i.player.setAudioDestination(t):(this.logger.info("zsc.psao.1 player don't exist"),!1):(this.logger.info("zsc.psao.1 play don't exist"),!1)},e.prototype.setStreamAudioOutput=function(e,t){var r=this;return!(null==t||0==t.length||!e||(this.logger.debug("zsc.ssao.0 device "+t),e?"undefined"!==e.sinkId?(e.setSinkId(t).then(function(){r.logger.info("zsc.ssao.0 success device: "+t)}).catch(function(e){r.logger.info("zsc.ssao.0 "+e.name)}),0):(this.logger.error("zsc.ssao.0 browser does not suppport"),1):(this.logger.error("zsc.ssao.0 no localVideo"),1)))},e.prototype.connetWithReuseSignalServer=function(e,t,s,r,i){var a=this;this.logger.info("zsc.crss.0 begin "+s);var c,d=null;this.signalList[s]?(d=this.signalList[s]).state==l.ENUM_SIGNAL_STATE.connected?(this.logger.info("zsc.crss.0 already connected "+s+" streamId: "+e),t?d.publishConnectedList.push(e):d.playConnectedList.push(e),r(e,d)):d.state==l.ENUM_SIGNAL_STATE.connecting&&(this.logger.debug("zsc.crss.0 signal is connecting "+s+" streamId: "+e),this.updateWaitingList(d,t,e,r,i)):(this.logger.info("zsc.crss.0 new signal "+s+" streamId: "+e),(c=new o.ZegoSignal(this.logger,this.stateCenter)).setSessionInfo(this.appid,this.userid),c.onUpdateHeartBeartInterval=this.onUpdateHeartBeartIntervalHandle,c.onDisconnect=this.onDisconnectHandle,this.signalList[s]={signal:c,state:l.ENUM_SIGNAL_STATE.connecting,publishWaitingList:[],playWaitingList:[],publishConnectedList:[],playConnectedList:[],tokenInfo:null,isTimeOut:!1},this.updateWaitingList(this.signalList[s],t,e,r,i),c.connectServer(this.token,s,function(e,t,r){(d=a.signalList[s]).isTimeOut&&(a.logger.error("zsc.crss.0 connected "+t+" over time"),c.disconnectServer(),delete a.signalList[s]);var i,n,o=0;if(0!=e){for(a.logger.debug("zsc.crss.0 connect failed "+t),o=0;o<d.publishWaitingList.length;o++)(i=d.publishWaitingList[o]).error&&i.error(i.streamId,e);for(o=0;o<d.playWaitingList.length;o++)(n=d.playWaitingList[o]).error&&n.error(n.streamId,e);delete a.signalList[s]}else{for(a.logger.debug("zsc.crss.0 connected success "+t),d.state=l.ENUM_SIGNAL_STATE.connected,d.tokenInfo=r,o=0;o<d.publishWaitingList.length;o++)(i=d.publishWaitingList[o]).success&&i.success(i.streamId,d),d.publishConnectedList.push(i.streamId);for(o=0;o<d.playWaitingList.length;o++)(n=d.playWaitingList[o]).success&&n.success(n.streamId,d),d.playConnectedList.push(n.streamId);d.publishWaitingList=[],d.playWaitingList=[],null==a.heartbeatTimer&&a.startSignalHeartbeat(),null==a.chargeInfosTimer&&a.startChargeInfosUpload()}}))},e.prototype.setPlayStateStart=function(e,t,r,i){var n=this.getTotalStreamId(e);if(this.playerList[n])return this.logger.warn("zsc.pss.1 player already exist"),!1;var o=new d.ZegoPlayWeb(this.logger,null,this.dataReport,this.qualityTimerInterval,this);return o.onPlayStateUpdate=this.onPlayStateUpdate,o.onPlayQualityUpdate=this.onPlayQualityUpdate,o.onVideoSizeChanged=this.onVideoSizeChanged,o.onRemoteCameraStatusUpdate=this.onRemoteCameraStatusUpdate,o.onRemoteMicStatusUpdate=this.onRemoteMicStatusUpdate,this.playerList[n]={player:o,remoteVideo:t,audioOutput:r,signal:null,serverUrls:[],retryCount:0,playOption:i,tryCountConnect:1,countConnectTimer:void 0},this.dataReport.eventStart(o.reportSeq,"GetSignalUrl"),!0},e.prototype.startPlayingStream=function(e,t,r){this.logger.info("zsc.sps.1 start play called");var i=this.getTotalStreamId(e),n=this.playerList[i];if(!n)return this.logger.error("zsc.sps.1 player don't exist"),!1;var o=n.player;if(this.dataReport.eventEndWithMsg(o.reportSeq,"GetSignalUrl",{urls:t}),0==t.length)return this.onPlayStateUpdate(f.ENUM_PLAY_STATE_UPDATE.error,e,f.playErrorList.DISPATCH_ERROR),this.logger.info("zsc.sps.1 server don't have signal url"),!1;n.serverUrls=n.serverUrls.concat(t);var s=t.indexOf(this.server);return-1!==s&&(n.serverUrls.splice(s,1),n.serverUrls.unshift(this.server)),this.connectPlayServer(i)},e.prototype.connectPlayServer=function(e){var s=this,t=this.playerList[e];return t?(this.dataReport.eventStart(t.player.reportSeq,"ConnectServer"),this.connetWithReuseSignalServerTimer(e,!1,function(e,t,r){var i,n,o=s.playerList[e];o?(i=o.player)?(s.dataReport.eventEndWithMsg(i.reportSeq,"ConnectServer",{result:0,server:r}),n=t.tokenInfo,s.logger.info("zsc.cps.1 update token success"),n&&n.report&&(i.qualityUpload=n.report,i.qualityUploadInterval=n.report_interval),i.signal=t.signal,o.retryCount=0,s.server=r,s.playStream(e),s.getTokenSuccess()):s.logger.error("zsc.cps.1 checkplayer don't exist"):s.logger.error("zsc.cps.1 after connect player don't exist")},function(e,t){var r=s.playerList[e];r?s.shouldRetry(r,t)?(s.logger.info("zsc.cps.1 retry connect"),r.serverUrls[0],r.serverUrls.splice(0,1),r.retryCount+=1,s.connectPlayServer(e)):s.onPlayStateUpdate(f.ENUM_PLAY_STATE_UPDATE.error,e,f.playErrorList.TOKEN_ERROR):s.logger.error("zsc.cps.1 after connect player don't exist")}),!0):(this.logger.error("zsc.cps.1 player don't exist"),!1)},e.prototype.connetWithReuseSignalServerTimer=function(r,e,i,t){var n,o,s,a,c=this;if(e&&this.publisherList[r]){if(s=(n=this.publisherList[r].serverUrls)[0==(a=(this.publisherList[r].tryCountConnect-1)%n.length)?n.length-1:a-1],1!==this.publisherList[r].tryCountConnect&&this.signalList[s]&&(this.signalList[s].isTimeOut=!0),this.publisherList[r].tryCountConnect>3*n.length)return void this.logger.error("zs.crsst.0 beyond max limit");this.publisherList[r].countConnectTimer=setTimeout(function(){c.connetWithReuseSignalServerTimer(r,e,i,t)},this.tryCountConnectInterval),o=n[a],this.logger.info("zs.crsst.0 called "+this.publisherList[r].tryCountConnect+" "+o),this.connetWithReuseSignalServer(r,e,o,function(e,t){c.publisherList[r].tryCountConnect=1,i(e,t,o),clearTimeout(c.publisherList[r].countConnectTimer)},this.publisherList[r].tryCountConnect===3*n.length?t:void 0),++this.publisherList[r].tryCountConnect}else if(!e&&this.playerList[r]){if(s=(n=this.playerList[r].serverUrls)[0==(a=(this.playerList[r].tryCountConnect-1)%n.length)?n.length-1:a-1],1!==this.playerList[r].tryCountConnect&&this.signalList[s]&&(this.signalList[s].isTimeOut=!0),this.playerList[r].tryCountConnect>3*n.length)return void this.logger.error("zs.crsst.0 beyond max limit");this.logger.info("zs.crsst.0 called "+this.playerList[r].tryCountConnect),this.playerList[r].countConnectTimer=setTimeout(function(){c.connetWithReuseSignalServerTimer(r,e,i,t)},this.tryCountConnectInterval),o=n[(this.playerList[r].tryCountConnect-1)%n.length],this.connetWithReuseSignalServer(r,e,o,function(e,t){c.playerList[r].tryCountConnect=1,i(e,t,o),clearTimeout(c.playerList[r].countConnectTimer)},this.playerList[r].tryCountConnect===3*n.length?t:void 0),++this.playerList[r].tryCountConnect}},e.prototype.playStream=function(e){var t=this.playerList[e].player;t?(this.logger.info("zsc.ps.1 call success"),t.startPlay(e,this.playerList[e].remoteVideo,this.playerList[e].audioOutput,this.playerList[e].playOption)):this.logger.warn("zsc.ps.1 player don't exist")},e.prototype.removeStreamFromSignal=function(e,t){var r=[];for(var i in this.signalList){var n=this.signalList[i];if(e){for(var o=0;o<n.publishConnectedList.length;o++)if(n.publishConnectedList[o]===t){this.logger.debug("zsc.rsfs.0 found from publish"),n.publishConnectedList.splice(o,1);break}}else for(var s=0;s<n.playConnectedList.length;s++)if(n.playConnectedList[s]===t){this.logger.debug("zsc.rsfs.0 found from play"),n.playConnectedList.splice(s,1);break}0==n.publishConnectedList.length&&0==n.playConnectedList.length&&(n.signal.disconnectServer(),r.push(i))}for(var a=0;a<r.length;a++)delete this.signalList[r[a]]},e.prototype.stopSignalHeartbeat=function(){this.logger.debug("zsc.ssh.1 call");var e=0;for(var t in this.signalList)e+=1;this.heartbeatTimer&&0==e&&(this.logger.info("zsc.ssh.1 stop"),clearTimeout(this.heartbeatTimer),this.heartbeatTimer=null)},e.prototype.stopChargeInfosUpload=function(){this.logger.debug("zsc.sciu.0 call");var e=0;for(var t in this.signalList)e+=1;this.chargeInfosTimer&&0==e&&(this.logger.info("zsc.sciu.0 stop"),clearTimeout(this.chargeInfosTimer),this.chargeInfosTimer=null)},e.prototype.stopPlayingStream=function(e){var t=this.getTotalStreamId(e),r=this.playerList[t];r?(this.playerList[t].countConnectTimer&&clearTimeout(this.playerList[t].countConnectTimer),delete this.playerList[t],r.player&&(r.player.stopPlay(),delete r.player),this.removeStreamFromSignal(!1,t),this.stopSignalHeartbeat(),this.stopChargeInfosUpload(),this.logger.debug("zsc.sps.1.1 call success")):this.logger.info("zsc.sps.1.1 player don't exist")},e.prototype.reset=function(){for(var e in this.publisherList)this.publisherList[e].publisher&&this.publisherList[e].publisher.stopPublish();for(var t in this.playerList)this.playerList[t].player&&this.playerList[t].player.stopPlay();for(var r in this.signalList)this.signalList[r].signal&&this.signalList[r].signal.disconnectServer();this.playerList={},this.publisherList={},this.signalList={},this.server="",this.heartbeatTimer&&(clearTimeout(this.heartbeatTimer),this.heartbeatTimer=null)},e.prototype.startSignalHeartbeat=function(){var e=this;this.logger.debug("zsc.ssh.0 call"),this.heartbeatTimer&&(clearTimeout(this.heartbeatTimer),this.heartbeatTimer=null),this.heartbeatTimer=setTimeout(function(){e.checkSignalHeartbeat()},this.heartbeatInterval)},e.prototype.startChargeInfosUpload=function(){var e=this;this.logger.debug("zsc.sciu.0 call"),this.chargeInfosTimer&&(clearTimeout(this.chargeInfosTimer),this.chargeInfosTimer=null),this.chargeInfosTimer=setTimeout(function(){e.checkChargeInfos()},this.chargeInfosInterval)},e.prototype.checkChargeInfos=function(){this.logger.debug("zsc.cci.0 call");var n={is_publishing:0,play_max_audio_bitrate:0,play_stream_resolution_infos:[]};for(var e in this.chargeInfos.timestamp_begin=(new Date).getTime(),this.publisherList){this.publisherList[e].publisher.state===l.ENUM_PUBLISH_STATE.publishing&&(n.is_publishing=1);break}n.play_max_audio_bitrate=0;var o=this;for(var t in this.playerList)!function(e){var t=o.playerList[e].remoteVideo,r={video_width:t.videoWidth||0,video_height:t.videoHeight||0,count:1};if(!n.play_stream_resolution_infos.find(function(e){return e.video_width==r.video_width&&e.video_height==r.video_height&&(e.count++,!0)})&&n.play_stream_resolution_infos.push(r),0==r.video_width&&0==r.video_height){var i=1e3*o.playerList[e].player.lastPlayStats.audioBitrate;i>n.play_max_audio_bitrate&&(n.play_max_audio_bitrate=i)}}(t);0!==this.chargeInfos.timestamp_end?(this.chargeInfos.timestamp_diff=this.chargeInfos.timestamp_begin-this.chargeInfos.timestamp_end,this.chargeInfos.timestamp_diff_flag=1):(this.chargeInfos.timestamp_diff=0,this.chargeInfos.timestamp_diff_flag=0),this.chargeInfos.timestamp_end=(new Date).getTime(),this.chargeInfos.infos=[n],0!==n.play_stream_resolution_infos.length&&this.logger.report(this.chargeInfos),this.chargeInfosTimer&&this.startChargeInfosUpload()},e.prototype.checkSignalHeartbeat=function(){for(var e in this.logger.debug("zsc.csh.0 call"),this.signalList)this.signalList[e].signal&&this.signalList[e].signal.sendHeartbeat();this.heartbeatTimer&&this.startSignalHeartbeat()},e.prototype.checkPreview=function(e){for(var t=0;t<this.previewVideoList.length;t++)if(this.previewVideoList[t].localVideo===e)return this.previewVideoList[t];return null},e.prototype.removePreview=function(e){for(var t=0;t<this.previewVideoList.length;t++)if(this.previewVideoList[t]===e){this.previewVideoList.splice(t,1);break}},e.prototype.onPlayerStreamUrlUpdate=function(e,t,r){},e.prototype.onVideoSizeChanged=function(e,t,r){},e.prototype.onRemoteCameraStatusUpdate=function(e,t){},e.prototype.onRemoteMicStatusUpdate=function(e,t){},e.prototype.setPublishStreamConstraints=function(e,t,r,i){var n=this;e=this.getTotalStreamId(e);var o=this.publisherList[e],s=/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent);if(o){var a=this.checkPreview(o.localVideo);if(a)if(!t||0==Object.keys(t).length||t.width<120||t.height<120)this.logger.error("zc.spsc.0 constraints wrong");else{a.mediaStreamConfig.videoInput!==t.videoInput&&delete a.mediaStreamConfig.facingMode&&delete t.facingMode;var c=Object.assign(a.mediaStreamConfig,t);if(c.externalCapture||c.externalMediaStream)this.logger.error("zc.spsc.0 do not support external stream");else{var d=a.getMediaStreamConstraints(c),l=o.publisher.localStream;if(!o.publisher.peerConnection.getSenders||!o.publisher.peerConnection.getSenders()[0].replaceTrack)return this.logger.error("zc.spsc.0 set publish constraints is not supported"),void(i&&i({code:1,msg:"not supported"}));s||l.getTracks().forEach(function(e){return e.stop()}),navigator.mediaDevices.getUserMedia(d).then(function(e){e.getTracks().forEach(function(t){var e=l.getTracks().find(function(e){return e.kind===t.kind});o.publisher.peerConnection.getSenders().find(function(e){return e.track.kind===t.kind}).replaceTrack(t),l.removeTrack(e),l.addTrack(t),n.logger.info("zc.spsc.0 set constraints success")}),r&&r()}).catch(function(e){n.logger.error("zc.spsc.0 fail reason ",e.name),i&&i({code:2,msg:e.name})})}}else this.logger.error("zc.spsc.0 preview no found")}else this.logger.error("zc.spsc.0 publisher not found")},e}(r(16).ZegoStreamCenter);t.ZegoStreamCenterWeb=h},function(e,t,r){"use strict";var o=this&&this.__assign||Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e};Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e){this.log=e,this.dataStatistics={},this.logger=e}return e.prototype.newReport=function(e){this.dataStatistics[e]={abs_time:Date.now(),time_consumed:0,error:0,events:[]}},e.prototype.addMsgExt=function(e,t){this.dataStatistics[e]&&(this.dataStatistics[e].msg_ext=t)},e.prototype.eventStart=function(e,t){this.dataStatistics[e]?null!=this.dataStatistics[e].events?this.dataStatistics[e].events.push({event:t,abs_time:Date.now(),time_consumed:0}):this.logger.warn("zd.es.0 no events"):this.logger.warn("zd.es.0 no seq match")},e.prototype.eventEnd=function(e,t,r){if(this.dataStatistics[e]){var i=this.dataStatistics[e].events;if(i&&0!==i.length){for(var n=i.length-1;0<=n;n--)if(i[n].event==t&&i[n].time_consumed){i[n].time_consumed=Date.now()-i[n].abs_time;break}}else this.logger.info("zd.ee.0 no events")}else this.logger.info("zd.ee.0 no seq match")},e.prototype.eventEndWithMsg=function(e,t,r){if(this.dataStatistics[e]){var i=this.dataStatistics[e].events;if(i){for(var n=i.length-1;0<=n;n--)if(i[n].event==t&&i[n].time_consumed){i[n].time_consumed=Date.now()-i[n].abs_time,null==i[n].msg_ext&&(i[n].msg_ext={}),i[n].msg_ext=o({},r);break}}else this.logger.warn("zd.ee.0 no events")}else this.logger.warn("zd.ee.0 no seq match")},e.prototype.addEventInfo=function(e,t,r,i){if(this.dataStatistics[e]){var n=this.dataStatistics[e].events;if(null!=n){for(var o=n.length-1;0<=o;o--)if(n[o].event==t&&null!=n[o].time_consumed&&n[o].event==t&&null!=n[o].time_consumed){null==n[o].msg_ext&&(n[o].msg_ext={}),n[o].msg_ext[r]=i;break}}else this.logger.warn("zd.aei.0 no events")}else this.logger.warn("zd.aei.0 no seq match")},e.prototype.addEvent=function(e,t,r){this.dataStatistics[e]?this.dataStatistics[e].events&&(r?this.dataStatistics[e].events.push({event:t,abs_time:Date.now(),msg_ext:r}):this.dataStatistics[e].events.push({event:t,abs_time:Date.now()})):this.logger.warn("zd.ae.0 no seq match")},e.prototype.uploadReport=function(e,t){var r=this.dataStatistics[e];null!=r&&(r.itemtype=t,r.time_consumed=Date.now()-r.abs_time,this.logger.report(r),delete this.dataStatistics[e])},e}();t.ZegoDataReport=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=r(0),o=r(1),i=function(){function e(e){var n=this;this.log=e,this.localVideo=null,this.localStream=null,this.previewSuc=!1,this.enableMicrophone=function(t,e){if(!n.localStream)return n.logger.error("zp.em.2 no localStream"),!1;for(var r in n.localStream.getAudioTracks().forEach(function(e){e.enabled=t}),e.publisherList){var i=e.publisherList[r].publisher;i.localStream==n.localStream&&i.signal.sendStreamStatus(o.getSeq(),i.sessionId,n.localStream&&n.localStream.getVideoTracks()[0]&&!0===n.localStream.getVideoTracks()[0].enabled?0:2,t?0:2)}return n.logger.debug("zp.em.2 call success"),!0},this.enableCamera=function(t,e){if(!n.localStream)return n.logger.error("zp.ec.2 no localStream"),!1;for(var r in n.localStream.getVideoTracks().forEach(function(e){e.enabled=t}),e.publisherList){var i=e.publisherList[r].publisher;i.localStream==n.localStream&&i.signal.sendStreamStatus(o.getSeq(),i.sessionId,t?0:2,n.localStream&&n.localStream.getAudioTracks()[0]&&1==n.localStream.getAudioTracks()[0].enabled?0:2)}return n.logger.debug("zp.ec.2 call success"),!0},this.setAudioDestination=function(e){return n.localVideo?"undefined"!==n.localVideo.sinkId?(n.localVideo.setSinkId(e).then(function(){n.logger.info("zp.sad.2 success device: "+e)}).catch(function(e){n.logger.info("zp.sad.2 "+e.name)}),!0):(n.logger.error("zp.sad.2 browser does not suppport"),!1):(n.logger.error("zp.sad.2 no localVideo"),!1)},this.logger=e}return e.prototype.getMediaStreamConstraints=function(e){var t,r,i,n,o,s={audio:null,video:null};return s.audio=!1,s.video=!1,e.audio&&(void 0===e.audioInput&&void 0===e.noiseSuppression&&void 0===e.autoGainControl&&void 0===e.echoCancellation?(s.audio={},s.audio.noiseSuppression=!0,s.audio.autoGainControl=!0,s.audio.echoCancellation=!0):(s.audio={},void 0!==e.audioInput&&null!==e.audioInput&&(s.audio.deviceId=e.audioInput),void 0!==e.noiseSuppression&&(s.audio.noiseSuppression=e.noiseSuppression),void 0!==e.autoGainControl&&(s.audio.autoGainControl=e.autoGainControl),void 0!==e.echoCancellation&&(s.audio.echoCancellation=e.echoCancellation))),e.video&&(t=640,r=480,i=15,n=800,1===e.videoQuality?(t=a.ENUM_RESOLUTION_TYPE.LOW.width,r=a.ENUM_RESOLUTION_TYPE.LOW.height,i=a.ENUM_RESOLUTION_TYPE.LOW.frameRate,n=a.ENUM_RESOLUTION_TYPE.LOW.bitRate):2===e.videoQuality?(t=a.ENUM_RESOLUTION_TYPE.MEDIUM.width,r=a.ENUM_RESOLUTION_TYPE.MEDIUM.height,i=a.ENUM_RESOLUTION_TYPE.MEDIUM.frameRate,n=a.ENUM_RESOLUTION_TYPE.MEDIUM.bitRate):3===e.videoQuality?(t=a.ENUM_RESOLUTION_TYPE.HIGH.width,r=a.ENUM_RESOLUTION_TYPE.HIGH.height,i=a.ENUM_RESOLUTION_TYPE.HIGH.frameRate,n=a.ENUM_RESOLUTION_TYPE.HIGH.bitRate):4===e.videoQuality?(t=e.width,r=e.height,i=e.frameRate,n=e.maxBitRate||800):this.logger.info("zp.gmsc.2 user default"),!0===e.horizontal&&(o=r,r=t,t=o),s.video={width:t,height:r,frameRate:i,bitRate:n},null!=e.facingMode?s.video.facingMode=e.facingMode:null!=e.videoInput&&null!=e.videoInput&&(s.video.deviceId={exact:e.videoInput}),this.logger.info("zp.gmsc.2 width: "+t+" height: "+r+" rate: "+i)),s},e.prototype.startPreview=function(e,t,r,i){var n,o=this;if(this.logger.debug("zp.sv.2 called"),this.localVideo=e,this.mediaStreamConfig=t,void 0!==navigator.mediaDevices&&null!=navigator.mediaDevices.getUserMedia){if(t.externalMediaStream instanceof MediaStream)return this.logger.debug("zp.sv.2 use external media stream"),this.previewSuc=!0,this.localStream=t.externalMediaStream,this.videoInfo={width:t.width,height:t.height,frameRate:t.frameRate,minBitRate:t.minBitRate,maxBitRate:t.maxBitRate},void(r&&r());t.externalCapture?this.captureStream(e,t)?(this.previewSuc=!0,r&&r()):i&&i("external capture fail"):(n=this.getMediaStreamConstraints(t),this.videoInfo=n.video,this.videoInfo&&(this.videoInfo.minBitRate=t.minBitRate||n.video.bitRate),this.videoInfo&&(this.videoInfo.maxBitRate=t.maxBitRate||n.video.bitRate),this.logger.info("zp.sv.2 ",JSON.stringify(n)),navigator.mediaDevices.getUserMedia(n).then(function(e){return o.logger.info("zp.sv.2 success"),o.localVideo?(o.localVideo.srcObject=e,o.localStream=e,o.previewSuc=!0,void(r&&r())):(o.logger.info("zp.sv.2 no localVideo"),void(i&&i("no localVideo")))},function(e){o.logger.info("zp.sv.2 failed "+e.message),i&&i(e.name)}))}else i&&i("browser don't support")},e.prototype.captureStream=function(e,t){if(!e)return this.logger.info("zp.cs.2 no local video"),!1;var r,i;if(e.captureStream)r=e.captureStream(),this.logger.debug("zp.cs.2 captureStream");else{if(!e.mozCaptureStream)return this.logger.info("zp.cs.2 don't support capture stream"),!1;r=e.mozCaptureStream(),this.logger.debug("zp.cs.2 mozCaptureStream")}return 0==r.getTracks().length?(this.logger.error("zp.cs.2 external capture tracks no found"),!1):(this.localStream=r,this.videoInfo={width:e.videoWidth,height:e.videoHeight,frameRate:t.frameRate||15,minBitRate:800,maxBitRate:800},"number"==typeof t.bitRate?(i<48&&(i=48),1e4<i&&(i=1e4),this.videoInfo.minBitRate=this.videoInfo.maxBitRate=t.bitRate):t.bitRate&&t.bitRate.minBitRate&&t.bitRate.maxBitRate&&"number"==typeof t.bitRate.minBitRate&&"number"==typeof t.bitRate.maxBitRate&&t.bitRate.minBitRate<=t.bitRate.maxBitRate&&(this.videoInfo.minBitRate=t.bitRate.minBitRate<48?48:t.bitRate.minBitRate,this.videoInfo.maxBitRate=1e4<t.bitRate.maxBitRate?1e4:t.bitRate.maxBitRate),this.logger.debug("zp.cs.2 called success"),!0)},e.prototype.stopPreview=function(){var e;this.logger.info("zp.sv.2.1 called"),this.localStream&&((e=this.localStream.getTracks()).reverse(),e.forEach(function(e){e.stop()}),this.localStream=null,this.localVideo.srcObject=null,this.localVideo=null,this.videoInfo=null)},e}();t.ZegoPreview=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var c=r(0),h=r(1),i=r(12),o=r(3),n=r(4),s=r(13),a=function(){function e(e,t,r,i,n){this.state=c.ENUM_PUBLISH_STATE.stop,this.sessionId=0,this.waitingICETimeInterval=5e3,this.waitingAnswerTimeInterval=5e3,this.candidateInfo=[],this.waitingICETimer=null,this.waitingAnswerTimer=null,this.qualityTimer=null,this.publishQualityList=[],this.maxQualityListCount=10,this.lastPublishStats={},this.reportSeq=h.getSeq(),this.qualityUpload=!1,this.qualityUploadInterval=3e4,this.qualityUploadLastTime=0,this.qualitySeq=0,this.maxRetryCount=3,this.currentRetryCount=0,this.retryState=c.ENUM_RETRY_STATE.didNotStart,this.waitingServerTimerInterval=3e3,this.waitingServerTimer=null,this.videoInfo={width:0,height:0,frameRate:0,minBitRate:0,maxBitRate:0},this.mediaStreamConfig=null,this.offerSeq=0,this.qualityCount=0,this.closeSessionSignal=!1,this.audioBitRate=48e3,this.localSdpRevert=!1,this.videoDecodeType="H264",this.stateNego=c.ENUM_PUBLISH_STATE_NEGO.stop,this.negoInterval=25e3,this.negoTryCount=1,this.negoTryMaxCount=2,this.publishEvent=!1,this.nextSignalTryCount=1,this.waittingConnectedTimer=null,this.waittingConnectedInerval=15e3,this.tryingNexitSignal=!1,this.logger=e,this.signal=t,this.dataReport=r,this.qualityTimeInterval=i,this.audioMixing=new o.audioMixUtil(e),this.streamCenter=n,r.newReport(this.reportSeq)}return e.prototype.publishStateUpdateError=function(e){this.logger.error("zp.psu.0 call "+JSON.stringify(e)),this.state===c.ENUM_PUBLISH_STATE.stop||this.negoTryCount<this.negoTryMaxCount&&this.stateNego<c.ENUM_PUBLISH_STATE_NEGO.iceConnected||(0!=this.sessionId&&this.shouldSendCloseSession(e)&&(this.signal.sendCloseSession(h.getSeq(),this.sessionId,1),this.closeSessionSignal=!0),this.state=c.ENUM_PUBLISH_STATE.stop,this.onPublishStateUpdate(h.ENUM_PUBLISH_STATE_UPDATE.error,this.streamId,e),this.resetPublish())},e.prototype.resetPublish=function(){this.logger.info("zp.rp.0 call"),this.streamId=null,this.state=c.ENUM_PUBLISH_STATE.stop,this.publishEvent=!1,null==this.peerConnection&&null==this.peerConnection||(this.peerConnection.close(),this.peerConnection=null),null!=this.waitingAnswerTimer&&(clearTimeout(this.waitingAnswerTimer),this.waitingAnswerTimer=null),null!=this.waitingICETimer&&(clearTimeout(this.waitingICETimer),this.waitingICETimer=null),null!=this.negoTimer&&(clearTimeout(this.negoTimer),this.negoTimer=null),null!=this.waittingConnectedTimer&&(clearTimeout(this.waittingConnectedTimer),this.waittingConnectedTimer=null),this.clearPublishQualityTimer(),this.signal&&(this.signal.unregisterPushCallback("CandidateInfoPush",this.sessionId),this.signal.unregisterPushCallback("MediaDescPush",this.sessionId),this.signal.unregisterPushCallback("CloseSessionPush",this.sessionId)),this.sessionSeq=0,this.offerSeq=0,this.candidateInfo=[],this.publishQualityList=[],this.qualityUploadLastTime=0,this.currentRetryCount=0,this.retryState=c.ENUM_RETRY_STATE.didNotStart,this.clearTryPublishTimer()},e.prototype.clearTryPublishTimer=function(){null!=this.waitingServerTimer&&(clearTimeout(this.waitingServerTimer),this.waitingServerTimer=null)},e.prototype.clearPublishQualityTimer=function(){null!=this.qualityTimer&&(clearInterval(this.qualityTimer),this.qualityTimer=null),this.lastPublishStats={},this.qualityCount=0},e.prototype.shouldSendCloseSession=function(e){return this.state!=c.ENUM_PUBLISH_STATE.stop&&this.state!=c.ENUM_PUBLISH_STATE.waitingSessionRsp},e.prototype.startPublish=function(e,t,r,i,n){var o=this;this.logger.info("zp.sp.0 called"),this.signal&&this.signal.negoInterval&&(this.negoInterval=this.signal.negoInterval),this.signal&&this.signal.negoTryCount&&(this.negoTryCount=this.signal.negoTryCount),this.signal&&this.signal.negoTryMaxCount&&(this.negoTryMaxCount=this.signal.negoTryMaxCount),e?(this.streamId=e,this.localStream=t,this.mediaStreamConfig=i,this.playOption=n||{},-1<navigator.userAgent.toLowerCase().indexOf("firefox")&&(i.externalCapture||i.externalMediaStream)&&(this.localStream.onaddtrack=function(){o.logger.info("zp.sp.0 Track added");var t=o.localStream.getVideoTracks(),r=o.localStream.getAudioTracks();1<t.length?(o.peerConnection.getSenders().find(function(e){return e.track.kind===t[1].kind}).replaceTrack(t[1]),o.localStream.removeTrack(t[0])):1<r.length&&(o.peerConnection.getSenders().find(function(e){return e.track.kind===r[1].kind}).replaceTrack(r[1]),o.localStream.removeTrack(r[0]))}),r&&(this.videoInfo=r),n&&n.audioBitRate&&(this.audioBitRate=n.audioBitRate),n&&n.videoDecodeType&&(this.videoDecodeType=n.videoDecodeType),this.sessionSeq=h.getSeq(),this.dataReport.eventStart(this.reportSeq,"CreateSession"),this.signal.createSession(this.sessionSeq,0,0,e,n&&n.streamParams,function(e,t,r){o.dataReport.eventEndWithMsg(o.reportSeq,"CreateSession",{sessionId:r.session_id}),o.logger.info("zp.sp.0 sessionId:"+r.session_id),o.sessionSeq==e?0!==r.result?(o.logger.error("zp.sp.0 create session failed "+r.result),o.publishStateUpdateError(h.publishErrorList.CREATE_SESSION_ERROR)):(o.sessionId=r.session_id,o.logger.debug("zp.sp.0 create session success "+o.sessionId),o.onCreatePublishSessionSuccess(r)):o.logger.error("zp.sp.0 seq is not match.")},function(e,t){o.dataReport.eventEndWithMsg(o.reportSeq,"CreateSession",{error:e}),o.publishStateUpdateError(h.publishErrorList.SEND_SESSION_TIMEOUT)}),this.state=c.ENUM_PUBLISH_STATE.waitingSessionRsp,this.logger.info("zp.sp.0 called success"),this.stateNego=c.ENUM_PUBLISH_STATE_NEGO.start,this.negoTimer=setTimeout(function(){o.stateNego!==c.ENUM_PUBLISH_STATE_NEGO.iceConnected&&o.negoTryCount<o.negoTryMaxCount?(o.signal.sendCloseSession(h.getSeq(),o.sessionId,1),o.resetPublish(),o.startPublish(e,t,r,i,n),++o.negoTryCount):o.stateNego!==c.ENUM_PUBLISH_STATE_NEGO.iceConnected&&o.negoTryCount===o.negoTryMaxCount&&(o.logger.error("zp.sp.0 waiting timeout"),o.publishStateUpdateError(h.publishErrorList.SERVER_NEGO_TIMEOUT))},this.negoInterval)):this.logger.error("zp.sp.0 streamId is null")},e.prototype.onCreatePublishSessionSuccess=function(e){var i=this;this.logger.info("zp.ops.0 called");var t=[];e.turn_server&&t.push(e.turn_server),e.stun_server&&t.push(e.stun_server);var r={iceTransportPolicy:"relay",iceServers:[{urls:t,username:e.turn_username,credential:e.turn_auth_key}]};this.logger.info("zp.ops.0 username: "+e.turn_username),this.logger.info("zp.ops.0 credential: "+e.turn_auth_key),this.peerConnection=new RTCPeerConnection(r),this.peerConnection.onicecandidate=function(e){i.onIceCandidate(e)},this.peerConnection.onsignalingstatechange=function(e){i.onConnectionStateChange(e)},this.peerConnection.oniceconnectionstatechange=function(e){i.onIceConnectionStateChange(e)};var n=[],o=[];this.localStream&&(this.localStream.getTracks().forEach(function(e){i.peerConnection.addTrack(e,i.localStream)}),n=this.localStream.getVideoTracks(),o=this.localStream.getAudioTracks(),0<n.length&&this.logger.info("zp.ops.0 video device: "+n[0].label),0<o.length&&this.logger.info("zp.ops.0 audio device: "+o[0].label));var s={offerToReceiveAudio:0<o.length?1:0,offerToReceiveVideo:0<n.length?1:0};this.logger.info("zp.ops.0 createOffer: "+JSON.stringify(s)),this.dataReport.eventStart(this.reportSeq,"CreateOffer"),this.peerConnection.createOffer(s).then(function(e){i.dataReport.eventEnd(i.reportSeq,"CreateOffer"),i.onCreateOfferSuccess(e)},function(e){i.dataReport.eventEndWithMsg(i.reportSeq,"CreateOffer",{error:e.toString()}),i.logger.error("zp.ops.0 create offer error "+e.toString()),i.publishStateUpdateError(h.publishErrorList.CREATE_OFFER_ERROR)}),this.signal.registerPushCallback("CandidateInfoPush",this.sessionId,function(e,t,r){i.onRecvCandidateInfo(e,t,r)}),this.signal.registerPushCallback("CloseSessionPush",this.sessionId,function(e,t,r){i.onRecvCloseSession(e,t,r)}),this.signal.registerPushCallback("MediaDescPush",this.sessionId,function(e,t,r){i.onRecvMediaDescription(e,t,r)}),this.signal.registerPushCallback("SessionResetPush",this.sessionId,function(e,t,r){i.onRecvResetSession(e,t,r)}),this.signal.registerPushCallback("PublishEventPush",this.sessionId,function(e,t,r){i.onRecvPublishEvent(e,t,r)}),this.logger.debug("zp.ops.0 call success")},e.prototype.onCreateOfferSuccess=function(e){var t=this;0!=this.videoInfo.maxBitRate&&(e.sdp=this.updateBandwidthRestriction(e.sdp,this.videoInfo.maxBitRate)),e.sdp=e.sdp.replace(/sendrecv/g,"sendonly"),e.sdp=e.sdp.replace(/useinbandfec=\d+/,"maxaveragebitrate="+this.audioBitRate),/m=video[\s\S]*m=audio/.test(e.sdp)&&(this.localSdpRevert=!0),e.sdp=n.sdpUtil.getSDPByVideDecodeType(e.sdp,this.videoDecodeType),this.logger.info("zp.oco.0 localSdp1 "+e.sdp.substr(0,e.sdp.length/2)),this.logger.info("zp.oco.0 localSdp2 "+e.sdp.substr(e.sdp.length/2)),this.dataReport.eventStart(this.reportSeq,"SetLocalDescription"),this.peerConnection.setLocalDescription(e).then(function(){t.dataReport.eventEnd(t.reportSeq,"SetLocalDescription"),t.onSetLocalDescriptionSuccess(e)},function(e){t.dataReport.eventEndWithMsg(t.reportSeq,"SetLocalDescription",{error:e.toString()}),t.logger.error("zp.oco.0 error "+e.toString()),t.publishStateUpdateError(h.publishErrorList.SET_LOCAL_DESC_ERROR)})},e.prototype.updateBandwidthRestriction=function(e,t){var r="AS";return"firefox"===i.browserDetails.browser&&(t=1e3*(t>>>0),r="TIAS"),e=-1===e.indexOf("b="+r+":")?(e=e.replace(/c=IN (.*)\r\n/g,"c=IN $1\r\nb="+r+":"+t+"\r\n")).replace("b="+r+":"+t+"\r\n",""):(e=e.replace(new RegExp("b="+r+":.*\r\n","g"),"b="+r+":"+t+"\r\n")).replace("b="+r+":"+t+"\r\n","")},e.prototype.onSetLocalDescriptionSuccess=function(e){var i=this;this.logger.info("zp.osd.0 success");var t={sdp:e.sdp,width:this.videoInfo.width,height:this.videoInfo.height,frameRate:this.videoInfo.frameRate,video_min_kpbs:this.videoInfo.minBitRate,video_max_kpbs:this.videoInfo.maxBitRate,audio_kpbs:48,keyframe_intv:2};this.offerSeq=h.getSeq(),this.dataReport.eventStart(this.reportSeq,"SendMediaDesc"),this.signal.sendMediaDesc(this.offerSeq,this.sessionId,0,t,function(e,t,r){i.offerSeq==e&&i.sessionId==t?(i.logger.info("zp.osd.0 send success"),i.dataReport.eventEnd(i.reportSeq,"SendMediaDesc"),i.waitingAnswerTimer=setTimeout(function(){i.state==c.ENUM_PUBLISH_STATE.waitingServerAnswer&&(i.logger.error("zp.osd.0 waiting timeout"),i.publishStateUpdateError(h.publishErrorList.SERVER_MEDIA_DESC_TIMEOUT))},i.waitingAnswerTimeInterval),i.logger.info("zp.osd.0 send success stateNego:waiterAnswer"),i.stateNego=c.ENUM_PUBLISH_STATE_NEGO.waiterAnswer,i.state=c.ENUM_PUBLISH_STATE.waitingServerAnswer):i.logger.error("zp.osd.0 seq or sessionId is not equal")},function(e,t){i.dataReport.eventEndWithMsg(i.reportSeq,"SendMediaDesc",{error:e}),i.publishStateUpdateError(h.publishErrorList.SEND_MEDIA_DESC_TIMEOUT)}),this.state=c.ENUM_PUBLISH_STATE.waitingOffserRsp,this.logger.debug("zp.osd.0 call success")},e.prototype.onRecvMediaDescription=function(e,t,r){this.logger.info("zp.ormd.0 received"),this.state==c.ENUM_PUBLISH_STATE.waitingServerAnswer?(this.stateNego=c.ENUM_PUBLISH_STATE_NEGO.waitingCandidate,this.logger.info("zp.orm.0 received stateNego:waitingCandidate"),null!=this.waitingAnswerTimer&&(clearTimeout(this.waitingAnswerTimer),this.waitingAnswerTimer=null),this.dataReport.addEvent(this.reportSeq,"RecvMediaDesc"),this.signal.sendMediaDescAck(e,this.sessionId,0),1==r.type?this.onGetRemoteOfferSucceses(r.sdp):this.publishStateUpdateError(h.publishErrorList.SERVER_MEDIA_DESC_ERROR)):this.logger.info("zp.ormd.0 current state "+this.state+" not allowed")},e.prototype.onGetRemoteOfferSucceses=function(e){var t,r,i,n,o,s=this;48e3!==this.audioBitRate&&(e=e.replace(/maxaveragebitrate=(\d+)/,"maxaveragebitrate="+this.audioBitRate)),this.localSdpRevert&&(t=[/[\s\S]*m=audio/.exec(e)[0].replace("m=audio",""),/m=video[\s\S]*/.exec(e)[0],/m=audio[\s\S]*m=video/.exec(e)[0].replace("m=video","")],i=t[1],n=t[2],o=/a=group:BUNDLE\s+(\w+)\s+(\w+)/.exec(r=t[0]),e=(r=r.replace(/a=group:BUNDLE\s+(\w+)\s+(\w+)/,"a=group:BUNDLE "+o[2]+" "+o[1]))+i+n),this.logger.info("zp.oro.0 remoteSdp:",e);var a={type:"answer",sdp:e,toJSON:function(){}};this.dataReport.eventStart(this.reportSeq,"SetRemoteDescription"),this.peerConnection.setRemoteDescription(new RTCSessionDescription(a)).then(function(){s.logger.info("zp.oro.0 set success"),s.dataReport.eventEnd(s.reportSeq,"SetRemoteDescription")},function(e){s.logger.error("zp.oro.0 failed: "+e.toString()),s.dataReport.eventEndWithMsg(s.reportSeq,"SetRemoteDescription",{error:e.toString()}),s.publishStateUpdateError(h.publishErrorList.SET_REMOTE_DESC_ERROR)}),this.state=c.ENUM_PUBLISH_STATE.waitingServerICE,this.waitingICETimer=setTimeout(function(){s.state==c.ENUM_PUBLISH_STATE.waitingServerICE&&(s.logger.error("zp.orod.0 waiting server timeout"),s.publishStateUpdateError(h.publishErrorList.SERVER_CANDIDATE_TIMEOUT))},this.waitingICETimeInterval),this.logger.debug("zp.oro.0 call success")},e.prototype.onIceConnectionStateChange=function(e){var t=this;this.state!=c.ENUM_PUBLISH_STATE.stop&&null!=this.peerConnection&&(this.logger.info("zp.oics.0 stateChanged "+this.peerConnection.iceConnectionState),"connected"===this.peerConnection.iceConnectionState?(this.logger.info("zp.oics.0 connected state "+this.state),this.dataReport.eventEnd(this.reportSeq,"IceConnected"),this.stateNego=c.ENUM_PUBLISH_STATE_NEGO.iceConnected,this.waittingConnectedTimer&&clearTimeout(this.waittingConnectedTimer),this.waittingConnectedTimer=null,this.logger.info("zp.oisc.0  stateNego:iceConnected"),this.negoTryCount=1,this.nextSignalTryCount=1,this.negoTimer&&(clearTimeout(this.negoTimer),this.negoTimer=null),this.publishEvent&&this.publishSuccess()):"closed"===this.peerConnection.iceConnectionState?(this.dataReport.addEvent(this.reportSeq,"IceClosed"),this.checkPublishConnectionFailedState(this.peerConnection.iceConnectionState)):"failed"===this.peerConnection.iceConnectionState?(this.dataReport.addEvent(this.reportSeq,"IceFailed"),this.checkPublishConnectionFailedState(this.peerConnection.iceConnectionState)):"disconnected"===this.peerConnection.iceConnectionState&&(this.dataReport.addEvent(this.reportSeq,"IceDisconnected"),this.waittingConnectedTimer=setTimeout(function(){t.tryingNexitSignal||t.tryNextSignal(h.publishErrorList.MEDIA_CONNECTION_DISCONNECTED)},this.waittingConnectedInerval)))},e.prototype.onIceCandidate=function(e){var t;this.logger.info("zp.oic.0 candidate"+e.candidate),e.candidate&&(this.logger.info("zp.oic.0 candidate"+e.candidate.candidate),this.state<c.ENUM_PUBLISH_STATE.connecting||this.state==c.ENUM_PUBLISH_STATE.stop?this.candidateInfo.push({candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex}):(t={candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex},this.sendCandidateInfo([t])))},e.prototype.sendCandidateInfo=function(e){var i=this;this.logger.info("zp.sci.0 called"),!(e=e.filter(function(e){return 0<e.candidate.indexOf("relay")}))||e.length<1?this.logger.info("zp.sci.0 cancelled"):(this.dataReport.eventStart(this.reportSeq,"SendIceCandidate"),this.stateNego!==c.ENUM_PUBLISH_STATE_NEGO.iceConnected&&(this.stateNego=c.ENUM_PUBLISH_STATE_NEGO.sendCandidate),this.logger.info("zp.sci.0  stateNego:sendCandidate"),this.signal.sendCandidateInfo(h.getSeq(),this.sessionId,e,function(e,t,r){i.logger.info("zp.sci.0 send success"),i.dataReport.eventEnd(i.reportSeq,"SendIceCandidate")},function(e,t){i.logger.error("zp.sci.0 failed to send: "+e.toString()),i.dataReport.eventEndWithMsg(i.reportSeq,"SendIceCandidate",{error:e}),i.publishStateUpdateError(h.publishErrorList.SEND_CANDIDATE_TIMEOUT)}))},e.prototype.onConnectionStateChange=function(e){this.logger.info("zp.ocs.0 called "+e.target.signalingState)},e.prototype.onRecvCandidateInfo=function(e,t,r){var i=this;if(this.logger.info("zp.oci.0 received "+JSON.stringify(r.infos)),this.state==c.ENUM_PUBLISH_STATE.waitingServerICE){null!=this.waitingICETimer&&(clearTimeout(this.waitingICETimer),this.waitingICETimer=null),this.dataReport.addEvent(this.reportSeq,"RecvIceCandidate"),this.signal.sendCandidateInfoAck(e,this.sessionId,0),this.sendCandidateInfo(this.candidateInfo),this.candidateInfo=[];for(var n=0;n<r.infos.length;n++){var o={sdpMid:r.infos[n].sdpMid,sdpMLineIndex:r.infos[n].sdpMLineIndex,candidate:r.infos[n].candidate};this.logger.debug("zp.orci.0 candidate "+o.candidate),this.peerConnection.addIceCandidate(new RTCIceCandidate(o)).then(function(){i.logger.debug("zp.oci.0 add success")},function(e){i.logger.error("zp.oci.0 add error "+e.toString()),i.publishStateUpdateError(h.publishErrorList.SERVER_CANDIDATE_ERROR)})}this.state=c.ENUM_PUBLISH_STATE.connecting,this.dataReport.eventStart(this.reportSeq,"IceConnected")}else this.logger.info("zp.oci.0 current state "+this.state+" not allowed")},e.prototype.onRecvCloseSession=function(e,t,r){this.logger.info("zp.orcs.0 reason: "+r.reason),this.dataReport.addEvent(this.reportSeq,"RecvCloseSession"),this.signal.sendCloseSessionAck(e,this.sessionId,0);var i=JSON.parse(JSON.stringify(h.publishErrorList.SESSION_CLOSED));i.msg+=r.reason,this.negoTimer&&clearTimeout(this.negoTimer);var n,o,s,a,c,d=+r.reason,l=r.err_info&&JSON.parse(r.err_info).action?JSON.parse(r.err_info).action:null;"number"==typeof d&&[26].includes(d)&&this.negoTryCount<this.negoTryMaxCount||5==l?(this.logger.info("zp.orcs.0 retry: "+this.streamId),n=this.streamId,o=this.localStream,s=this.videoInfo,a=this.mediaStreamConfig,c=this.playOption,this.signal.sendCloseSession(h.getSeq(),this.sessionId,1),this.resetPublish(),this.startPublish(n,o,s,a,c),++this.negoTryCount):[4,8,10,11,12,14,27].includes(d)||2==l?this.tryingNexitSignal||this.tryNextSignal(i):this.publishStateUpdateError(i)},e.prototype.onRecvResetSession=function(e,t,r){var i;this.logger.info("zp.orrs.0 received "),t==this.sessionId?(this.dataReport.addEvent(this.reportSeq,"RecvResetSession"),this.signal.sendCloseSessionAck(e,this.sessionId,0),i=JSON.parse(JSON.stringify(h.publishErrorList.SESSION_CLOSED)),this.negoTimer&&clearTimeout(this.negoTimer),this.tryingNexitSignal||this.tryNextSignal(i)):this.logger.error("zp.orrs.0 cannot find session")},e.prototype.onRecvPublishEvent=function(e,t,r){this.logger.info("zp.orpe.0 received"),this.publishEvent=!0,this.stateNego===c.ENUM_PUBLISH_STATE_NEGO.iceConnected&&0==r.event&&this.publishSuccess()},e.prototype.shouldRetryPublish=function(){return this.retryState==c.ENUM_RETRY_STATE.didNotStart&&this.state!=c.ENUM_PUBLISH_STATE.publishing?(this.logger.info("zp.srp.0.0 connection didn't success"),!1):this.retryState==c.ENUM_RETRY_STATE.retrying?(this.logger.info("zp.srp.0.0 already retrying"),!1):this.currentRetryCount>this.maxRetryCount?(this.logger.info("zp.srp.0.0 beyond max"),!1):(this.logger.info("zp.srp.1.0 call success"),!0)},e.prototype.startRetryPublish=function(){this.logger.info("zp.srp.0 call");var e=this.streamId;e?(this.resetPublish(),this.tryStartPublish(e)):this.logger.info("zp.srp.0 no streamid")},e.prototype.tryStartPublish=function(e){var t=this;if(this.logger.info("zp.tsp.0 call"),this.clearTryPublishTimer(),this.streamId=e,this.currentRetryCount>this.maxRetryCount)return this.logger.info("zp.tsp.0 beyond max limit"),void this.publishStateUpdateError(h.publishErrorList.WEBSOCKET_ERROR);this.retryState=c.ENUM_RETRY_STATE.retrying,this.currentRetryCount+=1,this.signal.isServerConnected()?(this.logger.info("zp.tsp.0 signal connected"),this.startPublish(e,this.localStream,this.videoInfo,this.mediaStreamConfig,this.playOption)):(this.logger.debug("zp.tsp.0 signal server not connected"),this.waitingAnswerTimer=setTimeout(function(){t.tryStartPublish(e)},this.waitingAnswerTimeInterval))},e.prototype.checkPublishConnectionFailedState=function(e){var t=null;"failed"==e?t=h.publishErrorList.MEDIA_CONNECTION_FAILED:"closed"==e&&(t=h.publishErrorList.MEDIA_CONNECTION_CLOSED),null!=t&&(this.state!=c.ENUM_PUBLISH_STATE.publishing&&this.retryState==c.ENUM_PUBLISH_STATE.didNotStart?(this.logger.info("zp.oics.0  state "+this.state+" retryState "+this.retryState+" connectionState "+e),this.publishStateUpdateError(t)):this.shouldRetryPublish()?(this.onPublishStateUpdate(h.ENUM_PUBLISH_STATE_UPDATE.retry,this.streamId),this.startRetryPublish()):this.publishStateUpdateError(t))},e.prototype.setPublishQualityTimer=function(){var t=this;null==this.qualityTimer&&(this.logger.info("zp.spq.0 called"),this.clearPublishQualityTimer(),this.qualityTimer=setInterval(function(){t.peerConnection&&t.peerConnection.getStats(null).then(function(e){t.getPublishStats(e)},function(e){t.logger.info("zp.spq.0 getStats error "+e.toString())})},this.qualityTimeInterval),this.lastPublishStats={time:0,audioBytesSent:0,videoBytesSent:0,framesEncoded:0,framesSent:0},this.qualitySeq=h.getSeq(),this.qualityCount=0,this.dataReport.newReport(this.qualitySeq))},e.prototype.getPublishStats=function(e){var t,r,i=this;e&&(t={audioCodeType:"opus",audioBitrate:0,videoBitrate:0,videoFPS:0,nackCount:0,pliCount:0,frameHeight:0,frameWidth:0,videoTransferFPS:0,totalRoundTripTime:0,currentRoundTripTime:0},r=this.lastPublishStats.time,e.forEach(function(e){("outbound-rtp"==e.type||"ssrc"==e.type&&null!=e.bytesSent)&&"audio"==e.mediaType?(0!=r&&(t.audioBitrate=8*(e.bytesSent-i.lastPublishStats.audioBytesSent)/(e.timestamp-r)),t.audioBitrate<0&&(t.audioBitrate=0),i.lastPublishStats.audioBytesSent=e.bytesSent,i.lastPublishStats.time=e.timestamp):("outbound-rtp"==e.type||"ssrc"==e.type&&null!=e.bytesSent)&&"video"==e.mediaType?(0!=r&&(t.videoBitrate=8*(e.bytesSent-i.lastPublishStats.videoBytesSent)/(e.timestamp-r),t.videoFPS=1e3*(e.framesEncoded-i.lastPublishStats.framesEncoded)/(e.timestamp-r)),t.videoBitrate<0&&(t.videoBitrate=0),t.videoFPS<0&&(t.videoFPS=0),t.nackCount=e.nackCount,t.pliCount=e.pliCount,i.lastPublishStats.videoBytesSent=e.bytesSent,i.lastPublishStats.framesEncoded=e.framesEncoded,i.lastPublishStats.time=e.timestamp):"track"==e.type&&("video"==e.kind||0<=e.id.indexOf("video"))?(t.frameHeight=e.frameHeight,t.frameWidth=e.frameWidth,0!=r&&(t.videoTransferFPS=1e3*(e.framesSent-i.lastPublishStats.framesSent)/(e.timestamp-r)),t.videoTransferFPS<0&&(t.videoTransferFPS=0),i.lastPublishStats.framesSent=e.framesSent):"candidate-pair"==e.type&&(null!=e.totalRoundTripTime&&(t.totalRoundTripTime=e.totalRoundTripTime),null!=e.currentRoundTripTime&&(t.currentRoundTripTime=e.currentRoundTripTime))}),this.uploadPublishQuality(t),0!=r&&this.onPublishQualityUpdate(this.streamId,t))},e.prototype.uploadPublishQuality=function(e){var t,i=this;this.qualityUpload&&(t=Date.parse(new Date+""),(0==this.qualityUploadLastTime||t-this.qualityUploadLastTime>=this.qualityUploadInterval)&&(e.stream_type="publish",e.stream_id=this.streamId,e.timeStamp=t/1e3,this.logger.info("zp.upq.0 upload"+JSON.stringify(e)),this.signal.QualityReport(h.getSeq(),this.sessionId,e,function(e,t,r){void 0!==r.report&&(i.qualityUpload=r.report,i.qualityUploadInterval=r.report_interval_ms)},function(e,t){i.logger.info("zp.upq.0 upload failed "+e)}),this.qualityUploadLastTime=t))},e.prototype.stopPublish=function(){for(var e in this.logger.info("zp.sp.0.1 called"),Object.keys(this.streamCenter.publisherList).length=1,this.streamCenter.playerList){var t=this.streamCenter.playerList[e].player;t.state==c.ENUM_PLAY_STATE.playing&&t.broadcasterStatus==c.ENUM_BROADCASTER_STATUS.start&&(this.signal&&this.signal.sendBroadcasterStatus(h.getSeq(),t.sessionId,0),t.broadcasterStatus=c.ENUM_BROADCASTER_STATUS.stop)}this.sessionId&&!this.closeSessionSignal&&this.signal.sendCloseSession(h.getSeq(),this.sessionId,0),this.dataReport.eventEndWithMsg(this.reportSeq,"PublishState",{state:this.state+""}),this.dataReport.addEvent(this.reportSeq,"StopPublish"),this.dataReport.addMsgExt(this.reportSeq,{stream:this.streamId,sessionId:this.sessionId}),this.dataReport.uploadReport(this.reportSeq,"RTCPublishStream"),this.resetPublish()},e.prototype.onPublishStateUpdate=function(e,t,r){},e.prototype.onPublishQualityUpdate=function(e,t){},e.prototype.onDisconnect=function(){this.logger.info("zp.od.0 call"),this.logger.info("zp.od.0 websocket disconnect"),this.dataReport.addEvent(this.reportSeq,"OnDisconnect"),this.tryingNexitSignal||this.tryNextSignal(h.publishErrorList.WEBSOCKET_ERROR)},e.prototype.playEffect=function(e,t,r,i){this.audioMixing.localStream=this.localStream,this.audioMixing.peerConnection=this.peerConnection,this.audioMixing.audioBuffer=t,this.audioMixing.playEffect(e.playTime,e.loop,e.replace,r,i)},e.prototype.pauseEffect=function(){this.audioMixing.pauseEffect()},e.prototype.resumeEffect=function(){this.audioMixing.resumeEffect()},e.prototype.startMixingAudio=function(e,t){return this.audioMixing.localStream=this.localStream,this.audioMixing.peerConnection=this.peerConnection,this.audioMixing.startMixingAudio(e,t)},e.prototype.stopMixingAudio=function(){return this.audioMixing.stopMixingAudio()},e.prototype.voiceChange=function(e){var t=new("undefined"!=typeof webkitAudioContext?webkitAudioContext:AudioContext),r=null,i=null;if(this.pitchEffect||(this.pitchEffect=new s.pitchUtil(t),r=t.createMediaStreamSource(this.localStream),i=t.createMediaStreamDestination(),r.connect(this.pitchEffect.input),this.pitchEffect.output.connect(i)),this.pitchEffect.setPitchOffset(e),!this.micTrack){var n=i.stream.getAudioTracks()[0],o=this.peerConnection.getSenders().find(function(e){return e.track.kind===n.kind});if(!o)return this.logger.error("zp.vc.0 no sender"),!1;this.micTrack=this.localStream.getAudioTracks()[0],o.replaceTrack(n),this.localStream.removeTrack(this.micTrack),this.localStream.addTrack(n)}},e.prototype.voiceBack=function(){var t=this;this.micTrack?(this.peerConnection.getSenders().find(function(e){return e.track.kind===t.micTrack.kind}).replaceTrack(this.micTrack),this.localStream.removeTrack(this.localStream.getAudioTracks()[0]),this.localStream.addTrack(this.micTrack),this.micTrack=null,this.pitchEffect=null):this.logger.error("zp.vb.0 mo mickTrack found")},e.prototype.publishSuccess=function(){for(var e in this.state!=c.ENUM_PUBLISH_STATE.publishing&&this.onPublishStateUpdate(h.ENUM_PUBLISH_STATE_UPDATE.start,this.streamId),this.state=c.ENUM_PUBLISH_STATE.publishing,this.tryingNexitSignal=!1,this.retryState!=c.ENUM_RETRY_STATE.didNotStart&&(this.retryState=c.ENUM_RETRY_STATE.finished,this.currentRetryCount=0),this.dataReport.eventStart(this.reportSeq,"PublishState"),this.streamCenter.playerList){var t=this.streamCenter.playerList[e].player;t.state==c.ENUM_PLAY_STATE.playing&&t.broadcasterStatus==c.ENUM_BROADCASTER_STATUS.stop&&(this.signal&&this.signal.sendBroadcasterStatus(h.getSeq(),t.sessionId,1),t.broadcasterStatus=c.ENUM_BROADCASTER_STATUS.start)}this.setPublishQualityTimer();var r=2,i=2;0!==this.localStream.getVideoTracks().length&&(r=0),0!==this.localStream.getAudioTracks().length&&(i=0),this.signal.sendStreamStatus(h.getSeq(),this.sessionId,r,i)},e.prototype.tryNextSignal=function(e){this.tryingNexitSignal=!0;var t=this.streamId,r=this.signal.server,i=this.streamCenter.publisherList[t],n=[];i&&i.serverUrls&&(n=i.serverUrls),this.nextSignalTryCount>3*n.length?(this.logger.error("zp.tns.0 try max limit"),this.publishStateUpdateError(e)):(n.forEach(function(e,t){return t<=n.indexOf(r)&&n.push(e)}),n.splice(0,n.indexOf(r)+1),this.logger.info("zp.tns.0 try next signal "+t),this.signal&&this.signal.state==c.ENUM_CONNECT_STATE.connected&&this.signal.sendCloseSession(h.getSeq(),this.sessionId,1),this.signal&&this.signal.removeSession(this.sessionId),this.resetPublish(),this.streamCenter.connectPublishServer(t),this.nextSignalTryCount++)},e}();t.ZegoPublish=a},function(e,t,r){e.exports=function n(o,s,a){function c(t,e){if(!s[t]){if(!o[t]){if(d)return d(t,!0);var r=new Error("Cannot find module '"+t+"'");throw r.code="MODULE_NOT_FOUND",r}var i=s[t]={exports:{}};o[t][0].call(i.exports,function(e){return c(o[t][1][e]||e)},i,i.exports,n,o,s,a)}return s[t].exports}for(var d=!1,e=0;e<a.length;e++)c(a[e]);return c}({1:[function(e,t,r){"use strict";var i=(0,e("./adapter_factory.js").adapterFactory)({window:window});t.exports=i},{"./adapter_factory.js":2}],2:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.adapterFactory=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.window,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0},i=s.log,n=s.detectBrowser(t),o={browserDetails:n,commonShim:h,extractVersion:s.extractVersion,disableLog:s.disableLog,disableWarnings:s.disableWarnings};switch(n.browser){case"chrome":if(!a||!a.shimPeerConnection||!r.shimChrome)return i("Chrome shim is not included in this adapter release."),o;i("adapter.js shimming chrome."),(o.browserShim=a).shimGetUserMedia(t),a.shimMediaStream(t),a.shimPeerConnection(t),a.shimOnTrack(t),a.shimAddTrackRemoveTrack(t),a.shimGetSendersWithDtmf(t),a.shimGetStats(t),a.shimSenderReceiverGetStats(t),a.fixNegotiationNeeded(t),h.shimRTCIceCandidate(t),h.shimConnectionState(t),h.shimMaxMessageSize(t),h.shimSendThrowTypeError(t),h.removeAllowExtmapMixed(t);break;case"firefox":if(!d||!d.shimPeerConnection||!r.shimFirefox)return i("Firefox shim is not included in this adapter release."),o;i("adapter.js shimming firefox."),(o.browserShim=d).shimGetUserMedia(t),d.shimPeerConnection(t),d.shimOnTrack(t),d.shimRemoveStream(t),d.shimSenderGetStats(t),d.shimReceiverGetStats(t),d.shimRTCDataChannel(t),h.shimRTCIceCandidate(t),h.shimConnectionState(t),h.shimMaxMessageSize(t),h.shimSendThrowTypeError(t);break;case"edge":if(!c||!c.shimPeerConnection||!r.shimEdge)return i("MS edge shim is not included in this adapter release."),o;i("adapter.js shimming edge."),(o.browserShim=c).shimGetUserMedia(t),c.shimGetDisplayMedia(t),c.shimPeerConnection(t),c.shimReplaceTrack(t),h.shimMaxMessageSize(t),h.shimSendThrowTypeError(t);break;case"safari":if(!l||!r.shimSafari)return i("Safari shim is not included in this adapter release."),o;i("adapter.js shimming safari."),(o.browserShim=l).shimRTCIceServerUrls(t),l.shimCreateOfferLegacy(t),l.shimCallbacksAPI(t),l.shimLocalStreamsAPI(t),l.shimRemoteStreamsAPI(t),l.shimTrackEventTransceiver(t),l.shimGetUserMedia(t),h.shimRTCIceCandidate(t),h.shimMaxMessageSize(t),h.shimSendThrowTypeError(t),h.removeAllowExtmapMixed(t);break;default:i("Unsupported browser!")}return o};var s=i(e("./utils")),a=i(e("./chrome/chrome_shim")),c=i(e("./edge/edge_shim")),d=i(e("./firefox/firefox_shim")),l=i(e("./safari/safari_shim")),h=i(e("./common_shim"));function i(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}},{"./chrome/chrome_shim":3,"./common_shim":6,"./edge/edge_shim":7,"./firefox/firefox_shim":11,"./safari/safari_shim":14,"./utils":15}],3:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return i.shimGetUserMedia}});var n=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return n.shimGetDisplayMedia}}),r.shimMediaStream=function(e){e.MediaStream=e.MediaStream||e.webkitMediaStream},r.shimOnTrack=function(o){var e;"object"!==(void 0===o?"undefined":a(o))||!o.RTCPeerConnection||"ontrack"in o.RTCPeerConnection.prototype?c.wrapPeerConnectionEvent(o,"track",function(e){return e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e}):(Object.defineProperty(o.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0}),e=o.RTCPeerConnection.prototype.setRemoteDescription,o.RTCPeerConnection.prototype.setRemoteDescription=function(){var n=this;return this._ontrackpoly||(this._ontrackpoly=function(i){i.stream.addEventListener("addtrack",function(t){var e=void 0;e=o.RTCPeerConnection.prototype.getReceivers?n.getReceivers().find(function(e){return e.track&&e.track.id===t.track.id}):{track:t.track};var r=new Event("track");r.track=t.track,r.receiver=e,r.transceiver={receiver:e},r.streams=[i.stream],n.dispatchEvent(r)}),i.stream.getTracks().forEach(function(t){var e=void 0;e=o.RTCPeerConnection.prototype.getReceivers?n.getReceivers().find(function(e){return e.track&&e.track.id===t.id}):{track:t};var r=new Event("track");r.track=t,r.receiver=e,r.transceiver={receiver:e},r.streams=[i.stream],n.dispatchEvent(r)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)})},r.shimGetSendersWithDtmf=function(e){var i,n,r,o,t,s;"object"===(void 0===e?"undefined":a(e))&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype?(i=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}},e.RTCPeerConnection.prototype.getSenders||(e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()},n=e.RTCPeerConnection.prototype.addTrack,e.RTCPeerConnection.prototype.addTrack=function(e,t){var r=n.apply(this,arguments);return r||(r=i(this,e),this._senders.push(r)),r},r=e.RTCPeerConnection.prototype.removeTrack,e.RTCPeerConnection.prototype.removeTrack=function(e){r.apply(this,arguments);var t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}),o=e.RTCPeerConnection.prototype.addStream,e.RTCPeerConnection.prototype.addStream=function(e){var t=this;this._senders=this._senders||[],o.apply(this,[e]),e.getTracks().forEach(function(e){t._senders.push(i(t,e))})},t=e.RTCPeerConnection.prototype.removeStream,e.RTCPeerConnection.prototype.removeStream=function(e){var r=this;this._senders=this._senders||[],t.apply(this,[e]),e.getTracks().forEach(function(t){var e=r._senders.find(function(e){return e.track===t});e&&r._senders.splice(r._senders.indexOf(e),1)})}):"object"===(void 0===e?"undefined":a(e))&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)&&(s=e.RTCPeerConnection.prototype.getSenders,e.RTCPeerConnection.prototype.getSenders=function(){var t=this,e=s.apply(this,[]);return e.forEach(function(e){return e._pc=t}),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}}))},r.shimGetStats=function(e){var a;e.RTCPeerConnection&&(a=e.RTCPeerConnection.prototype.getStats,e.RTCPeerConnection.prototype.getStats=function(e,t,r){var i=this,n=arguments;if(0<arguments.length&&"function"==typeof e)return a.apply(this,arguments);if(0===a.length&&(0===arguments.length||"function"!=typeof arguments[0]))return a.apply(this,[]);var o=function(e){var i={};return e.result().forEach(function(t){var r={id:t.id,timestamp:t.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[t.type]||t.type};t.names().forEach(function(e){r[e]=t.stat(e)}),i[r.id]=r}),i},s=function(t){return new Map(Object.keys(t).map(function(e){return[e,t[e]]}))};if(2<=arguments.length){return a.apply(this,[function(e){n[1](s(o(e)))},arguments[0]])}return new Promise(function(t,e){a.apply(i,[function(e){t(s(o(e)))},e])}).then(t,r)})},r.shimSenderReceiverGetStats=function(e){var r,t,i,o;"object"===(void 0===e?"undefined":a(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver&&("getStats"in e.RTCRtpSender.prototype||((r=e.RTCPeerConnection.prototype.getSenders)&&(e.RTCPeerConnection.prototype.getSenders=function(){var t=this,e=r.apply(this,[]);return e.forEach(function(e){return e._pc=t}),e}),(t=e.RTCPeerConnection.prototype.addTrack)&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=t.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){var t=this;return this._pc.getStats().then(function(e){return c.filterStats(e,t.track,!0)})}),"getStats"in e.RTCRtpReceiver.prototype||((i=e.RTCPeerConnection.prototype.getReceivers)&&(e.RTCPeerConnection.prototype.getReceivers=function(){var t=this,e=i.apply(this,[]);return e.forEach(function(e){return e._pc=t}),e}),c.wrapPeerConnectionEvent(e,"track",function(e){return e.receiver._pc=e.srcElement,e}),e.RTCRtpReceiver.prototype.getStats=function(){var t=this;return this._pc.getStats().then(function(e){return c.filterStats(e,t.track,!1)})}),"getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype&&(o=e.RTCPeerConnection.prototype.getStats,e.RTCPeerConnection.prototype.getStats=function(){if(0<arguments.length&&arguments[0]instanceof e.MediaStreamTrack){var t=arguments[0],r=void 0,i=void 0,n=void 0;return this.getSenders().forEach(function(e){e.track===t&&(r?n=!0:r=e)}),this.getReceivers().forEach(function(e){return e.track===t&&(i?n=!0:i=e),e.track===t}),n||r&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return o.apply(this,arguments)}))},r.shimAddTrackRemoveTrackWithNative=d,r.shimAddTrackRemoveTrack=function(a){if(a.RTCPeerConnection){var e=c.detectBrowser(a);if(a.RTCPeerConnection.prototype.addTrack&&65<=e.version)return d(a);var r=a.RTCPeerConnection.prototype.getLocalStreams;a.RTCPeerConnection.prototype.getLocalStreams=function(){var t=this,e=r.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map(function(e){return t._reverseStreams[e.id]})};var i=a.RTCPeerConnection.prototype.addStream;a.RTCPeerConnection.prototype.addStream=function(e){var t,r=this;this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},e.getTracks().forEach(function(t){if(r.getSenders().find(function(e){return e.track===t}))throw new DOMException("Track already exists.","InvalidAccessError")}),this._reverseStreams[e.id]||(t=new a.MediaStream(e.getTracks()),this._streams[e.id]=t,this._reverseStreams[t.id]=e,e=t),i.apply(this,[e])};var t=a.RTCPeerConnection.prototype.removeStream;a.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},a.RTCPeerConnection.prototype.addTrack=function(t,e){var r=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var i=[].slice.call(arguments,1);if(1!==i.length||!i[0].getTracks().find(function(e){return e===t}))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");var n=this.getSenders().find(function(e){return e.track===t});if(n)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};var o,s=this._streams[e.id];return s?(s.addTrack(t),Promise.resolve().then(function(){r.dispatchEvent(new Event("negotiationneeded"))})):(o=new a.MediaStream([t]),this._streams[e.id]=o,this._reverseStreams[o.id]=e,this.addStream(o)),this.getSenders().find(function(e){return e.track===t})},["createOffer","createAnswer"].forEach(function(e){var t=a.RTCPeerConnection.prototype[e];a.RTCPeerConnection.prototype[e]=function(){var r=this,i=arguments,e=arguments.length&&"function"==typeof arguments[0];return e?t.apply(this,[function(e){var t=s(r,e);i[0].apply(null,[t])},function(e){i[1]&&i[1].apply(null,e)},arguments[2]]):t.apply(this,arguments).then(function(e){return s(r,e)})}});var n=a.RTCPeerConnection.prototype.setLocalDescription;a.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type&&(arguments[0]=function(i,e){var n=e.sdp;return Object.keys(i._reverseStreams||[]).forEach(function(e){var t=i._reverseStreams[e],r=i._streams[t.id];n=n.replace(new RegExp(t.id,"g"),r.id)}),new RTCSessionDescription({type:e.type,sdp:n})}(this,arguments[0])),n.apply(this,arguments)};var o=Object.getOwnPropertyDescriptor(a.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(a.RTCPeerConnection.prototype,"localDescription",{get:function(){var e=o.get.apply(this);return""===e.type?e:s(this,e)}}),a.RTCPeerConnection.prototype.removeTrack=function(t){var r=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!t._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(t._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};var i=void 0;Object.keys(this._streams).forEach(function(e){r._streams[e].getTracks().find(function(e){return t.track===e})&&(i=r._streams[e])}),i&&(1===i.getTracks().length?this.removeStream(this._reverseStreams[i.id]):i.removeTrack(t.track),this.dispatchEvent(new Event("negotiationneeded")))}}function s(i,e){var n=e.sdp;return Object.keys(i._reverseStreams||[]).forEach(function(e){var t=i._reverseStreams[e],r=i._streams[t.id];n=n.replace(new RegExp(r.id,"g"),t.id)}),new RTCSessionDescription({type:e.type,sdp:n})}},r.shimPeerConnection=function(r){var e;!r.RTCPeerConnection&&r.webkitRTCPeerConnection&&(r.RTCPeerConnection=r.webkitRTCPeerConnection),r.RTCPeerConnection&&(["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var t=r.RTCPeerConnection.prototype[e];r.RTCPeerConnection.prototype[e]=function(){return arguments[0]=new("addIceCandidate"===e?r.RTCIceCandidate:r.RTCSessionDescription)(arguments[0]),t.apply(this,arguments)}}),e=r.RTCPeerConnection.prototype.addIceCandidate,r.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?e.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})},r.fixNegotiationNeeded=function(e){c.wrapPeerConnectionEvent(e,"negotiationneeded",function(e){if("stable"===e.target.signalingState)return e})};var c=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils.js"));function d(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){var t=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(function(e){return t._shimmedLocalStreams[e][0]})};var i=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,t){if(!t)return i.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var r=i.apply(this,arguments);return this._shimmedLocalStreams[t.id]?-1===this._shimmedLocalStreams[t.id].indexOf(r)&&this._shimmedLocalStreams[t.id].push(r):this._shimmedLocalStreams[t.id]=[t,r],r};var n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var r=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach(function(t){if(r.getSenders().find(function(e){return e.track===t}))throw new DOMException("Track already exists.","InvalidAccessError")});var t=this.getSenders();n.apply(this,arguments);var i=this.getSenders().filter(function(e){return-1===t.indexOf(e)});this._shimmedLocalStreams[e.id]=[e].concat(i)};var t=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],t.apply(this,arguments)};var o=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(r){var i=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},r&&Object.keys(this._shimmedLocalStreams).forEach(function(e){var t=i._shimmedLocalStreams[e].indexOf(r);-1!==t&&i._shimmedLocalStreams[e].splice(t,1),1===i._shimmedLocalStreams[e].length&&delete i._shimmedLocalStreams[e]}),o.apply(this,arguments)}}},{"../utils.js":15,"./getdisplaymedia":4,"./getusermedia":5}],4:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=function(o,e){o.navigator.mediaDevices&&"getDisplayMedia"in o.navigator.mediaDevices||o.navigator.mediaDevices&&"function"==typeof e&&(o.navigator.mediaDevices.getDisplayMedia=function(n){return e(n).then(function(e){var t=n.video&&n.video.width,r=n.video&&n.video.height,i=n.video&&n.video.frameRate;return n.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxFrameRate:i||3}},t&&(n.video.mandatory.maxWidth=t),r&&(n.video.mandatory.maxHeight=r),o.navigator.mediaDevices.getUserMedia(n)})})}},{}],5:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimGetUserMedia=function(e){var s,a,i,n,r,c=e&&e.navigator;c.mediaDevices&&(s=o.detectBrowser(e),a=function(n){if("object"!==(void 0===n?"undefined":d(n))||n.mandatory||n.optional)return n;var o={};return Object.keys(n).forEach(function(t){var r,i,e;"require"!==t&&"advanced"!==t&&"mediaSource"!==t&&(void 0!==(r="object"===d(n[t])?n[t]:{ideal:n[t]}).exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact),i=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t},void 0!==r.ideal&&(o.optional=o.optional||[],e={},"number"==typeof r.ideal?(e[i("min",t)]=r.ideal,o.optional.push(e),(e={})[i("max",t)]=r.ideal):e[i("",t)]=r.ideal,o.optional.push(e)),void 0!==r.exact&&"number"!=typeof r.exact?(o.mandatory=o.mandatory||{},o.mandatory[i("",t)]=r.exact):["min","max"].forEach(function(e){void 0!==r[e]&&(o.mandatory=o.mandatory||{},o.mandatory[i(e,t)]=r[e])}))}),n.advanced&&(o.optional=(o.optional||[]).concat(n.advanced)),o},i=function(r,i){if(61<=s.version)return i(r);var e;if((r=JSON.parse(JSON.stringify(r)))&&"object"===d(r.audio)&&((e=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])})((r=JSON.parse(JSON.stringify(r))).audio,"autoGainControl","googAutoGainControl"),e(r.audio,"noiseSuppression","googNoiseSuppression"),r.audio=a(r.audio)),r&&"object"===d(r.video)){var n=r.video.facingMode;n=n&&("object"===(void 0===n?"undefined":d(n))?n:{ideal:n});var t=s.version<66;if(n&&("user"===n.exact||"environment"===n.exact||"user"===n.ideal||"environment"===n.ideal)&&(!c.mediaDevices.getSupportedConstraints||!c.mediaDevices.getSupportedConstraints().facingMode||t)){delete r.video.facingMode;var o=void 0;if("environment"===n.exact||"environment"===n.ideal?o=["back","rear"]:"user"!==n.exact&&"user"!==n.ideal||(o=["front"]),o)return c.mediaDevices.enumerateDevices().then(function(e){var t=(e=e.filter(function(e){return"videoinput"===e.kind})).find(function(t){return o.some(function(e){return t.label.toLowerCase().includes(e)})});return!t&&e.length&&o.includes("back")&&(t=e[e.length-1]),t&&(r.video.deviceId=n.exact?{exact:t.deviceId}:{ideal:t.deviceId}),r.video=a(r.video),l("chrome: "+JSON.stringify(r)),i(r)})}r.video=a(r.video)}return l("chrome: "+JSON.stringify(r)),i(r)},n=function(e){return 64<=s.version?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}},c.getUserMedia=function(e,t,r){i(e,function(e){c.webkitGetUserMedia(e,t,function(e){r&&r(n(e))})})}.bind(c),c.mediaDevices.getUserMedia&&(r=c.mediaDevices.getUserMedia.bind(c.mediaDevices),c.mediaDevices.getUserMedia=function(e){return i(e,function(t){return r(t).then(function(e){if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach(function(e){e.stop()}),new DOMException("","NotFoundError");return e},function(e){return Promise.reject(n(e))})})}))};var o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils.js")),l=o.log},{"../utils.js":15}],6:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimRTCIceCandidate=function(t){var n;!t.RTCIceCandidate||t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype||(n=t.RTCIceCandidate,t.RTCIceCandidate=function(e){if("object"===(void 0===e?"undefined":o(e))&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){var t=new n(e),r=a.default.parseCandidate(e.candidate),i=Object.assign(t,r);return i.toJSON=function(){return{candidate:i.candidate,sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex,usernameFragment:i.usernameFragment}},i}return new n(e)},t.RTCIceCandidate.prototype=n.prototype,c.wrapPeerConnectionEvent(t,"icecandidate",function(e){return e.candidate&&Object.defineProperty(e,"candidate",{value:new t.RTCIceCandidate(e.candidate),writable:"false"}),e}))},r.shimMaxMessageSize=function(e){var o,s;!e.RTCSctpTransport&&e.RTCPeerConnection&&(o=c.detectBrowser(e),"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get:function(){return void 0===this._sctp?null:this._sctp}}),s=e.RTCPeerConnection.prototype.setRemoteDescription,e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e,t,r,i,n;return this._sctp=null,function(e){if(!e||!e.sdp)return!1;var t=a.default.splitSections(e.sdp);return t.shift(),t.some(function(e){var t=a.default.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")})}(arguments[0])&&(e=function(e){var t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;var r=parseInt(t[1],10);return r!=r?-1:r}(arguments[0]),t=function(e){var t=65536;return"firefox"===o.browser&&(t=o.version<57?-1===e?16384:2147483637:o.version<60?57===o.version?65535:65536:2147483637),t}(e),r=function(e,t){var r=65536;"firefox"===o.browser&&57===o.version&&(r=65535);var i=a.default.matchPrefix(e.sdp,"a=max-message-size:");return i.length>0?r=parseInt(i[0].substr(19),10):"firefox"===o.browser&&-1!==t&&(r=2147483637),r}(arguments[0],e),i=void 0,i=0===t&&0===r?Number.POSITIVE_INFINITY:0===t||0===r?Math.max(t,r):Math.min(t,r),n={},Object.defineProperty(n,"maxMessageSize",{get:function(){return i}}),this._sctp=n),s.apply(this,arguments)})},r.shimSendThrowTypeError=function(e){var t;function r(r,i){var n=r.send;r.send=function(){var e=arguments[0],t=e.length||e.size||e.byteLength;if("open"===r.readyState&&i.sctp&&t>i.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+i.sctp.maxMessageSize+" bytes)");return n.apply(r,arguments)}}e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype&&(t=e.RTCPeerConnection.prototype.createDataChannel,e.RTCPeerConnection.prototype.createDataChannel=function(){var e=t.apply(this,arguments);return r(e,this),e},c.wrapPeerConnectionEvent(e,"datachannel",function(e){return r(e.channel,e.target),e}))},r.shimConnectionState=function(e){var r;!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype||(r=e.RTCPeerConnection.prototype,Object.defineProperty(r,"connectionState",{get:function(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(r,"onconnectionstatechange",{get:function(){return this._onconnectionstatechange||null},set:function(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(function(e){var t=r[e];r[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=function(e){var t,r=e.target;return r._lastConnectionState!==r.connectionState&&(r._lastConnectionState=r.connectionState,t=new Event("connectionstatechange",e),r.dispatchEvent(t)),e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),t.apply(this,arguments)}}))},r.removeAllowExtmapMixed=function(e){var t,r;e.RTCPeerConnection&&("chrome"===(t=c.detectBrowser(e)).browser&&71<=t.version||(r=e.RTCPeerConnection.prototype.setRemoteDescription,e.RTCPeerConnection.prototype.setRemoteDescription=function(e){return e&&e.sdp&&-1!==e.sdp.indexOf("\na=extmap-allow-mixed")&&(e.sdp=e.sdp.split("\n").filter(function(e){return"a=extmap-allow-mixed"!==e.trim()}).join("\n")),r.apply(this,arguments)}))};var i,n=e("sdp"),a=(i=n)&&i.__esModule?i:{default:i},c=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("./utils"))},{"./utils":15,sdp:17}],7:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var i=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return i.shimGetUserMedia}});var n=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return n.shimGetDisplayMedia}}),r.shimPeerConnection=function(e){var r,t=s.detectBrowser(e);e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)&&(r=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled"),Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set:function(e){r.set.call(this,e);var t=new Event("enabled");t.enabled=e,this.dispatchEvent(t)}})),!e.RTCRtpSender||"dtmf"in e.RTCRtpSender.prototype||Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);var i=(0,d.default)(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=(0,a.filterIceServers)(e.iceServers,t.version),s.log("ICE servers after filtering:",e.iceServers)),new i(e)},e.RTCPeerConnection.prototype=i.prototype},r.shimReplaceTrack=function(e){!e.RTCRtpSender||"replaceTrack"in e.RTCRtpSender.prototype||(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)};var o,s=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils")),a=e("./filtericeservers"),c=e("rtcpeerconnection-shim"),d=(o=c)&&o.__esModule?o:{default:o}},{"../utils":15,"./filtericeservers":8,"./getdisplaymedia":9,"./getusermedia":10,"rtcpeerconnection-shim":16}],8:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.filterIceServers=function(e,t){var i=!1;return(e=JSON.parse(JSON.stringify(e))).filter(function(e){if(e&&(e.urls||e.url)){var t=e.urls||e.url;e.url&&!e.urls&&n.deprecated("RTCIceServer.url","RTCIceServer.urls");var r="string"==typeof t;return r&&(t=[t]),t=t.filter(function(e){if(0===e.indexOf("stun:"))return!1;var t=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");return t&&!i?i=!0:t&&!i}),delete e.url,e.urls=r?t[0]:t,!!t.length}})};var n=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils"))},{"../utils":15}],9:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=function(e){"getDisplayMedia"in e.navigator&&e.navigator.mediaDevices&&(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator)))}},{}],10:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetUserMedia=function(e){var t=e&&e.navigator,r=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return r(e).catch(function(e){return Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function(){return this.name}}}(e))})}}},{}],11:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return i.shimGetUserMedia}});var n=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return n.shimGetDisplayMedia}}),r.shimOnTrack=function(e){"object"===(void 0===e?"undefined":s(e))&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},r.shimPeerConnection=function(r){var e,i,n,o=a.detectBrowser(r);"object"===(void 0===r?"undefined":s(r))&&(r.RTCPeerConnection||r.mozRTCPeerConnection)&&(!r.RTCPeerConnection&&r.mozRTCPeerConnection&&(r.RTCPeerConnection=r.mozRTCPeerConnection),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var t=r.RTCPeerConnection.prototype[e];r.RTCPeerConnection.prototype[e]=function(){return arguments[0]=new("addIceCandidate"===e?r.RTCIceCandidate:r.RTCSessionDescription)(arguments[0]),t.apply(this,arguments)}}),e=r.RTCPeerConnection.prototype.addIceCandidate,r.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?e.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())},i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=r.RTCPeerConnection.prototype.getStats,r.RTCPeerConnection.prototype.getStats=function(e,t,r){return n.apply(this,[e||null]).then(function(r){if(o.version<53&&!t)try{r.forEach(function(e){e.type=i[e.type]||e.type})}catch(e){if("TypeError"!==e.name)throw e;r.forEach(function(e,t){r.set(t,Object.assign({},e,{type:i[e.type]||e.type}))})}return r}).then(t,r)})},r.shimSenderGetStats=function(e){var r,t;"object"!==(void 0===e?"undefined":s(e))||!e.RTCPeerConnection||!e.RTCRtpSender||e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype||((r=e.RTCPeerConnection.prototype.getSenders)&&(e.RTCPeerConnection.prototype.getSenders=function(){var t=this,e=r.apply(this,[]);return e.forEach(function(e){return e._pc=t}),e}),(t=e.RTCPeerConnection.prototype.addTrack)&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=t.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)})},r.shimReceiverGetStats=function(e){var r;"object"!==(void 0===e?"undefined":s(e))||!e.RTCPeerConnection||!e.RTCRtpSender||e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype||((r=e.RTCPeerConnection.prototype.getReceivers)&&(e.RTCPeerConnection.prototype.getReceivers=function(){var t=this,e=r.apply(this,[]);return e.forEach(function(e){return e._pc=t}),e}),a.wrapPeerConnectionEvent(e,"track",function(e){return e.receiver._pc=e.srcElement,e}),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)})},r.shimRemoveStream=function(e){!e.RTCPeerConnection||"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(t){var r=this;a.deprecated("removeStream","removeTrack"),this.getSenders().forEach(function(e){e.track&&t.getTracks().includes(e.track)&&r.removeTrack(e)})})},r.shimRTCDataChannel=function(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)};var a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils"))},{"../utils":15,"./getdisplaymedia":12,"./getusermedia":13}],12:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=function(r,i){r.navigator.mediaDevices&&"getDisplayMedia"in r.navigator.mediaDevices||r.navigator.mediaDevices&&(r.navigator.mediaDevices.getDisplayMedia=function(e){if(e&&e.video)return!0===e.video?e.video={mediaSource:i}:e.video.mediaSource=i,r.navigator.mediaDevices.getUserMedia(e);var t=new DOMException("getDisplayMedia without video constraints is undefined");return t.name="NotFoundError",t.code=8,Promise.reject(t)})}},{}],13:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimGetUserMedia=function(e){var t,r,i,n,o=d.detectBrowser(e),s=e&&e.navigator,a=e&&e.MediaStreamTrack;s.getUserMedia=function(e,t,r){d.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),s.mediaDevices.getUserMedia(e).then(t,r)},55<o.version&&"autoGainControl"in s.mediaDevices.getSupportedConstraints()||(t=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])},r=s.mediaDevices.getUserMedia.bind(s.mediaDevices),s.mediaDevices.getUserMedia=function(e){return"object"===(void 0===e?"undefined":c(e))&&"object"===c(e.audio)&&(e=JSON.parse(JSON.stringify(e)),t(e.audio,"autoGainControl","mozAutoGainControl"),t(e.audio,"noiseSuppression","mozNoiseSuppression")),r(e)},a&&a.prototype.getSettings&&(i=a.prototype.getSettings,a.prototype.getSettings=function(){var e=i.apply(this,arguments);return t(e,"mozAutoGainControl","autoGainControl"),t(e,"mozNoiseSuppression","noiseSuppression"),e}),a&&a.prototype.applyConstraints&&(n=a.prototype.applyConstraints,a.prototype.applyConstraints=function(e){return"audio"===this.kind&&"object"===(void 0===e?"undefined":c(e))&&(e=JSON.parse(JSON.stringify(e)),t(e,"autoGainControl","mozAutoGainControl"),t(e,"noiseSuppression","mozNoiseSuppression")),n.apply(this,[e])}))};var d=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils"))},{"../utils":15}],14:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimLocalStreamsAPI=function(e){var i;"object"===(void 0===e?"undefined":d(e))&&e.RTCPeerConnection&&("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),"addStream"in e.RTCPeerConnection.prototype||(i=e.RTCPeerConnection.prototype.addTrack,e.RTCPeerConnection.prototype.addStream=function(t){var r=this;this._localStreams||(this._localStreams=[]),this._localStreams.includes(t)||this._localStreams.push(t),t.getTracks().forEach(function(e){return i.call(r,e,t)})},e.RTCPeerConnection.prototype.addTrack=function(e,t){return t&&(this._localStreams?this._localStreams.includes(t)||this._localStreams.push(t):this._localStreams=[t]),i.call(this,e,t)}),"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;this._localStreams||(this._localStreams=[]);var r,i=this._localStreams.indexOf(e);-1!==i&&(this._localStreams.splice(i,1),r=e.getTracks(),this.getSenders().forEach(function(e){r.includes(e.track)&&t.removeTrack(e)}))}))},r.shimRemoteStreamsAPI=function(e){var t;"object"!==(void 0===e?"undefined":d(e))||!e.RTCPeerConnection||("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),"onaddstream"in e.RTCPeerConnection.prototype)||(Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(e){var r=this;this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach(function(e){var t;r._remoteStreams||(r._remoteStreams=[]),r._remoteStreams.includes(e)||(r._remoteStreams.push(e),(t=new Event("addstream")).stream=e,r.dispatchEvent(t))})})}}),t=e.RTCPeerConnection.prototype.setRemoteDescription,e.RTCPeerConnection.prototype.setRemoteDescription=function(){var r=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach(function(e){var t;r._remoteStreams||(r._remoteStreams=[]),0<=r._remoteStreams.indexOf(e)||(r._remoteStreams.push(e),(t=new Event("addstream")).stream=e,r.dispatchEvent(t))})}),t.apply(r,arguments)})},r.shimCallbacksAPI=function(e){var t,n,o,s,a,c,r;"object"===(void 0===e?"undefined":d(e))&&e.RTCPeerConnection&&(t=e.RTCPeerConnection.prototype,n=t.createOffer,o=t.createAnswer,s=t.setLocalDescription,a=t.setRemoteDescription,c=t.addIceCandidate,t.createOffer=function(e,t){var r=2<=arguments.length?arguments[2]:arguments[0],i=n.apply(this,[r]);return t?(i.then(e,t),Promise.resolve()):i},t.createAnswer=function(e,t){var r=2<=arguments.length?arguments[2]:arguments[0],i=o.apply(this,[r]);return t?(i.then(e,t),Promise.resolve()):i},r=function(e,t,r){var i=s.apply(this,[e]);return r?(i.then(t,r),Promise.resolve()):i},t.setLocalDescription=r,r=function(e,t,r){var i=a.apply(this,[e]);return r?(i.then(t,r),Promise.resolve()):i},t.setRemoteDescription=r,r=function(e,t,r){var i=c.apply(this,[e]);return r?(i.then(t,r),Promise.resolve()):i},t.addIceCandidate=r)},r.shimGetUserMedia=function(e){var t,r,i=e&&e.navigator;i.mediaDevices&&i.mediaDevices.getUserMedia&&(t=i.mediaDevices,r=t.getUserMedia.bind(t),i.mediaDevices.getUserMedia=function(e){return r(n(e))}),!i.getUserMedia&&i.mediaDevices&&i.mediaDevices.getUserMedia&&(i.getUserMedia=function(e,t,r){i.mediaDevices.getUserMedia(e).then(t,r)}.bind(i))},r.shimConstraints=n,r.shimRTCIceServerUrls=function(e){var o=e.RTCPeerConnection;e.RTCPeerConnection=function(e,t){if(e&&e.iceServers){for(var r=[],i=0;i<e.iceServers.length;i++){var n=e.iceServers[i];!n.hasOwnProperty("urls")&&n.hasOwnProperty("url")?(s.deprecated("RTCIceServer.url","RTCIceServer.urls"),(n=JSON.parse(JSON.stringify(n))).urls=n.url,delete n.url,r.push(n)):r.push(e.iceServers[i])}e.iceServers=r}return new o(e,t)},e.RTCPeerConnection.prototype=o.prototype,"generateCertificate"in e.RTCPeerConnection&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return o.generateCertificate}})},r.shimTrackEventTransceiver=function(e){"object"===(void 0===e?"undefined":d(e))&&e.RTCPeerConnection&&"receiver"in e.RTCTrackEvent.prototype&&!e.RTCTransceiver&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},r.shimCreateOfferLegacy=function(e){var i=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){var t,r;return e&&(void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio),t=this.getTransceivers().find(function(e){return"audio"===e.receiver.track.kind}),!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo),r=this.getTransceivers().find(function(e){return"video"===e.receiver.track.kind}),!1===e.offerToReceiveVideo&&r?"sendrecv"===r.direction?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":"recvonly"===r.direction&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):!0!==e.offerToReceiveVideo||r||this.addTransceiver("video")),i.apply(this,arguments)}};var s=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils"));function n(e){return e&&void 0!==e.video?Object.assign({},e,{video:s.compactObject(e.video)}):e}},{"../utils":15}],15:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.extractVersion=i,r.wrapPeerConnectionEvent=function(e,i,n){var t,o,s;e.RTCPeerConnection&&(t=e.RTCPeerConnection.prototype,o=t.addEventListener,t.addEventListener=function(e,r){if(e!==i)return o.apply(this,arguments);var t=function(e){var t=n(e);t&&r(t)};return this._eventMap=this._eventMap||{},this._eventMap[r]=t,o.apply(this,[e,t])},s=t.removeEventListener,t.removeEventListener=function(e,t){if(e!==i||!this._eventMap||!this._eventMap[t])return s.apply(this,arguments);var r=this._eventMap[t];return delete this._eventMap[t],s.apply(this,[e,r])},Object.defineProperty(t,"on"+i,{get:function(){return this["_on"+i]},set:function(e){this["_on"+i]&&(this.removeEventListener(i,this["_on"+i]),delete this["_on"+i]),e&&this.addEventListener(i,this["_on"+i]=e)},enumerable:!0,configurable:!0}))},r.disableLog=function(e){return"boolean"!=typeof e?new Error("Argument type: "+(void 0===e?"undefined":a(e))+". Please use a boolean."):e?"adapter.js logging disabled":"adapter.js logging enabled"},r.disableWarnings=function(e){return"boolean"!=typeof e?new Error("Argument type: "+(void 0===e?"undefined":a(e))+". Please use a boolean."):"adapter.js deprecation warnings "+(e?"disabled":"enabled")},r.log=function(){"undefined"==typeof window||a(window)},r.deprecated=function(e,t){},r.detectBrowser=function(e){var t=e.navigator,r={browser:null,version:null};if(void 0===e||!e.navigator)return r.browser="Not a browser.",r;if(t.mozGetUserMedia)r.browser="firefox",r.version=i(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)r.browser="chrome",r.version=i(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))r.browser="edge",r.version=i(t.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!t.userAgent.match(/AppleWebKit\/(\d+)\./))return r.browser="Not a supported browser.",r;r.browser="safari",r.version=i(t.userAgent,/AppleWebKit\/(\d+)\./,1)}return r},r.compactObject=function o(s){return"object"!==(void 0===s?"undefined":a(s))?s:Object.keys(s).reduce(function(e,t){var r="object"===a(s[t]),i=r?o(s[t]):s[t],n=r&&!Object.keys(i).length;return void 0===i||n?e:Object.assign(e,function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}({},t,i))},{})},r.walkStats=s,r.filterStats=function(r,t,e){var i=e?"outbound-rtp":"inbound-rtp",n=new Map;if(null===t)return n;var o=[];return r.forEach(function(e){"track"===e.type&&e.trackIdentifier===t.id&&o.push(e)}),o.forEach(function(t){r.forEach(function(e){e.type===i&&e.trackId===t.id&&s(r,e,n)})}),n};function i(e,t,r){var i=e.match(t);return i&&i.length>=r&&parseInt(i[r],10)}function s(t,r,i){r&&!i.has(r.id)&&(i.set(r.id,r),Object.keys(r).forEach(function(e){e.endsWith("Id")?s(t,t.get(r[e]),i):e.endsWith("Ids")&&r[e].forEach(function(e){s(t,t.get(e),i)})}))}},{}],16:[function(e,t,r){"use strict";var x=e("sdp");function c(e,t,r,i,n){var o,s,a=x.writeRtpDescription(e.kind,t);return a+=x.writeIceParameters(e.iceGatherer.getLocalParameters()),a+=x.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":n||"active"),a+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?a+="a=sendrecv\r\n":e.rtpSender?a+="a=sendonly\r\n":e.rtpReceiver?a+="a=recvonly\r\n":a+="a=inactive\r\n",e.rtpSender&&(o=e.rtpSender._initialTrackId||e.rtpSender.track.id,e.rtpSender._initialTrackId=o,s="msid:"+(i?i.id:"-")+" "+o+"\r\n",a+="a="+s,a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+s,e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+s,a+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")),a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+x.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+x.localCName+"\r\n"),a}function z(i,n){var o={codecs:[],headerExtensions:[],fecMechanisms:[]},s=function(e,t){e=parseInt(e,10);for(var r=0;r<t.length;r++)if(t[r].payloadType===e||t[r].preferredPayloadType===e)return t[r]};return i.codecs.forEach(function(r){for(var e=0;e<n.codecs.length;e++){var t=n.codecs[e];if(r.name.toLowerCase()===t.name.toLowerCase()&&r.clockRate===t.clockRate){if("rtx"===r.name.toLowerCase()&&r.parameters&&t.parameters.apt&&!function(e,t,r,i){var n=s(e.parameters.apt,r),o=s(t.parameters.apt,i);return n&&o&&n.name.toLowerCase()===o.name.toLowerCase()}(r,t,i.codecs,n.codecs))continue;(t=JSON.parse(JSON.stringify(t))).numChannels=Math.min(r.numChannels,t.numChannels),o.codecs.push(t),t.rtcpFeedback=t.rtcpFeedback.filter(function(e){for(var t=0;t<r.rtcpFeedback.length;t++)if(r.rtcpFeedback[t].type===e.type&&r.rtcpFeedback[t].parameter===e.parameter)return!0;return!1});break}}}),i.headerExtensions.forEach(function(e){for(var t=0;t<n.headerExtensions.length;t++){var r=n.headerExtensions[t];if(e.uri===r.uri){o.headerExtensions.push(r);break}}}),o}function o(e,t,r){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(r)}function A(e,t){var r=e.getRemoteCandidates().find(function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type});return r||e.addRemoteCandidate(t),!r}function g(e,t){var r=new Error(t);return r.name=e,r.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],r}t.exports=function(N,D){function O(e,t){t.addTrack(e),t.dispatchEvent(new N.MediaStreamTrackEvent("addtrack",{track:e}))}function n(e,t,r,i){var n=new Event("track");n.track=t,n.receiver=r,n.transceiver={receiver:r},n.streams=i,N.setTimeout(function(){e._dispatchEvent("track",n)})}var i=function(e){var t=this,r=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(e){t[e]=r[e].bind(r)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",e=JSON.parse(JSON.stringify(e||{})),this.usingBundle="max-bundle"===e.bundlePolicy,"negotiate"===e.rtcpMuxPolicy)throw g("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(e.rtcpMuxPolicy||(e.rtcpMuxPolicy="require"),e.iceTransportPolicy){case"all":case"relay":break;default:e.iceTransportPolicy="all"}switch(e.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:e.bundlePolicy="balanced"}if(e.iceServers=function(e,i){var n=!1;return(e=JSON.parse(JSON.stringify(e))).filter(function(e){if(e&&(e.urls||e.url)){var t=e.urls||e.url;e.url&&e.urls;var r="string"==typeof t;return r&&(t=[t]),t=t.filter(function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||n?0===e.indexOf("stun:")&&14393<=i&&-1===e.indexOf("?transport=udp"):n=!0}),delete e.url,e.urls=r?t[0]:t,!!t.length}})}(e.iceServers||[],D),this._iceGatherers=[],e.iceCandidatePoolSize)for(var i=e.iceCandidatePoolSize;0<i;i--)this._iceGatherers.push(new N.RTCIceGatherer({iceServers:e.iceServers,gatherPolicy:e.iceTransportPolicy}));else e.iceCandidatePoolSize=0;this._config=e,this.transceivers=[],this._sdpSessionId=x.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(i.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(i.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),i.prototype.onicecandidate=null,i.prototype.onaddstream=null,i.prototype.ontrack=null,i.prototype.onremovestream=null,i.prototype.onsignalingstatechange=null,i.prototype.oniceconnectionstatechange=null,i.prototype.onconnectionstatechange=null,i.prototype.onicegatheringstatechange=null,i.prototype.onnegotiationneeded=null,i.prototype.ondatachannel=null,i.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},i.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},i.prototype.getConfiguration=function(){return this._config},i.prototype.getLocalStreams=function(){return this.localStreams},i.prototype.getRemoteStreams=function(){return this.remoteStreams},i.prototype._createTransceiver=function(e,t){var r,i=0<this.transceivers.length,n={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};return this.usingBundle&&i?(n.iceTransport=this.transceivers[0].iceTransport,n.dtlsTransport=this.transceivers[0].dtlsTransport):(r=this._createIceAndDtlsTransports(),n.iceTransport=r.iceTransport,n.dtlsTransport=r.dtlsTransport),t||this.transceivers.push(n),n},i.prototype.addTrack=function(t,e){if(this._isClosed)throw g("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var r;if(this.transceivers.find(function(e){return e.track===t}))throw g("InvalidAccessError","Track already exists.");for(var i=0;i<this.transceivers.length;i++)this.transceivers[i].track||this.transceivers[i].kind!==t.kind||(r=this.transceivers[i]);return r=r||this._createTransceiver(t.kind),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(e)&&this.localStreams.push(e),r.track=t,r.stream=e,r.rtpSender=new N.RTCRtpSender(t,r.dtlsTransport),r.rtpSender},i.prototype.addStream=function(t){var i,r=this;15025<=D?t.getTracks().forEach(function(e){r.addTrack(e,t)}):(i=t.clone(),t.getTracks().forEach(function(e,t){var r=i.getTracks()[t];e.addEventListener("enabled",function(e){r.enabled=e.enabled})}),i.getTracks().forEach(function(e){r.addTrack(e,i)}))},i.prototype.removeTrack=function(t){if(this._isClosed)throw g("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof N.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var e=this.transceivers.find(function(e){return e.rtpSender===t});if(!e)throw g("InvalidAccessError","Sender was not created by this connection.");var r=e.stream;e.rtpSender.stop(),e.rtpSender=null,e.track=null,e.stream=null,-1===this.transceivers.map(function(e){return e.stream}).indexOf(r)&&-1<this.localStreams.indexOf(r)&&this.localStreams.splice(this.localStreams.indexOf(r),1),this._maybeFireNegotiationNeeded()},i.prototype.removeStream=function(e){var r=this;e.getTracks().forEach(function(t){var e=r.getSenders().find(function(e){return e.track===t});e&&r.removeTrack(e)})},i.prototype.getSenders=function(){return this.transceivers.filter(function(e){return!!e.rtpSender}).map(function(e){return e.rtpSender})},i.prototype.getReceivers=function(){return this.transceivers.filter(function(e){return!!e.rtpReceiver}).map(function(e){return e.rtpReceiver})},i.prototype._createIceGatherer=function(r,e){var i=this;if(e&&0<r)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var n=new N.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(n,"state",{value:"new",writable:!0}),this.transceivers[r].bufferedCandidateEvents=[],this.transceivers[r].bufferCandidates=function(e){var t=!e.candidate||0===Object.keys(e.candidate).length;n.state=t?"completed":"gathering",null!==i.transceivers[r].bufferedCandidateEvents&&i.transceivers[r].bufferedCandidateEvents.push(e)},n.addEventListener("localcandidate",this.transceivers[r].bufferCandidates),n},i.prototype._gather=function(a,c){var e,d=this,l=this.transceivers[c].iceGatherer;l.onlocalcandidate||(e=this.transceivers[c].bufferedCandidateEvents,this.transceivers[c].bufferedCandidateEvents=null,l.removeEventListener("localcandidate",this.transceivers[c].bufferCandidates),l.onlocalcandidate=function(e){var t,r,i,n,o,s;d.usingBundle&&0<c||((t=new Event("icecandidate")).candidate={sdpMid:a,sdpMLineIndex:c},r=e.candidate,(i=!r||0===Object.keys(r).length)?"new"!==l.state&&"gathering"!==l.state||(l.state="completed"):("new"===l.state&&(l.state="gathering"),r.component=1,r.ufrag=l.getLocalParameters().usernameFragment,n=x.writeCandidate(r),t.candidate=Object.assign(t.candidate,x.parseCandidate(n)),t.candidate.candidate=n,t.candidate.toJSON=function(){return{candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex,usernameFragment:t.candidate.usernameFragment}}),(o=x.getMediaSections(d._localDescription.sdp))[t.candidate.sdpMLineIndex]+=i?"a=end-of-candidates\r\n":"a="+t.candidate.candidate+"\r\n",d._localDescription.sdp=x.getDescription(d._localDescription.sdp)+o.join(""),s=d.transceivers.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}),"gathering"!==d.iceGatheringState&&(d.iceGatheringState="gathering",d._emitGatheringStateChange()),i||d._dispatchEvent("icecandidate",t),s&&(d._dispatchEvent("icecandidate",new Event("icecandidate")),d.iceGatheringState="complete",d._emitGatheringStateChange()))},N.setTimeout(function(){e.forEach(function(e){l.onlocalcandidate(e)})},0))},i.prototype._createIceAndDtlsTransports=function(){var e=this,t=new N.RTCIceTransport(null);t.onicestatechange=function(){e._updateIceConnectionState(),e._updateConnectionState()};var r=new N.RTCDtlsTransport(t);return r.ondtlsstatechange=function(){e._updateConnectionState()},r.onerror=function(){Object.defineProperty(r,"state",{value:"failed",writable:!0}),e._updateConnectionState()},{iceTransport:t,dtlsTransport:r}},i.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var r=this.transceivers[e].iceTransport;r&&(delete r.onicestatechange,delete this.transceivers[e].iceTransport);var i=this.transceivers[e].dtlsTransport;i&&(delete i.ondtlsstatechange,delete i.onerror,delete this.transceivers[e].dtlsTransport)},i.prototype._transceive=function(e,t,r){var i=z(e.localCapabilities,e.remoteCapabilities);t&&e.rtpSender&&(i.encodings=e.sendEncodingParameters,i.rtcp={cname:x.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(i.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(i)),r&&e.rtpReceiver&&0<i.codecs.length&&("video"===e.kind&&e.recvEncodingParameters&&D<15019&&e.recvEncodingParameters.forEach(function(e){delete e.rtx}),e.recvEncodingParameters.length?i.encodings=e.recvEncodingParameters:i.encodings=[{}],i.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(i.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(i.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(i))},i.prototype.setLocalDescription=function(e){var t,h,u,p=this;return-1===["offer","answer"].indexOf(e.type)?Promise.reject(g("TypeError",'Unsupported type "'+e.type+'"')):!o("setLocalDescription",e.type,p.signalingState)||p._isClosed?Promise.reject(g("InvalidStateError","Can not set local "+e.type+" in state "+p.signalingState)):("offer"===e.type?(t=x.splitSections(e.sdp),h=t.shift(),t.forEach(function(e,t){var r=x.parseRtpParameters(e);p.transceivers[t].localCapabilities=r}),p.transceivers.forEach(function(e,t){p._gather(e.mid,t)})):"answer"===e.type&&(t=x.splitSections(p._remoteDescription.sdp),h=t.shift(),u=0<x.matchPrefix(h,"a=ice-lite").length,t.forEach(function(e,t){var r,i,n,o=p.transceivers[t],s=o.iceGatherer,a=o.iceTransport,c=o.dtlsTransport,d=o.localCapabilities,l=o.remoteCapabilities;x.isRejected(e)&&0===x.matchPrefix(e,"a=bundle-only").length||o.rejected||(r=x.getIceParameters(e,h),i=x.getDtlsParameters(e,h),u&&(i.role="server"),p.usingBundle&&0!==t||(p._gather(o.mid,t),"new"===a.state&&a.start(s,r,u?"controlling":"controlled"),"new"===c.state&&c.start(i)),n=z(d,l),p._transceive(o,0<n.codecs.length,!1))})),p._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?p._updateSignalingState("have-local-offer"):p._updateSignalingState("stable"),Promise.resolve())},i.prototype.setRemoteDescription=function(R){var M=this;if(-1===["offer","answer"].indexOf(R.type))return Promise.reject(g("TypeError",'Unsupported type "'+R.type+'"'));if(!o("setRemoteDescription",R.type,M.signalingState)||M._isClosed)return Promise.reject(g("InvalidStateError","Can not set remote "+R.type+" in state "+M.signalingState));var P={};M.remoteStreams.forEach(function(e){P[e.id]=e});var L=[],e=x.splitSections(R.sdp),I=e.shift(),k=0<x.matchPrefix(I,"a=ice-lite").length,U=0<x.matchPrefix(I,"a=group:BUNDLE ").length;M.usingBundle=U;var t=x.matchPrefix(I,"a=ice-options:")[0];return M.canTrickleIceCandidates=!!t&&0<=t.substr(14).split(" ").indexOf("trickle"),e.forEach(function(e,t){var r,i,n,o,s,a,c,d,l,h,u,p,g,f,m,v,y,b=x.splitLines(e),S=x.getKind(e),C=x.isRejected(e)&&0===x.matchPrefix(e,"a=bundle-only").length,_=b[0].substr(2).split(" ")[2],T=x.getDirection(e,I),E=x.parseMsid(e),w=x.getMid(e)||x.generateIdentifier();C||"application"===S&&("DTLS/SCTP"===_||"UDP/DTLS/SCTP"===_)?M.transceivers[t]={mid:w,kind:S,protocol:_,rejected:!0}:(!C&&M.transceivers[t]&&M.transceivers[t].rejected&&(M.transceivers[t]=M._createTransceiver(S,!0)),p=x.parseRtpParameters(e),C||(h=x.getIceParameters(e,I),(u=x.getDtlsParameters(e,I)).role="client"),c=x.parseRtpEncodingParameters(e),g=x.parseRtcpParameters(e),f=0<x.matchPrefix(e,"a=end-of-candidates",I).length,m=x.matchPrefix(e,"a=candidate:").map(function(e){return x.parseCandidate(e)}).filter(function(e){return 1===e.component}),("offer"===R.type||"answer"===R.type)&&!C&&U&&0<t&&M.transceivers[t]&&(M._disposeIceAndDtlsTransports(t),M.transceivers[t].iceGatherer=M.transceivers[0].iceGatherer,M.transceivers[t].iceTransport=M.transceivers[0].iceTransport,M.transceivers[t].dtlsTransport=M.transceivers[0].dtlsTransport,M.transceivers[t].rtpSender&&M.transceivers[t].rtpSender.setTransport(M.transceivers[0].dtlsTransport),M.transceivers[t].rtpReceiver&&M.transceivers[t].rtpReceiver.setTransport(M.transceivers[0].dtlsTransport)),"offer"!==R.type||C?"answer"!==R.type||C||(i=(r=M.transceivers[t]).iceGatherer,n=r.iceTransport,o=r.dtlsTransport,s=r.rtpReceiver,a=r.sendEncodingParameters,d=r.localCapabilities,M.transceivers[t].recvEncodingParameters=c,M.transceivers[t].remoteCapabilities=p,M.transceivers[t].rtcpParameters=g,m.length&&"new"===n.state&&(!k&&!f||U&&0!==t?m.forEach(function(e){A(r.iceTransport,e)}):n.setRemoteCandidates(m)),U&&0!==t||("new"===n.state&&n.start(i,h,"controlling"),"new"===o.state&&o.start(u)),!z(r.localCapabilities,r.remoteCapabilities).codecs.filter(function(e){return"rtx"===e.name.toLowerCase()}).length&&r.sendEncodingParameters[0].rtx&&delete r.sendEncodingParameters[0].rtx,M._transceive(r,"sendrecv"===T||"recvonly"===T,"sendrecv"===T||"sendonly"===T),!s||"sendrecv"!==T&&"sendonly"!==T?delete r.rtpReceiver:(l=s.track,E?(P[E.stream]||(P[E.stream]=new N.MediaStream),O(l,P[E.stream]),L.push([l,s,P[E.stream]])):(P.default||(P.default=new N.MediaStream),O(l,P.default),L.push([l,s,P.default])))):((r=M.transceivers[t]||M._createTransceiver(S)).mid=w,r.iceGatherer||(r.iceGatherer=M._createIceGatherer(t,U)),m.length&&"new"===r.iceTransport.state&&(!f||U&&0!==t?m.forEach(function(e){A(r.iceTransport,e)}):r.iceTransport.setRemoteCandidates(m)),d=N.RTCRtpReceiver.getCapabilities(S),D<15019&&(d.codecs=d.codecs.filter(function(e){return"rtx"!==e.name})),a=r.sendEncodingParameters||[{ssrc:1001*(2*t+2)}],y=!1,"sendrecv"===T||"sendonly"===T?(y=!r.rtpReceiver,s=r.rtpReceiver||new N.RTCRtpReceiver(r.dtlsTransport,S),y&&(l=s.track,E&&"-"===E.stream||(v=E?(P[E.stream]||(P[E.stream]=new N.MediaStream,Object.defineProperty(P[E.stream],"id",{get:function(){return E.stream}})),Object.defineProperty(l,"id",{get:function(){return E.track}}),P[E.stream]):(P.default||(P.default=new N.MediaStream),P.default)),v&&(O(l,v),r.associatedRemoteMediaStreams.push(v)),L.push([l,s,v]))):r.rtpReceiver&&r.rtpReceiver.track&&(r.associatedRemoteMediaStreams.forEach(function(e){var t=e.getTracks().find(function(e){return e.id===r.rtpReceiver.track.id});t&&function(e,t){t.removeTrack(e),t.dispatchEvent(new N.MediaStreamTrackEvent("removetrack",{track:e}))}(t,e)}),r.associatedRemoteMediaStreams=[]),r.localCapabilities=d,r.remoteCapabilities=p,r.rtpReceiver=s,r.rtcpParameters=g,r.sendEncodingParameters=a,r.recvEncodingParameters=c,M._transceive(M.transceivers[t],!1,y)))}),void 0===M._dtlsRole&&(M._dtlsRole="offer"===R.type?"active":"passive"),M._remoteDescription={type:R.type,sdp:R.sdp},"offer"===R.type?M._updateSignalingState("have-remote-offer"):M._updateSignalingState("stable"),Object.keys(P).forEach(function(e){var t,i=P[e];i.getTracks().length&&(-1===M.remoteStreams.indexOf(i)&&(M.remoteStreams.push(i),(t=new Event("addstream")).stream=i,N.setTimeout(function(){M._dispatchEvent("addstream",t)})),L.forEach(function(e){var t=e[0],r=e[1];i.id===e[2].id&&n(M,t,r,[i])}))}),L.forEach(function(e){e[2]||n(M,e[0],e[1],[])}),N.setTimeout(function(){M&&M.transceivers&&M.transceivers.forEach(function(e){e.iceTransport&&"new"===e.iceTransport.state&&0<e.iceTransport.getRemoteCandidates().length&&e.iceTransport.addRemoteCandidate({})})},4e3),Promise.resolve()},i.prototype.close=function(){this.transceivers.forEach(function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},i.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},i.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,N.setTimeout(function(){var e;t.needNegotiation&&(t.needNegotiation=!1,e=new Event("negotiationneeded"),t._dispatchEvent("negotiationneeded",e))},0))},i.prototype._updateIceConnectionState=function(){var e,t,r={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};this.transceivers.forEach(function(e){e.iceTransport&&!e.rejected&&r[e.iceTransport.state]++}),e="new",0<r.failed?e="failed":0<r.checking?e="checking":0<r.disconnected?e="disconnected":0<r.new?e="new":0<r.connected?e="connected":0<r.completed&&(e="completed"),e!==this.iceConnectionState&&(this.iceConnectionState=e,t=new Event("iceconnectionstatechange"),this._dispatchEvent("iceconnectionstatechange",t))},i.prototype._updateConnectionState=function(){var e,t,r={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};this.transceivers.forEach(function(e){e.iceTransport&&e.dtlsTransport&&!e.rejected&&(r[e.iceTransport.state]++,r[e.dtlsTransport.state]++)}),r.connected+=r.completed,e="new",0<r.failed?e="failed":0<r.connecting?e="connecting":0<r.disconnected?e="disconnected":0<r.new?e="new":0<r.connected&&(e="connected"),e!==this.connectionState&&(this.connectionState=e,t=new Event("connectionstatechange"),this._dispatchEvent("connectionstatechange",t))},i.prototype.createOffer=function(){var a=this;if(a._isClosed)return Promise.reject(g("InvalidStateError","Can not call createOffer after close"));var t=a.transceivers.filter(function(e){return"audio"===e.kind}).length,r=a.transceivers.filter(function(e){return"video"===e.kind}).length,e=arguments[0];if(e){if(e.mandatory||e.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==e.offerToReceiveAudio&&(t=!0===e.offerToReceiveAudio?1:!1===e.offerToReceiveAudio?0:e.offerToReceiveAudio),void 0!==e.offerToReceiveVideo&&(r=!0===e.offerToReceiveVideo?1:!1===e.offerToReceiveVideo?0:e.offerToReceiveVideo)}for(a.transceivers.forEach(function(e){"audio"===e.kind?--t<0&&(e.wantReceive=!1):"video"===e.kind&&--r<0&&(e.wantReceive=!1)});0<t||0<r;)0<t&&(a._createTransceiver("audio"),t--),0<r&&(a._createTransceiver("video"),r--);var i=x.writeSessionBoilerplate(a._sdpSessionId,a._sdpSessionVersion++);a.transceivers.forEach(function(e,t){var r=e.track,i=e.kind,n=e.mid||x.generateIdentifier();e.mid=n,e.iceGatherer||(e.iceGatherer=a._createIceGatherer(t,a.usingBundle));var o=N.RTCRtpSender.getCapabilities(i);D<15019&&(o.codecs=o.codecs.filter(function(e){return"rtx"!==e.name})),o.codecs.forEach(function(t){"H264"===t.name&&void 0===t.parameters["level-asymmetry-allowed"]&&(t.parameters["level-asymmetry-allowed"]="1"),e.remoteCapabilities&&e.remoteCapabilities.codecs&&e.remoteCapabilities.codecs.forEach(function(e){t.name.toLowerCase()===e.name.toLowerCase()&&t.clockRate===e.clockRate&&(t.preferredPayloadType=e.payloadType)})}),o.headerExtensions.forEach(function(t){(e.remoteCapabilities&&e.remoteCapabilities.headerExtensions||[]).forEach(function(e){t.uri===e.uri&&(t.id=e.id)})});var s=e.sendEncodingParameters||[{ssrc:1001*(2*t+1)}];r&&15019<=D&&"video"===i&&!s[0].rtx&&(s[0].rtx={ssrc:s[0].ssrc+1}),e.wantReceive&&(e.rtpReceiver=new N.RTCRtpReceiver(e.dtlsTransport,i)),e.localCapabilities=o,e.sendEncodingParameters=s}),"max-compat"!==a._config.bundlePolicy&&(i+="a=group:BUNDLE "+a.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),i+="a=ice-options:trickle\r\n",a.transceivers.forEach(function(e,t){i+=c(e,e.localCapabilities,"offer",e.stream,a._dtlsRole),i+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===a.iceGatheringState||0!==t&&a.usingBundle||(e.iceGatherer.getLocalCandidates().forEach(function(e){e.component=1,i+="a="+x.writeCandidate(e)+"\r\n"}),"completed"===e.iceGatherer.state&&(i+="a=end-of-candidates\r\n"))});var n=new N.RTCSessionDescription({type:"offer",sdp:i});return Promise.resolve(n)},i.prototype.createAnswer=function(){var n=this;if(n._isClosed)return Promise.reject(g("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==n.signalingState&&"have-local-pranswer"!==n.signalingState)return Promise.reject(g("InvalidStateError","Can not call createAnswer in signalingState "+n.signalingState));var o=x.writeSessionBoilerplate(n._sdpSessionId,n._sdpSessionVersion++);n.usingBundle&&(o+="a=group:BUNDLE "+n.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),o+="a=ice-options:trickle\r\n";var s=x.getMediaSections(n._remoteDescription.sdp).length;n.transceivers.forEach(function(e,t){if(!(s<t+1)){if(e.rejected)return"application"===e.kind?"DTLS/SCTP"===e.protocol?o+="m=application 0 DTLS/SCTP 5000\r\n":o+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?o+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(o+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(o+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var r;e.stream&&("audio"===e.kind?r=e.stream.getAudioTracks()[0]:"video"===e.kind&&(r=e.stream.getVideoTracks()[0]),r&&15019<=D&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1}));var i=z(e.localCapabilities,e.remoteCapabilities);!i.codecs.filter(function(e){return"rtx"===e.name.toLowerCase()}).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,o+=c(e,i,"answer",e.stream,n._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(o+="a=rtcp-rsize\r\n")}});var e=new N.RTCSessionDescription({type:"answer",sdp:o});return Promise.resolve(e)},i.prototype.addIceCandidate=function(c){var d,l=this;return c&&void 0===c.sdpMLineIndex&&!c.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(e,t){if(!l._remoteDescription)return t(g("InvalidStateError","Can not add ICE candidate without a remote description"));if(c&&""!==c.candidate){var r=c.sdpMLineIndex;if(c.sdpMid)for(var i=0;i<l.transceivers.length;i++)if(l.transceivers[i].mid===c.sdpMid){r=i;break}var n=l.transceivers[r];if(!n)return t(g("OperationError","Can not add ICE candidate"));if(n.rejected)return e();var o=0<Object.keys(c.candidate).length?x.parseCandidate(c.candidate):{};if("tcp"===o.protocol&&(0===o.port||9===o.port))return e();if(o.component&&1!==o.component)return e();if((0===r||0<r&&n.iceTransport!==l.transceivers[0].iceTransport)&&!A(n.iceTransport,o))return t(g("OperationError","Can not add ICE candidate"));var s=c.candidate.trim();0===s.indexOf("a=")&&(s=s.substr(2)),(d=x.getMediaSections(l._remoteDescription.sdp))[r]+="a="+(o.type?s:"end-of-candidates")+"\r\n",l._remoteDescription.sdp=x.getDescription(l._remoteDescription.sdp)+d.join("")}else for(var a=0;a<l.transceivers.length&&(l.transceivers[a].rejected||(l.transceivers[a].iceTransport.addRemoteCandidate({}),(d=x.getMediaSections(l._remoteDescription.sdp))[a]+="a=end-of-candidates\r\n",l._remoteDescription.sdp=x.getDescription(l._remoteDescription.sdp)+d.join(""),!l.usingBundle));a++);e()})},i.prototype.getStats=function(t){if(t&&t instanceof N.MediaStreamTrack){var r=null;if(this.transceivers.forEach(function(e){e.rtpSender&&e.rtpSender.track===t?r=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(r=e.rtpReceiver)}),!r)throw g("InvalidAccessError","Invalid selector.");return r.getStats()}var i=[];return this.transceivers.forEach(function(t){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(e){t[e]&&i.push(t[e].getStats())})}),Promise.all(i).then(function(e){var t=new Map;return e.forEach(function(e){e.forEach(function(e){t.set(e.id,e)})}),t})},["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach(function(e){var t,r=N[e];r&&r.prototype&&r.prototype.getStats&&(t=r.prototype.getStats,r.prototype.getStats=function(){return t.apply(this).then(function(r){var i=new Map;return Object.keys(r).forEach(function(e){var t;r[e].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(t=r[e]).type]||t.type,i.set(e,r[e])}),i})})});var e=["createOffer","createAnswer"];return e.forEach(function(e){var r=i.prototype[e];i.prototype[e]=function(){var t=arguments;return"function"==typeof t[0]||"function"==typeof t[1]?r.apply(this,[arguments[2]]).then(function(e){"function"==typeof t[0]&&t[0].apply(null,[e])},function(e){"function"==typeof t[1]&&t[1].apply(null,[e])}):r.apply(this,arguments)}}),(e=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach(function(e){var r=i.prototype[e];i.prototype[e]=function(){var t=arguments;return"function"==typeof t[1]||"function"==typeof t[2]?r.apply(this,arguments).then(function(){"function"==typeof t[1]&&t[1].apply(null)},function(e){"function"==typeof t[2]&&t[2].apply(null,[e])}):r.apply(this,arguments)}}),["getStats"].forEach(function(e){var t=i.prototype[e];i.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then(function(){"function"==typeof e[1]&&e[1].apply(null)}):t.apply(this,arguments)}}),i}},{sdp:17}],17:[function(e,t,r){"use strict";var l={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};l.localCName=l.generateIdentifier(),l.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim()})},l.splitSections=function(e){return e.split("\nm=").map(function(e,t){return(0<t?"m="+e:e).trim()+"\r\n"})},l.getDescription=function(e){var t=l.splitSections(e);return t&&t[0]},l.getMediaSections=function(e){var t=l.splitSections(e);return t.shift(),t},l.matchPrefix=function(e,t){return l.splitLines(e).filter(function(e){return 0===e.indexOf(t)})},l.parseCandidate=function(e){for(var t,r={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},i=8;i<t.length;i+=2)switch(t[i]){case"raddr":r.relatedAddress=t[i+1];break;case"rport":r.relatedPort=parseInt(t[i+1],10);break;case"tcptype":r.tcpType=t[i+1];break;case"ufrag":r.ufrag=t[i+1],r.usernameFragment=t[i+1];break;default:r[t[i]]=t[i+1]}return r},l.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var r=e.type;return t.push("typ"),t.push(r),"host"!==r&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},l.parseIceOptions=function(e){return e.substr(14).split(" ")},l.parseRtpMap=function(e){var t=e.substr(9).split(" "),r={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.channels=3===t.length?parseInt(t[2],10):1,r.numChannels=r.channels,r},l.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var r=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==r?"/"+r:"")+"\r\n"},l.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:0<t[0].indexOf("/")?t[0].split("/")[1]:"sendrecv",uri:t[1]}},l.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},l.parseFmtp=function(e){for(var t,r={},i=e.substr(e.indexOf(" ")+1).split(";"),n=0;n<i.length;n++)r[(t=i[n].trim().split("="))[0].trim()]=t[1];return r},l.writeFmtp=function(t){var r,e="",i=t.payloadType;return void 0!==t.preferredPayloadType&&(i=t.preferredPayloadType),t.parameters&&Object.keys(t.parameters).length&&(r=[],Object.keys(t.parameters).forEach(function(e){t.parameters[e]?r.push(e+"="+t.parameters[e]):r.push(e)}),e+="a=fmtp:"+i+" "+r.join(";")+"\r\n"),e},l.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},l.writeRtcpFb=function(e){var t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}),t},l.parseSsrcMedia=function(e){var t=e.indexOf(" "),r={ssrc:parseInt(e.substr(7,t-7),10)},i=e.indexOf(":",t);return-1<i?(r.attribute=e.substr(t+1,i-t-1),r.value=e.substr(i+1)):r.attribute=e.substr(t+1),r},l.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map(function(e){return parseInt(e,10)})}},l.getMid=function(e){var t=l.matchPrefix(e,"a=mid:")[0];if(t)return t.substr(6)},l.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},l.getDtlsParameters=function(e,t){return{role:"auto",fingerprints:l.matchPrefix(e+t,"a=fingerprint:").map(l.parseFingerprint)}},l.writeDtlsParameters=function(e,t){var r="a=setup:"+t+"\r\n";return e.fingerprints.forEach(function(e){r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),r},l.getIceParameters=function(e,t){var r=l.splitLines(e);return{usernameFragment:(r=r.concat(l.splitLines(t))).filter(function(e){return 0===e.indexOf("a=ice-ufrag:")})[0].substr(12),password:r.filter(function(e){return 0===e.indexOf("a=ice-pwd:")})[0].substr(10)}},l.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},l.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=l.splitLines(e)[0].split(" "),i=3;i<r.length;i++){var n=r[i],o=l.matchPrefix(e,"a=rtpmap:"+n+" ")[0];if(o){var s=l.parseRtpMap(o),a=l.matchPrefix(e,"a=fmtp:"+n+" ");switch(s.parameters=a.length?l.parseFmtp(a[0]):{},s.rtcpFeedback=l.matchPrefix(e,"a=rtcp-fb:"+n+" ").map(l.parseRtcpFb),t.codecs.push(s),s.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(s.name.toUpperCase())}}}return l.matchPrefix(e,"a=extmap:").forEach(function(e){t.headerExtensions.push(l.parseExtmap(e))}),t},l.writeRtpDescription=function(e,t){var r="";r+="m="+e+" ",r+=0<t.codecs.length?"9":"0",r+=" UDP/TLS/RTP/SAVPF ",r+=t.codecs.map(function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType}).join(" ")+"\r\n",r+="c=IN IP4 0.0.0.0\r\n",r+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach(function(e){r+=l.writeRtpMap(e),r+=l.writeFmtp(e),r+=l.writeRtcpFb(e)});var i=0;return t.codecs.forEach(function(e){e.maxptime>i&&(i=e.maxptime)}),0<i&&(r+="a=maxptime:"+i+"\r\n"),r+="a=rtcp-mux\r\n",t.headerExtensions&&t.headerExtensions.forEach(function(e){r+=l.writeExtmap(e)}),r},l.parseRtpEncodingParameters=function(e){var r,i=[],t=l.parseRtpParameters(e),n=-1!==t.fecMechanisms.indexOf("RED"),o=-1!==t.fecMechanisms.indexOf("ULPFEC"),s=l.matchPrefix(e,"a=ssrc:").map(function(e){return l.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute}),a=0<s.length&&s[0].ssrc,c=l.matchPrefix(e,"a=ssrc-group:FID").map(function(e){return e.substr(17).split(" ").map(function(e){return parseInt(e,10)})});0<c.length&&1<c[0].length&&c[0][0]===a&&(r=c[0][1]),t.codecs.forEach(function(e){var t;"RTX"===e.name.toUpperCase()&&e.parameters.apt&&(t={ssrc:a,codecPayloadType:parseInt(e.parameters.apt,10)},a&&r&&(t.rtx={ssrc:r}),i.push(t),n&&((t=JSON.parse(JSON.stringify(t))).fec={ssrc:a,mechanism:o?"red+ulpfec":"red"},i.push(t)))}),0===i.length&&a&&i.push({ssrc:a});var d=l.matchPrefix(e,"b=");return d.length&&(d=0===d[0].indexOf("b=TIAS:")?parseInt(d[0].substr(7),10):0===d[0].indexOf("b=AS:")?1e3*parseInt(d[0].substr(5),10)*.95-16e3:void 0,i.forEach(function(e){e.maxBitrate=d})),i},l.parseRtcpParameters=function(e){var t={},r=l.matchPrefix(e,"a=ssrc:").map(function(e){return l.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute})[0];r&&(t.cname=r.value,t.ssrc=r.ssrc);var i=l.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=0<i.length,t.compound=0===i.length;var n=l.matchPrefix(e,"a=rtcp-mux");return t.mux=0<n.length,t},l.parseMsid=function(e){var t,r=l.matchPrefix(e,"a=msid:");if(1===r.length)return{stream:(t=r[0].substr(7).split(" "))[0],track:t[1]};var i=l.matchPrefix(e,"a=ssrc:").map(function(e){return l.parseSsrcMedia(e)}).filter(function(e){return"msid"===e.attribute});return 0<i.length?{stream:(t=i[0].value.split(" "))[0],track:t[1]}:void 0},l.generateSessionId=function(){return Math.random().toString().substr(2,21)},l.writeSessionBoilerplate=function(e,t,r){var i=void 0!==t?t:2;return"v=0\r\no="+(r||"thisisadapterortc")+" "+(e||l.generateSessionId())+" "+i+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},l.writeMediaSection=function(e,t,r,i){var n,o=l.writeRtpDescription(e.kind,t);return o+=l.writeIceParameters(e.iceGatherer.getLocalParameters()),o+=l.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":"active"),o+="a=mid:"+e.mid+"\r\n",e.direction?o+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?o+="a=sendrecv\r\n":e.rtpSender?o+="a=sendonly\r\n":e.rtpReceiver?o+="a=recvonly\r\n":o+="a=inactive\r\n",e.rtpSender&&(n="msid:"+i.id+" "+e.rtpSender.track.id+"\r\n",o+="a="+n,o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+n,e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+n,o+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")),o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+l.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+l.localCName+"\r\n"),o},l.getDirection=function(e,t){for(var r=l.splitLines(e),i=0;i<r.length;i++)switch(r[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[i].substr(2)}return t?l.getDirection(t):"sendrecv"},l.getKind=function(e){return l.splitLines(e)[0].split(" ")[0].substr(2)},l.isRejected=function(e){return"0"===e.split(" ",2)[1]},l.parseMLine=function(e){var t=l.splitLines(e)[0].substr(2).split(" ");return{kind:t[0],port:parseInt(t[1],10),protocol:t[2],fmt:t.slice(3).join(" ")}},l.parseOLine=function(e){var t=l.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:t[0],sessionId:t[1],sessionVersion:parseInt(t[2],10),netType:t[3],addressType:t[4],address:t[5]}},l.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var t=l.splitLines(e),r=0;r<t.length;r++)if(t[r].length<2||"="!==t[r].charAt(1))return!1;return!0},"object"==typeof t&&(t.exports=l)},{}]},{},[1])(1)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e){this.delayTime=.1,this.fadeTime=.05,this.startTime=.1,this.previousPitch=-1,this.context=e,this.input=e.createGain(),this.output=e.createGain(),this.mod1=e.createBufferSource(),this.mod2=e.createBufferSource(),this.mod3=e.createBufferSource(),this.mod4=e.createBufferSource(),this.shiftDownBuffer=this.createDelayTimeBuffer(e,this.startTime,this.fadeTime,!1),this.shiftUpBuffer=this.createDelayTimeBuffer(e,this.startTime,this.fadeTime,!0),this.mod1.buffer=this.shiftDownBuffer,this.mod2.buffer=this.shiftDownBuffer,this.mod3.buffer=this.shiftUpBuffer,this.mod4.buffer=this.shiftUpBuffer,this.mod1.loop=!0,this.mod2.loop=!0,this.mod3.loop=!0,this.mod4.loop=!0,this.mod1Gain=e.createGain(),this.mod2Gain=e.createGain(),this.mod3Gain=e.createGain(),this.mod4Gain=e.createGain(),this.mod3Gain.gain.value=0,this.mod4Gain.gain.value=0,this.mod1.connect(this.mod1Gain),this.mod2.connect(this.mod2Gain),this.mod3.connect(this.mod3Gain),this.mod4.connect(this.mod4Gain),this.modGain1=e.createGain(),this.modGain2=e.createGain(),this.delay1=e.createDelay(),this.delay2=e.createDelay(),this.mod1Gain.connect(this.modGain1),this.mod2Gain.connect(this.modGain2),this.mod3Gain.connect(this.modGain1),this.mod4Gain.connect(this.modGain2),this.modGain1.connect(this.delay1.delayTime),this.modGain2.connect(this.delay2.delayTime),this.fade1=e.createBufferSource(),this.fade2=e.createBufferSource(),this.fadeBuffer=this.createFadeBuffer(e,this.startTime,this.fadeTime),this.fade1.buffer=this.fadeBuffer,this.fade2.buffer=this.fadeBuffer,this.fade1.loop=!0,this.fade2.loop=!0,this.mix1=e.createGain(),this.mix2=e.createGain(),this.mix1.gain.value=0,this.mix2.gain.value=0,this.fade1.connect(this.mix1.gain),this.fade2.connect(this.mix2.gain),this.input.connect(this.delay1),this.input.connect(this.delay2),this.delay1.connect(this.mix1),this.delay2.connect(this.mix2),this.mix1.connect(this.output),this.mix2.connect(this.output);var t=e.currentTime+.05,r=t+this.startTime-this.fadeTime;this.mod1.start(t),this.mod2.start(r),this.mod3.start(t),this.mod4.start(r),this.fade1.start(t),this.fade2.start(r),this.setDelay(this.delayTime)}return e.prototype.createFadeBuffer=function(e,t,r){for(var i=t*e.sampleRate,n=i+(t-2*r)*e.sampleRate,o=e.createBuffer(1,n,e.sampleRate),s=o.getChannelData(0),a=r*e.sampleRate,c=i-a,d=0;d<i;++d)s[d]=d<a?Math.sqrt(d/a):c<=d?Math.sqrt(1-(d-c)/a):1;for(d=i;d<length;++d)s[d]=0;return o},e.prototype.createDelayTimeBuffer=function(e,t,r,i){for(var n=t*e.sampleRate,o=n+(t-2*r)*e.sampleRate,s=e.createBuffer(1,o,e.sampleRate),a=s.getChannelData(0),c=0;c<n;++c)a[c]=i?(n-c)/o:c/n;for(c=n;c<o;++c)a[c]=0;return s},e.prototype.setDelay=function(e){this.modGain1.gain.setTargetAtTime(.5*e,0,.01),this.modGain2.gain.setTargetAtTime(.5*e,0,.01)},e.prototype.setPitchOffset=function(e){0<e?(this.mod1Gain.gain.value=0,this.mod2Gain.gain.value=0,this.mod3Gain.gain.value=1,this.mod4Gain.gain.value=1):(this.mod1Gain.gain.value=1,this.mod2Gain.gain.value=1,this.mod3Gain.gain.value=0,this.mod4Gain.gain.value=0),this.setDelay(this.delayTime*Math.abs(e)),this.previousPitch=e},e}();t.pitchUtil=i},function(e,t,r){"use strict";var s=this&&this.__assign||Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e};Object.defineProperty(t,"__esModule",{value:!0});var l=r(0),n=r(1),i=function(){function e(e,t){this.sendDataMap={},this.sendDataList=new l.LinkedList,this.sendDataCheckOnceCount=100,this.signalSeq=0,this.pushCallback={},this.sessionInfos={},this.tryHeartbeatCount=0,this.heartbeatInterval=1e4,this.sendDataTimeout=5e3,this.sendDataDropTimeout=1e4,this.tryConnectCount=1,this.tryConnectTimer=null,this.tryConnectInterval=3e3,this.state=l.ENUM_CONNECT_STATE.disconnect,this.tokenType=0,this.browser=this.getBrowserAndVersion(),this.platform=navigator.platform,this.negoInterval=25e3,this.negoTryCount=1,this.negoTryMaxCount=2,this.logger=e,this.stateCenter=t}return e.prototype.getBrowserAndVersion=function(){var e,t=navigator.userAgent,r=t.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*([\d\.]+)/i)||[];return/trident/i.test(r[1])?{name:"IE",version:(e=/\brv[ :]+([\d\.]+)/g.exec(t)||[])[1]||""}:"Chrome"===r[1]&&null!=(e=t.match(/\bOPR|Edge\/([\d\.]+)/))?{name:"Opera",version:e[1]}:(r=r[2]?[r[1],r[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(e=t.match(/version\/([\d+\.]+)/i))&&r.splice(1,1,e[1]),{name:r[0],version:r[1]})},e.prototype.setSessionInfo=function(e,t){this.logger.debug("zs.ssi.0 call"),this.appid=e+"",this.userid=t},e.prototype.onDisconnect=function(e){},e.prototype.onUpdateHeartBeartInterval=function(e){},e.prototype.resetConnectTimer=function(){this.logger.info("zs.rct.0 call"),clearTimeout(this.tryConnectTimer),this.tryConnectTimer=null,this.tryConnectCount=0},e.prototype.bindWebSocketHandle=function(){var r=this;this.tryHeartbeatCount=0,this.websocket.onmessage=function(e){var t=JSON.parse(e.data);r.logger.info("zs.bsh.0 signmsg= ",t.header.cmd),r.logger.info("zs.bsh.0 signmsg= "+JSON.stringify(t)),t.header.appid==r.appid&&t.header.user_id===r.userid?r.handleServerPush(t):r.logger.warn("zs.bsh.0 check header failed")},this.websocket.onclose=function(e){r.logger.info("zs.bsh.0 signal close msg = "+JSON.stringify(e.code)),r.state!=l.ENUM_CONNECT_STATE.disconnect&&(r.resetConnectTimer(),r.startConnectTimer(),r.resetCheckMessage())},this.websocket.onerror=function(e){r.logger.error("zs.bsh.0 msg = "+JSON.stringify(e))}},e.prototype.resetCheckMessage=function(){this.logger.debug("zs.rcm.0 call");for(var e=this.sendDataList.getFirst();null!=e;)this.sendDataList.remove(e),e._data.error&&e._data.error(l.SEND_MSG_RESET,e._data.seq),e=this.sendDataList.getFirst();this.sendDataMap={}},e.prototype.handleServerPush=function(e){switch(e.header.cmd){case"LoginRsp":this.handleRespondData("LoginReq",e);break;case"CreateSessionRsp":this.handleRespondData("CreateSessionReq",e),0===e.body.result&&this.addSession(e.header.session_id,e.body.session_token);break;case"MediaDescRsp":this.handleRespondData("MediaDescReq",e);break;case"CandidateInfoRsp":this.handleRespondData("CandidateInfoReq",e);break;case"CloseSessionRsp":this.handleRespondData("CloseSessionReq",e),this.removeSession(e.header.session_id);break;case"ClientHBRsp":this.handleRespondData("ClientHBReq",e);break;case"MediaDescPush":case"CandidateInfoPush":this.handlePushData(e);break;case"CloseSessionPush":this.handlePushData(e),this.removeSession(e.header.session_id);break;case"QualityReportRsp":this.handleRespondData("QualityReportReq",e);break;case"SessionResetPush":this.handlePushResetSessionData(e);break;case"StreamStatusNotifyPush":case"PublishEventPush":case"PlayEventPush":this.handlePushData(e)}},e.prototype.disconnectCallback=function(){this.connectCallback&&(this.connectCallback(-1,this.server,void 0),this.connectCallback=null);var e=this.server;this.disconnectServer(),this.onDisconnect(e)},e.prototype.updateToken=function(){var o=this;this.logger.info("zs.ut.0 call");var e={token:this.token,tokenType:this.tokenType,roomid:this.stateCenter.roomid,anchorname:this.stateCenter.anchor_info.anchor_id,sdkversion:l.PROTO_VERSION,osinfo:navigator.appVersion};if(0!=Object.keys(this.sessionInfos).length){var t=[];for(var r in this.sessionInfos){var i=parseInt(r);t.push({session_id:i,session_token:this.sessionInfos[i].token})}e.sessions=t}this.sendMessageWithCallback("LoginReq",n.getSeq(),0,e,function(e,t,r){var i,n;0==r.result?(o.token=r.token,o.tokenType=r.tokenType,i={report:r.report,report_interval:r.report_interval_ms},r.negoInterval&&(o.negoInterval=r.negoInterval),r.negoTryCount&&(o.negoTryCount=r.negoTryCount),r.negoTryMaxCount&&(o.negoTryMaxCount=r.negoTryMaxCount),null!=o.connectCallback&&(o.connectCallback(0,o.server,i),o.connectCallback=null)):(n={error:r.strError},null!=o.connectCallback&&(o.connectCallback(r.result,o.server,n),o.connectCallback=null))},function(e,t){null!=o.connectCallback&&(o.connectCallback(-1,o.server,void 0),o.connectCallback=null)})},e.prototype.sendMessageWithCallback=function(e,t,r,i,n,o){if(this.logger.debug("zs.smwc.0 call "+e),!this.websocket||1!==this.websocket.readyState)return this.logger.error("zs.smwc.0 connect not establish"),void(o&&o(l.SEND_MSG_TIMEOUT,t));var s={header:this.getHeader(e,t,r),body:i};null==n&&(n=null),null==o&&(o=null);var a={seq:t,deleted:!1,cmd:e,time:Date.parse(new Date+""),success:n,error:o},c=this.sendDataList.push(a);this.sendDataMap[a.seq]=c;var d=JSON.stringify(s);this.websocket.send(d),this.logger.debug("zs.smwc.0 success")},e.prototype.getHeader=function(e,t,r){return this.globalHeader={version:"1.0.1",cmd:e,appid:this.appid+"",seq:t,user_id:this.userid,session_id:r},this.globalHeader},e.prototype.connectServer=function(e,t,r){var i=this;if(this.token=e,this.server=t,this.state=l.ENUM_CONNECT_STATE.connecting,this.connectCallback=r,this.websocket&&1===this.websocket.readyState)this.resetConnectTimer(),this.state=l.ENUM_CONNECT_STATE.connected;else{this.logger.info("zs.cs.0 need new websocket");try{this.websocket&&(this.logger.warn("zs.cs.0 close error websocket"),this.websocket.onclose=null,this.websocket.onerror=null,this.websocket.close(),this.websocket=null),this.websocket=new WebSocket(this.server),this.websocket.onopen=function(){i.resetConnectTimer(),i.logger.info("zs.cs.0 websocket open call"),i.bindWebSocketHandle(),i.updateToken(),i.state=l.ENUM_CONNECT_STATE.connected},this.websocket.onclose=function(e){i.logger.info("zs.cs.0 signal websocket close code "+JSON.stringify(e.code))},this.websocket.onerror=function(e){i.logger.info("zs.cs.0 websocket onerror call  "+JSON.stringify(e))}}catch(e){this.logger.error("zs.cs.0 websocket error "+e)}}this.tryConnectTimer=setTimeout(function(){i.startConnectTimer(r)},this.tryConnectInterval)},e.prototype.startConnectTimer=function(e){if(this.logger.info("zs.sct.0 call"),this.tryConnectCount>=l.MAX_TRY_CONNECT_COUNT)return this.logger.info("zs.sct.0 beyond "+this.server+" max limit"),void this.disconnectCallback();this.websocket&&1===this.websocket.readyState?this.resetConnectTimer():(this.tryConnectCount+=1,this.connectServer(this.token,this.server,e))},e.prototype.disconnectServer=function(){this.logger.debug("zs.ds.0 call"),this.connectCallback=null,this.resetCheckMessage(),this.resetConnectTimer(),this.websocket&&(this.websocket.onclose=null,this.websocket.onerror=null,this.websocket.close(),this.websocket=null),this.token="",this.sessionInfos={},this.tokenType=0,this.tryHeartbeatCount=0,this.tryConnectCount=0,this.state=l.ENUM_CONNECT_STATE.disconnect},e.prototype.isServerConnected=function(){return!(!this.websocket||1!==this.websocket.readyState)},e.prototype.createSession=function(e,t,r,i,n,o,s){void 0===n&&(n=""),this.logger.debug("zs.cs.1 call: ",i);var a="";l.PROTO_VERSION.split(".").forEach(function(e,t){return 1==e.length&&1==t?a+="0"+e:a+=e});var c={type:t,stream_id:i,platform:this.platform,browser:this.browser.name,version:this.browser.version,app_id:this.appid,negotiate_mode:r,strAuthParam:n,sdk_version:+a};this.sendMessageWithCallback("CreateSessionReq",e,0,c,o,s)},e.prototype.removeSession=function(e){this.logger.info("zs.rs.0 call"),this.sessionInfos[e]&&delete this.sessionInfos[e]},e.prototype.sendCloseSession=function(e,t,r,i,n){this.logger.debug("zs.scs.0 call: ",t);var o={reason:r};this.removeSession(t),this.sendMessageWithCallback("CloseSessionReq",e,t,o,i,n)},e.prototype.sendMessage=function(e,t,r,i){var n,o;this.logger.debug("zs.sm.0 call "+e),this.websocket&&1===this.websocket.readyState?(n={header:this.getHeader(e,t,r),body:i},o=JSON.stringify(n),this.websocket.send(o),this.logger.debug("zs.sm.0 success")):this.logger.error("zs.sm.0 connect not establish")},e.prototype.handleRespondData=function(e,t){this.logger.debug("zs.hrd.0 call");var r=this.sendDataMap[t.header.seq];if(null!=r){var i=r._data;i.cmd!==e?this.logger.error("sz.hrd.0 command is not match"):i.success&&i.success(t.header.seq,t.header.session_id,t.body),delete this.sendDataMap[t.header.seq],this.sendDataList.remove(r)}else{if("CloseSessionRsp"==t.header.cmd)return;this.logger.error("zs.hrd.0 cannot find data "+e)}},e.prototype.addSession=function(e,t){this.logger.info("zs.as.0 call"),this.sessionInfos[e]={token:t}},e.prototype.handlePushData=function(e){this.logger.debug("zs.hpd.0 call "+e.header.cmd+" session "+e.header.session_id);var t=this.pushCallback[e.header.cmd+e.header.session_id];t?t.callback&&t.callback(e.header.seq,e.header.session_id,e.body):this.logger.info("zs.hpd.0 no callbackData "+e.header.cmd+" session: "+e.header.session_id)},e.prototype.handlePushResetSessionData=function(e){this.logger.debug("zs.hprsd.0 call ");var t=[];if(0==e.body.cResetType)t=Object.keys(this.sessionInfos);else if(1==e.body.cResetType)for(var r=0;r<e.body.session_ids.length;r++)t.push(e.body.session_ids[r]);if(this.sendResetSessionAck(e.header.seq,0,0),0!=t.length)for(var i=0;i<t.length;i++){var n=this.pushCallback[e.header.cmd+t[i]];null==n?this.logger.info("zs.hprsd.0 no callbackData "+t[i]):n.callback&&n.callback(e.header.seq,t[i],e.body)}else this.logger.info("zs.hprsd.0 no session to callback")},e.prototype.sendMediaDesc=function(e,t,r,i,n,o){this.logger.debug("zs.smd.0 call: ",t);var s={type:r,sdp:i.sdp};null!=i.width&&(s.width=i.width),null!=i.height&&(s.height=i.height),null!=i.frameRate&&(s.framerate=i.frameRate),null!=i.video_min_kpbs&&(s.video_min_kpbs=i.video_min_kpbs),null!=i.video_max_kpbs&&(s.video_max_kpbs=i.video_max_kpbs),null!=i.audio_kpbs&&(s.audio_kpbs=i.audio_kpbs),null!=i.keyframe_intv&&(s.keyframe_intv=i.keyframe_intv),this.sendMessageWithCallback("MediaDescReq",e,t,s,n,o)},e.prototype.sendCandidateInfo=function(e,t,r,i,n){this.logger.debug("zs.sci.0 call: ",t);for(var o=[],s=0;s<r.length;s++){var a={candidate:r[s].candidate,sdpMid:r[s].sdpMid,sdpMLineIndex:r[s].sdpMLineIndex};o.push(a)}var c={infos:o};this.sendMessageWithCallback("CandidateInfoReq",e,t,c,i,n)},e.prototype.sendMediaDescAck=function(e,t,r){this.logger.debug("zs.smda.0 call: ",t);var i={result:r};this.sendMessage("MediaDescAck",e,t,i)},e.prototype.sendCandidateInfoAck=function(e,t,r){this.logger.debug("zs.scia.0 call: ",t);var i={result:r};this.sendMessage("CandidateInfoAck",e,t,i)},e.prototype.sendCloseSessionAck=function(e,t,r){this.logger.debug("zs.scsa.0 call: ",t);var i={result:r};this.sendMessage("CloseSessionAck",e,t,i)},e.prototype.sendResetSessionAck=function(e,t,r){this.logger.debug("zs.ssra.0 call: ",t);var i={result:r};this.sendMessage("SessionResetAck",e,t,i)},e.prototype.registerPushCallback=function(e,t,r){r&&"function"==typeof r&&(this.logger.debug("zs.rpc.0 setcallback"),this.pushCallback[e+t]={callback:r})},e.prototype.unregisterPushCallback=function(e,t){delete this.pushCallback[e+t]},e.prototype.checkMessageTimeout=function(){for(var e=this.sendDataList.getFirst(),t=Date.parse(new Date+""),r=0,i=0,n=0;!(null==e||e._data.time+this.sendDataTimeout>t||(delete this.sendDataMap[e._data.seq],this.sendDataList.remove(e),++i,null==e._data.error||0<this.sendDataDropTimeout&&e._data.time+this.sendDataDropTimeout<t?++n:e._data.error&&e._data.error(l.SEND_MSG_TIMEOUT,e._data.seq),++r>=this.sendDataCheckOnceCount));)e=this.sendDataList.getFirst();0==i&&0==n||this.logger.debug("zs.cmt.0 call success, state: timeout=",i," drop=",n)},e.prototype.sendHeartbeat=function(){var i=this;if(this.logger.debug("zs.shb.0 call tryHeartbeatCount:"+this.tryHeartbeatCount),0!=Object.keys(this.sessionInfos).length){if(++this.tryHeartbeatCount>l.MAX_TRY_HEARTBEAT_COUNT)return this.logger.error("zs.shb.0 heartbeat try limit"),void this.disconnectCallback();var e=[];for(var t in this.sessionInfos)e.push(parseInt(t));var r={session_ids:e};this.sendMessageWithCallback("ClientHBReq",n.getSeq(),0,r,function(e,t,r){i.heartbeatInterval!=r.hb_interval&&(i.heartbeatInterval=r.hb_interval,i.onUpdateHeartBeartInterval(r.hb_interval)),i.tryHeartbeatCount=0},function(e,t){})}else this.logger.info("zs.shb.0 no need to heartbeat")},e.prototype.QualityReport=function(e,t,r,i,n){this.logger.debug("zs.qr.0 call");var o={streams:[s({},r,{aid:t})]};this.sendMessageWithCallback("QualityReportReq",e,t,o,i,n)},e.prototype.sendStreamStatus=function(e,t,r,i){this.logger.debug("zs.sss.0 call");var n={mic_status:i,camera_status:r};this.logger.info("zs.sss.0 stream status "+JSON.stringify(n)),this.sendMessage("StreamStatusNotify",e,t,n)},e.prototype.sendBroadcasterStatus=function(e,t,r){this.logger.debug("zs.sss.0 call");var i={status:r};this.sendMessage("BroadcasterStatusNotify",e,t,i)},e}();t.ZegoSignal=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(0),l=r(1),i=r(4),n=function(){function e(e,t,r,i,n){this.state=s.ENUM_PLAY_STATE.stop,this.candidateInfo=[],this.waitICETimer=null,this.waitingICETimeInterval=5e3,this.waitingOfferTimer=null,this.waitingOfferTimeInterval=5e3,this.waitingServerTimer=null,this.waitingServerTimerInterval=3e3,this.qualityTimer=null,this.playQualityList=[],this.maxQualityListCount=10,this.lastPlayStats={audioPacketsLost:0,videoPacketsLost:0,time:0,audioTime:0,videoTime:0,audioBytesReceived:0,videoBytesReceived:0,framesDecoded:0,framesReceived:0,framesDropped:0,audioBitrate:0},this.reportSeq=l.getSeq(),this.videoSizeCallback=!1,this.qualityUpload=!1,this.qualityUploadInterval=3e4,this.qualityUploadLastTime=0,this.maxRetryCount=3,this.currentRetryCount=0,this.retryState=s.ENUM_RETRY_STATE.didNotStart,this.closeSessionSignal=!1,this.stateNego=s.ENUM_PLAY_STATE_NEGO.stop,this.negoInterval=25e3,this.negoTryCount=1,this.negoTryMaxCount=2,this.broadcasterStatus=s.ENUM_BROADCASTER_STATUS.stop,this.cameraStatus=null,this.micStatus=null,this.playEvent=!1,this.nextSignalTryCount=1,this.waittingConnectedTimer=null,this.waittingConnectedInerval=15e3,this.gotStreamStatus=!1,this.tryingNexitSignal=!1,this.logger=e,this.signal=t,this.dataReport=r,this.qualityTimeInterval=i,this.streamCenter=n,r.newReport(this.reportSeq)}return e.prototype.setAudioDestination=function(e){var t=this;return this.remoteVideo?"undefined"!==this.remoteVideo.sinkId?(this.remoteVideo.setSinkId(e).then(function(){t.logger.info("zp.sad.1 success device: "+e)}).catch(function(e){t.logger.info("zp.sad.1 "+e.name)}),!0):(this.logger.error("zp.sad.1 browser does not suppport"),!1):(this.logger.info("zp.sad.1 no remoteVideo"),!1)},e.prototype.startPlay=function(e,t,r,i){var n=this;this.logger.info("zp.sp.1 called ",e),this.playEvent=!1,this.signal&&this.signal.negoInterval&&(this.negoInterval=this.signal.negoInterval),this.signal&&this.signal.negoTryCount&&(this.negoTryCount=this.signal.negoTryCount),this.signal&&this.signal.negoTryMaxCount&&(this.negoTryMaxCount=this.signal.negoTryMaxCount),e?(this.streamId=e,this.remoteVideo=t,this.audioOutput=r,this.playOption=i||{},i&&i.videoDecodeType&&(this.playOption.videoDecodeType=i.videoDecodeType),this.sessionSeq=l.getSeq(),this.dataReport.eventStart(this.reportSeq,"CreateSession"),this.signal.createSession(this.sessionSeq,1,0,e,i&&i.streamParams,function(e,t,r){n.dataReport.eventEndWithMsg(n.reportSeq,"CreateSession",{sessionId:r.session_id}),n.logger.info("zp.sp.1 sessionId:"+r.session_id),n.sessionSeq==e?0!==r.result?(n.logger.error("zp.sp.1 create error"),n.playStateUpdateError(l.playErrorList.CREATE_SESSION_ERROR)):(n.sessionId=r.session_id,n.onCreatePlaySessionSuccess(r)):n.logger.error("zp.sp.1 seq is not match.")},function(e,t){n.dataReport.eventEndWithMsg(n.reportSeq,"CreateSession",{error:e}),n.playStateUpdateError(l.playErrorList.SEND_SESSION_TIMEOUT)}),this.state=s.ENUM_PLAY_STATE.waitingSessionRsp,this.logger.debug("zp.sp.1 called success"),this.stateNego=s.ENUM_PLAY_STATE_NEGO.start,this.negoTimer=setTimeout(function(){n.stateNego!==s.ENUM_PLAY_STATE_NEGO.iceConnected&&n.negoTryCount<n.negoTryMaxCount?(n.signal.sendCloseSession(l.getSeq(),n.sessionId,1),n.resetPlay(),n.startPlay(e,t,r,i),++n.negoTryCount):n.stateNego!==s.ENUM_PLAY_STATE_NEGO.iceConnected&&n.negoTryCount===n.negoTryMaxCount&&(n.logger.error("zp.sp.1 waiting timeout"),n.playStateUpdateError(l.playErrorList.SERVER_NEGO_TIMEOUT))},this.negoInterval)):this.logger.warn("zp.sp.1 streamId is null")},e.prototype.onCreatePlaySessionSuccess=function(e){var i=this;this.logger.info("zp.ops.1 success");var t=[];e.turn_server&&t.push(e.turn_server),e.stun_server&&t.push(e.stun_server);var r={iceTransportPolicy:"relay",iceServers:[{urls:t,username:e.turn_username,credential:e.turn_auth_key}]};this.logger.info("zp.ops.1 username: "+e.turn_username),this.logger.info("zp.ops.1 credential: "+e.turn_auth_key),this.peerConnection=new RTCPeerConnection(r),this.peerConnection.onicecandidate=function(e){i.onIceCandidate(e)},this.peerConnection.onsignalingstatechange=function(e){i.onConnectionStateChange(e)},this.peerConnection.oniceconnectionstatechange=function(e){i.onIceConnectionStateChange(e)},this.peerConnection.ontrack=function(e){i.onGotRemoteStream(e.streams[0])},this.remoteVideo.oncanplay=function(){i.logger.debug("zp.ops.1 "+i.remoteVideo.videoWidth+" X "+i.remoteVideo.videoHeight),i.videoSizeCallback||(i.logger.debug("zp.ops.1 onresize callback"),i.onVideoSizeChanged(i.streamId,i.remoteVideo.videoWidth,i.remoteVideo.videoHeight),i.videoSizeCallback=!0)};var n={offerToReceiveAudio:1,offerToReceiveVideo:1};this.playOption&&"audio"===this.playOption.playType&&(n.offerToReceiveVideo=0),this.playOption&&"video"===this.playOption.playType&&(n.offerToReceiveAudio=0),this.logger.info("zp.ops.1 createOffer: "+JSON.stringify(n)),this.dataReport.eventStart(this.reportSeq,"CreateOffer"),this.peerConnection.createOffer(n).then(function(e){i.dataReport.eventEnd(i.reportSeq,"CreateOffer"),i.onCreateOfferSuccess(e)},function(e){i.dataReport.eventEndWithMsg(i.reportSeq,"CreateOffer",{error:e.toString()}),i.logger.error("zp.ops.0 create offer error "+e.toString()),i.playStateUpdateError(l.playErrorList.CREATE_OFFER_ERROR)}),this.signal.registerPushCallback("MediaDescPush",this.sessionId,function(e,t,r){i.onRecvMediaDesc(e,t,r)}),this.signal.registerPushCallback("CandidateInfoPush",this.sessionId,function(e,t,r){i.onRecvCandidateInfo(e,t,r)}),this.signal.registerPushCallback("CloseSessionPush",this.sessionId,function(e,t,r){i.onRecvCloseSession(e,t,r)}),this.signal.registerPushCallback("SessionResetPush",this.sessionId,function(e,t,r){i.onRecvResetSession(e,t,r)}),this.signal.registerPushCallback("StreamStatusNotifyPush",this.sessionId,function(e,t,r){i.gotStreamStatus=!0,i.streamStatus=r,i.remoteStream&&i.onRecvStreamStatus(r)}),this.signal.registerPushCallback("PlayEventPush",this.sessionId,function(e,t,r){i.onRecvPlayEvent(e,t,r)}),this.logger.debug("zp.ops.1 call success")},e.prototype.onCreateOfferSuccess=function(e){var t=this;this.logger.info("zp.oco.1 localSdp1 "+e.sdp.substr(0,e.sdp.length/2)),this.logger.info("zp.oco.1 localSdp2 "+e.sdp.substr(e.sdp.length/2)),e.sdp=e.sdp.replace(/sendrecv/g,"recvonly"),this.playOption.videoDecodeType&&(e.sdp=i.sdpUtil.getSDPByVideDecodeType(e.sdp,this.playOption.videoDecodeType)),this.dataReport.eventStart(this.reportSeq,"SetLocalDescription"),this.peerConnection.setLocalDescription(e).then(function(){t.dataReport.eventEnd(t.reportSeq,"SetLocalDescription"),t.onSetLocalDescriptionSuccess(e)},function(e){t.logger.error("zp.oca.1 set error "+e.toString()),t.dataReport.eventEnd(t.reportSeq,"SetLocalDescription",{error:e.toString()}),t.playStateUpdateError(l.playErrorList.SET_LOCAL_DESC_ERROR)})},e.prototype.onSetLocalDescriptionSuccess=function(e){var i=this;this.logger.info("zp.osd.1 success");var t={sdp:e.sdp};this.answerSeq=l.getSeq(),this.dataReport.eventStart(this.reportSeq,"SendMediaDesc"),this.signal.sendMediaDesc(this.answerSeq,this.sessionId,0,t,function(e,t,r){i.logger.info("zp.osd.1 sendMediaDesc resp"),i.answerSeq==e&&i.sessionId==t?(i.logger.info("zp.osd.1 send success stateNego:waiterAnswer"),i.stateNego=s.ENUM_PLAY_STATE_NEGO.waiterAnswer,i.dataReport.eventEnd(i.reportSeq,"SendMediaDesc"),i.waitingOfferTimer=setTimeout(function(){i.state==s.ENUM_PLAY_STATE.waitingOffserRsp&&(i.logger.error("zp.osd.1 waiting timeout"),i.playStateUpdateError(l.playErrorList.SERVER_CANDIDATE_TIMEOUT))},i.waitingOfferTimeInterval),i.state=s.ENUM_PLAY_STATE.waitingServerAnswer):i.logger.error("zp.osd.1 seq or sessionId is not equal "+i.answerSeq+" "+e,0+i.sessionId+" "+t)},function(e,t){i.logger.error("zp.osd.1 failed to send "+e),i.dataReport.eventEndWithMsg(i.reportSeq,"SendMediaDesc",{error:e}),i.playStateUpdateError(l.playErrorList.SEND_MEDIA_DESC_TIMEOUT)}),this.state=s.ENUM_PLAY_STATE.waitingOffserRsp},e.prototype.onRecvMediaDesc=function(e,t,r){var i,n=this;this.logger.info("zp.orm.1 received ",r),this.stateNego=s.ENUM_PLAY_STATE_NEGO.waitingCandidate,this.logger.info("zp.orm.1 received stateNego:waitingCandidate"),this.state===s.ENUM_PLAY_STATE.waitingServerAnswer?(null!=this.waitingOfferTimer&&(clearTimeout(this.waitingOfferTimer),this.waitingOfferTimer=null),this.dataReport.addEvent(this.reportSeq,"RecvMediaDesc"),this.signal.sendMediaDescAck(e,this.sessionId,0),i={type:"answer",sdp:r.sdp,toJSON:function(){}},this.dataReport.eventStart(this.reportSeq,"SetRemoteDescription"),this.logger.info("zp.orm.1 remoteSdp ",i.sdp),this.peerConnection.setRemoteDescription(new RTCSessionDescription(i)).then(function(){n.dataReport.eventEnd(n.reportSeq,"SetRemoteDescription"),n.logger.info("zp.orm.1 set success")},function(e){n.logger.error("zp.orm.1 set remote error "+e.toString()),n.dataReport.eventEndWithMsg(n.reportSeq,"SetRemoteDescription",{error:e.toString()}),n.playStateUpdateError(l.playErrorList.SET_REMOTE_DESC_ERROR)}),this.waitICETimer=setTimeout(function(){n.state==s.ENUM_PLAY_STATE.waitingServerICE&&(n.logger.error("zp.orm.1 waiting server timeout"),n.playStateUpdateError(l.playErrorList.SERVER_CANDIDATE_TIMEOUT))},this.waitingICETimeInterval),this.state=s.ENUM_PLAY_STATE.waitingServerICE,this.logger.debug("zp.orm.1 call success")):this.logger.error("zp.orm.1 current state "+this.state+" not allowed")},e.prototype.onRecvCandidateInfo=function(e,t,r){var i=this;if(this.logger.info("zp.orci.1 received "),this.state==s.ENUM_PLAY_STATE.waitingServerICE){null!=this.waitICETimer&&(clearTimeout(this.waitICETimer),this.waitICETimer=null),this.dataReport.addEvent(this.reportSeq,"RecvIceCandidate"),this.signal.sendCandidateInfoAck(e,this.sessionId,0),this.sendCandidateInfo(this.candidateInfo),this.candidateInfo=[];for(var n=0;n<r.infos.length;n++){var o={sdpMid:r.infos[n].sdpMid,sdpMLineIndex:r.infos[n].sdpMLineIndex,candidate:r.infos[n].candidate};this.logger.debug("zp.orci.1 candidate "+o.candidate),this.peerConnection.addIceCandidate(new RTCIceCandidate(o)).then(function(){i.logger.debug("zp.orci.1 add success")},function(e){i.logger.error("zp.orci.1 add error "+e.toString()),i.playStateUpdateError(l.playErrorList.SERVER_CANDIDATE_ERROR)})}this.state=s.ENUM_PLAY_STATE.connecting,this.logger.debug("zp.orci.1 call success")}else this.logger.warn("zp.orci.1 current state "+this.state+" not allowed")},e.prototype.onRecvPlayEvent=function(e,t,r){var i,n,o,s;this.logger.info("zp.orpe.1 received"),!0===this.playEvent&&0==r.event?(this.logger.info("zp.orpe.1 retry: "+this.streamId),i=this.streamId,n=this.remoteVideo,o=this.audioOutput,s=this.playOption,this.signal.sendCloseSession(l.getSeq(),this.sessionId,1),this.resetPlay(),this.startPlay(i,n,o,s)):this.playEvent=!0},e.prototype.onIceCandidate=function(e){var t;this.logger.info("zp.oic.1 called"),null!=e.candidate&&(this.logger.debug("zp.oic.1 candidate "+e.candidate.candidate),this.state<s.ENUM_PLAY_STATE.connecting||this.state==s.ENUM_PLAY_STATE.stop?(this.logger.debug("zp.oic.1 cached"),this.candidateInfo.push({candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex})):(this.logger.debug("zp.oic.1 send"),t={candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex},this.sendCandidateInfo([t])))},e.prototype.onConnectionStateChange=function(e){this.logger.info("zp.oisc.1 called "+e.target.signalingState)},e.prototype.onIceConnectionStateChange=function(e){var t=this;if(this.state!=s.ENUM_PLAY_STATE.stop&&null!=this.peerConnection)if(this.logger.info("zp.oisc.1  stateChanged "+this.peerConnection.iceConnectionState),"connected"===this.peerConnection.iceConnectionState){for(var r in this.dataReport.addEvent(this.reportSeq,"IceConnected"),this.state!=s.ENUM_PLAY_STATE.playing&&this.onPlayStateUpdate(l.ENUM_PLAY_STATE_UPDATE.start,this.streamId),this.state=s.ENUM_PLAY_STATE.playing,this.tryingNexitSignal=!1,this.retryState!=s.ENUM_RETRY_STATE.didNotStart&&(this.retryState=s.ENUM_RETRY_STATE.finished,this.currentRetryCount=0),this.dataReport.eventStart(this.reportSeq,"PlayState"),this.streamCenter.publisherList)if(this.streamCenter.publisherList[r].publisher.state==s.ENUM_PUBLISH_STATE.publishing&&this.broadcasterStatus==s.ENUM_BROADCASTER_STATUS.stop){this.signal&&this.signal.sendBroadcasterStatus(l.getSeq(),this.sessionId,1),this.broadcasterStatus=s.ENUM_BROADCASTER_STATUS.start;break}this.setPlayQualityTimer(),this.stateNego=s.ENUM_PLAY_STATE_NEGO.iceConnected,this.logger.info("zp.oisc.1  stateNego:iceConnected"),this.negoTryCount=1,this.nextSignalTryCount=1,this.waittingConnectedTimer&&clearTimeout(this.waittingConnectedTimer),this.waittingConnectedTimer=null,this.negoTimer&&clearTimeout(this.negoTimer)}else"closed"===this.peerConnection.iceConnectionState?(this.dataReport.addEvent(this.reportSeq,"IceClosed"),this.checkPlayConnectionFailedState(this.peerConnection.iceConnectionState)):"failed"===this.peerConnection.iceConnectionState?(this.dataReport.addEvent(this.reportSeq,"IceFailed"),this.checkPlayConnectionFailedState(this.peerConnection.iceConnectionState)):"disconnected"===this.peerConnection.iceConnectionState&&(this.dataReport.addEvent(this.reportSeq,"IceDisconnected"),this.waittingConnectedTimer=setTimeout(function(){t.tryingNexitSignal||t.tryNextSignal(l.publishErrorList.MEDIA_CONNECTION_DISCONNECTED)},this.waittingConnectedInerval))},e.prototype.checkPlayConnectionFailedState=function(e){var t=null;"failed"==e?t=l.playErrorList.MEDIA_CONNECTION_FAILED:"closed"==e&&(t=l.playErrorList.MEDIA_CONNECTION_CLOSED),null!=t&&(this.state!=s.ENUM_PLAY_STATE.playing&&this.retryState==s.ENUM_PLAY_STATE.didNotStart?(this.logger.info("zp.oics.1  state "+this.state+" retryState "+this.retryState+" connectionState "+e),this.playStateUpdateError(t)):this.shouldRetryPlay()?(this.onPlayStateUpdate(l.ENUM_PLAY_STATE_UPDATE.retry,this.streamId),this.startRetryPlay()):this.playStateUpdateError(t))},e.prototype.shouldRetryPlay=function(){return this.retryState==s.ENUM_RETRY_STATE.didNotStart&&this.state!=s.ENUM_PLAY_STATE.playing?(this.logger.info("zp.srp.1.0 connection didn't success"),!1):this.retryState==s.ENUM_RETRY_STATE.retrying?(this.logger.info("zp.srp.0.0 already retrying"),!1):this.currentRetryCount>this.maxRetryCount?(this.logger.info("zp.srp.1.0 beyond max"),!1):(this.logger.debug("zp.srp.1.0 call success"),!0)},e.prototype.startRetryPlay=function(){this.logger.debug("zp.srp.0 call");var e=this.streamId,t=this.remoteVideo,r=this.audioOutput;this.resetPlay(),this.tryStartPlay(e,t,r)},e.prototype.clearTryPlayTimer=function(){null!=this.waitingServerTimer&&(clearTimeout(this.waitingServerTimer),this.waitingServerTimer=null)},e.prototype.tryStartPlay=function(e,t,r){var i=this;if(this.logger.debug("zp.tsp.1 call"),this.clearTryPlayTimer(),this.streamId=e,this.remoteVideo=t,this.audioOutput=r,this.currentRetryCount>this.maxRetryCount)return this.logger.error("zp.tsp.1 beyond max limit"),void this.playStateUpdateError(l.playErrorList.WEBSOCKET_ERROR);this.retryState=s.ENUM_RETRY_STATE.retrying,this.currentRetryCount+=1,this.signal.isServerConnected()?(this.logger.debug("zp.tsp.1 signal connected"),this.startPlay(e,this.remoteVideo,this.audioOputput,this.playOption)):(this.logger.debug("zp.tsp.1 signal server not connected"),this.waitingServerTimer=setTimeout(function(){i.tryStartPlay(e,i.remoteVideo,i.audioOputput)},this.waitingServerTimerInterval))},e.prototype.clearPlayQualityTimer=function(){null!=this.qualityTimer&&(clearInterval(this.qualityTimer),this.qualityTimer=null),this.lastPlayStats={audioPacketsLost:null,videoPacketsLost:null,time:null,audioTime:null,videoTime:null,audioBytesReceived:null,videoBytesReceived:null,framesDecoded:null,framesDropped:null,framesReceived:null,audioBitrate:null}},e.prototype.resetPlay=function(){this.logger.info("zp.rp.1 call"),this.streamId=null,this.state=s.ENUM_PLAY_STATE.stop,this.playEvent=!1,null!=this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null),null!=this.waitingOfferTimer&&(clearTimeout(this.waitingOfferTimer),this.waitingOfferTimer=null),null!=this.waitICETimer&&(clearTimeout(this.waitICETimer),this.waitICETimer=null),null!=this.negoTimer&&(clearTimeout(this.negoTimer),this.negoTimer=null),null!=this.waittingConnectedTimer&&(clearTimeout(this.waittingConnectedTimer),this.waittingConnectedTimer=null),this.clearPlayQualityTimer(),this.remoteVideo&&(this.remoteVideo.srcObject=null,this.remoteVideo.oncanplay=null,this.remoteVideo=null),this.audioOputput=null,this.signal&&(this.signal.unregisterPushCallback("MediaDescPush",this.sessionId),this.signal.unregisterPushCallback("CandidateInfoPush",this.sessionId),this.signal.unregisterPushCallback("CloseSessionPush",this.sessionId)),this.sessionSeq=0,this.answerSeq=0,this.videoSizeCallback=!1,this.currentRetryCount=0,this.retryState=s.ENUM_RETRY_STATE.didNotStart,this.clearTryPlayTimer()},e.prototype.setPlayQualityTimer=function(){var t=this;null==this.qualityTimer&&(this.logger.debug("zp.spq.1 startTimer"),this.clearPlayQualityTimer(),this.qualityTimer=setInterval(function(){t.peerConnection&&t.peerConnection.getStats(null).then(function(e){t.getPlayStats(e)},function(e){t.logger.info("zp.spq.1 getStats error "+e.toString())})},this.qualityTimeInterval),this.lastPlayStats={audioPacketsLost:0,videoPacketsLost:0,time:0,audioTime:0,videoTime:0,audioBytesReceived:0,videoBytesReceived:0,framesDecoded:0,framesReceived:0,framesDropped:0,audioBitrate:0})},e.prototype.getPlayStats=function(e){var t,r,i,n=this;null!=e&&(t={audioFractionLost:null,audioPacketsLost:0,audioPacketsLostRate:0,audioBitrate:0,audioLevel:0,audioSendLevel:0,audioSamplingRate:0,audioCodecType:"opus",audioQuality:null,videoQuality:null,videoPacketsLostRate:0,videoBitrate:0,videoFPS:0,playData:0,nackCount:0,pliCount:0,audioJitter:0,videoFractionLost:null,videoFramesDecoded:0,frameHeight:0,frameWidth:0,videoTransferFPS:0,videoFramesDropped:0,totalRoundTripTime:0,currentRoundTripTime:0},r=this.lastPlayStats.time,i=null,e.forEach(function(e){("inbound-rtp"==e.type||"ssrc"==e.type&&null!=e.bytesReceived)&&("audio"==e.mediaType||0<=e.id.indexOf("AudioStream"))?(0!=r&&(t.audioBitrate=8*(e.bytesReceived-n.lastPlayStats.audioBytesReceived)/(e.timestamp-r)),t.audioBitrate<0&&(t.audioBitrate=0),t.audioJitter=e.jitter,t.audioPacketsLost=e.packetsLost,t.audioFractionLost=e.fractionLost,t.audioPacketsLostRate=(e.packetsLost-n.lastPlayStats.audioPacketsLost)/(e.timestamp-n.lastPlayStats.audioTime),n.lastPlayStats.audioBytesReceived=e.bytesReceived,n.lastPlayStats.audioPacketsLost=e.packetsLost,n.lastPlayStats.audioTime=e.timestamp,n.lastPlayStats.time=e.timestamp,n.lastPlayStats.audioBitrate=t.audioBitrate):("inbound-rtp"==e.type||"ssrc"==e.type&&null!=e.bytesReceived)&&("video"==e.mediaType||0<=e.id.indexOf("VideoStream"))?(0!=r&&(t.videoBitrate=8*(e.bytesReceived-n.lastPlayStats.videoBytesReceived)/(e.timestamp-r),t.videoFPS=1e3*(e.framesDecoded-n.lastPlayStats.framesDecoded)/(e.timestamp-r)),t.videoBitrate<0&&(t.videoBitrate=0),t.videoFPS<0&&(t.videoFPS=0),t.nackCount=e.nackCount,t.pliCount=e.pliCount,t.videoFractionLost=e.fractionLost,t.videoFramesDecoded=e.framesDecoded,t.videoPacketsLostRate=(e.packetsLost-n.lastPlayStats.videoPacketsLost)/(e.timestamp-n.lastPlayStats.videoTime),n.lastPlayStats.videoBytesReceived=e.bytesReceived,n.lastPlayStats.framesDecoded=e.framesDecoded,n.lastPlayStats.videoPacketsLost=e.packetsLost,n.lastPlayStats.videoTime=e.timestamp,n.lastPlayStats.time=e.timestamp):"track"==e.type&&("video"==e.kind||0<=e.id.indexOf("video"))?(t.frameHeight=e.frameHeight,t.frameWidth=e.frameWidth,0!=r&&(t.videoTransferFPS=1e3*(e.framesReceived-n.lastPlayStats.framesReceived)/(e.timestamp-r),t.videoFramesDropped=e.framesDropped-n.lastPlayStats.framesDropped),t.videoTransferFPS<0&&(t.videoTransferFPS=0),t.videoFramesDropped<0&&(t.videoFramesDropped=0),n.lastPlayStats.framesReceived=e.framesReceived,n.lastPlayStats.framesDropped=e.framesDropped):"track"==e.type&&("audio"==e.kind||0<=e.id.indexOf("audio"))?(t.audioLevel=e.audioLevel,t.audioSendLevel=e.totalAudioEnergy,t.audioSamplingRate=e.totalSamplesDuration):"candidate-pair"==e.type&&(null!=e.totalRoundTripTime&&(t.totalRoundTripTime=e.totalRoundTripTime),null!=e.currentRoundTripTime&&(t.currentRoundTripTime=e.currentRoundTripTime,i=1e3*t.currentRoundTripTime))}),t.audioQuality=this.getNetQuality(i,t.audioFractionLost),t.videoQuality=this.getNetQuality(i,t.videoFractionLost),this.uploadPlayQuality(t),0!=r&&this.onPlayQualityUpdate(this.streamId,t))},e.prototype.getNetQuality=function(e,t){return e&&e<600?.4<t?2:.3<t?4:5:e<900?.4<t?2:.2<t?3:4:.2<t?2:3},e.prototype.uploadPlayQuality=function(e){var t,i=this;this.qualityUpload&&(t=Date.parse(new Date+""),(0==this.qualityUploadLastTime||t-this.qualityUploadLastTime>=this.qualityUploadInterval)&&(e.stream_type="play",e.stream_id=this.streamId,e.timeStamp=t/1e3,this.logger.info("zp.upq.1 upload"+JSON.stringify(e)),this.signal.QualityReport(l.getSeq(),this.sessionId,e,function(e,t,r){void 0!==r.report&&(i.qualityUpload=r.report,i.qualityUploadInterval=r.report_interval_ms)},function(e,t){i.logger.info("zp.upq.1 upload failed "+e)}),this.qualityUploadLastTime=t))},e.prototype.onRecvResetSession=function(e,t,r){var i;this.logger.info("zp.orrs.1 received "),t==this.sessionId?(this.dataReport.addEvent(this.reportSeq,"RecvResetSession"),this.signal.sendCloseSessionAck(e,this.sessionId,0),i=JSON.parse(JSON.stringify(l.playErrorList.SESSION_CLOSED)),this.negoTimer&&clearTimeout(this.negoTimer),this.tryingNexitSignal||this.tryNextSignal(i)):this.logger.info("zp.orrs.1 cannot find session")},e.prototype.onRecvCloseSession=function(e,t,r){this.logger.info("zp.orcs.1 reason: "+r.reason),this.dataReport.addEvent(this.reportSeq,"RecvCloseSession"),this.signal.sendCloseSessionAck(e,this.sessionId,0);var i=JSON.parse(JSON.stringify(l.playErrorList.SESSION_CLOSED));i.msg+=r.reason,this.negoTimer&&clearTimeout(this.negoTimer);var n,o,s,a,c=+r.reason,d=r.err_info&&JSON.parse(r.err_info).action?JSON.parse(r.err_info).action:null;"number"==typeof c&&[24,28].includes(c)&&this.negoTryCount<this.negoTryMaxCount||5==d?(this.logger.info("zp.orcs.1 retry: "+this.streamId),n=this.streamId,o=this.remoteVideo,s=this.audioOutput,a=this.playOption,this.signal.sendCloseSession(l.getSeq(),this.sessionId,1),this.resetPlay(),this.startPlay(n,o,s,a),++this.negoTryCount):[4,8,10,11,12,14,26,27].includes(c)||2==d?this.tryingNexitSignal||this.tryNextSignal(i):this.playStateUpdateError(i)},e.prototype.onRecvStreamStatus=function(e){this.logger.debug("zp.orss.0 call");var t=this.remoteVideo.srcObject;0!==e.camera_status&&t&&0!==t.getVideoTracks().length&&(t.getVideoTracks().forEach(function(e){e.stop(),t.removeTrack(e)}),this.remoteVideo.srcObject=t),0==e.camera_status&&t&&0==t.getVideoTracks().length&&(this.remoteVideo.srcObject=this.remoteStream.clone()),this.cameraStatus!==e.camera_status&&this.onRemoteCameraStatusUpdate(this.streamId,e.camera_status),this.micStatus!==e.mic_status&&this.onRemoteMicStatusUpdate(this.streamId,e.mic_status),this.cameraStatus=e.camera_status,this.micStatus=e.mic_status,this.logger.debug("zp.orss.0 call success")},e.prototype.onGotRemoteStream=function(e){this.logger.info("zp.ogrs.0 called "+e),this.remoteVideo?(this.remoteStream=e,this.remoteVideo.srcObject=e.clone(),this.audioOputput&&this.setAudioDestination(this.audioOputput),this.gotStreamStatus&&this.onRecvStreamStatus(this.streamStatus),this.dataReport.addEvent(this.reportSeq,"GetRemoteStream")):this.logger.error("zp.ogrs.0 no remoteVideo")},e.prototype.sendCandidateInfo=function(e){var i=this;this.logger.info("zp.sci.1 called"),!(e=e.filter(function(e){return!(0<e.candidate.indexOf("tcp"))&&(!!e.candidate||void 0)}))||e.length<1?this.logger.info("zp.sci.1 cancelled"):(this.dataReport.eventStart(this.reportSeq,"SendIceCandidate"),this.stateNego!==s.ENUM_PLAY_STATE_NEGO.iceConnected&&(this.stateNego=s.ENUM_PLAY_STATE_NEGO.sendCandidate),this.logger.info("zp.sci.1  stateNego:sendCandidate"),this.signal.sendCandidateInfo(l.getSeq(),this.sessionId,e,function(e,t,r){i.logger.debug("zp.sci.1 send success"),i.dataReport.eventEnd(i.reportSeq,"SendIceCandidate")},function(e,t){i.logger.error("zp.sci.1 failed to send: "+e.toString()),i.dataReport.eventEndWithMsg(i.reportSeq,"SendIceCandidate",{error:e}),i.playStateUpdateError(l.playErrorList.SEND_CANDIDATE_ERROR)}))},e.prototype.shouldSendCloseSession=function(e){return this.state!=l.ENUM_PLAY_STATE_UPDATE.stop&&this.state!=s.ENUM_PLAY_STATE.waitingSessionRsp},e.prototype.playStateUpdateError=function(e){this.logger.info("zp.psue.1 called ",e.code),this.state===s.ENUM_PLAY_STATE.stop||this.negoTryCount<this.negoTryMaxCount&&this.stateNego<s.ENUM_PLAY_STATE_NEGO.iceConnected||(0!=this.sessionId&&this.shouldSendCloseSession(e)&&(this.signal.sendCloseSession(l.getSeq(),this.sessionId,1),this.closeSessionSignal=!0),this.state=s.ENUM_PLAY_STATE.stop,this.onPlayStateUpdate(l.ENUM_PLAY_STATE_UPDATE.error,this.streamId,e),this.resetPlay())},e.prototype.onPlayStateUpdate=function(e,t,r){},e.prototype.onPlayQualityUpdate=function(e,t){},e.prototype.onVideoSizeChanged=function(e,t,r){},e.prototype.onRemoteCameraStatusUpdate=function(e,t){},e.prototype.onRemoteMicStatusUpdate=function(e,t){},e.prototype.stopPlay=function(){for(var e in this.logger.info("zp.sp.1.1 called"),this.streamCenter.publisherList)if(this.streamCenter.publisherList[e].publisher.state==s.ENUM_PUBLISH_STATE.publishing&&this.broadcasterStatus==s.ENUM_BROADCASTER_STATUS.start){this.signal&&this.signal.sendBroadcasterStatus(l.getSeq(),this.sessionId,0),this.broadcasterStatus=s.ENUM_BROADCASTER_STATUS.stop;break}this.sessionId&&!this.closeSessionSignal&&this.signal.sendCloseSession(l.getSeq(),this.sessionId,0),this.dataReport.eventEndWithMsg(this.reportSeq,"PlayState",{state:this.state+""}),this.dataReport.addEvent(this.reportSeq,"StopPlay"),this.dataReport.addMsgExt(this.reportSeq,{stream:this.streamId,sessionId:this.sessionId}),this.dataReport.uploadReport(this.reportSeq,"RTCPlayStream"),this.resetPlay()},e.prototype.onDisconnect=function(){this.logger.info("zp.od.1 call"),this.logger.info("zp.od.1 websocket disconnect"),this.dataReport.addEvent(this.reportSeq,"OnDisconnect"),this.tryingNexitSignal||this.tryNextSignal(l.playErrorList.WEBSOCKET_ERROR)},e.prototype.tryNextSignal=function(e){this.tryingNexitSignal=!0;var t=this.streamId,r=this.signal.server,i=this.streamCenter.playerList[t],n=[];i&&i.serverUrls&&(n=i.serverUrls),this.nextSignalTryCount>3*n.length?(this.logger.error("zp.tns.1 try max limit"),this.playStateUpdateError(e)):(n.forEach(function(e,t){return t<=n.indexOf(r)&&n.push(e)}),n.splice(0,n.indexOf(r)+1),this.logger.info("zp.tns.1 try next signal "+t),this.signal&&this.signal.state==s.ENUM_CONNECT_STATE.connected&&this.signal.sendCloseSession(l.getSeq(),this.sessionId,1),this.signal&&this.signal.removeSession(this.sessionId),this.resetPlay(),this.streamCenter.connectPlayServer(t),this.nextSignalTryCount++)},e}();t.ZegoPlayWeb=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){this.playerList={},this.publisherList={}}return e.prototype.setSessionInfo=function(e,t,r,i){},e}();t.ZegoStreamCenter=i},function(e,t,r){"use strict";var i,n=this&&this.__extends||(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0});var o=r(18),s=r(0),a=r(2),c=r(19),d=r(20),l=r(21),h=r(23),u=r(24),p=r(25),g=function(e){function t(){return e.call(this)||this}return n(t,e),t.prototype.init=function(){this.bindSocketHandler(),this.bindStreamHandler(),this.bindHeatBeatHandler(),this.bindRoomHandler(),this.bindMessageHandler(),this.bindLiveHandler(),this.bindStreamCenterHandler()},t.prototype.bindSocketHandler=function(){var t=this;this.socketCenter=new c.SocketCenter(this.logger,this.stateCenter),this.socketCenter.registerRouter("push_signal",function(e){t.liveHandler.handlePushSignalMsg(e)}),this.socketCenter.getSocket=function(e){return t.getSocket(e)},this.socketCenter.handlePushKickout=function(e){t.logger.info("zb.cm.bsh.0  call hpk"),t.roomHandler.setRunState(s.ENUM_RUN_STATE.logout),t.roomHandler.resetRoom(),t.onKickOut({code:s.sdkErrorList.KICK_OUT.code,msg:s.sdkErrorList.KICK_OUT.msg+e.body.reason}),t.logger.debug("zb.cm.bsh.0  call hpk success")},this.socketCenter.handlePushCustomMsg=function(e){t.messageHandler.handlePushCustomMsg(e)},this.socketCenter.handlePushUserStateUpdateMsg=function(e){t.roomHandler.handlePushUserStateUpdateMsg(e)},this.socketCenter.handlePushRoomMsg=function(e){t.onRecvRoomMsg(e.body.chat_data,e.body.server_msg_id,e.body.ret_msg_id)},this.socketCenter.handlePushMergeMsg=function(e){t.messageHandler.handlePushMergeMsg(e)},this.socketCenter.handlePushTransMsg=function(e){t.messageHandler.handlePushTransMsg(e)},this.socketCenter.handleBigImMsgRsp=function(e){t.messageHandler.handleBigImMsgRsp(e)}},t.prototype.bindStreamHandler=function(){var i=this;this.streamHandler=new l.StreamHandler(this.logger,this.stateCenter,this.socketCenter),this.streamHandler.onStreamUpdated=function(e,t){i.onStreamUpdated(e,t)},this.streamHandler.onPublishStateUpdate=function(e,t,r){i.onPublishStateUpdate(e,t,r)},this.streamHandler.onStreamExtraInfoUpdated=function(e){i.onStreamExtraInfoUpdated(e)},this.streamHandler.setCDNInfo=function(e,t){i.setCDNInfo(e,t)}},t.prototype.bindHeatBeatHandler=function(){var n=this;this.heartBeatHandler=new h.HeartBeatHandler(this.logger,this.stateCenter,this.socketCenter),this.heartBeatHandler.onRecvReliableMessage=function(e,t,r){n.onRecvReliableMessage(e,t,r)},this.heartBeatHandler.handleFetchStreamListRsp=function(e){n.streamHandler.handleFetchStreamListRsp(e)},this.heartBeatHandler.fetchUserList=function(){n.roomHandler.fetchUserList()},this.heartBeatHandler.onUpdateOnlineCount=function(e,t){n.onUpdateOnlineCount(e,t)},this.heartBeatHandler.updateStreamInfo=function(e,t,r,i){void 0===r&&(r=""),n.streamHandler.updateStreamInfo(e,t,r,i)},this.heartBeatHandler.hbLogout=function(e){n.onDisconnect(e)}},t.prototype.bindRoomHandler=function(){var i=this;this.roomHandler=new d.RoomHandler(this.logger,this.stateCenter,this.socketCenter),this.roomHandler.loginSuccessCallBack=function(e,t){var r=t.body.hearbeat_interval<s.MINIUM_HEARTBEAT_INTERVAL?s.MINIUM_HEARTBEAT_INTERVAL:t.body.hearbeat_interval;i.stateCenter.tryHeartbeatCount=0,i.stateCenter.heartbeatTimer&&clearTimeout(i.stateCenter.heartbeatTimer),i.heartBeatHandler.start(r),i.heartBeatHandler.resetCheckMessage(),i.heartBeatHandler.startCheckMessageTimeout(),i.streamCenter.setSessionInfo(i.stateCenter.appid,i.stateCenter.idName,i.stateCenter.token,i.stateCenter.testEnvironment),t.body.anchor_info&&i.onGetAnchorInfo(t.body.anchor_info.anchor_id_name,t.body.anchor_info.anchor_nick_name),t.body.online_count&&i.onUpdateOnlineCount(i.stateCenter.roomid,t.body.online_count),i.logger.info("zb.cm.brh hls userStateUpdate "+i.stateCenter.userStateUpdate),i.stateCenter.userStateUpdate&&(i.logger.info("zb.cm.brh hls fetch all new userlist"),i.roomHandler.fetchUserList()),i.streamHandler.handleStreamStart(e,t)},this.roomHandler.onGetTotalUserList=function(e,t){i.onGetTotalUserList(e,t)},this.roomHandler.resetRoomCallBack=function(){i.heartBeatHandler.resetHeartbeat(),i.heartBeatHandler.resetCheckMessage(),i.resetStreamCenter()},this.roomHandler.onUserStateUpdate=function(e,t){i.onUserStateUpdate(e,t)},this.roomHandler.onDisconnect=function(e){i.onDisconnect(e)},this.roomHandler.loginBodyData=function(){return i.loginBodyData()}},t.prototype.bindMessageHandler=function(){var i=this;this.messageHandler=new u.MessageHandler(this.logger,this.stateCenter,this.socketCenter),this.messageHandler.onRecvCustomCommand=function(e,t,r){i.onRecvCustomCommand(e,t,r)},this.messageHandler.onRecvBigRoomMessage=function(e,t){i.onRecvBigRoomMessage(e,t)},this.messageHandler.onRecvReliableMessage=function(e,t,r){i.onRecvReliableMessage(e,t,r)}},t.prototype.bindLiveHandler=function(){var n=this;this.liveHandler=new p.LiveHandler(this.logger,this.stateCenter,this.socketCenter),this.liveHandler.onRecvEndJoinLiveCommand=function(e,t,r,i){n.onRecvEndJoinLiveCommand(e,t,r,i)},this.liveHandler.onRecvInviteJoinLiveRequest=function(e,t,r,i){n.onRecvInviteJoinLiveRequest(e,t,r,i)},this.liveHandler.onRecvJoinLiveRequest=function(e,t,r,i){n.onRecvJoinLiveRequest(e,t,r,i)}},t.prototype.bindStreamCenterHandler=function(){var i=this;this.streamCenter.onPlayStateUpdate=function(e,t,r){i.onPlayStateUpdateHandle(e,t,r)},this.streamCenter.onPlayQualityUpdate=function(e,t){i.onPlayQualityUpdate(e,t)},this.streamCenter.onPublishStateUpdate=function(e,t,r){i.onPublishStateUpdateHandle(e,t,r)},this.streamCenter.onPublishQualityUpdate=function(e,t){i.onPublishQualityUpdate(e,t)},this.streamCenter.onPlayerStreamUrlUpdate=function(e,t,r){i.onStreamUrlUpdate(e,t,r)},this.streamCenter.onVideoSizeChanged=function(e,t,r){i.onVideoSizeChanged(e,t,r)},this.streamCenter.onRemoteCameraStatusUpdate=function(e,t){i.onRemoteCameraStatusUpdate(e,t)},this.streamCenter.onRemoteMicStatusUpdate=function(e,t){i.onRemoteMicStatusUpdate(e,t)}},t.prototype.config=function(e){return this.logger.debug("zb.cm.cf call"),a.ClientUtil.checkConfigParam(e,this.logger)?(this.stateCenter.appid=e.appid,"string"==typeof e.server?(this.stateCenter.server=e.server,this.stateCenter.serverBak=e.server):Array.isArray(e.server)&&0<e.server.length&&(this.stateCenter.server=e.server[0],this.stateCenter.serverBak=e.server[1]||e.server[0]),this.logger.info("zb.cm.cf server "+JSON.stringify(e.server)),this.stateCenter.idName=e.idName,this.stateCenter.nickName=e.nickName,this.logger.setLogLevel(e.logLevel),!1===e.audienceCreateRoom&&(this.stateCenter.roomCreateFlag=0),e.remoteLogLevel?this.logger.setRemoteLogLevel(e.remoteLogLevel):this.logger.setRemoteLogLevel(0),this.logger.setSessionInfo(e.appid,"","",e.idName,"",s.PROTO_VERSION),e.logUrl&&this.logger.openLogServer(e.logUrl),-1==this.stateCenter.server.indexOf("test2-wsliveroom-api.zego.im")&&-1==this.stateCenter.server.indexOf("wsliveroom-test.zegocloud.com")&&-1==this.stateCenter.server.indexOf("wsliveroom-test.zego.im")||(this.stateCenter.testEnvironment=!0),this.stateCenter.configOK=!0,navigator&&navigator.appVersion&&this.logger.info("zb.cm.cf "+navigator.appVersion),this.logger.debug("zb.cm.cf call success"),!0):(this.logger.error("zb.cm.cf param error"),!1)},t.prototype.login=function(e,t,r,i,n){"string"==typeof e?"string"==typeof r?1===t||2===t?this.roomHandler.login(e,t,r,null,i,n):this.logger.error("zb.rh.lg role error"):this.logger.error("zb.rh.lg token type error"):this.logger.error("zb.rh.lg roomid  type error")},t.prototype.loginWithAuthor=function(e,t,r,i,n,o){"string"!=typeof e||"string"!=typeof r||"string"!=typeof i||1!==t&&2!==t?this.logger.error("zb.rh.lg params error"):this.roomHandler.login(e,t,r,i,n,o)},t.prototype.logout=function(){return this.roomHandler.logout()},t.prototype.setUserStateUpdate=function(e){"boolean"==typeof e&&this.roomHandler.setUserStateUpdate(e)},t.prototype.onUserStateUpdate=function(e,t){},t.prototype.onGetTotalUserList=function(e,t){},t.prototype.onUpdateOnlineCount=function(e,t){},t.prototype.onGetAnchorInfo=function(e,t){},t.prototype.release=function(){this.logger.debug("zb.cm.rl call"),this.roomHandler.setRunState(s.ENUM_RUN_STATE.logout),this.roomHandler.resetRoom(),this.logger.stopLogServer(),this.logger.debug("zb.cm.rl call success")},t.prototype.sendCustomCommand=function(e,t,r,i){return"string"!=typeof t&&"object"!=typeof t?(this.logger.error("zb.mh.scc params error"),!1):this.messageHandler.sendCustomCommand(e,t,r,i)},t.prototype.onRecvCustomCommand=function(e,t,r){},t.prototype.sendRoomMsg=function(e,t,r,i,n){this.messageHandler.sendRoomMsg(e,t,r,i,n)},t.prototype.onRecvRoomMsg=function(e,t,r){},t.prototype.sendReliableMessage=function(e,t,r,i){this.messageHandler.sendReliableMessage(e,t,r,i)},t.prototype.onRecvReliableMessage=function(e,t,r){},t.prototype.sendBigRoomMessage=function(e,t,r,i,n){this.messageHandler.sendBigRoomMessage(e,t,r,i,n)},t.prototype.onRecvBigRoomMessage=function(e,t){},t.prototype.sendRelayMessage=function(e,t,r,i){this.messageHandler.sendRelayMessage(e,t,r,i)},t.prototype.requestJoinLive=function(e,t,r,i){return this.liveHandler.requestJoinLive(e,t,r,i)},t.prototype.onRecvJoinLiveRequest=function(e,t,r,i){},t.prototype.inviteJoinLive=function(e,t,r,i){return this.liveHandler.inviteJoinLive(e,t,r,i)},t.prototype.onRecvInviteJoinLiveRequest=function(e,t,r,i){},t.prototype.endJoinLive=function(e,t,r){return this.liveHandler.endJoinLive(e,t,r)},t.prototype.onRecvEndJoinLiveCommand=function(e,t,r,i){},t.prototype.respondJoinLive=function(e,t,r,i){return this.liveHandler.respondJoinLive(e,t,r,i)},t.prototype.updateMixStream=function(e,t,r){return this.streamHandler.updateMixStream(e,t,r)},t.prototype.stopMixStream=function(e,t,r){return this.streamHandler.stopMixStream(e,t,r)},t.prototype.publishTarget=function(e,t,r){return this.streamHandler.publishTarget(e,t,r)},t.prototype.updateStreamExtraInfo=function(e,t){return this.streamHandler.updateStreamExtraInfo(e,t)},t.prototype.onStreamUrlUpdate=function(e,t,r){},t.prototype.onStreamUpdated=function(e,t){},t.prototype.onStreamExtraInfoUpdated=function(e){},t.prototype.onPlayStateUpdate=function(e,t,r){},t.prototype.onVideoSizeChanged=function(e,t,r){},t.prototype.onRemoteCameraStatusUpdate=function(e,t){},t.prototype.onRemoteMicStatusUpdate=function(e,t){},t.prototype.onPlayQualityUpdate=function(e,t){},t.prototype.onPublishStateUpdate=function(e,t,r){},t.prototype.onPublishQualityUpdate=function(e,t){},t.prototype.onDisconnect=function(e){},t.prototype.onKickOut=function(e){},t.getCurrentVersion=function(){return s.PROTO_VERSION},t}(o.Common);t.BaseCenter=g},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),o=r(1),i=function(){function e(){}return e.prototype.onPlayStateUpdateHandle=function(e,t,r){1==e&&this.stopPlayingStream(t),this.onPlayStateUpdate(e,t,r)},e.prototype.onPublishStateUpdateHandle=function(e,t,r){var i=this;0==e?this.stateCenter.publishStreamList[t]&&(this.stateCenter.publishStreamList[t].state==n.ENUM_PUBLISH_STREAM_STATE.tryPublish?(this.stateCenter.publishStreamList[t].state=n.ENUM_PUBLISH_STREAM_STATE.update_info,this.streamHandler.updateStreamInfo(t,n.ENUM_STREAM_SUB_CMD.liveBegin,this.stateCenter.publishStreamList[t].extra_info,function(e){i.stateCenter.publishStreamList[t]&&i.stateCenter.publishStreamList[t].state==n.ENUM_PUBLISH_STREAM_STATE.update_info&&(i.stateCenter.publishStreamList[t].state=n.ENUM_PUBLISH_STREAM_STATE.stop,i.onPublishStateUpdate(1,t,e),i.streamCenter.stopPlayingStream(t))})):this.WebrtcOnPublishStateUpdateHandle(e,t,r)):(this.onPublishStateUpdate(e,t,r),1==e&&this.stopPublishingStream(t))},e.prototype.resetStreamCenter=function(){if(this.stateCenter.customUrl&&(this.stateCenter.customUrl=null),this.streamCenter.reset(),!this.socketCenter.isDisConnect())for(var e in this.stateCenter.publishStreamList)this.stateCenter.publishStreamList[e].state==n.ENUM_PUBLISH_STREAM_STATE.publishing&&this.streamHandler.updateStreamInfo(e,n.ENUM_STREAM_SUB_CMD.liveEnd,this.stateCenter.publishStreamList[e].extra_info)},e.prototype.handleFetchWebRtcUrlRsp=function(e){var t=e.body.stream_id,r=!1;if(0<e.body.urls.length?r=!0:this.logger.error("cb.cm.hfwur signal url is empty"),"push"===e.body.ptype)!r&&this.onPublishStateUpdate(1,t,o.publishErrorList.DISPATCH_ERROR)&&this.stopPublishingStream(t),this.stateCenter.publishStreamList[t]?this.streamCenter.startPublishingStream(t,e.body.urls):this.logger.error("cb.cm.hfwur no streamid to publish");else if("pull"==e.body.ptype){!r&&this.onPlayStateUpdate(1,t,o.playErrorList.DISPATCH_ERROR)&&this.stopPlayingStream(t);for(var i=!1,n=0;n<this.stateCenter.streamList.length;n++)if(this.stateCenter.streamList[n].stream_id===t){i=!0;break}0==i&&this.logger.warn("cb.cm.hfwur cannot find stream, continue to play"),this.streamCenter.startPlayingStream(t,e.body.urls)}},e}();t.Common=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var d=r(0),i=r(2),n=function(){function e(e,t){var r=this;this.cmdSeq=0,this.responseRouters={},this.logger=e,this.stateCenter=t,this.responseRouters={push_kickout:function(e){r.handlePushKickout(e)},push_custommsg:function(e){r.handlePushCustomMsg(e)},push_im_chat:function(e){r.handlePushRoomMsg(e)},push_userlist_update:function(e){r.handlePushUserStateUpdateMsg(e)},push_merge_message:function(e){r.handlePushMergeMsg(e)},trans:function(e){r.handleTransRsp(e)},push_trans:function(e){r.handlePushTransMsg(e)}}}return e.prototype.handlePushKickout=function(e){},e.prototype.handlePushCustomMsg=function(e){},e.prototype.handlePushRoomMsg=function(e){},e.prototype.handlePushUserStateUpdateMsg=function(e){},e.prototype.handlePushMergeMsg=function(e){},e.prototype.handlePushTransMsg=function(e){},e.prototype.handleBigImMsgRsp=function(e){},e.prototype.handleTransRsp=function(e){var t;this.stateCenter.isLogin()?0==e.body.err_code?(t=e.body.trans_type,this.stateCenter.transSeqMap[t]?(this.stateCenter.transSeqMap[t].seq=e.body.trans_seq,this.logger.debug("zb.sc.htr trans "+t+" seq "+e.body.trans_seq)):this.logger.error("zb.sc.htr cannot match send info")):this.logger.error("zb.sc.htr trans send error "+e.body.err_code):this.logger.error("zb.sc.htr not login")},e.prototype.handleBizChannelRspCallback=function(e,t){0===e.body.err_code?null!=t.success&&t.success(e.header.seq,e.body.cmd,e.body.rsp_body):null!=t.error&&t.error(e.body.err_code,e.header.seq,e.body.rsp_body)},e.prototype.registerRouter=function(e,t){this.responseRouters[e]=t},e.prototype.getSocket=function(e){return null},e.prototype.getHeaderV2=function(e){return{Protocol:"req_v2",cmd:e,appid:this.stateCenter.appid,seq:++this.cmdSeq,user_id:this.stateCenter.userid,session_id:this.stateCenter.sessionid||"",room_id:this.stateCenter.roomid||""}},e.prototype.getHeader=function(e){return{Protocol:"req",cmd:e,appid:this.stateCenter.appid,seq:++this.cmdSeq,user_id:this.stateCenter.userid,session_id:this.stateCenter.sessionid||"",room_id:this.stateCenter.roomid||""}},e.prototype.sendMessage=function(e,t,r,i){if(this.logger.debug("zb.sc.sm call "+e),this.isDisConnect())return this.logger.error("zb.sc.sm error  "+e+"websocket is disconnected"),-1;var n,o,s="V1"===d.ROOMVERSION?this.getHeader(e):this.getHeaderV2(e),a={header:s,body:t};return null==r&&(r=null),null==i&&(i=null),null==r&&null==i||(n={data:a,seq:s.seq,deleted:!1,time:Date.parse(new Date+""),success:r,error:i},o=this.stateCenter.sendCommandList.push(n),this.stateCenter.sendCommandMap[n.seq]=o),this.websocket.send(JSON.stringify(a)),this.logger.debug("zb.sc.sm success"),s.seq},e.prototype.sendCustomMessage=function(e,t,r,i){if(this.logger.debug("zb.sc.scm call"),this.isDisConnect())return this.logger.error("zb.sc.scm error"),!1;var n="V1"===d.ROOMVERSION?this.getHeader(e):this.getHeaderV2(e),o={header:n,body:t},s=JSON.stringify(o);null==r&&(r=null),null==i&&(i=null);var a={data:o,seq:n.seq,deleted:!1,time:Date.parse(new Date+""),success:r,error:i},c=this.stateCenter.sendDataList.push(a);return this.stateCenter.sendDataMap[a.seq]=c,this.websocket.send(s),this.logger.debug("zb.sc.scm success seq: ",n.seq),!0},e.prototype.isDisConnect=function(){return!this.websocket||1!==this.websocket.readyState},e.prototype.closeSocket=function(){this.websocket&&(this.logger.info("zb.sc.cs close websocket"),this.websocket.onclose=null,this.websocket.onerror=null,this.websocket.close(),this.websocket=null)},e.prototype.createSocket=function(e){this.websocket=this.getSocket(e)},e.prototype.openHandler=function(e){this.websocket.onopen=e},e.prototype.closeHandler=function(e){this.websocket.onclose=e},e.prototype.errorHandler=function(){var t=this;this.websocket.onerror=function(e){t.logger.error("zb.sc.oe msg="+JSON.stringify(e))}},e.prototype.checkResponse=function(e){return(e.header.appid!==this.stateCenter.appid||e.header.session_id!==this.stateCenter.sessionid||e.header.user_id!==this.stateCenter.userid||e.header.room_id!==this.stateCenter.roomid||this.stateCenter.runState!==d.ENUM_RUN_STATE.login)&&(this.logger.error("zb.sc.crp check session fail."),!0)},e.prototype.responseHandler=function(){var r=this;this.websocket.onmessage=function(e){var t=JSON.parse(e.data);r.logger.info("zb.sc.ws.rph jsonmsg= ",t.header.cmd),r.logger.info("zb.sc.ws.rph jsonmsg= ",e.data),0!==t.body.err_code&&t.body.err_message&&r.logger.error("zb.sc.ws.rph cmd="+t.header.cmd+", err_code="+t.body.err_code+", err_message="+t.body.err_message+" "),"login"!==t.header.cmd?"logout"!==t.header.cmd?r.stateCenter.isLogin()?r.checkResponse(t)?r.logger.error("zb.sc.ws.rph check session fail."):(r.handleSendCommandMsgRsp(t),r.logger.info("zb.sc.ws.rph cmd="+t.header.cmd+",function="+!!r.responseRouters[t.header.cmd]),r.responseRouters[t.header.cmd]&&r.responseRouters[t.header.cmd](t)):r.logger.warn("zb.sc.ws.rph  already logout"):r.responseRouters.logout(t,r.cmdSeq):r.responseRouters.login(t,r.cmdSeq)}},e.prototype.handleSendCommandMsgRsp=function(e){this.logger.debug("zb.sc.hscmr call");var t,r=this.stateCenter.sendCommandMap[e.header.seq];null!=r&&("login"==(t=r._data).data.header.cmd?this.logger.debug("zb.sc.hscmr don't check "+t.data.header.cmd):"relay"==t.data.header.cmd?this.handleRelayRspCallback(e,t):"bigim_chat"==t.data.header.cmd?this.handleBigImRspCallback(e,t):"biz_channel"==t.data.header.cmd?this.handleBizChannelRspCallback(e,t):0===e.body.err_code?null!=t.success&&t.success(e.header.seq):null!=t.error&&t.error(i.ClientUtil.getServerError(e.body.err_code),e.header.seq),delete this.stateCenter.sendCommandMap[e.header.seq],this.stateCenter.sendCommandList.remove(r)),this.logger.debug("zb.sc.hscmr call success")},e.prototype.handleRelayRspCallback=function(e,t){0===e.body.err_code?null!=t.success&&t.success(e.header.seq,e.body.relay_result):null!=t.error&&t.error(i.ClientUtil.getServerError(e.body.err_code),e.header.seq)},e.prototype.handleBigImRspCallback=function(e,t){0===e.body.err_code?null!=t.success&&this.handleBigImMsgRsp(e):null!=t.error&&t.error(i.ClientUtil.getServerError(e.body.err_code),e.header.seq)},e}();t.SocketCenter=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(0),a=r(2),i=function(){function e(e,t,r){this.logger=e,this.socketCenter=r,this.stateCenter=t}return e.prototype.setRunState=function(e){this.logger.debug("zb.rh.srs old="+this.stateCenter.runState+", new="+e),this.stateCenter.lastRunState=this.stateCenter.runState,this.stateCenter.runState=e},e.prototype.resetTryLogin=function(){this.logger.debug("zb.rh.rtl call"),clearTimeout(this.stateCenter.tryLoginTimer),this.stateCenter.tryLoginTimer=null,this.stateCenter.tryLoginCount=0,this.logger.debug("zb.rh.rtl call success")},e.prototype.resetBigRoomInfo=function(){this.stateCenter.transSeqMap={},this.stateCenter.realyMessageList=[],this.stateCenter.relayTimer&&(clearTimeout(this.stateCenter.relayTimer),this.stateCenter.relayTimer=null),this.stateCenter.bigImLastTimeIndex=0,this.stateCenter.bigIMmessageList=[],this.stateCenter.bigImCallbackMap={},this.stateCenter.bigImTimer&&(clearTimeout(this.stateCenter.bigImTimer),this.stateCenter.bigImTimer=null),this.stateCenter.serverTimeOffset=0,this.stateCenter.datiTimeWindow=0,this.stateCenter.bigimTimeWindow=0},e.prototype.resetRoom=function(){var t=this;this.logger.debug("zb.rh.rr call"),this.resetTryLogin(),this.resetRoomCallBack(),this.stateCenter.streamList=[],this.stateCenter.streamQuerying=!1,this.stateCenter.publishStreamList={},this.stateCenter.joinLiveCallbackMap={},this.stateCenter.joinLiveRequestMap={},this.stateCenter.streamUrlMap={},this.resetBigRoomInfo(),this.stateCenter.cmdCallback={},this.logger.debug("zb.rh.rr call send logout=",this.stateCenter.sessionid),"0"!==this.stateCenter.sessionid&&this.stateCenter.runState!==s.ENUM_RUN_STATE.logout&&(this.socketCenter.registerRouter("logout",function(e){t.handleLogoutRsp(e)}),this.socketCenter.sendMessage("logout",{reserve:0})),this.socketCenter.closeSocket(),this.setRunState(s.ENUM_RUN_STATE.logout),this.stateCenter.userid="",this.stateCenter.sessionid="",this.logger.setSessionInfo(this.stateCenter.appid,this.stateCenter.roomid,this.stateCenter.sessionid,this.stateCenter.userid,this.stateCenter.idName,s.PROTO_VERSION),this.logger.debug("zb.rh.rr call success")},e.prototype.resetRoomCallBack=function(){},e.prototype.onDisconnect=function(e){},e.prototype.loginSuccessCallBack=function(e,t){},e.prototype.onGetTotalUserList=function(e,t){},e.prototype.login=function(e,t,r,i,n,o){if(this.logger.setSessionInfo(this.stateCenter.appid,e,"","",this.stateCenter.idName,s.PROTO_VERSION),this.logger.info("zb.rh.lg call:",e,r),i&&(this.stateCenter.third_token=i),!this.stateCenter.configOK||!a.ClientUtil.checkLoginParam(e,r))return this.logger.error("zb.rh.lg param error"),void o({code:"",msg:"param error"});this.stateCenter.runState!==s.ENUM_RUN_STATE.logout&&(this.logger.debug("zb.rh.lg reset"),this.setRunState(s.ENUM_RUN_STATE.logout),this.resetRoom()),this.logger.debug("zb.rh.lg begin"),this.setRunState(s.ENUM_RUN_STATE.trylogin),this.stateCenter.roomid=e,this.stateCenter.token=r,this.stateCenter.role=t,a.ClientUtil.registerCallback("login",{success:n,error:o},this.stateCenter.callbackList),this.resetTryLogin(),this.tryLogin(),this.logger.info("zb.rh.lg call success")},e.prototype.loginBodyData=function(){return null},e.prototype.tryLogin=function(){var r=this;if(this.logger.debug("zb.rh.tl call"),this.stateCenter.runState===s.ENUM_RUN_STATE.trylogin){if(++this.stateCenter.tryLoginCount>s.MAX_TRY_LOGIN_COUNT){this.logger.error("zb.rh.tl fail times limit");var e=this.stateCenter.lastRunState;return this.setRunState(s.ENUM_RUN_STATE.logout),this.resetRoom(),void(e==s.ENUM_RUN_STATE.login?(this.logger.error("zb.rh.tl fail and disconnect"),this.onDisconnect(s.sdkErrorList.LOGIN_DISCONNECT)):(this.logger.info("zb.rh.tl fail and callback user"),a.ClientUtil.actionErrorCallback("login",this.stateCenter.callbackList)(s.sdkErrorList.LOGIN_TIMEOUT)))}if(this.stateCenter.startConnceTime=(new Date).getTime(),this.socketCenter.isDisConnect()){this.logger.debug("zb.rh.tl need new websocket");try{this.socketCenter.closeSocket(),this.logger.debug("zb.rh.tl new websocket"),this.socketCenter.createSocket(this.stateCenter.tryLoginCount%2==1?this.stateCenter.server:this.stateCenter.serverBak),this.socketCenter.registerRouter("login",function(e,t){r.handleLoginRsp(e,t)}),this.socketCenter.closeHandler(function(e){r.socketCenter.closeSocket(),r.closeHandler(e)}),this.socketCenter.openHandler(function(){r.openHandler()})}catch(r){this.logger.error("zb.rh.tl websocket err:"+r)}}else{var t=this.loginBodyData();this.logger.info("zb.rh.tl use current websocket and sent login"),this.socketCenter.sendMessage("login",t)}this.stateCenter.tryLoginTimer=setTimeout(function(){r.tryLogin()},s.TRY_LOGIN_INTERVAL[this.stateCenter.tryLoginCount%s.MAX_TRY_LOGIN_COUNT]),this.logger.info("zb.rh.tl call success")}else this.logger.error("zb.rh.tl state error")},e.prototype.handleLoginRsp=function(e,t){if(this.logger.debug("zb.rh.hlr call"),this.stateCenter.runState===s.ENUM_RUN_STATE.trylogin){if(e.header.seq===t)return 0!==e.body.err_code?(this.handleLoginFail(e),void this.logger.error("zb.rh.hlr server error=",e.body.err_code)):(this.handleLoginSuccess(e),void this.logger.info("zb.rh.hlr call success."));this.logger.error("zb.rh.hlr in wrong seq, local=",t,",recv=",e.header.seq)}else this.logger.error("zb.rh.hlr state error")},e.prototype.handleLoginFail=function(e){var t,r;this.logger.debug("zb.rh.hlf call"),a.ClientUtil.isKeepTryLogin(e.body.err_code)?this.logger.warn("zb.rh.hlf KeepTry true"):(t=this.stateCenter.lastRunState,this.setRunState(s.ENUM_RUN_STATE.logout),this.resetRoom(),r=a.ClientUtil.getServerError(e.body.err_code),t===s.ENUM_RUN_STATE.login?(this.logger.info("zb.rh.hlf callback disconnect"),this.onDisconnect(r)):(this.logger.info("zb.rh.hlf callback error"),a.ClientUtil.actionErrorCallback("login",this.stateCenter.callbackList)(r)),this.logger.debug("zb.rh.hlf call success"))},e.prototype.handleLoginSuccess=function(e){this.stateCenter.startloginSucTime=(new Date).getTime(),this.logger.info("zb.rh.hls call");var t,r=this.stateCenter.lastRunState;this.setRunState(s.ENUM_RUN_STATE.login),this.stateCenter.userid=e.body.user_id,this.stateCenter.sessionid=e.body.session_id,this.stateCenter.anchor_info=e.body.anchor_info||this.stateCenter.anchor_info,this.stateCenter.userListInterval=e.body.userlist_interval||this.stateCenter.userListInterval,this.stateCenter.userListMergeInterval=e.body.userlist_merge_timeout||this.stateCenter.userListMergeInterval,this.logger.setSessionInfo(this.stateCenter.appid,this.stateCenter.roomid,this.stateCenter.sessionid,this.stateCenter.userid,this.stateCenter.idName,s.PROTO_VERSION),e.body.config_info&&(this.logger.setRemoteLogLevel(e.body.config_info.log_level),""!=e.body.config_info.log_url&&this.logger.openLogServer(e.body.config_info.log_url)),null!=e.body.ret_timestamp&&"string"==typeof e.body.ret_timestamp&&(t=parseFloat(e.body.ret_timestamp),this.stateCenter.serverTimeOffset=0==t?0:e.body.ret_timestamp-(new Date).getTime()),e.body.bigim_time_window&&"number"==typeof e.body.bigim_time_window&&(this.stateCenter.bigimTimeWindow=e.body.bigim_time_window),e.body.dati_time_window&&"number"==typeof e.body.dati_time_window&&(this.stateCenter.datiTimeWindow=e.body.dati_time_window),e.body.cluster_env&&1===e.body.cluster_env&&(this.stateCenter.testEnvironment=!0),this.resetTryLogin(),this.loginSuccessCallBack(r,e)},e.prototype.openHandler=function(){this.logger.info("zb.rh.oh websocket.onpen call"),this.socketCenter.responseHandler();var e=this.loginBodyData();this.logger.info("zb.rh.oh websocket.onpen send login"),this.stateCenter.startloginTime=(new Date).getTime(),this.socketCenter.sendMessage("login",e),this.logger.debug("zb.rh.oh websocket.onpen call success")},e.prototype.closeHandler=function(e){this.logger.info("zb.rh.ws.oc room websocket close "+JSON.stringify(e.code)),this.stateCenter.runState!==s.ENUM_RUN_STATE.logout?this.stateCenter.runState===s.ENUM_RUN_STATE.trylogin&&this.stateCenter.tryLoginCount<=s.MAX_TRY_LOGIN_COUNT?this.logger.info("zb.rh.ws.oc is called because of try login"):this.stateCenter.runState===s.ENUM_RUN_STATE.login?(this.logger.info("zb.rh.ws.oc is called because of network broken, try again"),this.setRunState(s.ENUM_RUN_STATE.trylogin),this.resetTryLogin(),this.tryLogin()):(this.logger.error("zb.rh.ws.oc out of think!!!"),this.setRunState(s.ENUM_RUN_STATE.logout),this.resetRoom(),this.onDisconnect(s.sdkErrorList.UNKNOWN)):this.logger.info("zb.rh.ws.oc onclose logout flow call websocket.close")},e.prototype.logout=function(){return this.logger.debug("zb.rh.lo call"),this.stateCenter.runState===s.ENUM_RUN_STATE.logout?(this.logger.warn("zb.rh.lo at logout"),!1):(this.resetRoom(),this.logger.info("zb.rh.lo call success"),!0)},e.prototype.setUserStateUpdate=function(e){return this.logger.debug("zb.rh.su call"),"boolean"!=typeof e?(this.logger.info("zb.rh.su param error"),!1):(this.stateCenter.userStateUpdate=e,this.logger.info("zb.rh.su call success "+e),!0)},e.prototype.fetchUserList=function(){this.logger.debug("zb.rh.ful call"),this.stateCenter.userQuerying?this.logger.warn("zb.rh.ful is already querying"):(this.stateCenter.userQuerying=!0,this.stateCenter.userTempList=[],"V1"===s.ROOMVERSION?this.fetchUserListWithPage(0):this.fetchUserListWithPageV2(0),this.logger.info("zb.rh.ful the first time call"))},e.prototype.fetchUserListWithPageV2=function(t){var r=this;this.logger.debug("zb.rh.fulwp call"),this.socketCenter.registerRouter("user_list_v2",function(e){r.handleFetchUserListRspV2(t,e)}),this.socketCenter.sendMessage("user_list_v2",{marker:0===t?"":t+"",mode:0,limit:100}),this.logger.info("zb.rh.fulwp call success")},e.prototype.fetchUserListWithPage=function(e){var t=this;this.logger.debug("zb.rh.fulwp call"),this.socketCenter.registerRouter("user_list",function(e){t.handleFetchUserListRsp(e)}),this.socketCenter.sendMessage("user_list",{user_index:e,sort_type:0}),this.logger.info("zb.rh.fulwp call success")},e.prototype.handleFetchUserListRspV2=function(e,t){if(this.logger.debug("zb.rh.hfulr call"),0!=t.body.err_code)return this.stateCenter.userQuerying=!1,this.stateCenter.lastUserQueryTime=Date.now()+this.stateCenter.userListInterval,void this.logger.info("zb.rh.hfulr fetch error "+t.body.err_code);if(this.stateCenter.userStateUpdate){if(this.stateCenter.userTempList=this.stateCenter.userTempList.concat(t.body.user_baseinfos),e!=t.body.marker)return this.logger.warn("zb.rh.hfulr fetch another page"),void this.fetchUserListWithPageV2(e+1);this.stateCenter.userSeq=t.body.server_user_seq,this.logger.info("zb.rh.hfulr set user Seq "+this.stateCenter.userSeq);for(var r=[],i=0;i<this.stateCenter.userTempList.length;i++){var n={idName:this.stateCenter.userTempList[i].id_name,nickName:this.stateCenter.userTempList[i].nick_name,role:this.stateCenter.userTempList[i].role};r.push(n)}this.stateCenter.userQuerying=!1,this.stateCenter.lastUserQueryTime=Date.now()+this.stateCenter.userListInterval,this.onGetTotalUserList(this.stateCenter.roomid,r),this.stateCenter.userTempList=[],this.logger.info("zb.rh.hfulr call success user_list "+r+" count "+r.length)}},e.prototype.handleFetchUserListRsp=function(e){if(this.logger.debug("zb.rh.hfulr call"),0!=e.body.err_code)return this.stateCenter.userQuerying=!1,this.stateCenter.lastUserQueryTime=Date.now()+this.stateCenter.userListInterval,void this.logger.info("zb.rh.hfulr fetch error "+e.body.err_code);if(this.stateCenter.userStateUpdate){this.stateCenter.userTempList=this.stateCenter.userTempList.concat(e.body.user_baseinfos);var t=e.body.ret_user_index;if(t!=e.body.server_user_index)return this.logger.warn("zb.rh.hfulr fetch another page"),void this.fetchUserListWithPage(t+1);this.stateCenter.userSeq=e.body.server_user_seq,this.logger.info("zb.rh.hfulr set user Seq "+this.stateCenter.userSeq);for(var r=[],i=0;i<this.stateCenter.userTempList.length;i++){var n={idName:this.stateCenter.userTempList[i].id_name,nickName:this.stateCenter.userTempList[i].nick_name,role:this.stateCenter.userTempList[i].role};r.push(n)}this.stateCenter.userQuerying=!1,this.stateCenter.lastUserQueryTime=Date.now()+this.stateCenter.userListInterval,this.onGetTotalUserList(this.stateCenter.roomid,r),this.stateCenter.userTempList=[],this.logger.info("zb.rh.hfulr call success user_list "+r+" count "+r.length)}},e.prototype.handleLogoutRsp=function(e){this.logger.debug("zb.rh.hlor result=",e.body.err_code)},e.prototype.handlePushUserStateUpdateMsg=function(e){if(this.logger.info("zb.rh.hpus call"),this.stateCenter.isLogin())if(this.stateCenter.userStateUpdate)if(this.stateCenter.userSeq+e.body.user_actions.length===e.body.user_list_seq){this.stateCenter.userSeq=e.body.user_list_seq,this.logger.debug("zb.rh.hpus push userSeq "+this.stateCenter.userSeq);for(var t=[],r=0;r<e.body.user_actions.length;r++){var i={action:e.body.user_actions[r].Action,idName:e.body.user_actions[r].IdName,nickName:e.body.user_actions[r].NickName,role:e.body.user_actions[r].Role,loginTime:e.body.user_actions[r].LoginTime};t.push(i)}this.onUserStateUpdate(e.body.room_id,t),this.logger.info("zb.rh.hpus call success")}else this.mergeUserByUserSeq(e.body.user_list_seq,e.body.user_actions);else this.logger.info("zb.rh.hpus no userStateUpdate flag");else this.logger.error("zb.rh.hpus not login")},e.prototype.onUserStateUpdate=function(e,t){},e.prototype.mergeUserByUserSeq=function(e,t){var r=this;this.stateCenter.userSeqMergeMap||(this.logger.warn("zb.rh.hpus new merge userlist "+this.stateCenter.userSeq+" server "+e),this.stateCenter.userSeqMergeMap={},this.stateCenter.userSeqMergeTimer&&clearTimeout(this.stateCenter.userSeqMergeTimer),this.stateCenter.userSeqMergeTimer=setTimeout(function(){var e,t=Object.keys(r.stateCenter.userSeqMergeMap).map(function(e){return+e}).sort(function(e,t){return e-t});t[t.length-1]-t[0]+1===t.length?r.mergeUser(t):(r.stateCenter.userSeqMergeMap=null,e=r.stateCenter.lastUserQueryTime-Date.now(),r.logger.info("zb.rh.hpus fetch merge userlist "+r.stateCenter.userSeq+" userSeqList "+t.join(",")+" wait "+e),0<e?(r.stateCenter.userQueryTimer&&clearTimeout(r.stateCenter.userQueryTimer),r.stateCenter.userQueryTimer=setTimeout(function(){r.fetchUserList()},e)):r.fetchUserList())},this.stateCenter.userListMergeInterval)),this.logger.warn("zb.rh.hpus merge userlist "+this.stateCenter.userSeq+" server "+e+" userlist "+t.length),this.stateCenter.userSeqMergeMap[e]=t},e.prototype.mergeUser=function(e){var t=this;this.logger.info("zb.rh.hpus merge userlist "+this.stateCenter.userSeq+" userSeqList "+e.join(",")),this.stateCenter.userSeq=e[e.length-1];var r={};e.forEach(function(e){t.stateCenter.userSeqMergeMap[e].forEach(function(e){r[e.IdName]=e})}),this.stateCenter.userSeqMergeMap=null;var i=Object.values(r).map(function(e){return{action:e.Action,idName:e.IdName,nickName:e.NickName,role:e.Role,loginTime:e.LoginTime?String(e.LoginTime):""}});i.sort(function(e,t){return e.loginTime.localeCompare(t.loginTime)}),this.onUserStateUpdate(this.stateCenter.roomid,i)},e}();t.RoomHandler=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var p=r(0),g=r(2),n=r(22),i=function(){function e(e,t,r){this.logger=e,this.socketCenter=r,this.stateCenter=t}return e.prototype.setCDNInfo=function(e,t){},e.prototype.onStreamUpdated=function(e,t){},e.prototype.onStreamExtraInfoUpdated=function(e){},e.prototype.handleStreamStart=function(e,t){var r=this;if(this.stateCenter.streamQuerying=!1,this.socketCenter.registerRouter("stream",function(e){r.handleStreamUpdateRsp(e)}),this.socketCenter.registerRouter("push_stream_update",function(e){r.handlePushStreamUpdateMsg(e)}),e==p.ENUM_RUN_STATE.login)this.logger.info("zb.sh.hss recover from disconnect so call streamupdate"),this.handleFullUpdateStream(t.body.stream_seq,t.body.stream_info||[]);else{this.logger.info("zb.sh.hss success callback user"),this.stateCenter.streamList=t.body.stream_info||[],this.stateCenter.streamSeq=t.body.stream_seq;for(var i=0;i<this.stateCenter.streamList.length;i++)this.stateCenter.streamList[i].anchor_id_name==this.stateCenter.idName&&(this.updateStreamInfo(this.stateCenter.streamList[i].stream_id,p.ENUM_STREAM_SUB_CMD.liveEnd),this.stateCenter.streamList.splice(i,1));var n=this.makeCallbackStreamList(this.stateCenter.streamList);g.ClientUtil.actionSuccessCallback("login",this.stateCenter.callbackList)(n)}},e.prototype.onPublishStateUpdate=function(e,t,r){},e.prototype.updateStreamInfo=function(e,t,r,i){var n=this;void 0===r&&(r=""),this.logger.debug("zb.sh.usi call");var o={stream_id:e,extra_info:r},s={sub_cmd:t,stream_msg:JSON.stringify(o)};this.socketCenter.registerRouter("stream",function(e){n.handleStreamUpdateRsp(e)}),this.socketCenter.sendMessage("stream",s,void 0,i),this.logger.info("zb.sh.usi call success cmd "+t)},e.prototype.handleStreamUpdateRsp=function(e){if(this.stateCenter.isLogin())if(0==e.body.err_code){this.logger.info("zb.sh.hsur stream seq "+this.stateCenter.streamSeq+" server seq "+e.body.stream_seq),this.stateCenter.streamSeq=e.body.stream_seq;for(var t=0;t<e.body.stream_info.length;t++){var r=e.body.stream_info[t].stream_id;if(!this.stateCenter.publishStreamList[r])return void this.logger.info("hsur.0 stream is not exist");this.stateCenter.publishStreamList[r].state==p.ENUM_PUBLISH_STREAM_STATE.update_info&&(this.stateCenter.publishStreamList[r].state=p.ENUM_PUBLISH_STREAM_STATE.publishing,this.onPublishStateUpdate(0,r,0))}}else this.logger.error("zb.sh.hsur stream update error "+e.body.err_code);else this.logger.error("zb.sh.hsur not login")},e.prototype.handleFetchStreamListRsp=function(e){this.logger.info("zb.sh.hfslr call"),this.stateCenter.streamQuerying=!1,0===e.body.err_code?this.stateCenter.streamSeq!==e.body.stream_seq?(this.handleFullUpdateStream(e.body.stream_seq,e.body.stream_info),this.logger.debug("zb.sh.hfslr call success")):this.logger.info("zb.sh.hfslr same seq"):this.logger.info("zb.sh.hfslr server error=",e.body.err_code)},e.prototype.handleFullUpdateStream=function(e,t){var i=this;this.logger.debug("zb.sh.hfus call"),this.stateCenter.streamSeq=e,this.logger.debug("zb.sh.hfus server seq "+this.stateCenter.streamSeq),g.ClientUtil.mergeStreamList(this.logger,this.stateCenter.idName,this.stateCenter.streamList,t,function(e,t,r){0!==e.length&&(i.logger.debug("zb.sh.hfus callback addstream"),i.onStreamUpdated(p.ENUM_STREAM_UPDATE_TYPE.added,i.makeCallbackStreamList(e))),0!==t.length&&(i.logger.debug("zb.sh.hfus callback delstream"),i.onStreamUpdated(p.ENUM_STREAM_UPDATE_TYPE.deleted,i.makeCallbackStreamList(t))),0!==r.length&&(i.logger.debug("zb.sh.hfus callback updatestream"),i.onStreamExtraInfoUpdated(i.makeCallbackStreamList(r)))}),this.logger.info("zb.sh.hfus call success")},e.prototype.handlePushStreamUpdateMsg=function(e){if(this.logger.info("zb.sh.hpsum call"),e.body.stream_info&&0!==e.body.stream_info.length){if(e.body.stream_info.length+this.stateCenter.streamSeq!==e.body.stream_seq)return this.logger.info("zb.sh.hpsum call updatestream"),void this.fetchStreamList();switch(this.stateCenter.streamSeq=e.body.stream_seq,e.body.stream_cmd){case p.ENUM_STREAM_UPDATE_CMD.added:this.handleAddedStreamList(e.body.stream_info);break;case p.ENUM_STREAM_UPDATE_CMD.deleted:this.handleDeletedStreamList(e.body.stream_info);break;case p.ENUM_STREAM_UPDATE_CMD.updated:this.handleUpdatedStreamList(e.body.stream_info)}this.logger.info("zb.sh.hpsum call success")}else this.logger.info("zb.sh.hpsum, emtpy list")},e.prototype.handleAddedStreamList=function(e){this.logger.debug("zb.sh.hasl call");for(var t,r=[],i=0;i<e.length;i++)if(e[i].anchor_id_name!=this.stateCenter.idName){t=!1;for(var n=0;n<this.stateCenter.streamList.length;n++)if(e[i].stream_id===this.stateCenter.streamList[n].stream_id){t=!0;break}t||r.push(e[i])}else this.logger.debug("hdsl.0 have self stream added");if(0!==r.length){this.logger.debug("zb.sh.hasl callback addstream");for(var o=0;o<r.length;o++)this.stateCenter.streamList.push(r[o]);this.onStreamUpdated(p.ENUM_STREAM_UPDATE_TYPE.added,this.makeCallbackStreamList(r))}this.logger.info("zb.sh.hasl call success")},e.prototype.handleDeletedStreamList=function(e){this.logger.debug("zb.sh.hdsl call");for(var t=[],r=0;r<e.length;r++)if(e[r].anchor_id_name!=this.stateCenter.idName){for(var i=this.stateCenter.streamList.length-1;0<=i;i--)if(e[r].stream_id===this.stateCenter.streamList[i].stream_id){this.stateCenter.streamList.splice(i,1),t.push(e[r]);break}}else this.logger.debug("zb.sh.hdsl have self stream deleted");0!==t.length&&(this.logger.debug("zb.sh.hdsl callback delstream"),this.onStreamUpdated(p.ENUM_STREAM_UPDATE_TYPE.deleted,this.makeCallbackStreamList(t))),this.logger.info("zb.sh.hdsl call")},e.prototype.handleUpdatedStreamList=function(e){this.logger.debug("zb.sh.husl call");for(var t=[],r=0;r<e.length;r++)if(e[r].anchor_id_name!=this.stateCenter.idName){for(var i=0;i<this.stateCenter.streamList.length;i++)if(e[r].stream_id===this.stateCenter.streamList[i].stream_id){e[r].extra_info!==this.stateCenter.streamList[i].extra_info&&(this.stateCenter.streamList[i]=e[r],t.push(e[r]));break}}else this.logger.debug("hsul.0 have self stream updated");0!==t.length&&(this.logger.debug("zb.sh.husl callback updatestream"),this.onStreamExtraInfoUpdated(this.makeCallbackStreamList(t))),this.logger.info("zb.sh.husl call success")},e.prototype.fetchStreamList=function(){this.logger.info("zb.sh.fsl call"),this.stateCenter.isLogin()?this.stateCenter.streamQuerying?this.logger.info("zb.sh.fsl already doing"):(this.stateCenter.streamQuerying=!0,this.logger.debug("zb.sh.fsl send fetch request"),this.socketCenter.registerRouter("stream_info",this.handleFetchStreamListRsp),this.socketCenter.sendMessage("stream_info",{reserve:0}),this.logger.debug("zb.sh.fsl call success")):this.logger.info("zb.sh.fsl state error")},e.prototype.makeCallbackStreamList=function(e){var t=[];if(e&&0<e.length)for(var r=0;r<e.length;r++){var i={anchor_id_name:e[r].anchor_id_name,stream_gid:e[r].stream_gid,anchor_nick_name:e[r].anchor_nick_name,extra_info:e[r].extra_info,stream_id:e[r].stream_id,urls_flv:"",urls_rtmp:"",urls_hls:"",urls_https_flv:"",urls_https_hls:""};this.setCDNInfo(i,e[r]),t.push(i)}return t},e.prototype.updateMixStream=function(d,l,h){var u=this;if(this.logger.info("zb.sh.ums call"),null==d.outputStreamId&&null==d.outputUrl)return this.logger.error("zb.sh.ums no mix stream info"),!1;if(0==d.streamList.length)return this.logger.error("zb.sh.ums no input stream"),!1;var e={id_name:this.stateCenter.idName,live_channel:this.stateCenter.roomid,appid:this.stateCenter.appid,version:p.PROTO_VERSION};"string"==typeof d.userData&&d.userData.length<=1e4&&(e.UserData=d.userData);for(var t=[],r=0;r<d.streamList.length;r++){var i=d.streamList[r],n=i.streamId;this.stateCenter.testEnvironment&&(n="zegotest-"+this.stateCenter.appid+"-"+i.streamId),t.push({stream_id:n,rect:{layer:r,top:i.top,left:i.left,bottom:i.bottom,right:i.right}})}e.MixInput=t;var o={};if(null!=d.outputStreamId?this.stateCenter.testEnvironment?o.stream_id="zegotest-"+this.stateCenter.appid+"-"+d.outputStreamId:o.stream_id=d.outputStreamId:null!=d.outputUrl&&(o.mixurl=d.outputUrl),!d.outputBitrate)return this.logger.error("zb.sh.ums no bitrate param"),!1;if(o.bitrate=d.outputBitrate,!d.outputFps)return this.logger.error("zb.sh.ums no fps param"),!1;if(o.fps=d.outputFps,!d.outputWidth)return this.logger.error("zb.sh.ums no width param"),!1;if(o.width=d.outputWidth,!d.outputHeight)return this.logger.error("zb.sh.ums no height param"),!1;if(o.height=d.outputHeight,d.outputAudioConfig&&(o.audio_enc_id=d.outputAudioConfig),d.outputAudioBitrate&&(o.audio_bitrate=d.outputAudioBitrate),d.outputAudioChannels&&(o.audio_channel_cnt=d.outputAudioChannels),d.outputBgColor){if("number"!=typeof d.outputBgColor)return this.logger.error("zb.sh.ums param outputBgColor error"),!1;e.output_bg_color=d.outputBgColor}if(d.outputBgImage){if("string"!=typeof d.outputBgImage||!d.outputBgImage.startsWith("preset-id://"))return this.logger.error("zb.sh.ums param outputBgImage error"),!1;e.output_bg_image=d.outputBgImage}this.stateCenter.testEnvironment?o.testenv=1:o.testenv=0,e.MixOutput=[o],d.extraParams&&(e.extra_params=d.extraParams);var s={channel:"zeus",cmd:"start_mix",req_body:JSON.stringify(e)};return this.logger.debug("zb.sh.ums send command"),this.socketCenter.sendMessage("biz_channel",s,function(e,t,r){u.logger.debug("zb.sh.ums receive message");var i="zegotest-"+u.stateCenter.appid+"-";if(0!=r.length){for(var n=JSON.parse(r),o=[],s=d.outputStreamId,a=0;a<n.play.length;a++){var c={rtmpUrls:null,hlsUrls:null,flvUrls:null};u.stateCenter.testEnvironment&&s&&s.startsWith(i)&&(s=s.slice(i.length)),n.play[a].rtmp_url&&0<n.play[a].rtmp_url.length&&(c.rtmpUrls=[n.play[a].rtmp_url]),n.play[a].hls_url&&0<n.play[a].hls_url.length&&(c.hlsUrls=[n.play[a].hls_url]),n.play[a].hdl_url&&0<n.play[a].hdl_url.length&&(c.flvUrls=[n.play[a].hdl_url]),o.push(c)}l&&l(s,o)}else h&&h(g.ClientUtil.getServerError(p.MIXSTREAM_ERROR_CODE+1))},function(e,t,r){if("number"==typeof e){u.logger.debug("zb.sh.ums error: "+e);var i=[];if(1000000150==e&&0!=r.length)for(var n=JSON.parse(r),o="zegotest-"+u.stateCenter.appid+"-",s=0;s<n.non_exist_streams.length;s++){var a=n.non_exist_streams[s];u.stateCenter.testEnvironment&&a.startsWith(o)?i.push(a.slice(o.length)):i.push(a)}h&&h(g.ClientUtil.getServerError(p.MIXSTREAM_ERROR_CODE+e),i)}else u.logger.debug("zb.sh.ums error code "+e.code),h&&h(e)}),!0},e.prototype.publishTarget=function(s,a,c){var e,t,r,i,d=this;s.type&&-1!=["addpush","delpush","clearpush"].indexOf(s.type)?(this.logger.info("zb.sh.ptcall"),s.streamId&&"string"==typeof s.streamId?s.pushUrl&&"string"==typeof s.pushUrl?s.appSecret&&"string"==typeof s.appSecret?this.stateCenter.publishStreamList[s.streamId]?(e=Math.ceil((new Date).getTime()/1e3),t=s.streamId,this.stateCenter.testEnvironment&&(t="zegotest-"+this.stateCenter.appid+"-"+s.streamId),r={appid:this.stateCenter.appid,biz_type:0,timestamp:e,signature:n(this.stateCenter.appid.toString()+e.toString()+s.appSecret),seq:this.stateCenter.cdnSeq++,version:+p.PROTO_VERSION,stream_id:t,pushurl:s.pushUrl},i={channel:"media",cmd:s.type,req_body:JSON.stringify(r)},this.logger.debug("zb.sh.pt send command"),this.socketCenter.sendMessage("biz_channel",i,function(e,t,r){if(d.logger.debug("zb.sh.pt receive message"),0!=r.length){var i=JSON.parse(r),n=i.code,o=i.message;if(n&&0!=n)return d.logger.error("zb.sh.pt "+s.type+" error code: "+n+" "+o),void(c&&c({code:n,message:o}));d.logger.info("zb.sh.pt "+s.type+" success"),a&&a()}else c&&c(g.ClientUtil.getServerError(p.MIXSTREAM_ERROR_CODE+1))},function(e,t,r){d.logger.debug("zb.sh.pt error: "+c);var i="";2001==e?i="invalid channel":2002==e&&(i="bizchannel error"),c&&c({code:e,message:i})})):this.logger.error("zb.sh.pt publish stream no found"):this.logger.error("zb.sh.pt appSecret error"):this.logger.error("zb.sh.pt pushurl error"):this.logger.error("zb.sh.pt streamid error")):this.logger.error("zb.sh.pt cdn push type error")},e.prototype.stopMixStream=function(e,r,i){if(this.logger.info("zb.sh.sms call"),null==e.outputStreamId&&null==e.outputUrl)return this.logger.error("zb.sh.sms no mix stream info"),!1;var t={id_name:this.stateCenter.idName,live_channel:this.stateCenter.roomid,appid:this.stateCenter.appid,version:p.PROTO_VERSION};null!=e.outputStreamId?this.stateCenter.testEnvironment?t.stream_id="zegotest-"+this.stateCenter.appid+"-"+e.outputStreamId:t.stream_id=e.outputStreamId:null!=e.outputUrl&&(t.mixurl=e.outputUrl);var n={channel:"zeus",cmd:"stop_mix",req_body:JSON.stringify(t)};return this.socketCenter.sendMessage("biz_channel",n,function(e,t){r&&r()},function(e,t){"number"==typeof e?i&&i(g.ClientUtil.getServerError(p.MIXSTREAM_ERROR_CODE+e)):i&&i(e)}),!0},e.prototype.updateStreamExtraInfo=function(e,t){return this.logger.info("zb.sh.usei call"),e?"string"==typeof t&&(this.stateCenter.publishStreamList[e]&&(this.stateCenter.publishStreamList[e].extra_info=t,this.stateCenter.publishStreamList[e].state>=p.ENUM_PUBLISH_STREAM_STATE.update_info&&this.updateStreamInfo(e,p.ENUM_STREAM_SUB_CMD.liveUpdate,t)),!0):(this.logger.error("zb.sh.usei param error"),!1)},e}();t.StreamHandler=i},function(t,s,m){var v;!function(){"use strict";function h(e,t){var r=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(r>>16)<<16|65535&r}function a(e,t,r,i,n,o){return h(function(e,t){return e<<t|e>>>32-t}(h(h(t,e),h(i,o)),n),r)}function u(e,t,r,i,n,o,s){return a(t&r|~t&i,e,t,n,o,s)}function p(e,t,r,i,n,o,s){return a(t&i|r&~i,e,t,n,o,s)}function g(e,t,r,i,n,o,s){return a(t^r^i,e,t,n,o,s)}function f(e,t,r,i,n,o,s){return a(r^(t|~i),e,t,n,o,s)}function c(e,t){var r,i,n,o,s;e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;var a=1732584193,c=-271733879,d=-1732584194,l=271733878;for(r=0;r<e.length;r+=16)c=f(c=f(c=f(c=f(c=g(c=g(c=g(c=g(c=p(c=p(c=p(c=p(c=u(c=u(c=u(c=u(n=c,d=u(o=d,l=u(s=l,a=u(i=a,c,d,l,e[r],7,-680876936),c,d,e[r+1],12,-389564586),a,c,e[r+2],17,606105819),l,a,e[r+3],22,-1044525330),d=u(d,l=u(l,a=u(a,c,d,l,e[r+4],7,-176418897),c,d,e[r+5],12,1200080426),a,c,e[r+6],17,-1473231341),l,a,e[r+7],22,-45705983),d=u(d,l=u(l,a=u(a,c,d,l,e[r+8],7,1770035416),c,d,e[r+9],12,-1958414417),a,c,e[r+10],17,-42063),l,a,e[r+11],22,-1990404162),d=u(d,l=u(l,a=u(a,c,d,l,e[r+12],7,1804603682),c,d,e[r+13],12,-40341101),a,c,e[r+14],17,-1502002290),l,a,e[r+15],22,1236535329),d=p(d,l=p(l,a=p(a,c,d,l,e[r+1],5,-165796510),c,d,e[r+6],9,-1069501632),a,c,e[r+11],14,643717713),l,a,e[r],20,-373897302),d=p(d,l=p(l,a=p(a,c,d,l,e[r+5],5,-701558691),c,d,e[r+10],9,38016083),a,c,e[r+15],14,-660478335),l,a,e[r+4],20,-405537848),d=p(d,l=p(l,a=p(a,c,d,l,e[r+9],5,568446438),c,d,e[r+14],9,-1019803690),a,c,e[r+3],14,-187363961),l,a,e[r+8],20,1163531501),d=p(d,l=p(l,a=p(a,c,d,l,e[r+13],5,-1444681467),c,d,e[r+2],9,-51403784),a,c,e[r+7],14,1735328473),l,a,e[r+12],20,-1926607734),d=g(d,l=g(l,a=g(a,c,d,l,e[r+5],4,-378558),c,d,e[r+8],11,-2022574463),a,c,e[r+11],16,1839030562),l,a,e[r+14],23,-35309556),d=g(d,l=g(l,a=g(a,c,d,l,e[r+1],4,-1530992060),c,d,e[r+4],11,1272893353),a,c,e[r+7],16,-155497632),l,a,e[r+10],23,-1094730640),d=g(d,l=g(l,a=g(a,c,d,l,e[r+13],4,681279174),c,d,e[r],11,-358537222),a,c,e[r+3],16,-722521979),l,a,e[r+6],23,76029189),d=g(d,l=g(l,a=g(a,c,d,l,e[r+9],4,-640364487),c,d,e[r+12],11,-421815835),a,c,e[r+15],16,530742520),l,a,e[r+2],23,-995338651),d=f(d,l=f(l,a=f(a,c,d,l,e[r],6,-198630844),c,d,e[r+7],10,1126891415),a,c,e[r+14],15,-1416354905),l,a,e[r+5],21,-57434055),d=f(d,l=f(l,a=f(a,c,d,l,e[r+12],6,1700485571),c,d,e[r+3],10,-1894986606),a,c,e[r+10],15,-1051523),l,a,e[r+1],21,-2054922799),d=f(d,l=f(l,a=f(a,c,d,l,e[r+8],6,1873313359),c,d,e[r+15],10,-30611744),a,c,e[r+6],15,-1560198380),l,a,e[r+13],21,1309151649),d=f(d,l=f(l,a=f(a,c,d,l,e[r+4],6,-145523070),c,d,e[r+11],10,-1120210379),a,c,e[r+2],15,718787259),l,a,e[r+9],21,-343485551),a=h(a,i),c=h(c,n),d=h(d,o),l=h(l,s);return[a,c,d,l]}function d(e){var t,r="",i=32*e.length;for(t=0;t<i;t+=8)r+=String.fromCharCode(e[t>>5]>>>t%32&255);return r}function l(e){var t,r=[];for(r[(e.length>>2)-1]=void 0,t=0;t<r.length;t+=1)r[t]=0;var i=8*e.length;for(t=0;t<i;t+=8)r[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return r}function i(e){var t,r,i="0123456789abcdef",n="";for(r=0;r<e.length;r+=1)t=e.charCodeAt(r),n+=i.charAt(t>>>4&15)+i.charAt(15&t);return n}function r(e){return unescape(encodeURIComponent(e))}function n(e){return function(e){return d(c(l(e),8*e.length))}(r(e))}function o(e,t){return function(e,t){var r,i,n=l(e),o=[],s=[];for(o[15]=s[15]=void 0,16<n.length&&(n=c(n,8*e.length)),r=0;r<16;r+=1)o[r]=909522486^n[r],s[r]=1549556828^n[r];return i=c(o.concat(l(t)),512+8*t.length),d(c(s.concat(i),640))}(r(e),r(t))}function e(e,t,r){return t?(r?o:function(e,t){return i(o(e,t))})(t,e):(r?n:function(e){return i(n(e))})(e)}void 0===(v=function(){return e}.call(s,m,s,t))||(t.exports=v)}()},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=r(0),i=r(2),n=function(){function e(e,t,r){this.logger=e,this.socketCenter=r,this.stateCenter=t}return e.prototype.resetHeartbeat=function(){this.logger.debug("zb.hb.rht call"),this.stateCenter.heartbeatTimer&&clearTimeout(this.stateCenter.heartbeatTimer),this.stateCenter.heartbeatTimer=null,this.stateCenter.tryHeartbeatCount=0,this.logger.debug("zb.hb.rht call success")},e.prototype.hbLogout=function(e){},e.prototype.start=function(e){var t=this;if(this.logger.debug("zb.hb.sht call"),this.stateCenter.isLogin()){if(3<++this.stateCenter.tryHeartbeatCount)return this.logger.error("zb.hb.sht come to try limit"),void this.hbLogout(a.sdkErrorList.HEARTBEAT_TIMEOUT);this.logger.debug("zb.hb.sht send packet"),this.socketCenter.registerRouter("hb",function(e){t.handleHeartbeatRsp(e)}),this.socketCenter.sendMessage("hb",{reserve:0}),this.logger.debug("zb.hb.sht call success"),this.stateCenter.heartbeatInterval=e,this.stateCenter.heartbeatTimer=setTimeout(function(){t.start(t.stateCenter.heartbeatInterval)},this.stateCenter.heartbeatInterval)}else this.logger.error("zb.hb.sht state error")},e.prototype.handleHeartbeatRsp=function(e){if(this.logger.debug("zb.hb.hhbr call"),0!==e.body.err_code)return this.logger.error("zb.hb.hhbr call disconnect, server error=",e.body.err_code),void this.hbLogout(i.ClientUtil.getServerError(e.body.err_code));for(var t in this.stateCenter.tryHeartbeatCount=0,this.stateCenter.heartbeatInterval=e.body.hearbeat_interval,this.stateCenter.heartbeatInterval<a.MINIUM_HEARTBEAT_INTERVAL&&(this.stateCenter.heartbeatInterval=a.MINIUM_HEARTBEAT_INTERVAL),e.body.bigim_time_window&&"number"==typeof e.body.bigim_time_window&&(this.stateCenter.bigimTimeWindow=e.body.bigim_time_window),e.body.dati_time_window&&"number"==typeof e.body.dati_time_window&&(this.stateCenter.datiTimeWindow=e.body.dati_time_window),this.ReliableMessageHandler(e),this.fetchStreamList(e),this.patchUserList(e),this.stateCenter.publishStreamList)this.stateCenter.publishStreamList[t].state==a.ENUM_PUBLISH_STREAM_STATE.update_info&&(this.logger.info("zb.hb.hhbr try to update stream info"),this.updateStreamInfo(t,a.ENUM_STREAM_SUB_CMD.liveBegin,this.stateCenter.publishStreamList[t].extra_info));null!=e.body.online_count&&0!=e.body.online_count&&this.onUpdateOnlineCount(this.stateCenter.roomid,e.body.online_count),this.logger.debug("zb.hb.hhbr call success")},e.prototype.ReliableMessageHandler=function(e){var i=this;if(e.body.trans_seqs)for(var t=0;t<e.body.trans_seqs.length;t++){var r=e.body.trans_seqs[t].trans_channel,n=e.body.trans_seqs[t].trans_seq_array;0<(n=n.filter(function(e){var t=e.trans_type,r=e.trans_seq;return!i.stateCenter.transSeqMap[t]||i.stateCenter.transSeqMap[t].seq!==r})).length&&this.fetchReliableMessage(r,n)}},e.prototype.fetchReliableMessage=function(e,t){var r=this;this.logger.debug("zb.hb.frm call");var i={trans_channel:e,fetch_array:t};this.socketCenter.registerRouter("trans_fetch",function(e){r.handleFetchTransRsp(e)}),this.socketCenter.sendMessage("trans_fetch",i),this.logger.debug("zb.hb.frm call success")},e.prototype.handleFetchTransRsp=function(i){var n=this;this.stateCenter.isLogin()?0==i.body.err_code?i.body.trans_fetch_results.forEach(function(e){var t=e.trans_type,r=e.trans_seq;n.stateCenter.transSeqMap[t]={seq:r},i.body.trans_user_idname!=n.stateCenter.idName&&n.onRecvReliableMessage(t,r,e.trans_data),n.logger.debug("zb.hb.hftr trans "+t+" seq "+r)}):this.logger.error("zb.hb.hftr trans send error "+i.body.err_code):this.logger.error("zb.hb.hftr not login")},e.prototype.fetchStreamList=function(e){var t=this;e.body.stream_seq!==this.stateCenter.streamSeq&&(this.logger.debug("zb.hb.fsl current seq "+this.stateCenter.streamSeq+" server Seq "+e.body.stream_seq),this.logger.debug("zb.hb.fsl call"),this.stateCenter.isLogin()?this.stateCenter.streamQuerying?this.logger.warn("zb.hb.fsl already doing"):(this.stateCenter.streamQuerying=!0,this.logger.debug("zb.hb.fsl send fetch request"),this.socketCenter.registerRouter("stream_info",function(e){t.handleFetchStreamListRsp(e)}),this.socketCenter.sendMessage("stream_info",{reserve:0}),this.logger.debug("zb.hb.fsl call success")):this.logger.error("zb.hb.fsl state error"))},e.prototype.patchUserList=function(e){var t,r=this;e.body.server_user_seq!==this.stateCenter.userSeq&&this.stateCenter.userStateUpdate&&!this.stateCenter.userSeqMergeMap&&(t=this.stateCenter.lastUserQueryTime-Date.now(),this.logger.info("zb.hb.hhbr call update user "+this.stateCenter.userSeq+" server "+e.body.server_user_seq+" wait "+t),0<t?(this.stateCenter.userQueryTimer&&clearTimeout(this.stateCenter.userQueryTimer),this.stateCenter.userQueryTimer=setTimeout(function(){r.fetchUserList()},t)):this.fetchUserList())},e.prototype.handleFetchStreamListRsp=function(e){},e.prototype.fetchUserList=function(){},e.prototype.updateStreamInfo=function(e,t,r,i){void 0===r&&(r="")},e.prototype.onUpdateOnlineCount=function(e,t){},e.prototype.onRecvReliableMessage=function(e,t,r){},e.prototype.resetCheckMessage=function(){this.logger.debug("zb.hb.rcm call"),clearTimeout(this.stateCenter.sendDataCheckTimer),this.stateCenter.sendDataCheckTimer=null,this.checkSendMessageList(this.stateCenter.sendDataList),this.checkSendMessageList(this.stateCenter.sendCommandList),this.stateCenter.sendDataMap={},this.stateCenter.sendCommandMap={},this.logger.debug("zb.hb.rcm call success")},e.prototype.checkSendMessageList=function(e){for(var t=e.getFirst();null!=t;)e.remove(t),t._data.error&&(t._data.data.body.custom_msg?t._data.error(a.sdkErrorList.SEND_MSG_TIMEOUT,t._data.data.header.seq,t._data.data.body.custom_msg):t._data.error(a.sdkErrorList.SEND_MSG_TIMEOUT,t._data.data.header.seq)),t=e.getFirst()},e.prototype.checkMessageListTimeout=function(e,t){for(var r=e.getFirst(),i=Date.parse(new Date+""),n=0,o=0,s=0;!(null==r||r._data.time+this.stateCenter.sendDataTimeout>i||(delete t[r._data.data.header.seq],e.remove(r),++o,null==r._data.error||0<this.stateCenter.sendDataDropTimeout&&r._data.time+this.stateCenter.sendDataDropTimeout<i?++s:r._data.data.body.custom_msg?r._data.error(a.sdkErrorList.SEND_MSG_TIMEOUT,r._data.data.header.seq,r._data.data.body.custom_msg):r._data.error(a.sdkErrorList.SEND_MSG_TIMEOUT,r._data.data.header.seq),++n>=this.stateCenter.sendDataCheckOnceCount));)r=e.getFirst();0==o&&0==s||this.logger.debug("zb.hb.cmt call success, stat: timeout=",o,"drop=",s)},e.prototype.startCheckMessageTimeout=function(){var e=this;this.stateCenter.isLogin()?(this.checkMessageListTimeout(this.stateCenter.sendDataList,this.stateCenter.sendDataMap),this.checkMessageListTimeout(this.stateCenter.sendCommandList,this.stateCenter.sendCommandMap),this.stateCenter.sendDataCheckTimer=setTimeout(function(){e.startCheckMessageTimeout()},this.stateCenter.sendDataCheckInterval)):this.logger.error("zb.hb.scmt state error")},e}();t.HeartBeatHandler=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var c=r(0),a=r(2),i=function(){function e(e,t,r){this.logger=e,this.socketCenter=r,this.stateCenter=t}return e.prototype.sendCustomCommand=function(e,t,r,i){var n=this;if(this.logger.debug("zb.mh.scc call"),!this.stateCenter.isLogin())return this.logger.error("zb.mh.scc state error"),!1;if(!e)return this.logger.error("zb.mh.scc dstMembers error"),!1;var o={from_userid:this.stateCenter.idName,from_username:this.stateCenter.nickName,request_id:this.stateCenter.getRequestId(),custom_content:t||"",room_id:this.stateCenter.roomid},s={dest_id_name:e,custom_msg:JSON.stringify(o)};return a.ClientUtil.checkCustomCommandParam(s)?(this.socketCenter.registerRouter("custommsg",function(e){n.handleSendCustomMsgRsp(e)}),this.socketCenter.sendCustomMessage("custommsg",s,r,i),this.logger.info("zb.mh.scc call success"),!0):(this.logger.info("zb.mh.scc param error"),!1)},e.prototype.handleSendCustomMsgRsp=function(e){this.logger.debug("zb.mh.hscmrcall");var t,r=this.stateCenter.sendDataMap[e.header.seq];null!=r?("custommsg"!=(t=r._data).data.header.cmd?this.logger.error("zb.mh.hscmrcmd wrong"+t.data.header.cmd):0===e.body.err_code?null!=t.success&&t.success(e.header.seq,t.data.body.custom_msg):null!=t.error&&t.error(a.ClientUtil.getServerError(e.body.err_code),e.header.seq,t.data.body.custom_msg),delete this.stateCenter.sendDataMap[e.header.seq],this.stateCenter.sendDataList.remove(r)):this.logger.error("zb.mh.hscmrno found seq="+e.header.seq),this.logger.debug("zb.mh.hscmr  call success")},e.prototype.handlePushCustomMsg=function(e){var t=JSON.parse(e.body.custommsg);this.logger.debug("zb.mh.hpcm submsg=",t),this.onRecvCustomCommand(t.from_userid,t.from_username,t.custom_content)},e.prototype.onRecvCustomCommand=function(e,t,r){},e.prototype.sendRoomMsg=function(e,t,r,i,n){var o=this;if(this.logger.debug("zb.mh.srm call"),this.stateCenter.isLogin()){var s=Date.parse(new Date+"");if(0<this.stateCenter.sendRoomMsgTime&&this.stateCenter.sendRoomMsgTime+this.stateCenter.SendRoomMsgInterval>s)return this.logger.info("zb.mh.srm freq error"),void(n&&n(c.sdkErrorList.FREQ_LIMITED,0,e,t,r));this.stateCenter.sendRoomMsgTime=s,this.logger.debug("zb.mh.srm send fetch request");var a={msg_category:e,msg_type:t,msg_content:r};this.socketCenter.registerRouter("im_chat",function(e){o.handleSendRoomMsgRsp(e)}),this.socketCenter.sendCustomMessage("im_chat",a,i,n),this.logger.info("zb.mh.srm call success")}else this.logger.error("zb.mh.srm state error")},e.prototype.handleSendRoomMsgRsp=function(e){this.logger.debug("zb.mh.hsrmr call");var t,r=this.stateCenter.sendDataMap[e.header.seq];null!=r?("im_chat"!=(t=r._data).data.header.cmd?this.logger.error("zb.mh.hsrmr cmd wrong"+t.data.header.cmd):0===e.body.err_code?t.success&&t.success(e.header.seq,e.body.msg_id,t.data.body.msg_category,t.data.body.msg_type,t.data.body.msg_content):t.error&&t.error(a.ClientUtil.getServerError(e.body.err_code),e.header.seq,t.data.body.msg_category,t.data.body.msg_type,t.data.body.msg_content),delete this.stateCenter.sendDataMap[e.header.seq],this.stateCenter.sendDataList.remove(r)):this.logger.error("hzb.mh.hsrmr no found seq="+e.header.seq),this.logger.info("zb.mh.hsrmr call success")},e.prototype.onRecvRoomMsg=function(e,t,r){},e.prototype.sendReliableMessage=function(e,t,r,i){this.logger.debug("zb.mh.srirm call"),this.stateCenter.transSeqMap[e]||(this.stateCenter.transSeqMap[e]={seq:0});var n={trans_type:e,trans_data:t,trans_local_seq:this.stateCenter.transSeqMap[e].seq,trans_channel:"clt"};this.socketCenter.sendMessage("trans",n,r,i)},e.prototype.sendBigRoomMessage=function(e,t,r,i,n){var o=this;this.logger.debug("zb.mh.sbim call");var s,a,c,d=this.stateCenter.bigimTimeWindow,l=this.stateCenter.serverTimeOffset,h=(new Date).getTime()+l,u=(++this.stateCenter.cmdSeq).toString();null==i&&(i=null),null==n&&(n=null),this.stateCenter.bigImCallbackMap[u]={success:i,error:n},0==d?(s={msg_category:e,msg_type:t,msg_content:r,bigmsg_client_id:u},this.logger.debug("zb.mh.sbim no time window"),this.sendBigRoomMessageInternal([s],function(e){o.handleBigImMsgRsp(e)},n)):(a=Math.floor(h/d),this.logger.debug("currentIndex "+a+" lastTimeIndex "+this.stateCenter.bigImLastTimeIndex),this.stateCenter.bigImLastTimeIndex<a&&0==this.stateCenter.bigImMessageList.length?(this.stateCenter.bigImLastTimeIndex=a,c={msg_category:e,msg_type:t,msg_content:r,bigmsg_client_id:u},this.sendBigRoomMessageInternal([c],function(e){o.handleBigImMsgRsp(e)},n)):(this.stateCenter.bigImMessageList.push({msg_category:e,msg_type:t,msg_content:r,bigmsg_client_id:u}),1==this.stateCenter.bigImMessageList.length&&this.setBigImTimer(l,d)))},e.prototype.handlePushMergeMsg=function(e){if(this.stateCenter.isLogin()){for(var t=0;t<e.body.messages.length;t++)14001===e.body.messages[t].sub_cmd&&this.handlePushBigRooMsg(e.body.messages[t].msg_body);this.logger.debug("zb.mh.hpmm call success")}else this.logger.error("zb.mh.hpmmnot login")},e.prototype.handlePushBigRooMsg=function(e){var t;try{t=JSON.parse(e)}catch(e){return void this.logger.warn("zb.mh.hpbrm parse json error")}if(t){for(var r=t.room_id,i=[],n=0;n<t.msg_data.length;n++){var o=t.msg_data[n];o.id_name!=this.stateCenter.idName?i.push({idName:o.id_name,nickName:o.nick_name,messageId:o.bigmsg_id,category:o.msg_category,type:o.msg_type,content:o.msg_content,time:o.send_time}):this.logger.debug("zb.mh.hpbrm self message")}0==i.length?this.logger.debug("zb.mh.hpbrm no other pushData except self"):this.onRecvBigRoomMessage(i,r),this.logger.debug("zb.mh.hpbrm call success")}else this.logger.warn("zb.mh.hpbrm cann't find message body")},e.prototype.onRecvBigRoomMessage=function(e,t){},e.prototype.sendBigRoomMessageInternal=function(e,t,r){this.logger.debug("zb.mh.sbim call");var i={msgs:e};this.socketCenter.sendMessage("bigim_chat",i,t,r)},e.prototype.handleBigImMsgRsp=function(e){if(this.stateCenter.isLogin()){this.stateCenter.bigimTimeWindow!=e.body.bigim_time_window&&(this.stateCenter.bigimTimeWindow=e.body.bigim_time_window);for(var t=0;t<e.body.msgs.length;t++){var r,i=e.body.msgs[t].bigmsg_client_id,n=e.body.msgs[t].bigmsg_id;this.stateCenter.bigImCallbackMap[i]&&(null!=(r=this.stateCenter.bigImCallbackMap[i].success)&&r(e.header.seq,n),delete this.stateCenter.bigImCallbackMap[i])}}else this.logger.info("zb.mh.hbmr not login")},e.prototype.setBigImTimer=function(e,t){var r=this,i=t-((new Date).getTime()+e)%t,n=a.ClientUtil.generateRandumNumber(t)+i;this.logger.info("zb.mh.sbt setTimer "+n),this.stateCenter.bigImTimer=setTimeout(function(){r.onBigImTimer()},n)},e.prototype.onBigImTimer=function(){var o=this,e=(new Date).getTime()+this.stateCenter.serverTimeOffset;this.stateCenter.bigImLastTimeIndex=Math.floor(e/this.stateCenter.bigimTimeWindow);for(var t=[],s=[],r=0;r<this.stateCenter.bigImMessageList.length&&!(20<=r);r++){var i=this.stateCenter.bigImMessageList[r];t.push({msg_category:i.msg_category,msg_type:i.msg_type,msg_content:i.msg_content,bigmsg_client_id:i.bigmsg_client_id}),s.push(i.bigmsg_client_id)}20<this.stateCenter.bigImMessageList.length?this.stateCenter.bigImMessageList.splice(0,20):this.stateCenter.bigImMessageList=[],this.sendBigRoomMessageInternal(t,function(e){o.handleBigImMsgRsp(e)},function(e,t){for(var r=0;r<s.length;r++){var i=s[r],n=o.stateCenter.bigImCallbackMap[i];n&&(null!=n.error&&n.error(e,t),delete o.stateCenter.bigImCallbackMap[i])}}),clearTimeout(this.stateCenter.bigImTimer),this.stateCenter.bigImTimer=null,0<this.stateCenter.bigImMessageList.length&&this.setBigImTimer(this.stateCenter.serverTimeOffset,this.stateCenter.bigimTimeWindow)},e.prototype.sendRelayMessage=function(e,t,r,i){this.logger.debug("zb.mh.srm call");var n=this.stateCenter.datiTimeWindow,o=this.stateCenter.serverTimeOffset;0<n?(this.stateCenter.realyMessageList.push({type:e,data:t,success:r,error:i}),1==this.stateCenter.realyMessageList.length&&this.setRelayTimer(o,n)):this.sendRelayMessageInternal(e,t,r,i)},e.prototype.sendRelayMessageInternal=function(e,t,r,i){this.logger.debug("zb.mh.srmi call");var n={relay_type:e,relay_data:t};this.socketCenter.sendMessage("relay",n,r,i)},e.prototype.setRelayTimer=function(e,t){var r=this,i=2*t-((new Date).getTime()+e)%t,n=a.ClientUtil.generateRandumNumber(i);this.logger.info("zb.mh.srt setTimer "+n),this.stateCenter.relayTimer=setTimeout(function(){r.onRelayTimer()},n)},e.prototype.onRelayTimer=function(){var e;0!=this.stateCenter.realyMessageList.length?(e=this.stateCenter.realyMessageList[0],this.sendRelayMessageInternal(e.type,e.data,e.success,e.error),clearTimeout(this.stateCenter.relayTimer),this.stateCenter.relayTimer=null,this.stateCenter.realyMessageList.splice(0,1),0<this.stateCenter.realyMessageList.length&&this.setRelayTimer(this.stateCenter.serverTimeOffset,this.stateCenter.datiTimeWindow)):this.logger.info("zb.mh.ort no relay data")},e.prototype.handlePushTransMsg=function(e){var t,r;this.stateCenter.isLogin()?(t=e.body.trans_type,r=e.body.trans_seq,this.stateCenter.transSeqMap[t]?this.stateCenter.transSeqMap[t].seq=r:this.stateCenter.transSeqMap[t]={seq:r},e.body.trans_user_idname!=this.stateCenter.idName?this.onRecvReliableMessage(t,r,e.body.trans_data):this.logger.debug("zb.mh.hptr receive self trans message"),this.logger.info("zb.mh.hptr trans "+t+" seq "+r)):this.logger.error("zb.mh.hptr not login")},e.prototype.onRecvReliableMessage=function(e,t,r){},e}();t.MessageHandler=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=r(0),i=function(){function e(e,t,r){this.logger=e,this.socketCenter=r,this.stateCenter=t}return e.prototype.requestJoinLive=function(e,t,r,i){this.logger.debug("zb.lh.rjl call");var n=this.stateCenter.getRequestId(),o=this.stateCenter.getSignalCmdContent(n,e);return null!=i&&(this.stateCenter.joinLiveCallbackMap[n]=i,this.sendSignalCmd(a.ENUM_SIGNAL_SUB_CMD.joinLiveRequest,o,e,t,r),!0)},e.prototype.inviteJoinLive=function(e,t,r,i){this.logger.debug("zb.lh.ijl call");var n=this.stateCenter.getRequestId(),o=this.stateCenter.getSignalCmdContent(n,e);return null!=i&&(this.stateCenter.joinLiveCallbackMap[n]=i,this.sendSignalCmd(a.ENUM_SIGNAL_SUB_CMD.joinLiveInvite,o,e,t,r),!0)},e.prototype.endJoinLive=function(e,t,r){this.logger.debug("zb.lh.ejl call");var i=this.stateCenter.getRequestId(),n=this.stateCenter.getSignalCmdContent(i,e);return this.sendSignalCmd(a.ENUM_SIGNAL_SUB_CMD.joinLiveStop,n,e,t,r),!0},e.prototype.respondJoinLive=function(e,t,r,i){this.logger.debug("zb.lh.rpjl call");var n=this.stateCenter.joinLiveRequestMap[e];if(!n)return this.logger.info("zb.lh.rpjl no dest id name"),!1;var o=0;!0===t&&(o=1);var s=this.stateCenter.getSignalCmdContent(e,n,o);return this.sendSignalCmd(a.ENUM_SIGNAL_SUB_CMD.joinLiveResult,s,n,r,i),delete this.stateCenter.joinLiveRequestMap[e],!0},e.prototype.sendSignalCmd=function(e,t,r,i,n){var o;this.logger.debug("zb.lh.ssc call"),this.stateCenter.isLogin()?(this.logger.debug("zb.lh.ssc send signal cmd "+e),o={sub_cmd:e,signal_msg:t,dest_id_name:[r]},this.socketCenter.sendMessage("signal",o,i,n),this.logger.info("zb.lh.ssc call success")):this.logger.error("zb.lh.ssc state error")},e.prototype.handlePushSignalMsg=function(e){if(this.stateCenter.isLogin()){var t=JSON.parse(e.body.signal_msg);switch(this.logger.debug("zb.lh.hpcm hpsm= ",t),e.body.sub_cmd){case a.ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveRequest:this.handlePushJoinLiveRequestMsg(t);break;case a.ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveResult:this.handlePushJoinLiveResultMsg(t);break;case a.ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveInvite:this.handlePushJoinLiveInviteMsg(t);break;case a.ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveStop:this.handlePushJoinLiveStopMsg(t)}this.logger.debug("zb.lh.hpsm call end")}else this.logger.warn("zb.lh.hpsm not login")},e.prototype.handlePushJoinLiveRequestMsg=function(e){var t,r=e.request_id;"string"==typeof r?"string"==typeof(t=e.from_userid)?(this.stateCenter.joinLiveRequestMap[r]=t,this.logger.info("zb.lh.hpjlrm onRecvJoinLiveRequest "+t),this.onRecvJoinLiveRequest(r,e.from_userid,e.from_username,e.room_id)):this.logger.error("zb.lh.hpjlrm no from user"):this.logger.error("zb.lh.hpjlrm no requestId")},e.prototype.onRecvJoinLiveRequest=function(e,t,r,i){},e.prototype.handlePushJoinLiveInviteMsg=function(e){var t,r=e.request_id;"string"==typeof r?"string"==typeof(t=e.from_userid)?(this.stateCenter.joinLiveRequestMap[r]=t,this.logger.info("zb.lh.hpjlim onRecvInviteJoinLiveRequest "+t),this.onRecvInviteJoinLiveRequest(r,e.from_userid,e.from_username,e.room_id)):this.logger.error("zb.lh.hpjlim no from user"):this.logger.error("zb.lh.hpjlim no requestId")},e.prototype.onRecvInviteJoinLiveRequest=function(e,t,r,i){},e.prototype.handlePushJoinLiveResultMsg=function(e){var t=e.request_id;if("string"==typeof t){var r=e.result;if(null!=r){var i=1==r;if(this.stateCenter.joinLiveCallbackMap[t]){var n=this.stateCenter.joinLiveCallbackMap[t];if(!n)return void this.logger.info("hpjlrm.o no callback");this.logger.info("zb.lh.hpjlrm joinLiveRequest/invite result "+i),delete this.stateCenter.joinLiveCallbackMap[t],n(i,e.from_userid,e.from_username)}}else this.logger.info("zb.lh.hpjlrm no result")}else this.logger.error("zb.lh.hpjlrm no requestId")},e.prototype.handlePushJoinLiveStopMsg=function(e){var t=e.request_id;"string"==typeof t?(this.logger.info("zb.lh.hpjlsm onRecvEndJoinLiveCommand "+e.from_userid),this.onRecvEndJoinLiveCommand(t,e.from_userid,e.from_username,e.room_id)):this.logger.error("zb.lh.hpjlsm no requestId")},e.prototype.onRecvEndJoinLiveCommand=function(e,t,r,i){},e}();t.LiveHandler=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=r(0),n=r(1),o=function(){function e(){this.testEnvironment=!1,this.third_token="",this.pullLimited=!0,this.configOK=!1,this.roomCreateFlag=1,this.runState=i.ENUM_RUN_STATE.logout,this.lastRunState=i.ENUM_RUN_STATE.logout,this.callbackList={},this.streamList=[],this.publishStreamList={},this.userQuerying=!1,this.userTempList=[],this.userSeq=0,this.userSeqMergeMap=null,this.userSeqMergeTimer=null,this.userQueryTimer=null,this.lastUserQueryTime=0,this.userListInterval=3e4,this.userListMergeInterval=5e3,this.anchor_info={anchor_id:"",anchor_id_name:"",anchor_nick_name:""},this.sendCommandMap={},this.sendCommandList=new i.LinkedList,this.sendDataMap={},this.sendDataList=new i.LinkedList,this.joinLiveCallbackMap={},this.joinLiveRequestMap={},this.streamUrlMap={},this.cmdCallback={},this.transSeqMap={},this.realyMessageList=[],this.relayTimer=null,this.bigImLastTimeIndex=0,this.bigIMmessageList=[],this.bigImCallbackMap={},this.bigImTimer=null,this.serverTimeOffset=0,this.datiTimeWindow=0,this.bigimTimeWindow=0,this.bigImMessageList=[],this.tryLoginCount=0,this.tryLoginTimer=null,this.heartbeatTimer=null,this.sendDataCheckTimer=null,this.sendDataCheckInterval=2e3,this.sendDataTimeout=5e3,this.sendDataDropTimeout=1e4,this.sendDataCheckOnceCount=100,this.sendRoomMsgTime=0,this.SendRoomMsgInterval=500,this.cmdSeq=0,this.audioEffectBuffer={},this.audioBitRate=48e3,this.cdnSeq=0}return e.prototype.isLogin=function(){return this.runState===i.ENUM_RUN_STATE.login},e.prototype.getRequestId=function(){return this.idName+"-"+n.getSeq()},e.prototype.getSignalCmdContent=function(e,t,r){var i={request_id:e,room_id:this.roomid,from_userid:this.idName,from_username:this.nickName,to_userid:t};return null!=r&&(i.result=r),JSON.stringify(i)},e}();t.StateCenter=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=r(2),n=function(){function e(e){var a=e.type,t=e.channels,r=void 0===t?1:t,i=e.bufferSize,n=void 0===i?0:i,o=e.sampleBit,s=void 0===o?16:o,c=e.sampleRate,d=void 0===c?44100:c,l=this;this.instant=0,this.slow=0,this.clip=0;var h=new("undefined"!=typeof webkitAudioContext?webkitAudioContext:AudioContext);this.context=h,this.type=a,this.channels=r,this.bufferSize=n,this.sampleBit=s,this.sampleRate=d,this.script=h.createScriptProcessor(n,r,r),(new Date).getTime(),this.script.addEventListener("audioprocess",function(e){var t,r=e.inputBuffer.getChannelData(0),i=0,n=0;for(t=0;t<r.length;++t)i+=r[t]*r[t],.99<Math.abs(r[t])&&(n+=1);if(l.instant=Math.sqrt(i/r.length),l.slow=.95*l.slow+.05*l.instant,l.clip=n/r.length,"pcm"===a||"wav"===a){for(var o=[],s=0;s<l.channels;s++)o.push(e.inputBuffer.getChannelData(s));l.recorderBuffer(o)}}),"pcm"!==a&&"wav"!==a||this.initRecorderBuffer(a)}return e.prototype.connectToSource=function(e,t){try{this.mic=this.context.createMediaStreamSource(e),this.mic.connect(this.script),this.script.connect(this.context.destination),void 0!==t&&t(null)}catch(e){void 0!==t&&t(e)}return this},e.prototype.recorderBuffer=function(e){this.worker.postMessage({command:"record",val:e})},e.prototype.initRecorderBuffer=function(e){var t=this;this.worker=i.ClientUtil.inlineWorker(function(){var c,d,l,i,o,n,s=[],a=this;function h(e){var t,r,i,n;return 1==c?(t=p(s[0],o,s),1!=e&&(r=u(e,t))):2==c&&(i=p(s[0],o,s),n=p(s[1],o,s),1!=e?r=g(u(e,i),u(e,n)):t=g(i,n)),1!=e?r:t}function u(e,t){for(var r=new Float32Array(t.length/e),i=0,n=0;i<r.length;)r[i]=t[n],n+=e,i++;return r}function p(e,t,r){for(var i=new Float32Array(t*e.length),n=0,o=0;o<r[0].length;o++)i.set(r[0][o],n),n+=r[0][o].length;return i}function g(e,t){for(var r=new Float32Array(e.length+t.length),i=0;i<e.length+t.length;i+=2)r[i]=e[i/2>>0],r[i+1]=t[i/2>>0];return r}function f(e,t,r){for(var i=0;i<r.length;i++)e.setUint8(t+i,r.charCodeAt(i))}function m(e,t,r){for(var i=0;i<r.length;i++,t+=2){var n=Math.max(-1,Math.min(1,r[i]));e.setInt16(t,n<0?32768*n:32767*n,!0)}}function v(e,t,r){for(var i=0;i<r.length;i++,t++){var n=Math.max(-1,Math.min(1,r[i])),o=n<0?128*n:127*n;o+=128,e.setInt8(t,o)}}this.onmessage=function(e){switch(e.data.command){case"init":t=e.data.val,c=t.sampleChannel,d=t.sampleBit,l=t.sampleRate,i=t.oldSampleRate,o=t.bufferSize,n=t.type;break;case"record":!function(e){for(var t=0;t<c;t++)s[t]||(s[t]=[]),s[t].push(e[t]);var r=Math.round(i/l);"pcm"===n?function(e){var t=function(e,t){var r;8==t?r=e.length:16==t&&(r=e.length,r*=2);var i=new ArrayBuffer(r),n=new DataView(i);return 8==t?v(n,0,e):16==d&&m(n,0,e),n}(h(e),d);a.postMessage({command:"exportPcmLive",val:t})}(r):"wav"===n&&function(e){var t=function(e,t){var r;8==t?r=e.length:16==d&&(r=e.length,r*=2);var i=new ArrayBuffer(r+44),n=new DataView(i),o=l,s=d,a=c;return f(n,0,"RIFF"),n.setUint32(4,36+r,!0),f(n,8,"WAVE"),f(n,12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,a,!0),n.setUint32(24,o,!0),n.setUint32(28,o*a*(s/8),!0),n.setUint16(32,a*(s/8),!0),n.setUint16(34,s,!0),f(n,36,"data"),n.setUint32(40,r,!0),8==d?v(n,44,e):16==d&&m(n,44,e),n}(h(e),d);a.postMessage({command:"exportWav",val:t})}(r),s=[]}(e.data.val)}var t}}),this.worker.postMessage({command:"init",val:{sampleChannel:this.channels,sampleBit:this.sampleBit,sampleRate:this.sampleRate,oldSampleRate:this.context.sampleRate,bufferSize:this.bufferSize,type:e}}),this.worker.onmessage=function(e){switch(e.data.command){case"exportPcmLive":t.onReceiveBuffer(e.data.val);break;case"exportWav":t.onReceiveWav(e.data.val)}}},e.prototype.onReceiveBuffer=function(e){},e.prototype.onReceiveWav=function(e){},e.prototype.writeString=function(e,t,r){for(var i=0;i<r.length;i++)e.setUint8(t+i,r.charCodeAt(i))},e.prototype.writeBuffer=function(e,t,r){for(var i=0;i<r.byteLength;i++)e.setUint8(t+i,r[i])},e.prototype.concatenation=function(e){for(var t=0,r=0;r<e.length;++r)t+=e[r].buffer.byteLength;var i=new Uint8Array(t),n=0;for(r=0;r<e.length;++r)i.set(new Uint8Array(e[r].buffer),n),n+=e[r].buffer.byteLength;return i},e.prototype.encodeWave=function(e){var t=this.concatenation(e),r=t.byteLength,i=new ArrayBuffer(r+44),n=new DataView(i),o=this.sampleRate,s=this.sampleBit,a=this.channels;return this.writeString(n,0,"RIFF"),n.setUint32(4,36+r,!0),this.writeString(n,8,"WAVE"),this.writeString(n,12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,a,!0),n.setUint32(24,o,!0),n.setUint32(28,o*a*(s/8),!0),n.setUint16(32,a*(s/8),!0),n.setUint16(34,s,!0),this.writeString(n,36,"data"),n.setUint32(40,r,!0),this.writeBuffer(n,44,t),n},e.prototype.stop=function(){this.mic.disconnect(),this.script.disconnect()},e}();t.MediaUtil=n}])},function(e,t,r){"use strict";r.r(t),r.d(t,"v1",function(){return a}),r.d(t,"v3",function(){return l}),r.d(t,"v4",function(){return T}),r.d(t,"v5",function(){return w});var i="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto),n=new Uint8Array(16);function g(){if(!i)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return i(n)}for(var o=[],s=0;s<256;++s)o.push((s+256).toString(16).substr(1));var f,m,v=function(e,t){var r=t||0;return(o[e[r+0]]+o[e[r+1]]+o[e[r+2]]+o[e[r+3]]+"-"+o[e[r+4]]+o[e[r+5]]+"-"+o[e[r+6]]+o[e[r+7]]+"-"+o[e[r+8]]+o[e[r+9]]+"-"+o[e[r+10]]+o[e[r+11]]+o[e[r+12]]+o[e[r+13]]+o[e[r+14]]+o[e[r+15]]).toLowerCase()},y=0,b=0;var a=function(e,t,r){var i,n=t&&r||0,o=t||new Array(16),s=(e=e||{}).node||f,a=void 0!==e.clockseq?e.clockseq:m;null!=s&&null!=a||(i=e.random||(e.rng||g)(),null==s&&(s=f=[1|i[0],i[1],i[2],i[3],i[4],i[5]]),null==a&&(a=m=16383&(i[6]<<8|i[7])));var c=void 0!==e.msecs?e.msecs:Date.now(),d=void 0!==e.nsecs?e.nsecs:b+1,l=c-y+(d-b)/1e4;if(l<0&&void 0===e.clockseq&&(a=a+1&16383),(l<0||y<c)&&void 0===e.nsecs&&(d=0),1e4<=d)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");y=c,m=a;var h=(1e4*(268435455&(c+=122192928e5))+(b=d))%4294967296;o[n++]=h>>>24&255,o[n++]=h>>>16&255,o[n++]=h>>>8&255,o[n++]=255&h;var u=c/4294967296*1e4&268435455;o[n++]=u>>>8&255,o[n++]=255&u,o[n++]=u>>>24&15|16,o[n++]=u>>>16&255,o[n++]=a>>>8|128,o[n++]=255&a;for(var p=0;p<6;++p)o[n+p]=s[p];return t||v(o)};function c(e,a,c){function t(e,t,r,i){var n;if("string"==typeof e&&(e=function(e){e=unescape(encodeURIComponent(e));for(var t=[],r=0;r<e.length;++r)t.push(e.charCodeAt(r));return t}(e)),"string"==typeof t&&(n=[],t.replace(/[a-fA-F0-9]{2}/g,function(e){n.push(parseInt(e,16))}),t=n),!Array.isArray(e))throw TypeError("value must be an array of bytes");if(!Array.isArray(t)||16!==t.length)throw TypeError("namespace must be uuid string or an Array of 16 byte values");var o=c(t.concat(e));if(o[6]=15&o[6]|a,o[8]=63&o[8]|128,r){i=i||0;for(var s=0;s<16;++s)r[i+s]=o[s];return r}return v(o)}try{t.name=e}catch(e){}return t.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",t.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",t}function h(e){return 14+(e+64>>>9<<4)+1}function u(e,t){var r=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(r>>16)<<16|65535&r}function d(e,t,r,i,n,o){return u((s=u(u(t,e),u(i,o)))<<(a=n)|s>>>32-a,r);var s,a}function p(e,t,r,i,n,o,s){return d(t&r|~t&i,e,t,n,o,s)}function S(e,t,r,i,n,o,s){return d(t&i|r&~i,e,t,n,o,s)}function C(e,t,r,i,n,o,s){return d(t^r^i,e,t,n,o,s)}function _(e,t,r,i,n,o,s){return d(r^(t|~i),e,t,n,o,s)}var l=c("v3",48,function(e){if("string"==typeof e){var t=unescape(encodeURIComponent(e));e=new Uint8Array(t.length);for(var r=0;r<t.length;++r)e[r]=t.charCodeAt(r)}return function(e){for(var t=[],r=32*e.length,i="0123456789abcdef",n=0;n<r;n+=8){var o=e[n>>5]>>>n%32&255,s=parseInt(i.charAt(o>>>4&15)+i.charAt(15&o),16);t.push(s)}return t}(function(e,t){e[t>>5]|=128<<t%32,e[h(t)-1]=t;for(var r=1732584193,i=-271733879,n=-1732584194,o=271733878,s=0;s<e.length;s+=16){var a=r,c=i,d=n,l=o;r=p(r,i,n,o,e[s],7,-680876936),o=p(o,r,i,n,e[s+1],12,-389564586),n=p(n,o,r,i,e[s+2],17,606105819),i=p(i,n,o,r,e[s+3],22,-1044525330),r=p(r,i,n,o,e[s+4],7,-176418897),o=p(o,r,i,n,e[s+5],12,1200080426),n=p(n,o,r,i,e[s+6],17,-1473231341),i=p(i,n,o,r,e[s+7],22,-45705983),r=p(r,i,n,o,e[s+8],7,1770035416),o=p(o,r,i,n,e[s+9],12,-1958414417),n=p(n,o,r,i,e[s+10],17,-42063),i=p(i,n,o,r,e[s+11],22,-1990404162),r=p(r,i,n,o,e[s+12],7,1804603682),o=p(o,r,i,n,e[s+13],12,-40341101),n=p(n,o,r,i,e[s+14],17,-1502002290),i=p(i,n,o,r,e[s+15],22,1236535329),r=S(r,i,n,o,e[s+1],5,-165796510),o=S(o,r,i,n,e[s+6],9,-1069501632),n=S(n,o,r,i,e[s+11],14,643717713),i=S(i,n,o,r,e[s],20,-373897302),r=S(r,i,n,o,e[s+5],5,-701558691),o=S(o,r,i,n,e[s+10],9,38016083),n=S(n,o,r,i,e[s+15],14,-660478335),i=S(i,n,o,r,e[s+4],20,-405537848),r=S(r,i,n,o,e[s+9],5,568446438),o=S(o,r,i,n,e[s+14],9,-1019803690),n=S(n,o,r,i,e[s+3],14,-187363961),i=S(i,n,o,r,e[s+8],20,1163531501),r=S(r,i,n,o,e[s+13],5,-1444681467),o=S(o,r,i,n,e[s+2],9,-51403784),n=S(n,o,r,i,e[s+7],14,1735328473),i=S(i,n,o,r,e[s+12],20,-1926607734),r=C(r,i,n,o,e[s+5],4,-378558),o=C(o,r,i,n,e[s+8],11,-2022574463),n=C(n,o,r,i,e[s+11],16,1839030562),i=C(i,n,o,r,e[s+14],23,-35309556),r=C(r,i,n,o,e[s+1],4,-1530992060),o=C(o,r,i,n,e[s+4],11,1272893353),n=C(n,o,r,i,e[s+7],16,-155497632),i=C(i,n,o,r,e[s+10],23,-1094730640),r=C(r,i,n,o,e[s+13],4,681279174),o=C(o,r,i,n,e[s],11,-358537222),n=C(n,o,r,i,e[s+3],16,-722521979),i=C(i,n,o,r,e[s+6],23,76029189),r=C(r,i,n,o,e[s+9],4,-640364487),o=C(o,r,i,n,e[s+12],11,-421815835),n=C(n,o,r,i,e[s+15],16,530742520),i=C(i,n,o,r,e[s+2],23,-995338651),r=_(r,i,n,o,e[s],6,-198630844),o=_(o,r,i,n,e[s+7],10,1126891415),n=_(n,o,r,i,e[s+14],15,-1416354905),i=_(i,n,o,r,e[s+5],21,-57434055),r=_(r,i,n,o,e[s+12],6,1700485571),o=_(o,r,i,n,e[s+3],10,-1894986606),n=_(n,o,r,i,e[s+10],15,-1051523),i=_(i,n,o,r,e[s+1],21,-2054922799),r=_(r,i,n,o,e[s+8],6,1873313359),o=_(o,r,i,n,e[s+15],10,-30611744),n=_(n,o,r,i,e[s+6],15,-1560198380),i=_(i,n,o,r,e[s+13],21,1309151649),r=_(r,i,n,o,e[s+4],6,-145523070),o=_(o,r,i,n,e[s+11],10,-1120210379),n=_(n,o,r,i,e[s+2],15,718787259),i=_(i,n,o,r,e[s+9],21,-343485551),r=u(r,a),i=u(i,c),n=u(n,d),o=u(o,l)}return[r,i,n,o]}(function(e){if(0===e.length)return[];for(var t=8*e.length,r=new Uint32Array(h(t)),i=0;i<t;i+=8)r[i>>5]|=(255&e[i/8])<<i%32;return r}(e),8*e.length))});var T=function(e,t,r){var i=(e=e||{}).random||(e.rng||g)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t){r=r||0;for(var n=0;n<16;++n)t[r+n]=i[n];return t}return v(i)};function E(e,t){return e<<t|e>>>32-t}var w=c("v5",80,function(e){var t=[1518500249,1859775393,2400959708,3395469782],r=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof e){var i=unescape(encodeURIComponent(e));e=[];for(var n=0;n<i.length;++n)e.push(i.charCodeAt(n))}e.push(128);for(var o=e.length/4+2,s=Math.ceil(o/16),a=new Array(s),c=0;c<s;++c){for(var d=new Uint32Array(16),l=0;l<16;++l)d[l]=e[64*c+4*l]<<24|e[64*c+4*l+1]<<16|e[64*c+4*l+2]<<8|e[64*c+4*l+3];a[c]=d}a[s-1][14]=8*(e.length-1)/Math.pow(2,32),a[s-1][14]=Math.floor(a[s-1][14]),a[s-1][15]=8*(e.length-1)&4294967295;for(var h=0;h<s;++h){for(var u=new Uint32Array(80),p=0;p<16;++p)u[p]=a[h][p];for(var g=16;g<80;++g)u[g]=E(u[g-3]^u[g-8]^u[g-14]^u[g-16],1);for(var f=r[0],m=r[1],v=r[2],y=r[3],b=r[4],S=0;S<80;++S)var C=Math.floor(S/20),_=E(f,5)+function(e,t,r,i){switch(e){case 0:return t&r^~t&i;case 1:return t^r^i;case 2:return t&r^t&i^r&i;case 3:return t^r^i}}(C,m,v,y)+b+t[C]+u[S]>>>0,b=y,y=v,v=E(m,30)>>>0,m=f,f=_;r[0]=r[0]+f>>>0,r[1]=r[1]+m>>>0,r[2]=r[2]+v>>>0,r[3]=r[3]+y>>>0,r[4]=r[4]+b>>>0}return[r[0]>>24&255,r[0]>>16&255,r[0]>>8&255,255&r[0],r[1]>>24&255,r[1]>>16&255,r[1]>>8&255,255&r[1],r[2]>>24&255,r[2]>>16&255,r[2]>>8&255,255&r[2],r[3]>>24&255,r[3]>>16&255,r[3]>>8&255,255&r[3],r[4]>>24&255,r[4]>>16&255,r[4]>>8&255,255&r[4]]})}],n.c=i,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(r,i,function(e){return t[e]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=59);function n(e){if(i[e])return i[e].exports;var t=i[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,n),t.l=!0,t.exports}var r,i});